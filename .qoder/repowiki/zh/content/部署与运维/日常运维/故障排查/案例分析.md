# 案例分析

<cite>
**本文档引用的文件**   
- [migrate_grafana.py](file://bklog/apps/log_databus/management/commands/migrate_grafana.py)
- [iam_upgrade_action_v2.py](file://bklog/apps/iam/management/commands/iam_upgrade_action_v2.py)
- [flow.py](file://bklog/apps/log_clustering/tasks/flow.py)
- [clustering_config.py](file://bklog/apps/log_clustering/handlers/clustering_config.py)
- [dataflow_handler.py](file://bklog/apps/log_clustering/handlers/dataflow/dataflow_handler.py)
- [exceptions.py](file://bklog/apps/log_clustering/exceptions.py)
- [log.py](file://bklog/apps/utils/log.py)
</cite>

## 目录
1. [Grafana仪表盘迁移失败案例](#grafana仪表盘迁移失败案例)
2. [IAM动作升级导致的权限中断案例](#iam动作升级导致的权限中断案例)
3. [聚类流程执行异常案例](#聚类流程执行异常案例)
4. [诊断思维模式与检查顺序](#诊断思维模式与检查顺序)

## Grafana仪表盘迁移失败案例

该案例涉及从旧版Grafana 8.x（bk-log）迁移到新版Grafana 9.x（bk-monitor）时，仪表盘配置迁移失败的问题。迁移脚本`migrate_grafana.py`负责执行整个迁移流程，包括从源Grafana提取配置、转换配置以适应新环境，以及将配置写入目标Grafana实例。

故障现象通常表现为部分或全部业务（biz_id）的仪表盘未能成功创建。根据日志分析，失败原因主要集中在三个阶段：配置提取、配置转换和配置写入。脚本通过`extract_failed_biz`、`convert_failed_biz`和`write_failed_biz`三个字典分别记录各阶段的失败业务及其错误信息，并在执行结束时集中输出。

在配置提取阶段，失败通常源于无法从源Grafana获取组织（organization）列表或特定业务的仪表盘列表。这可能是由于网络问题、API认证失败或源Grafana服务不可用导致。脚本通过检查`get_all_organization`和`search_dashboard`接口的响应状态码来识别此类错误。

在配置转换阶段，主要挑战是确保数据源（datasource）的正确性。脚本会尝试为每个业务创建一个名为"bk_log_datasource"的数据源。如果该数据源不存在，脚本会先创建一个新的组织（organization），然后在该组织下创建数据源。此过程可能因权限不足或Grafana API限制而失败。

在配置写入阶段，失败通常发生在创建文件夹（folder）或仪表盘（dashboard）时。脚本会为每个文件夹生成一个唯一的标题（例如，`[bklog] 迁移目录`），以避免与现有文件夹冲突。如果目标Grafana中已存在同名文件夹，且无法通过添加后缀（如`_bklog`）解决冲突，则写入操作会失败。

**Section sources**
- [migrate_grafana.py](file://bklog/apps/log_databus/management/commands/migrate_grafana.py#L91-L188)
- [migrate_grafana.py](file://bklog/apps/log_databus/management/commands/migrate_grafana.py#L210-L245)
- [migrate_grafana.py](file://bklog/apps/log_databus/management/commands/migrate_grafana.py#L323-L341)

## IAM动作升级导致的权限中断案例

此案例描述了在执行IAM（身份与访问管理）系统升级时，因权限策略迁移不完整而导致的权限中断问题。核心脚本`iam_upgrade_action_v2.py`负责将旧版动作（如`view_dashboard`）的权限策略迁移到新版动作（如`view_dashboard_v2`）。

故障的根本原因在于权限策略的迁移过程是异步且分批进行的。脚本首先查询所有旧动作的权限策略，然后将这些策略转换为针对新动作的授权请求，并通过多线程并发执行。然而，在高并发环境下，部分授权请求可能因网络抖动、API限流或数据库锁竞争而失败。

脚本通过`grant_resource`函数处理单个授权请求。该函数内部使用`batch_path_authorization`调用IAM API。如果此调用失败，异常会被捕获并记录，但不会中断整个迁移流程。这导致了部分用户或用户组的权限未能成功迁移，从而在升级后出现“无权限”访问的错误。

为了验证修复效果，脚本在迁移完成后会执行`check_upgrade_polices`函数。该函数会对比每个动作在升级前后的策略数量。如果发现某个动作的旧策略数量大于0，而新策略数量等于0，则判定为升级失败。这是一个关键的验证步骤，能够有效识别出完全失败的迁移操作。

解决方案是确保`grant_resource`函数的幂等性，并在主流程中增加重试机制。对于失败的授权请求，应记录其详细信息（如subject、action、resources），以便在后续进行重试。此外，应降低并发数以减轻系统压力，或在非高峰时段执行升级操作。

**Section sources**
- [iam_upgrade_action_v2.py](file://bklog/apps/iam/management/commands/iam_upgrade_action_v2.py#L160-L191)
- [iam_upgrade_action_v2.py](file://bklog/apps/iam/management/commands/iam_upgrade_action_v2.py#L375-L394)
- [iam_upgrade_action_v2.py](file://bklog/apps/iam/management/commands/iam_upgrade_action_v2.py#L210-L240)

## 聚类流程执行异常案例

该案例聚焦于日志聚类功能中的`flow.py`任务执行异常。聚类流程（flow）是数据处理的核心，涉及数据接入、预处理、模型预测和结果聚合等多个环节。当`flow.py`中的任务执行失败时，会导致聚类功能完全中断。

故障现象表现为聚类任务状态长时间停留在“运行中”或“等待执行”，最终变为“失败”。通过分析`clustering_config.py`中的`get_access_status`函数，可以发现系统通过检查`predict_flow_id`和`log_count_aggregation_flow_id`对应DataFlow的状态来判断流程健康度。

根本原因通常与计算平台（bkdata）的DataFlow服务状态有关。`dataflow_handler.py`中的`check_dataflow_status`函数会调用`get_dataflow_info` API来获取flow的详细信息。如果该API调用失败，或返回的flow状态为`failure`，则判定为流程异常。常见的异常原因包括：
1.  **资源不足**：Flink或Spark作业因CPU、内存资源不足而被Kubernetes终止。
2.  **数据源问题**：上游数据源（如Kafka Topic）不存在或数据格式不匹配。
3.  **代码或配置错误**：在更新聚类字段或正则表达式后，未正确重启或更新flow。

诊断此问题的关键是从日志中识别`BkdataFlowException`异常。该异常在`exceptions.py`中定义，其错误信息会明确指出是哪个`flow_id`出现了问题。修复后，应通过`operator_flow`函数以`RESTART`操作重启相关flow，并通过`get_access_status`接口持续监控其状态，直至变为“成功”。

**Section sources**
- [flow.py](file://bklog/apps/log_clustering/tasks/flow.py#L33-L51)
- [clustering_config.py](file://bklog/apps/log_clustering/handlers/clustering_config.py#L342-L373)
- [dataflow_handler.py](file://bklog/apps/log_clustering/handlers/dataflow/dataflow_handler.py#L132-L147)
- [exceptions.py](file://bklog/apps/log_clustering/exceptions.py#L61-L63)

## 诊断思维模式与检查顺序

针对跨模块问题（如权限与采集联动失败），应采用系统性的诊断思维模式。首先，明确故障现象和影响范围，例如“用户A无法查看业务B的仪表盘”。然后，根据系统架构，自上而下地检查各模块。

1.  **前端与API层**：检查用户操作日志，确认请求是否发出，以及API返回的HTTP状态码和错误信息。利用`requests_curl_log`工具记录完整的请求/响应CURL日志，这是识别问题的第一手资料。
2.  **权限层**：确认用户是否拥有执行该操作的权限。检查IAM策略，特别是与`VIEW_DASHBOARD`、`MANAGE_COLLECTION`等动作相关的策略。验证权限升级脚本的执行日志，确保策略已成功迁移。
3.  **业务逻辑层**：深入分析核心业务逻辑。例如，在Grafana迁移案例中，需检查`migrate_grafana.py`的执行日志，定位是在提取、转换还是写入阶段失败。在聚类案例中，需检查`task_details`中的任务详情，判断是哪个节点执行失败。
4.  **依赖服务层**：检查所有外部依赖服务的状态，包括Grafana、IAM、计算平台（bkdata）和数据传输服务（Transfer）。通过调用各自的健康检查API来验证服务可用性。
5.  **数据层**：确认底层数据的完整性和正确性。例如，检查Elasticsearch中索引集的数据是否正常写入，或检查数据库中相关配置记录是否存在。

验证修复效果时，应遵循“观察-修复-验证”的循环。首先复现故障，然后应用修复方案（如重试任务、重启服务、修正配置），最后通过相同的观察手段（如API调用、日志检查）确认问题已解决。整个过程应详细记录，形成可复用的诊断知识库。

**Section sources**
- [log.py](file://bklog/apps/utils/log.py#L180-L205)
- [clustering_config.py](file://bklog/apps/log_clustering/handlers/clustering_config.py#L280-L302)
- [migrate_grafana.py](file://bklog/apps/log_databus/management/commands/migrate_grafana.py#L489-L510)