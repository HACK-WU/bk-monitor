# 执行步骤

<cite>
**本文档中引用的文件**  
- [manage.py](file://bklog/manage.py)
- [requirements.txt](file://bklog/requirements.txt)
- [env.sh](file://bklog/scripts/env.sh)
- [env.bat](file://bklog/scripts/env.bat)
- [iam_upgrade_action_v2.py](file://bklog/apps/iam/management/commands/iam_upgrade_action_v2.py)
- [migrate_tool.py](file://bklog/home_application/management/commands/migrate_tool.py)
- [settings.py](file://bklog/settings.py)
- [default.py](file://bklog/config/default.py)
- [prod.py](file://bklog/config/prod.py)
- [dev.py](file://bklog/config/dev.py)
</cite>

## 目录
1. [引言](#引言)
2. [停机维护流程](#停机维护流程)
3. [代码部署步骤](#代码部署步骤)
4. [数据库迁移执行方法](#数据库迁移执行方法)
5. [配置文件更新注意事项](#配置文件更新注意事项)
6. [蓝鲸平台特有升级步骤](#蓝鲸平台特有升级步骤)
7. [常见问题与解决方案](#常见问题与解决方案)
8. [结论](#结论)

## 引言
本文档旨在为蓝鲸监控平台（bk-monitor）提供详细的版本升级执行步骤，涵盖从准备到完成的完整操作流程。文档重点描述了停机维护、代码部署、数据库迁移、配置更新等关键环节，并特别针对蓝鲸平台的特性提供了专属指导。通过遵循本指南，运维人员可以确保系统升级过程的安全性、稳定性和可追溯性。

## 停机维护流程

在进行版本升级前，必须执行停机维护以确保数据一致性和服务稳定性。正确的服务停止顺序和时间窗口管理是成功升级的关键。

### 服务停止顺序
1. **停止前端服务**：首先停止Nginx或前端代理服务，防止新的用户请求进入系统。
2. **停止Celery任务队列**：停止所有Celery worker进程，确保正在进行的异步任务完成后再关闭。
3. **停止Gunicorn应用服务**：停止Django应用的Gunicorn进程，切断应用层服务。
4. **停止定时任务**：通过`crontab -e`或系统服务管理工具停止所有与bk-monitor相关的定时任务。
5. **确认服务状态**：使用`ps`、`netstat`等命令确认所有相关进程均已停止。

### 时间窗口管理
- **选择低峰期**：建议在业务低峰期（如凌晨00:00-04:00）进行升级操作。
- **提前通知**：至少提前24小时通知相关业务方和用户系统维护计划。
- **预留缓冲时间**：为升级过程预留充足时间，建议首次升级预留4-6小时，包含回滚时间。
- **监控系统状态**：在整个维护期间持续监控系统资源使用情况和日志输出。

**Section sources**
- [manage.py](file://bklog/manage.py)
- [settings.py](file://bklog/settings.py)

## 代码部署步骤

### Git分支切换
1. 进入项目根目录：`cd `
2. 拉取最新代码：`git pull origin master`
3. 切换到发布分支：`git checkout release/v4.6.3`
4. 验证代码版本：`git log -1` 确认当前提交符合发布要求

### 依赖安装
1. 安装Python依赖包：
```bash
pip install -r bklog/requirements.txt
pip install -r bklog/requirements_dev.txt
```
2. 安装开发环境依赖（如需要）：
```bash
pip install -r bklog/requirements_env.txt
```
3. 安装预提交钩子：
```bash
pre-commit install
pre-commit install --hook-type commit-msg
```

### 静态文件收集
1. 执行静态文件收集命令：
```bash
python bklog/manage.py collectstatic --noinput
```
2. 验证静态文件目录：
- 确认`static/`目录下已生成必要的JS、CSS文件
- 检查版本号是否正确更新

**Section sources**
- [requirements.txt](file://bklog/requirements.txt)
- [env.sh](file://bklog/scripts/env.sh)
- [env.bat](file://bklog/scripts/env.bat)

## 数据库迁移执行方法

数据库迁移是版本升级中最关键的环节之一，必须确保迁移脚本按正确顺序执行。

### 自定义管理命令
系统提供了多个自定义管理命令用于数据库迁移，位于`management/commands`目录下：

- `iam_upgrade_action_v2.py`：用于升级IAM权限模型
- `migrate_tool.py`：用于迁移采集配置和索引集
- 其他模块的迁移命令分布在各自应用的`management/commands`目录中

### 迁移执行流程
1. **备份数据库**：在执行任何迁移前，必须对MySQL和Redis进行完整备份。
2. **执行基础迁移**：
```bash
python bklog/manage.py migrate
```
3. **执行自定义迁移命令**：
```bash
# 执行IAM权限升级
python bklog/manage.py iam_upgrade_action_v2

# 执行配置迁移工具
python bklog/manage.py migrate_tool --bk_biz_id=2 --collector_config_data=config.json
```
4. **验证迁移结果**：
- 检查Django迁移记录表`django_migrations`
- 验证关键数据表结构是否正确更新
- 测试核心功能是否正常

### 迁移顺序原则
1. 先执行Django标准迁移
2. 再执行自定义数据迁移
3. 最后执行权限和配置相关的迁移
4. 每个步骤完成后进行验证再进行下一步

**Section sources**
- [manage.py](file://bklog/manage.py)
- [iam_upgrade_action_v2.py](file://bklog/apps/iam/management/commands/iam_upgrade_action_v2.py)
- [migrate_tool.py](file://bklog/home_application/management/commands/migrate_tool.py)

## 配置文件更新注意事项

### 配置文件结构
项目配置文件位于`bklog/config/`目录下，采用分层设计：
- `default.py`：默认配置
- `dev.py`：开发环境配置
- `stag.py`：预发布环境配置
- `prod.py`：生产环境配置

### 配置更新步骤
1. **备份原配置**：在修改前备份当前的配置文件
2. **对比配置差异**：
```bash
diff config/prod.py config/prod.py.bak
```
3. **更新关键配置项**：
- 数据库连接信息
- Redis配置
- Elasticsearch集群配置
- 蓝鲸平台接入参数

### 环境变量设置
使用`env.sh`脚本设置环境变量：
```bash
# 设置运行版本
./scripts/env.sh open

# 或者设置为ieod版本
./scripts/env.sh ieod
```

### 配置示例
```python
# 生产环境配置示例 (prod.py)
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'bk_monitor',
        'USER': 'bk_monitor',
        'PASSWORD': 'your_password',
        'HOST': '127.0.0.1',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
            'sql_mode': 'STRICT_TRANS_TABLES',
        },
    }
}

# Redis配置
REDIS = {
    'host': '127.0.0.1',
    'port': 6379,
    'password': '',
    'db': 0,
}
```

**Section sources**
- [default.py](file://bklog/config/default.py)
- [prod.py](file://bklog/config/prod.py)
- [dev.py](file://bklog/config/dev.py)
- [env.sh](file://bklog/scripts/env.sh)

## 蓝鲸平台特有升级步骤

### 蓝鲸环境适配
1. **运行版本设置**：通过`change_run_ver.py`脚本设置正确的运行版本
```bash
python ./scripts/change_run_ver.py -V open
```
2. **环境变量配置**：确保`BKPAAS_ENGINE_REGION`和`BK_PAAS_HOST`等环境变量正确设置

### IAM权限同步
1. **执行权限迁移**：使用专门的管理命令同步IAM权限
```bash
python bklog/manage.py iam_upgrade_action_v2
```
2. **验证权限配置**：检查`apps/iam/handlers/actions.py`中的权限定义是否正确加载

### API网关更新
1. **更新API定义**：根据`support-files/apigw/`目录下的YAML文件更新API网关配置
2. **重新发布API**：在蓝鲸API网关控制台重新发布相关API

### 服务注册与发现
1. **Consul配置更新**：如果使用Consul，确保服务注册信息正确
2. **健康检查验证**：确认新版本服务的健康检查接口正常工作

**Section sources**
- [env.sh](file://bklog/scripts/env.sh)
- [change_run_ver.py](file://bklog/scripts/change_run_ver.py)
- [actions.py](file://bklog/apps/iam/handlers/actions.py)

## 常见问题与解决方案

### 依赖安装失败
**问题**：`pip install`过程中出现依赖冲突或安装失败  
**解决方案**：
1. 清理pip缓存：`pip cache purge`
2. 使用虚拟环境隔离：`python -m venv venv && source venv/bin/activate`
3. 分步安装依赖：先安装基础依赖，再安装特定环境依赖

### 数据库迁移错误
**问题**：`migrate`命令执行失败，出现表已存在或字段冲突  
**解决方案**：
1. 检查迁移历史：`python manage.py showmigrations`
2. 手动修复迁移状态：`python manage.py migrate --fake`
3. 备份数据后重新初始化：仅在测试环境使用

### 配置不生效
**问题**：修改配置文件后，系统未应用新配置  
**解决方案**：
1. 确认配置文件路径正确
2. 检查环境变量是否覆盖了配置文件设置
3. 重启所有相关服务使配置生效

### 静态文件404
**问题**：前端页面无法加载JS/CSS文件  
**解决方案**：
1. 重新执行`collectstatic`命令
2. 检查Nginx配置中静态文件路径是否正确
3. 验证文件权限是否可读

### 性能下降
**问题**：升级后系统响应变慢  
**解决方案**：
1. 检查Redis连接池配置
2. 验证数据库索引是否完整
3. 监控Celery任务队列积压情况

**Section sources**
- [requirements.txt](file://bklog/requirements.txt)
- [settings.py](file://bklog/settings.py)
- [manage.py](file://bklog/manage.py)

## 结论
本文档提供了蓝鲸监控平台版本升级的完整执行步骤，涵盖了从停机维护到最终验证的全过程。通过遵循这些标准化的流程，可以最大限度地降低升级风险，确保系统的稳定性和数据的完整性。建议在正式升级前在测试环境进行完整的演练，并制定详细的回滚计划以应对可能出现的意外情况。