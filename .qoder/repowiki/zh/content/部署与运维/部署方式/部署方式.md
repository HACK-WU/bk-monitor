# 部署方式

<cite>
**本文档引用文件**  
- [Dockerfile](file://bklog/Dockerfile)
- [supervisord.conf](file://bklog/support-files/supervisord.conf)
- [app.yml](file://bklog/app.yml)
- [dev.env.yml](file://bklog/dev.env.yml)
- [stag.env.yml](file://bklog/stag.env.yml)
- [prod.env.yml](file://bklog/prod.env.yml)
- [uwsgi.ini](file://bklog/support-files/uwsgi.ini)
- [default.py](file://bklog/config/default.py)
- [env.py](file://bklog/config/env.py)
- [settings.py](file://bklog/settings.py)
- [bcs.py](file://bklog/apps/utils/bcs.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [Docker 部署](#docker-部署)
4. [Kubernetes 部署](#kubernetes-部署)
5. [传统部署](#传统-部署)
6. [环境变量与配置管理](#环境变量与配置管理)
7. [部署方式对比与迁移指南](#部署方式对比与迁移指南)
8. [安全与敏感信息管理](#安全与敏感信息管理)
9. [结论](#结论)

## 简介
本文档详细介绍了蓝鲸日志平台（BK-LOG）的三种主要部署方式：Docker 部署、Kubernetes 部署和传统部署。文档涵盖每种部署方式的具体配置、实现细节、优缺点分析以及适用场景，并提供环境变量管理、敏感信息处理和迁移建议，帮助用户根据实际需求选择最合适的部署方案。

## 项目结构
蓝鲸日志平台的项目结构清晰，主要部署相关文件位于 `bklog` 目录下。关键部署配置文件包括：
- `Dockerfile`：用于构建应用镜像
- `support-files/` 目录：包含 `supervisord.conf`、`uwsgi.ini` 等传统部署配置
- `*.env.yml` 文件：定义不同环境（dev, stag, prod）的配置
- `config/` 目录：包含运行时配置逻辑

**Section sources**
- [Dockerfile](file://bklog/Dockerfile)
- [supervisord.conf](file://bklog/support-files/supervisord.conf)
- [app.yml](file://bklog/app.yml)

## Docker 部署

### Dockerfile 详解
项目的 `Dockerfile` 采用多阶段构建策略，确保镜像的轻量化和安全性。

1.  **基础镜像**：使用 `tencentos/tencentos4-minimal:4.4-v20250922` 作为基础镜像，通过 `ARG` 指令定义，便于替换。
2.  **依赖安装**：在构建阶段安装 `dnf`、`gcc`、`python3-devel` 等编译工具，用于后续 Python 包的编译。
3.  **代码与依赖**：将项目代码复制到 `/app/code`，使用 `uv` 工具创建虚拟环境并安装 `requirements.txt` 中的依赖，指定腾讯镜像源以加速下载。
4.  **环境变量**：设置 `C_FORCE_ROOT=1` 和虚拟环境相关路径，确保应用在容器内正确运行。
5.  **默认命令**：`CMD` 指令设置为 `python manage.py migrate`，在容器启动时自动执行数据库迁移。

该 `Dockerfile` 设计简洁高效，利用了现代 Python 包管理工具 `uv`，显著提升了构建速度。

### 镜像构建步骤
1.  **准备环境**：确保已安装 Docker。
2.  **构建镜像**：
    ```bash
    docker build -t bklog:latest .
    ```
3.  **验证镜像**：
    ```bash
    docker images | grep bklog
    ```

### 容器运行参数配置
运行容器时，可通过 `-e` 参数传入环境变量，通过 `-v` 挂载日志和配置目录。
```bash
docker run -d \
  --name bklog \
  -p 8000:8000 \
  -e BK_ENV=prod \
  -v /host/logs:/app/logs \
  -v /host/config:/app/conf \
  bklog:latest
```

**Section sources**
- [Dockerfile](file://bklog/Dockerfile)

## Kubernetes 部署

### Kubernetes 集成支持
项目代码中明确包含了对 Kubernetes 部署模式的支持。通过 `settings.IS_K8S_DEPLOY_MODE` 配置项来判断当前是否为 K8s 部署环境。

```python
# apps/utils/bcs.py
def k8s_config(self):
    bcs_apigateway_host = settings.BCS_APIGATEWAY_HOST if settings.IS_K8S_DEPLOY_MODE else BCS_APIGATEWAY_ROOT
```

此代码片段表明，应用会根据部署模式动态选择 API 网关地址，体现了对 K8s 环境的原生支持。

### Helm Chart 配置说明
虽然项目中未直接提供 Helm Chart，但其配置结构非常适合封装为 Helm Chart。一个典型的 `values.yaml` 应包含以下部分：

```yaml
# 示例 values.yaml
replicaCount: 3
image:
  repository: your-registry/bklog
  tag: latest
  pullPolicy: IfNotPresent

env:
  BK_ENV: prod
  IS_K8S_DEPLOY_MODE: "True"

resources:
  requests:
    memory: "4096Mi"
    cpu: "2000m"
  limits:
    memory: "8192Mi"
    cpu: "4000m"

service:
  type: ClusterIP
  port: 8000

ingress:
  enabled: true
  hosts:
    - bklog.example.com
```

### Deployment 和 Service 资源配置
基于项目配置，可定义以下核心资源。

#### Deployment 配置
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bklog-deployment
spec:
  replicas: 3
  selector:
    matchLabels:
      app: bklog
  template:
    metadata:
      labels:
        app: bklog
    spec:
      containers:
      - name: bklog
        image: your-registry/bklog:latest
        ports:
        - containerPort: 8000
        env:
        - name: BK_ENV
          value: "prod"
        - name: IS_K8S_DEPLOY_MODE
          value: "True"
        resources:
          requests:
            memory: "4096Mi"
            cpu: "2000m"
          limits:
            memory: "8192Mi"
            cpu: "4000m"
        volumeMounts:
        - name: log-volume
          mountPath: /app/logs
      volumes:
      - name: log-volume
        emptyDir: {}
```

#### Service 配置
```yaml
apiVersion: v1
kind: Service
metadata:
  name: bklog-service
spec:
  selector:
    app: bklog
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8000
  type: ClusterIP
```

**Section sources**
- [bcs.py](file://bklog/apps/utils/bcs.py)
- [env.py](file://bklog/config/env.py)

## 传统部署

### 基于 supervisord 的进程管理
项目提供了完整的 `supervisord.conf` 配置文件，用于管理多个后台进程。

#### 配置详解
- **主进程 (uwsgi)**：运行 Web 服务，监听 `{{.app_container_path}}conf/{{.app_code}}.ini` 配置。
- **Celery Worker**：配置了多个队列（`default`, `async_export`, `pipeline`, `service_schedule` 等），分别处理不同类型的任务，确保任务隔离和资源合理分配。
- **自动重启**：所有进程均配置 `autorestart = true`，保证服务的高可用性。
- **环境变量**：通过 `environment = {{.environment}}` 统一注入环境变量。

此配置展示了复杂应用的进程管理最佳实践，将 Web 服务与异步任务解耦。

### Nginx 反向代理设置
虽然项目中未直接提供 Nginx 配置，但结合 `uwsgi.ini` 文件，可以推断出标准的 Nginx 反向代理配置。

#### uwsgi.ini 配置
```ini
[uwsgi]
socket = 127.0.0.1:8000
master = true
processes = 4
module = wsgi:application
```

#### Nginx 配置示例
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        include uwsgi_params;
        uwsgi_pass 127.0.0.1:8000;
    }

    location /static/ {
        alias /path/to/static/files/;
    }

    location /media/ {
        alias /path/to/media/files/;
    }
}
```
此配置将 Nginx 作为前端服务器，处理静态文件请求，并将动态请求转发给后端的 uWSGI 服务。

**Section sources**
- [supervisord.conf](file://bklog/support-files/supervisord.conf)
- [uwsgi.ini](file://bklog/support-files/uwsgi.ini)

## 环境变量与配置管理

### 配置文件结构
项目采用分层配置管理：
- `config/default.py`：定义所有默认配置项。
- `*.env.yml`：按环境（dev, stag, prod）覆盖默认配置，支持变量注入（如 `{env.BK_PAAS_HOST}`）。
- `settings.py`：运行时动态加载对应环境的配置。

### 环境变量配置说明
关键环境变量包括：
- `BK_ENV`：指定运行环境（dev, stag, prod），决定加载哪个 `.env.yml` 文件。
- `IS_K8S_DEPLOY_MODE`：标识是否在 Kubernetes 环境中运行。
- `BKAPP_USE_NEW_MONITOR_APIGATEWAY`：控制是否使用新的监控网关地址。
- `BKAPP_ENABLE_SHARED_FS`：在 `app.yml` 中定义，启用共享文件系统。

**Section sources**
- [default.py](file://bklog/config/default.py)
- [env.py](file://bklog/config/env.py)
- [settings.py](file://bklog/settings.py)
- [app.yml](file://bklog/app.yml)

## 部署方式对比与迁移指南

### 优缺点对比

| 部署方式 | 优点 | 缺点 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **Docker** | 环境隔离、部署简单、可移植性强 | 单机资源管理弱、缺乏编排能力 | 开发测试、单机部署、CI/CD |
| **Kubernetes** | 高可用、弹性伸缩、服务发现、强大的编排能力 | 学习曲线陡峭、运维复杂、资源开销大 | 生产环境、大规模集群、微服务架构 |
| **传统部署** | 技术成熟、直接控制、性能损耗小 | 部署繁琐、环境一致性差、扩展性差 | 遗留系统、对性能要求极高的场景 |

### 迁移指南
1.  **从传统部署迁移到 Docker**：将 `supervisord.conf` 和 `uwsgi.ini` 打包进 Docker 镜像，使用 Docker Compose 管理多容器。
2.  **从 Docker 迁移到 Kubernetes**：将 Docker 镜像推送到镜像仓库，编写对应的 Deployment、Service 和 Ingress 资源清单，并利用 ConfigMap 管理 `*.env.yml` 配置。
3.  **关键步骤**：确保 `IS_K8S_DEPLOY_MODE` 环境变量正确设置，以便应用能正确识别部署环境并调整行为。

## 安全与敏感信息管理

### 敏感信息管理建议
1.  **环境变量**：将数据库密码、API 密钥等敏感信息通过环境变量注入，避免硬编码。
2.  **Kubernetes Secrets**：在 K8s 环境中，使用 `Secret` 对象存储敏感信息，并在 Pod 中以环境变量或卷的形式挂载。
3.  **配置文件**：`*.env.yml` 文件不应提交到版本控制系统，应通过安全渠道分发。
4.  **最小权限原则**：为应用分配最小必要的权限，例如数据库连接用户应仅具备所需表的读写权限。

## 结论
蓝鲸日志平台提供了灵活多样的部署选项。对于生产环境，推荐使用 Kubernetes 部署以获得最佳的稳定性和可扩展性。Docker 部署是开发和测试的理想选择。传统部署方式虽然复杂，但在特定场景下仍有其价值。通过合理的环境变量和配置管理，可以实现不同部署方式间的平滑迁移。始终遵循安全最佳实践，妥善管理敏感信息，是保障系统安全运行的关键。