# 生产环境配置

<cite>
**本文档引用的文件**  
- [prod.py](file://bklog/config/prod.py)
- [default.py](file://bklog/config/default.py)
- [log.py](file://bklog/config/log.py)
- [uwsgi.ini](file://bklog/support-files/uwsgi.ini)
- [gunicorn_config.py](file://bklog/gunicorn_config.py)
- [sentinel.py](file://bklog/apps/utils/sentinel.py)
- [mysql.py](file://bklog/home_application/utils/mysql.py)
</cite>

## 目录
1. [引言](#引言)
2. [数据库连接池配置](#数据库连接池配置)
3. [Redis缓存策略](#redis缓存策略)
4. [Elasticsearch连接参数优化](#elasticsearch连接参数优化)
5. [日志级别设置与轮转策略](#日志级别设置与轮转策略)
6. [性能监控配置](#性能监控配置)
7. [安全配置建议](#安全配置建议)
8. [高可用架构配置](#高可用架构配置)
9. [资源配置建议与性能调优](#资源配置建议与性能调优)
10. [结论](#结论)

## 引言
本文档旨在为蓝鲸日志平台（BK-LOG）提供全面的生产环境配置指南。文档涵盖了数据库连接池、Redis缓存、Elasticsearch连接等核心组件的优化配置，详细说明了日志管理、性能监控、安全防护和高可用架构的最佳实践。通过遵循本文档的建议，可以确保系统在生产环境中稳定、高效、安全地运行。

## 数据库连接池配置
生产环境中的数据库连接池配置对于系统性能和稳定性至关重要。系统通过环境变量从外部注入数据库连接信息，确保了配置的灵活性和安全性。

数据库连接配置主要在 `prod.py` 文件中定义，当部署模式为Kubernetes时，系统会动态加载数据库连接参数。配置包括数据库名称、用户名、密码、主机地址和端口，这些信息均通过环境变量获取，避免了敏感信息的硬编码。

```python
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.mysql",
        "NAME": os.environ.get("DB_NAME"),
        "USER": os.environ.get("DB_USERNAME"),
        "PASSWORD": os.environ.get("DB_PASSWORD"),
        "HOST": os.environ.get("DB_HOST"),
        "PORT": os.environ.get("DB_PORT"),
    },
}
```

此外，系统通过 `home_application/utils/mysql.py` 文件中的 `MySQLClient` 类管理数据库连接，实现了连接的单例模式，确保了连接的高效复用和资源的合理管理。

**Section sources**
- [prod.py](file://bklog/config/prod.py#L107-L116)
- [mysql.py](file://bklog/home_application/utils/mysql.py#L33-L57)

## Redis缓存策略
Redis作为系统的核心缓存组件，其配置直接影响到系统的响应速度和负载能力。系统支持Redis Sentinel高可用模式，确保了缓存服务的稳定性和可靠性。

在 `default.py` 文件中，系统定义了多个缓存后端，包括Redis、数据库、虚拟缓存和本地内存缓存。默认情况下，系统使用Redis作为主要缓存后端，通过 `USE_REDIS` 标志位进行控制。

```python
CACHES = {
    "redis": {
        "BACKEND": "django_prometheus.cache.backends.redis.RedisCache",
        "LOCATION": f"redis://{REDIS_HOST}:{REDIS_PORT}/0",
        "OPTIONS": {"CLIENT_CLASS": "django_redis.client.DefaultClient", "PASSWORD": REDIS_PASSWD},
        "KEY_PREFIX": APP_CODE,
        "VERSION": REDIS_VERSION,
    },
    # ... 其他缓存配置
}
```

为了实现高可用，系统在 `sentinel.py` 文件中实现了 `SentinelConnectionFactory` 和 `SentinelClient` 类，用于创建和管理Redis Sentinel连接。这些类确保了客户端能够自动发现主从节点，并在故障发生时进行无缝切换。

```python
class SentinelConnectionFactory(ConnectionFactory):
    def __init__(self, options):
        sentinels = options.get("SENTINELS")
        if not sentinels:
            raise ImproperlyConfigured("SENTINELS must be provided as a list of (host, port).")
        # ... 初始化Sentinel连接
```

**Section sources**
- [default.py](file://bklog/config/default.py#L1181-L1202)
- [sentinel.py](file://bklog/apps/utils/sentinel.py#L31-L106)

## Elasticsearch连接参数优化
Elasticsearch是日志存储和查询的核心组件，其连接参数的优化对于查询性能和系统稳定性至关重要。系统通过 `log_esquery` 模块管理与Elasticsearch集群的连接。

在 `es_client.py` 文件中，`get_es_client` 函数根据Elasticsearch的版本动态加载相应的客户端库（Elasticsearch 5.x、6.x或7.x+），并创建连接实例。连接参数包括主机地址、端口、用户名、密码、协议和超时设置。

```python
def get_es_client(
    *,
    version: str,
    hosts: list,
    username: str,
    password: str,
    port: int,
    sniffer_timeout=600,
    verify_certs=False,
    **kwargs,
) -> Elasticsearch:
    # 根据版本加载客户端
    if version.startswith("5."):
        es_client = Elasticsearch5
    elif version.startswith("6."):
        es_client = Elasticsearch6
    else:
        es_client = Elasticsearch
    # ... 创建并返回客户端实例
```

在 `QueryClientEs.py` 和 `QueryClientLog.py` 文件中，系统通过 `_get_connection` 方法建立与Elasticsearch的连接，并设置了600秒的嗅探器超时时间，以适应集群拓扑的变化。同时，系统禁用了证书验证（`verify_certs=False`），以减少连接开销，但在生产环境中建议启用证书验证以增强安全性。

**Section sources**
- [es_client.py](file://bklog/apps/log_esquery/utils/es_client.py#L40-L57)
- [QueryClientEs.py](file://bklog/apps/log_esquery/esquery/client/QueryClientEs.py#L147-L158)
- [QueryClientLog.py](file://bklog/apps/log_esquery/esquery/client/QueryClientLog.py#L193-L205)

## 日志级别设置与轮转策略
合理的日志级别设置和轮转策略对于系统运维和故障排查至关重要。系统在 `prod.py` 文件中定义了生产环境的日志级别，默认为 `ERROR`，可以通过环境变量 `LOG_LEVEL` 进行调整。

```python
LOG_LEVEL = os.environ.get("LOG_LEVEL", "ERROR")
```

日志的详细配置在 `log.py` 文件中通过 `get_logging_config_dict` 函数定义。系统使用 `RotatingFileHandler` 处理器，将日志文件按大小进行轮转，每个日志文件最大为10MB，保留5个备份文件。

```python
logging_config = {
    "version": 1,
    "handlers": {
        "root": {
            "class": log_class,
            "formatter": "verbose",
            "filename": os.path.join(log_dir, "%s-django.log" % log_name_prefix),
            "maxBytes": 1024 * 1024 * 10,  # 10MB
            "backupCount": 5,
        },
        # ... 其他处理器
    },
    # ... 其他配置
}
```

此外，系统还支持将日志以JSON格式输出，并可选地通过UDP或OTLP协议上报到集中式日志收集系统，便于日志的集中分析和监控。

**Section sources**
- [prod.py](file://bklog/config/prod.py#L42)
- [log.py](file://bklog/config/log.py#L21-L157)

## 性能监控配置
系统集成了多种性能监控机制，包括Prometheus指标暴露、Celery任务监控和Gunicorn性能监控。

在 `default.py` 文件中，系统通过 `django_prometheus` 库将Django和Redis的性能指标暴露给Prometheus。同时，Celery的并发数可以通过环境变量 `BK_CELERYD_CONCURRENCY` 进行配置，以适应不同负载场景。

```python
CELERYD_CONCURRENCY = os.getenv("BK_CELERYD_CONCURRENCY", 2)
```

在 `gunicorn_config.py` 文件中，系统配置了Gunicorn的Worker数量为8，并设置了65秒的请求超时时间。这些参数可以根据实际的CPU核心数和业务需求进行调整。

```python
workers = 8
timeout = 65
```

**Section sources**
- [default.py](file://bklog/config/default.py#L206)
- [gunicorn_config.py](file://bklog/gunicorn_config.py#L42)

## 安全配置建议
### HTTPS设置
系统通过 `HttpsMiddleware` 中间件强制HTTP请求重定向到HTTPS。当请求不安全（非HTTPS）且 `DEFAULT_HTTPS_HOST` 配置了HTTPS主机地址时，中间件会返回302重定向响应。

```python
class HttpsMiddleware(MiddlewareMixin):
    def process_request(self, request):
        if not request.is_secure() and settings.DEFAULT_HTTPS_HOST:
            return HttpResponseIndexRedirect(request.path)
```

### API网关认证
系统使用JWT（JSON Web Token）进行API网关认证。`ApiGatewayJWTMiddleware` 中间件负责解析请求头中的 `X-Bkapi-JWT`，并验证其有效性。系统支持内部和外部API网关，通过不同的公钥进行验证。

```python
class ApiGatewayJWTMiddleware(ApiGatewayJWTGenericMiddleware):
    def __call__(self, request):
        is_external = request.headers.get("Is-External", "false")
        if is_external == "true":
            self.provider.public_key_provider = SettingsExternalPublicKeyProvider()
        return super().__call__(request)
```

### 跨域防护
系统通过 `CheckXssMiddleware` 中间件提供XSS（跨站脚本）防护。同时，CSRF（跨站请求伪造）保护通过 `CsrfViewMiddleware` 实现，CSRF令牌的Cookie名称被设置为 `bklog_csrftoken`。

```python
MIDDLEWARE = (
    # ... 其他中间件
    "django.middleware.csrf.CsrfViewMiddleware",
    "blueapps.middleware.xss.middlewares.CheckXssMiddleware",
    # ... 其他中间件
)
CSRF_COOKIE_NAME = "bklog_csrftoken"
```

**Section sources**
- [middlewares.py](file://bklog/apps/middlewares.py#L205-L211)
- [apigw.py](file://bklog/apps/middleware/apigw.py#L123-L124)
- [default.py](file://bklog/config/default.py#L124)

## 高可用架构配置
### 负载均衡
系统通过Gunicorn和uWSGI等WSGI服务器的多Worker模式实现应用层的负载均衡。在 `gunicorn_config.py` 中配置了8个Worker，在 `uwsgi.ini` 中配置了16个Worker，充分利用多核CPU的处理能力。

```ini
# uwsgi.ini
workers = 16
```

### 故障转移
系统的故障转移主要通过以下机制实现：
1.  **数据库**：依赖底层MySQL集群的主从复制和故障转移机制。
2.  **Redis**：通过Redis Sentinel实现主从切换。
3.  **Elasticsearch**：利用Elasticsearch集群自身的分布式和高可用特性。
4.  **服务注册与发现**：在 `gunicorn_config.py` 中，系统通过 `when_ready` 和 `on_exit` 回调函数，将Gunicorn实例注册到Consul服务注册中心，并设置TCP健康检查。当实例启动时注册，退出时注销，确保负载均衡器能及时感知服务状态。

```python
def when_ready(server):
    check = consul.Check.tcp(_ip, _port, "10s")
    client = BKConsul()
    client.agent.service.register(module_name, node_name, address=_ip, port=_port, check=check, tags=[submodule_name])
```

### 数据备份策略
系统本身不直接管理底层存储（MySQL、Elasticsearch）的备份，但提供了日志归档功能。通过 `log_databus/tasks/archive.py` 中的定时任务 `clean_expired_restore_index_set`，系统可以清理过期的归档恢复配置，间接管理归档数据的生命周期。

**Section sources**
- [gunicorn_config.py](file://bklog/gunicorn_config.py#L76-L81)
- [archive.py](file://bklog/apps/log_databus/tasks/archive.py#L32-L47)

## 资源配置建议与性能调优
### 不同规模部署的资源配置建议
-   **小型部署**（日均日志量 < 1TB）：
    -   应用服务器：2-4核CPU，8GB内存，2个Gunicorn Worker。
    -   数据库：4核CPU，16GB内存，SSD存储。
    -   Redis：2核CPU，4GB内存。
    -   Elasticsearch：3个节点，每个节点4核CPU，16GB内存，SSD存储。
-   **中型部署**（日均日志量 1TB - 10TB）：
    -   应用服务器：4-8核CPU，16GB内存，4-8个Gunicorn Worker。
    -   数据库：8核CPU，32GB内存，高性能SSD存储。
    -   Redis：4核CPU，8GB内存。
    -   Elasticsearch：5-7个节点，每个节点8核CPU，32GB内存，高性能SSD存储。
-   **大型部署**（日均日志量 > 10TB）：
    -   应用服务器：8核以上CPU，32GB以上内存，8-16个Gunicorn Worker。
    -   数据库：16核以上CPU，64GB以上内存，专用数据库服务器。
    -   Redis：8核以上CPU，16GB以上内存，Redis集群。
    -   Elasticsearch：10个以上节点，采用热温架构，高性能SSD存储。

### 性能调优参数
-   **Gunicorn**：
    -   `workers`：建议设置为 `(2 * CPU核心数) + 1`。
    -   `timeout`：根据最长查询时间设置，避免误杀长查询。
    -   `max_requests`：设置为1000-2000，防止Worker内存泄漏。
-   **uWSGI**：
    -   `cheaper`：动态调整Worker数量，初始值设为4。
    -   `buffer-size`：适当增大以处理大请求。
-   **数据库**：
    -   优化 `innodb_buffer_pool_size`，建议设置为物理内存的70-80%。
    -   合理设置连接池大小，避免连接过多导致数据库压力。
-   **Elasticsearch**：
    -   合理规划分片（Shard）数量，避免单个分片过大或过小。
    -   配置合适的刷新间隔（refresh_interval）以平衡写入性能和搜索延迟。

**Section sources**
- [gunicorn_config.py](file://bklog/gunicorn_config.py#L42)
- [uwsgi.ini](file://bklog/support-files/uwsgi.ini#L19-L28)

## 结论
本文档详细阐述了蓝鲸日志平台在生产环境下的各项关键配置。通过合理配置数据库连接池、Redis缓存、Elasticsearch连接，优化日志策略，实施严格的安全措施，并构建高可用架构，可以确保系统在高负载下稳定运行。建议根据实际的业务规模和性能需求，参考本文档的资源配置建议进行部署和调优，以达到最佳的性能和可靠性。