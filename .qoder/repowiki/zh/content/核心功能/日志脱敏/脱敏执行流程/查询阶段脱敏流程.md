# 查询阶段脱敏流程

<cite>
**本文档引用文件**  
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py)
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py)
- [models.py](file://bklog/apps/log_desensitize/models.py)
- [constants.py](file://bklog/apps/log_desensitize/constants.py)
- [utils.py](file://bklog/apps/log_desensitize/utils.py)
- [search_handlers_esquery.py](file://bklog/apps/log_search/handlers/search/search_handlers_esquery.py)
- [async_export.py](file://bklog/apps/log_search/tasks/async_export.py)
- [unify_query_async_export.py](file://bklog/apps/log_search/tasks/unify_query_async_export.py)
- [desensitize_rule_views.py](file://bklog/apps/log_desensitize/views/desensitize_rule_views.py)
</cite>

## 目录
1. [引言](#引言)
2. [查询阶段脱敏机制](#查询阶段脱敏机制)
3. [脱敏处理流程](#脱敏处理流程)
4. [脱敏策略与权限控制](#脱敏策略与权限控制)
5. [高亮显示与脱敏协同](#高亮显示与脱敏协同)
6. [大规模查询处理](#大规模查询处理)
7. [缓存与性能优化](#缓存与性能优化)
8. [实际应用示例](#实际应用示例)
9. [结论](#结论)

## 引言
查询阶段脱敏是在用户查询日志数据时动态执行的敏感信息保护机制。该机制在获取原始数据后、返回用户前进行实时脱敏处理，确保敏感信息不会被未授权用户访问。本文档详细介绍了查询阶段脱敏的实现原理、处理流程、权限控制策略以及性能优化方案。

## 查询阶段脱敏机制

查询阶段脱敏机制通过在搜索服务中集成DesensitizeHandler，在获取原始数据后、返回用户前进行实时脱敏处理。该机制具有高度灵活性，可根据用户权限动态调整脱敏策略。

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 搜索服务 as "搜索服务"
participant 脱敏处理器 as "DesensitizeHandler"
participant 原始数据 as "原始数据"
participant 脱敏数据 as "脱敏数据"
用户->>搜索服务 : 发起查询请求
搜索服务->>原始数据 : 获取原始日志数据
原始数据-->>搜索服务 : 返回原始数据
搜索服务->>脱敏处理器 : 调用脱敏处理
脱敏处理器->>脱敏处理器 : 应用脱敏规则
脱敏处理器-->>搜索服务 : 返回脱敏数据
搜索服务-->>用户 : 返回脱敏后的查询结果
Note over 搜索服务,脱敏处理器 : 基于用户权限和业务配置<br/>动态决定是否执行脱敏
```

**图示来源**
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L147-L177)
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L52-L117)

**本节来源**
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L147-L177)
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L52-L117)

## 脱敏处理流程

脱敏处理流程包括初始化脱敏配置、构建脱敏规则映射、执行脱敏操作等关键步骤。系统首先检查是否需要进行脱敏，然后根据索引集ID获取相应的脱敏配置，最后应用脱敏规则处理数据。

```mermaid
flowchart TD
Start([开始]) --> CheckDesensitize["检查是否需要脱敏"]
CheckDesensitize --> |是| GetConfig["获取脱敏配置"]
CheckDesensitize --> |否| ReturnOriginal["返回原始数据"]
GetConfig --> BuildMapping["构建字段规则映射"]
BuildMapping --> SortRules["按优先级排序规则"]
SortRules --> ApplyRules["应用脱敏规则"]
ApplyRules --> ProcessText["处理文本内容"]
ProcessText --> ProcessDict["处理字典结构"]
ProcessDict --> MergeResult["合并处理结果"]
MergeResult --> End([结束])
style CheckDesensitize fill:#f9f,stroke:#333
style ApplyRules fill:#ccf,stroke:#333
```

**图示来源**
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L147-L177)
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L52-L117)

**本节来源**
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L147-L177)
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L52-L117)

## 脱敏策略与权限控制

脱敏策略与权限控制机制确保只有授权用户才能查看未脱敏的敏感信息。系统通过多层次的权限检查来决定是否执行脱敏处理，包括应用白名单检查、特权用户检查等。

```mermaid
classDiagram
class DesensitizeRule {
+string rule_name
+string operator
+dict params
+string match_pattern
+string space_uid
+bool is_public
+list match_fields
+bool is_active
}
class DesensitizeConfig {
+int index_set_id
+list text_fields
}
class DesensitizeFieldConfig {
+int index_set_id
+string field_name
+int rule_id
+string match_pattern
+string operator
+dict params
+int sort_index
}
class DesensitizeHandler {
+dict field_rule_mapping
+list rules
+DesensitizeHandler(desensitize_config_info)
+transform_text(text, is_highlight)
+transform_dict(log_content)
+transform(log, rules, is_highlight)
}
DesensitizeConfig --> DesensitizeFieldConfig : "包含"
DesensitizeRule --> DesensitizeFieldConfig : "关联"
DesensitizeHandler --> DesensitizeFieldConfig : "使用"
DesensitizeHandler --> DesensitizeRule : "引用"
```

**图示来源**
- [models.py](file://bklog/apps/log_desensitize/models.py#L29-L80)
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L52-L117)

**本节来源**
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L527-L547)
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L52-L117)
- [models.py](file://bklog/apps/log_desensitize/models.py#L29-L80)

## 高亮显示与脱敏协同

高亮显示功能与脱敏处理协同工作，确保在进行文本高亮的同时正确处理脱敏逻辑。系统能够在高亮匹配内容的同时，对敏感信息进行脱敏处理，提供更好的用户体验。

```mermaid
sequenceDiagram
participant 搜索服务 as "搜索服务"
participant 脱敏处理器 as "DesensitizeHandler"
participant 高亮处理器 as "HighlightProcessor"
participant 用户界面 as "用户界面"
搜索服务->>脱敏处理器 : 请求脱敏处理(is_highlight=True)
脱敏处理器->>脱敏处理器 : 查找匹配模式
脱敏处理器->>脱敏处理器 : 应用脱敏算子
脱敏处理器->>脱敏处理器 : 添加<mark>标签
脱敏处理器-->>搜索服务 : 返回高亮脱敏结果
搜索服务->>高亮处理器 : 处理对象类型高亮
高亮处理器->>高亮处理器 : 合并打平后的高亮字段
高亮处理器-->>搜索服务 : 返回完整高亮数据
搜索服务-->>用户界面 : 显示高亮脱敏结果
Note over 脱敏处理器,高亮处理器 : 脱敏与高亮处理<br/>按流水线方式执行
```

**图示来源**
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L494-L507)
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L813-L819)

**本节来源**
- [desensitize.py](file://bklog/apps/log_desensitize/handlers/desensitize.py#L494-L507)
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L813-L819)

## 大规模查询处理

针对大规模查询结果集，系统实现了分页处理和流式脱敏策略，确保在处理大量数据时的性能和内存效率。通过分块处理和流式传输，系统能够高效处理海量日志数据的脱敏需求。

```mermaid
flowchart LR
A[查询请求] --> B{结果集大小}
B --> |小于阈值| C[单次处理]
B --> |大于阈值| D[分页处理]
D --> E[分块获取数据]
E --> F[流式脱敏处理]
F --> G[分批返回结果]
C --> H[直接脱敏处理]
H --> I[返回结果]
G --> I
I --> J[完成]
style D fill:#f96,stroke:#333
style F fill:#f96,stroke:#333
```

**图示来源**
- [async_export.py](file://bklog/apps/log_search/tasks/async_export.py#L424-L448)
- [unify_query_async_export.py](file://bklog/apps/log_search/tasks/unify_query_async_export.py#L553-L568)

**本节来源**
- [search_handlers_esquery.py](file://bklog/apps/log_search/handlers/search/search_handlers_esquery.py#L1335-L1361)
- [async_export.py](file://bklog/apps/log_search/tasks/async_export.py#L424-L448)
- [unify_query_async_export.py](file://bklog/apps/log_search/tasks/unify_query_async_export.py#L553-L568)

## 缓存与性能优化

系统通过多种缓存策略和性能优化技术来提升查询阶段脱敏的效率。包括脱敏配置缓存、查询结果缓存、并行处理等机制，有效降低了脱敏处理的性能开销。

```mermaid
graph TD
A[性能优化策略] --> B[脱敏配置缓存]
A --> C[查询结果缓存]
A --> D[并行处理]
A --> E[流式处理]
A --> F[内存优化]
B --> G["缓存DesensitizeConfig<br/>和DesensitizeFieldConfig"]
C --> H["缓存用户检索历史<br/>和字段长度信息"]
D --> I["多存储集群并行导出"]
E --> J["分块流式处理大数据集"]
F --> K["限制最大分析偏移量"]
style A fill:#0af,stroke:#333,color:#fff
style B fill:#ff6,stroke:#333
style C fill:#ff6,stroke:#333
style D fill:#ff6,stroke:#333
```

**图示来源**
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L57-L58)
- [search_handlers_esquery.py](file://bklog/apps/log_search/handlers/search/search_handlers_esquery.py#L2171-L2188)

**本节来源**
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L57-L58)
- [search_handlers_esquery.py](file://bklog/apps/log_search/handlers/search/search_handlers_esquery.py#L2171-L2188)
- [async_export.py](file://bklog/apps/log_search/tasks/async_export.py#L322-L759)

## 实际应用示例

以下示例展示了不同用户角色查询同一数据时的差异化脱敏效果。系统根据用户权限和业务配置，动态调整脱敏策略，确保数据安全的同时提供适当的访问权限。

```mermaid
erDiagram
USER||--o{DESENSITIZE_RULE: "创建"
USER||--o{DESENSITIZE_CONFIG: "配置"
BUSINESS||--o{DESENSITIZE_RULE: "拥有"
INDEX_SET||--o{DESENSITIZE_CONFIG: "关联"
DESENSITIZE_CONFIG||--o{DESENSITIZE_FIELD_CONFIG: "包含"
DESENSITIZE_RULE||--o{DESENSITIZE_FIELD_CONFIG: "引用"
USER {
string username PK
string role
string permission_level
}
BUSINESS {
int bk_biz_id PK
string business_name
}
INDEX_SET {
int index_set_id PK
string index_set_name
string scenario_id
}
DESENSITIZE_RULE {
int rule_id PK
string rule_name
string operator
json params
string match_pattern
string space_uid
bool is_public
json match_fields
bool is_active
}
DESENSITIZE_CONFIG {
int config_id PK
int index_set_id FK
json text_fields
}
DESENSITIZE_FIELD_CONFIG {
int config_id PK
int index_set_id FK
string field_name
int rule_id FK
string match_pattern
string operator
json params
int sort_index
}
```

**图示来源**
- [desensitize_rule_views.py](file://bklog/apps/log_desensitize/views/desensitize_rule_views.py#L49-L91)
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L527-L547)

**本节来源**
- [desensitize_rule_views.py](file://bklog/apps/log_desensitize/views/desensitize_rule_views.py#L49-L91)
- [base.py](file://bklog/apps/log_unifyquery/handler/base.py#L527-L547)
- [test_desensitize_handle.py](file://bklog/apps/tests/log_desensitize/test_desensitize_handle.py#L28-L61)

## 结论

查询阶段脱敏流程提供了一种灵活、安全的日志数据保护机制。通过在查询时动态执行脱敏处理，系统能够根据用户权限和业务需求精确控制敏感信息的可见性。该机制具有以下优势：

1. **灵活性高**：支持基于用户权限动态调整脱敏策略
2. **安全性强**：多层次权限检查确保数据安全
3. **性能优化**：通过缓存和流式处理降低性能开销
4. **易于管理**：集中化的脱敏规则配置和管理

未来可进一步优化的方向包括：
- 增强脱敏规则的实时更新能力
- 优化大规模数据集的流式处理性能
- 提供更细粒度的权限控制策略
- 增强脱敏效果的可视化和审计功能