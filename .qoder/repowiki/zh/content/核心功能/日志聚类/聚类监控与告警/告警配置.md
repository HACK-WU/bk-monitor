# 告警配置

<cite>
**本文档引用文件**   
- [alert_strategy.py](file://bklog/apps/log_search/handlers/alert_strategy.py)
- [alert_strategy_view.py](file://bklog/apps/log_search/views/alert_strategy_view.py)
- [monitor.py](file://bklog/apps/api/modules/monitor.py)
- [constants.py](file://bklog/apps/log_clustering/constants.py)
- [monitor.py](file://bklog/apps/log_clustering/utils/monitor.py)
- [clustering_monitor.py](file://bklog/apps/log_clustering/handlers/clustering_monitor.py)
- [cmsi.py](file://bklog/apps/api/modules/cmsi.py)
- [wework.py](file://bklog/apps/api/modules/wework.py)
- [models.py](file://bklog/apps/log_search/models.py)
- [serializers.py](file://bklog/apps/log_search/serializers.py)
</cite>

## 目录
1. [引言](#引言)
2. [告警规则配置](#告警规则配置)
3. [告警级别体系](#告警级别体系)
4. [告警通知渠道配置](#告警通知渠道配置)
5. [告警生命周期管理](#告警生命周期管理)
6. [告警配置最佳实践](#告警配置最佳实践)
7. [API接口文档](#api接口文档)

## 引言

告警配置功能是蓝鲸日志平台的核心功能之一，用于监控日志数据并及时发现异常情况。本文档详细说明了告警配置的各项功能，包括告警规则的配置方式、告警级别体系、通知渠道配置、告警生命周期管理以及API接口文档。通过本文档，用户可以全面了解如何配置和管理告警策略，以确保系统的稳定运行。

## 告警规则配置

告警规则的配置主要包括阈值设置、时间窗口和触发条件等参数的定义和使用。这些参数共同决定了告警何时被触发。

### 阈值设置

阈值设置用于定义告警触发的具体条件。例如，在日志数量突增告警中，可以通过设置阈值来检测日志数量的异常增长。具体的阈值配置包括：

- **方法（method）**：支持多种比较方法，如大于等于（gte）、小于等于（lte）等。
- **阈值（threshold）**：具体的数值阈值，当监控指标超过或低于此值时触发告警。

```python
DEFAULT_ALGORITHMS = [
    {"type": "Threshold", "level": 2, "config": [[{"method": "gte", "threshold": 1}]], "unit_prefix": ""}
]
```

### 时间窗口

时间窗口定义了告警检测的时间范围。通过设置时间窗口，可以控制告警检测的频率和持续时间。常见的配置包括：

- **检测周期（check_window）**：每次检测的时间间隔，单位为分钟。
- **聚合间隔（agg_interval）**：数据聚合的时间间隔，单位为秒。

```python
TRIGGER_CONFIG = {
    "count": 1,
    "check_window": 5,
    "uptime": {"calendars": [], "time_ranges": [{"start": "00:00", "end": "23:59"}]},
}
```

### 触发条件

触发条件定义了告警触发的具体逻辑。通过组合多个条件，可以实现复杂的告警逻辑。常见的触发条件包括：

- **表达式（expression）**：用于定义复杂的逻辑表达式。
- **连接符（connector）**：用于连接多个条件，支持“and”和“or”。

```python
DETECTS = [
    {
        "level": 2,
        "expression": "",
        "trigger_config": TRIGGER_CONFIG,
        "recovery_config": {"check_window": 5},
        "connector": "and",
    }
]
```

**Section sources**
- [constants.py](file://bklog/apps/log_clustering/constants.py#L83-L123)
- [clustering_monitor.py](file://bklog/apps/log_clustering/handlers/clustering_monitor.py#L188-L217)

## 告警级别体系

告警级别体系用于区分不同严重程度的告警，帮助用户快速识别和处理问题。当前支持的告警级别包括致命、预警和提醒。

### 告警级别定义

- **致命（CRITICAL）**：表示系统出现严重问题，需要立即处理。
- **预警（WARNING）**：表示系统存在潜在问题，需要关注。
- **提醒（REMIND）**：表示系统出现一般性问题，建议查看。

```python
class StrategiesAlarmLevelEnum(ChoicesEnum):
    CRITICAL = 1
    WARNING = 2
    REMIND = 3

    _choices_labels = (
        (CRITICAL, _lazy("致命")),
        (WARNING, _lazy("预警")),
        (REMIND, _lazy("提醒")),
    )
```

### 应用场景

- **致命**：适用于关键服务中断、数据丢失等严重影响业务的情况。
- **预警**：适用于性能下降、资源紧张等可能影响业务的情况。
- **提醒**：适用于日志异常、配置错误等一般性问题。

**Section sources**
- [constants.py](file://bklog/apps/log_clustering/constants.py#L202-L211)

## 告警通知渠道配置

告警通知渠道配置用于定义告警信息的发送方式，支持邮件、微信、短信、Webhook等多种渠道。

### 通知方式

- **邮件（mail）**：通过邮件发送告警信息。
- **微信（weixin）**：通过企业微信发送告警信息。
- **短信（sms）**：通过短信发送告警信息。
- **语音（voice）**：通过电话语音通知。
- **Webhook**：通过HTTP请求发送告警信息。

```python
def get_msg_type(self, requests):
    """
    @api {get} /meta/msg_type/ 获取通知列表
    @apiName list_meta_msg_type
    @apiGroup 01_Meta
    @apiSuccess {String} type 类型
    @apiSuccess {String} label 名称
    """
    return Response(MetaHandler.get_msg_type())
```

### 通知分级和收敛

- **通知分级**：根据告警级别选择不同的通知方式。例如，致命告警可以通过邮件和短信同时通知，而提醒告警仅通过邮件通知。
- **通知收敛**：为了避免告警风暴，可以通过设置通知间隔和收敛规则来减少重复通知。

```python
DEFAULT_ALERT_NOTICE = [
    {
        "time_range": "00:00:00--23:59:00",
        "notify_config": [
            {"notice_ways": [{"name": "rtx"}], "level": 3},
            {"notice_ways": [{"name": "rtx"}], "level": 2},
            {"notice_ways": [{"name": "rtx"}], "level": 1},
        ],
    }
]
```

**Section sources**
- [cmsi.py](file://bklog/apps/api/modules/cmsi.py#L22-L117)
- [wework.py](file://bklog/apps/api/modules/wework.py#L21-L48)
- [constants.py](file://bklog/apps/log_clustering/constants.py#L114-L123)

## 告警生命周期管理

告警生命周期管理包括告警触发、确认、恢复、关闭等状态流转，确保告警处理的完整性和可追溯性。

### 状态流转

- **触发（abnormal）**：当监控指标满足触发条件时，告警进入触发状态。
- **确认（ack）**：运维人员确认告警后，告警进入确认状态。
- **恢复（recovered）**：当监控指标恢复正常时，告警进入恢复状态。
- **关闭（closed）**：告警处理完成后，告警进入关闭状态。

```python
def get_alert_records(self, status=AlertStatusEnum.ALL.value, page=1, page_size=10):
    """
    查询告警记录
    :param status: 状态
    :param page: 页数
    :param page_size: 每页条数
    """
    # 查询告警记录的逻辑
    pass
```

### 处理流程

1. **触发**：系统检测到异常情况，生成告警。
2. **通知**：根据配置的通知方式发送告警信息。
3. **确认**：运维人员收到告警后进行确认。
4. **处理**：运维人员分析并解决问题。
5. **恢复**：系统检测到问题已解决，告警自动恢复。
6. **关闭**：运维人员确认问题已解决，关闭告警。

**Section sources**
- [alert_strategy.py](file://bklog/apps/log_search/handlers/alert_strategy.py#L25-L86)
- [alert_strategy_view.py](file://bklog/apps/log_search/views/alert_strategy_view.py#L75-L153)

## 告警配置最佳实践

### 设置合理的阈值

为了避免告警风暴，应根据历史数据和业务需求设置合理的阈值。建议定期回顾和调整阈值，以适应业务变化。

### 设计有效的通知模板

通知模板应包含足够的信息，以便运维人员快速定位问题。建议包含以下内容：

- **告警级别**：明确告警的严重程度。
- **告警时间**：记录告警触发的时间。
- **告警详情**：描述告警的具体内容和可能的原因。
- **处理建议**：提供初步的处理建议。

```python
DEFAULT_PATTERN_MONITOR_MSG = """
{{content.level}}
{{content.begin_time}}
{{content.time}}
{{content.duration}}
{{content.target_type}}
{{content.data_source}}
{{content.current_value}}
{{content.biz}}
{{content.target}}
{{content.dimension}}
{{content.detail}}

**内容:** 智能模型检测到异常, 异常类型: {{alarm.bkm_info.alert_msg}}, 近 {{ (strategy.items[0].query_configs[0]["agg_interval"] / 60) | int }} 分钟出现次数 ({{alarm.current_value | int }})
**负责人:** {{ json.loads(alarm.related_info)["owners"] or '无' }}
**备注:** {% if "remark_text" in json.loads(alarm.related_info) %}{{ json.loads(alarm.related_info)["remark_text"] }}【{{ json.loads(alarm.related_info)["remark_time"] }}】({{ json.loads(alarm.related_info)["remark_user"] }} ){% else %} 无 {% endif %}
**日志示例:** {{ json.loads(alarm.related_info)["log"] }}
[更多日志]({{ json.loads(alarm.related_info)["bklog_link"] }})
"""
```

**Section sources**
- [constants.py](file://bklog/apps/log_clustering/constants.py#L156-L177)

## API接口文档

### 查询告警记录

#### 请求方法
POST

#### 请求路径
`/alert_strategy/$index_set_id/alert_records/`

#### 请求参数
- `space_uid`：空间唯一标识
- `status`：状态
- `page`：页数
- `page_size`：每页条数

#### 返回示例
```json
{
    "result": true,
    "data": [
        {
            "id": "1741686571487423209",
            "strategy_id": 1234567,
            "alert_name": "告警能力补齐-test1",
            "first_anomaly_time": 1741685940,
            "duration": "10m",
            "status": "CLOSED",
            "severity": 2,
            "assignee": "xxx",
            "appointee": "xxx",
            "end_time": 17416865714
        }
    ],
    "code": 0,
    "message": ""
}
```

**Section sources**
- [alert_strategy_view.py](file://bklog/apps/log_search/views/alert_strategy_view.py#L43-L82)

### 查询策略记录

#### 请求方法
POST

#### 请求路径
`/alert_strategy/$index_set_id/strategy_records/`

#### 请求参数
- `space_uid`：空间唯一标识
- `page`：页数
- `page_size`：每页条数

#### 返回示例
```json
{
    "result": true,
    "data": [
        {
            "strategy_id": 156827,
            "name": "告警能力补齐-test2",
            "query_string": "*",
            "latest_time": 1741750200
        },
        {
            "strategy_id": 156728,
            "name": "告警能力补齐-test",
            "query_string": "serverIp : 11.154.220",
            "latest_time": 1741749840
        }
    ],
    "code": 0,
    "message": ""
}
```

**Section sources**
- [alert_strategy_view.py](file://bklog/apps/log_search/views/alert_strategy_view.py#L83-L117)

### 获取日志平台关联信息

#### 请求方法
GET

#### 请求路径
`/alert_strategy/$index_set_id/log_related_info/`

#### 请求参数
- `alert_id`：告警ID

#### 返回示例
```json
{
    "result": true,
    "data": {
        "query_string": "*",
        "agg_condition": [
            {
                "condition": "and",
                "method": "eq",
                "dimension_name": "云区域ID",
                "value": ["0"],
                "key": "cloudId"
            }
        ]
    },
    "code": 0,
    "message": ""
}
```

**Section sources**
- [alert_strategy_view.py](file://bklog/apps/log_search/views/alert_strategy_view.py#L119-L172)