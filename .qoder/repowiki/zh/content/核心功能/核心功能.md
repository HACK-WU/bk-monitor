# 核心功能

<cite>
**本文档引用的文件**   
- [models.py](file://bklog/apps/log_search/models.py)
- [models.py](file://bklog/apps/log_clustering/models.py)
- [models.py](file://bklog/apps/log_databus/models.py)
- [models.py](file://bklog/apps/log_desensitize/models.py)
- [models.py](file://bklog/bk_dataview/grafana/models.py)
- [constants.py](file://bklog/apps/log_search/constants.py)
- [constants.py](file://bklog/apps/log_clustering/constants.py)
- [constants.py](file://bklog/apps/log_databus/constants.py)
- [constants.py](file://bklog/apps/log_desensitize/constants.py)
</cite>

## 目录
1. [日志搜索功能](#日志搜索功能)
2. [日志采集机制](#日志采集机制)
3. [日志聚类分析功能](#日志聚类分析功能)
4. [日志脱敏处理能力](#日志脱敏处理能力)
5. [Grafana集成和可视化功能](#grafana集成和可视化功能)
6. [功能集成关系](#功能集成关系)

## 日志搜索功能

日志搜索功能是系统的核心功能之一，提供了强大的查询语法、过滤条件和聚合分析能力。系统支持多种查询模式，包括默认搜索和上下文检索。用户可以通过索引集进行日志查询，每个索引集包含一个或多个结果表（Result Table），支持对日志数据进行高效检索。

查询语法支持标准的Elasticsearch查询语言，用户可以通过关键词、字段过滤、时间范围等多种方式进行搜索。系统提供了丰富的过滤条件选项，包括包含、不包含、等于、不等于、正则匹配和正则不匹配等。用户可以通过组合多个过滤条件来精确筛选日志数据。

聚合分析功能允许用户对日志数据进行统计分析，支持按时间、字段等维度进行分组统计。系统提供了多种聚合方式，包括计数、求和、平均值等，帮助用户发现日志数据中的模式和趋势。搜索结果支持多种排序方式，用户可以根据时间戳、相关性等字段进行排序。

**Section sources**
- [models.py](file://bklog/apps/log_search/models.py#L106-L800)
- [constants.py](file://bklog/apps/log_search/constants.py#L1-L800)

## 日志采集机制

日志采集机制是系统数据来源的基础，涵盖了采集配置、数据传输和存储流程。系统通过采集配置（CollectorConfig）来定义日志采集的详细参数，包括采集场景、数据分类、采集目标等。采集场景支持行日志、段日志、Windows事件日志、自定义等多种类型。

数据传输通过节点管理（Node Management）实现，系统会创建订阅任务来部署采集器到目标主机。采集器（bkunifylogbeat）负责收集日志数据并将其发送到Transfer集群进行处理。Transfer集群负责数据的接收、解析和转发，将处理后的数据写入Elasticsearch集群进行存储。

存储流程包括数据清洗和入库两个阶段。数据清洗阶段会对原始日志进行解析，提取出结构化的字段信息。系统支持多种清洗方式，包括JSON、分隔符和正则表达式等。清洗后的数据会被写入Elasticsearch集群，按照预定义的索引模板进行存储，支持按时间进行索引分片。

**Section sources**
- [models.py](file://bklog/apps/log_databus/models.py#L101-L800)
- [constants.py](file://bklog/apps/log_databus/constants.py#L1-L745)

## 日志聚类分析功能

日志聚类分析功能通过智能算法对日志进行模式识别和分类，帮助用户发现异常日志模式。系统基于AIOPS技术，使用聚类算法将相似的日志条目归为同一类别，形成日志模式（Pattern）。每个模式都有一个唯一的指纹（Signature），用于标识和跟踪。

模式识别算法支持多种敏感度级别，用户可以根据需要调整聚类的精细程度。系统会自动学习日志的结构特征，提取关键字段进行聚类分析。对于新出现的日志模式，系统会标记为"新类"，并可以配置告警策略来通知相关人员。

应用场景包括异常检测、故障诊断和日志分析优化。通过聚类分析，用户可以快速识别系统中的异常行为，如错误日志的突然增加、新的错误模式出现等。系统还支持对聚类结果进行备注和标记，方便团队协作和知识积累。

**Section sources**
- [models.py](file://bklog/apps/log_clustering/models.py#L1-L337)
- [constants.py](file://bklog/apps/log_clustering/constants.py#L1-L326)

## 日志脱敏处理能力

日志脱敏处理能力用于保护敏感信息，防止日志数据中的隐私信息泄露。系统提供了灵活的脱敏规则配置，支持掩码屏蔽和文本替换两种脱敏算子。用户可以定义脱敏规则，指定需要脱敏的字段和匹配模式。

脱敏规则可以应用于特定的索引集，系统会在数据写入Elasticsearch之前执行脱敏处理。对于包含敏感信息的日志字段，如身份证号、手机号、邮箱地址等，系统会根据配置的规则进行脱敏处理。掩码屏蔽可以将部分字符替换为星号，而文本替换可以将敏感信息替换为预定义的占位符。

执行流程包括规则匹配、脱敏处理和结果验证三个阶段。系统会首先匹配日志中的敏感字段，然后应用相应的脱敏算子进行处理，最后验证脱敏结果的正确性。脱敏配置支持启用和禁用，用户可以根据需要动态调整脱敏策略。

**Section sources**
- [models.py](file://bklog/apps/log_desensitize/models.py#L1-L80)
- [constants.py](file://bklog/apps/log_desensitize/constants.py#L1-L84)

## Grafana集成和可视化功能

Grafana集成和可视化功能提供了强大的数据展示能力，支持创建丰富的仪表盘和图表。系统通过Grafana数据源（DataSource）与Elasticsearch集群集成，将日志数据作为数据源提供给Grafana使用。

仪表盘创建过程包括数据源配置、面板添加和布局设计三个步骤。用户首先需要配置Grafana数据源，指定Elasticsearch集群的连接信息。然后可以添加各种类型的面板，如柱状图、折线图、表格等，每个面板可以配置不同的查询语句和可视化选项。最后通过拖拽方式设计仪表盘的布局，实现信息的直观展示。

数据展示方式支持多种图表类型和交互功能。系统支持时间序列图、热力图、饼图等多种可视化形式，用户可以根据数据特点选择合适的图表类型。交互功能包括时间范围选择、字段筛选、下钻分析等，帮助用户深入探索数据。仪表盘支持共享和导出，方便团队协作和报告生成。

**Section sources**
- [models.py](file://bklog/bk_dataview/grafana/models.py#L1-L145)

## 功能集成关系

各功能模块之间存在紧密的集成关系，形成了完整的日志管理闭环。日志采集是整个流程的起点，采集的数据经过清洗和处理后存储到Elasticsearch集群，为后续的搜索和分析提供数据基础。

采集数据与搜索功能的集成体现在索引集的创建上。每个采集配置会关联一个索引集，用户可以通过该索引集进行日志搜索。采集配置中的清洗规则直接影响搜索时的字段结构，确保搜索功能能够正确解析和查询日志数据。

采集数据与聚类分析功能的集成通过聚类配置实现。用户可以为特定的采集项启用日志聚类功能，系统会自动对采集的日志进行模式识别和分类。聚类结果可以作为搜索的过滤条件，帮助用户快速定位特定类型的日志。

脱敏处理在数据写入存储之前执行，确保敏感信息不会被记录到Elasticsearch中。脱敏后的数据仍然可以用于搜索和分析，但敏感信息已被保护。Grafana可视化功能直接读取Elasticsearch中的数据，包括经过脱敏处理的日志，确保数据展示的安全性。

**Section sources**
- [models.py](file://bklog/apps/log_search/models.py#L336-L498)
- [models.py](file://bklog/apps/log_databus/models.py#L101-L200)
- [models.py](file://bklog/apps/log_clustering/models.py#L106-L143)
- [models.py](file://bklog/apps/log_desensitize/models.py#L54-L70)
- [models.py](file://bklog/bk_dataview/grafana/models.py#L87-L117)