# 可视化

<cite>
**本文档引用的文件**
- [views.py](file://bklog/apps/grafana/views.py)
- [data_source.py](file://bklog/apps/grafana/data_source.py)
- [query.py](file://bklog/apps/grafana/handlers/query.py)
- [provisioning.py](file://bklog/apps/grafana/provisioning.py)
- [urls.py](file://bklog/apps/grafana/urls.py)
- [serializers.py](file://bklog/apps/grafana/serializers.py)
- [home_dashboard.py](file://bklog/apps/grafana/handlers/home_dashboard.py)
- [client.py](file://bklog/bk_dataview/grafana/client.py)
- [monitor.py](file://bklog/apps/api/modules/monitor.py)
- [chart_handlers.py](file://bklog/apps/log_search/handlers/search/chart_handlers.py)
- [model.py](file://bklog/apps/grafana/model.py)
</cite>

## 目录
1. [引言](#引言)
2. [Grafana集成机制](#grafana集成机制)
3. [数据源配置](#数据源配置)
4. [仪表盘管理](#仪表盘管理)
5. [查询接口](#查询接口)
6. [自定义仪表盘创建流程](#自定义仪表盘创建流程)
7. [预置仪表盘管理](#预置仪表盘管理)
8. [可视化查询处理流程](#可视化查询处理流程)
9. [业务监控仪表盘案例](#业务监控仪表盘案例)
10. [性能优化建议](#性能优化建议)

## 引言
本文档详细介绍了蓝鲸日志平台的可视化功能，重点阐述了Grafana集成机制、数据源配置、仪表盘管理、查询接口等核心组件。文档涵盖了自定义仪表盘的创建流程、预置仪表盘的管理和更新机制，以及可视化查询的完整处理链路。通过实际案例展示了如何构建业务监控仪表盘，并提供了性能优化建议和大规模仪表盘管理的最佳实践。

## Grafana集成机制
蓝鲸日志平台通过深度集成Grafana实现了强大的可视化能力。系统采用代理模式将Grafana嵌入到平台中，通过自定义视图和API接口实现功能扩展。

```mermaid
graph TD
A[用户请求] --> B[GrafanaProxyView]
B --> C{请求类型}
C --> |仪表盘请求| D[patch_home_panels]
C --> |数据查询| E[GrafanaQueryHandler]
C --> |追踪请求| F[GrafanaTraceViewSet]
D --> G[自定义首页]
E --> H[数据源查询]
F --> I[追踪数据查询]
H --> J[后端数据服务]
I --> J
J --> K[返回结果]
```

**图表来源**
- [views.py](file://bklog/apps/grafana/views.py#L67-L100)
- [home_dashboard.py](file://bklog/apps/grafana/handlers/home_dashboard.py#L27-L130)

**部分来源**
- [views.py](file://bklog/apps/grafana/views.py#L67-L100)
- [home_dashboard.py](file://bklog/apps/grafana/handlers/home_dashboard.py#L27-L130)

## 数据源配置
系统支持多种数据源配置方式，包括标准数据源、追踪数据源和自定义ES数据源。数据源的创建和管理通过Provisioning机制实现。

### 数据源类型
系统支持以下三种主要数据源类型：

```mermaid
classDiagram
class Datasource {
+name : str
+type : str
+url : str
+access : str
+isDefault : bool
+jsonData : Dict
+orgId : int
}
class Provisioning {
+datasources(request, org_name, org_id) List[Datasource]
+dashboards(request, org_name, org_id) List[Dashboard]
}
class CustomIndexSetESDataSource {
+space_uid : str
+index_set_id : int
+index_set_name : str
+time_field : str
+token : str
+to_datasource() Datasource
+list_datasource(bk_biz_id) List[Datasource]
}
class TraceProvisioning {
+datasources(request, org_name, org_id) List[Datasource]
+datasource_callback(request, org_name, org_id, datasource, status, content)
}
Provisioning <|-- CustomESDataSourceProvisioning
Provisioning <|-- TraceProvisioning
Provisioning <|-- Provisioning
CustomIndexSetESDataSource --> Datasource : "转换为"
```

**图表来源**
- [provisioning.py](file://bklog/apps/grafana/provisioning.py#L36-L126)
- [data_source.py](file://bklog/apps/grafana/data_source.py#L46-L152)
- [client.py](file://bklog/bk_dataview/grafana/client.py#L39-L128)

**部分来源**
- [provisioning.py](file://bklog/apps/grafana/provisioning.py#L36-L126)
- [data_source.py](file://bklog/apps/grafana/data_source.py#L46-L152)

### 数据源配置流程
数据源配置遵循以下流程：

```mermaid
flowchart TD
A[创建组织] --> B[配置数据源]
B --> C{数据源类型}
C --> |标准数据源| D[Provisioning]
C --> |追踪数据源| E[TraceProvisioning]
C --> |自定义ES数据源| F[CustomESDataSourceProvisioning]
D --> G[注入数据源配置]
E --> G
F --> G
G --> H[回调处理]
H --> I[持久化配置]
I --> J[返回结果]
```

**图表来源**
- [provisioning.py](file://bklog/apps/grafana/provisioning.py#L36-L126)
- [model.py](file://bklog/apps/grafana/model.py#L25-L29)

**部分来源**
- [provisioning.py](file://bklog/apps/grafana/provisioning.py#L36-L126)
- [model.py](file://bklog/apps/grafana/model.py#L25-L29)

## 仪表盘管理
系统提供了完整的仪表盘管理功能，包括创建、更新、删除和权限控制。

### 仪表盘操作API
主要的仪表盘操作通过以下API接口实现：

```mermaid
sequenceDiagram
participant 用户
participant GrafanaViewSet
participant MonitorApi
participant Grafana服务
用户->>GrafanaViewSet : 创建仪表盘或目录
GrafanaViewSet->>MonitorApi : create_dashboard_or_folder
MonitorApi->>Grafana服务 : 调用API创建
Grafana服务-->>MonitorApi : 返回结果
MonitorApi-->>GrafanaViewSet : 返回结果
GrafanaViewSet-->>用户 : 返回响应
用户->>GrafanaViewSet : 保存到仪表盘
GrafanaViewSet->>MonitorGrafanaHandler : save_to_dashboard
MonitorGrafanaHandler->>MonitorApi : save_to_dashboard
MonitorApi->>Grafana服务 : 调用API保存
Grafana服务-->>MonitorApi : 返回结果
MonitorApi-->>MonitorGrafanaHandler : 返回结果
MonitorGrafanaHandler-->>GrafanaViewSet : 返回结果
GrafanaViewSet-->>用户 : 返回响应
```

**图表来源**
- [views.py](file://bklog/apps/grafana/views.py#L522-L565)
- [monitor.py](file://bklog/apps/api/modules/monitor.py#L159-L175)
- [urls.py](file://bklog/apps/grafana/urls.py#L39-L58)

**部分来源**
- [views.py](file://bklog/apps/grafana/views.py#L522-L565)
- [monitor.py](file://bklog/apps/api/modules/monitor.py#L159-L175)

### 仪表盘权限控制
系统通过IAM权限系统对仪表盘操作进行细粒度控制：

```mermaid
flowchart TD
A[用户请求] --> B{操作类型}
B --> |查看仪表盘| C[VIEW_DASHBOARD]
B --> |管理仪表盘| D[MANAGE_DASHBOARD]
C --> E[验证业务权限]
D --> F[验证管理权限]
E --> G{有权限?}
F --> G
G --> |是| H[执行操作]
G --> |否| I[拒绝访问]
H --> J[返回结果]
```

**图表来源**
- [views.py](file://bklog/apps/grafana/views.py#L150-L157)
- [actions.py](file://bklog/apps/iam/handlers/actions.py#L177-L195)

**部分来源**
- [views.py](file://bklog/apps/grafana/views.py#L150-L157)

## 查询接口
系统提供了丰富的查询接口，支持指标查询、日志查询和变量查询等多种查询方式。

### 查询接口设计
查询接口采用统一的API设计模式：

```mermaid
classDiagram
class GrafanaQueryHandler {
+bk_biz_id : int
+space_uid : str
+query(query_dict) List
+query_log(query_dict) dict
+unify_query(query_dict) dict
+get_metric_list(category_id) List
+get_variable_field(bk_obj_id) List
+get_variable_value(variable_type, params) List
}
class QuerySerializer {
+dashboard_id : str
+panel_id : int
+bk_biz_id : int
+metric_field : str
+result_table_id : str
+where : List
+group_by : List
+query_string : str
+method : str
+interval : int
+target : List
+start_time : int
+end_time : int
}
class QueryLogSerializer {
+dashboard_id : str
+panel_id : int
+bk_biz_id : int
+result_table_id : str
+where : List
+query_string : str
+target : List
+size : int
+start_time : int
+end_time : int
}
GrafanaQueryHandler --> QuerySerializer : "使用"
GrafanaQueryHandler --> QueryLogSerializer : "使用"
```

**图表来源**
- [query.py](file://bklog/apps/grafana/handlers/query.py#L59-L800)
- [serializers.py](file://bklog/apps/grafana/serializers.py#L54-L86)
- [serializers.py](file://bklog/apps/grafana/serializers.py#L73-L85)

**部分来源**
- [query.py](file://bklog/apps/grafana/handlers/query.py#L59-L800)
- [serializers.py](file://bklog/apps/grafana/serializers.py#L54-L86)

### 查询处理流程
查询请求的处理流程如下：

```mermaid
flowchart TD
A[接收查询请求] --> B[参数验证]
B --> C[权限校验]
C --> D{查询类型}
D --> |指标查询| E[执行聚合查询]
D --> |日志查询| F[执行日志查询]
D --> |统一查询| G[执行统一查询]
E --> H[格式化时间序列]
F --> I[格式化表格数据]
G --> H
H --> J[返回结果]
I --> J
```

**图表来源**
- [query.py](file://bklog/apps/grafana/handlers/query.py#L278-L405)
- [query.py](file://bklog/apps/grafana/handlers/query.py#L407-L463)

**部分来源**
- [query.py](file://bklog/apps/grafana/handlers/query.py#L278-L463)

## 自定义仪表盘创建流程
创建自定义仪表盘涉及多个步骤，包括图表类型选择、查询配置和布局设计。

### 创建流程
自定义仪表盘的创建流程如下：

```mermaid
flowchart TD
A[选择图表类型] --> B[配置数据源]
B --> C[编写查询语句]
C --> D[设置聚合方法]
D --> E[配置时间范围]
E --> F[调整面板布局]
F --> G[设置变量]
G --> H[保存仪表盘]
H --> I[分享仪表盘]
```

**部分来源**
- [views.py](file://bklog/apps/grafana/views.py#L545-L565)
- [serializers.py](file://bklog/apps/grafana/serializers.py#L127-L137)

### 图表类型配置
系统支持多种图表类型，每种类型有不同的配置参数：

```mermaid
classDiagram
class ChartConfig {
+chart_alias : str
+chart_name : str
+field_name : str
+show_type : str
+display : bool
+tips : str
}
class LineChart {
+chart_alias : "line"
+chart_name : "曲线图"
}
class BarChart {
+chart_alias : "bar"
+chart_name : "柱状图"
}
class TableChart {
+chart_alias : "table"
+chart_name : "表格"
}
class TraceChart {
+chart_alias : "consuming"
+chart_name : "耗时图"
}
ChartConfig <|-- LineChart
ChartConfig <|-- BarChart
ChartConfig <|-- TableChart
ChartConfig <|-- TraceChart
```

**图表来源**
- [log.py](file://bklog/apps/log_trace/handlers/proto/log.py#L93-L131)
- [trace_field_handlers.py](file://bklog/apps/log_trace/handlers/trace_field_handlers.py#L127-L151)

## 预置仪表盘管理
系统提供了预置仪表盘的管理和更新机制，确保用户能够快速使用标准化的监控视图。

### 预置仪表盘更新机制
预置仪表盘的更新流程如下：

```mermaid
flowchart TD
A[检测更新] --> B{有更新?}
B --> |是| C[备份当前配置]
C --> D[应用新配置]
D --> E[验证配置]
E --> F[更新完成]
B --> |否| F
F --> G[返回状态]
```

**部分来源**
- [provisioning.py](file://bklog/apps/grafana/provisioning.py#L36-L126)

## 可视化查询处理流程
从Grafana请求到后端数据查询再到结果返回的完整链路如下：

```mermaid
sequenceDiagram
participant Grafana
participant GrafanaViewSet
participant GrafanaQueryHandler
participant SearchHandler
participant 后端存储
Grafana->>GrafanaViewSet : 发送查询请求
GrafanaViewSet->>GrafanaQueryHandler : 调用查询方法
GrafanaQueryHandler->>GrafanaQueryHandler : 权限校验
GrafanaQueryHandler->>GrafanaQueryHandler : 构建查询参数
GrafanaQueryHandler->>SearchHandler : 执行搜索
SearchHandler->>后端存储 : 查询数据
后端存储-->>SearchHandler : 返回原始数据
SearchHandler-->>GrafanaQueryHandler : 返回聚合结果
GrafanaQueryHandler->>GrafanaQueryHandler : 格式化结果
GrafanaQueryHandler-->>GrafanaViewSet : 返回格式化数据
GrafanaViewSet-->>Grafana : 返回响应
```

**图表来源**
- [views.py](file://bklog/apps/grafana/views.py#L196-L233)
- [query.py](file://bklog/apps/grafana/handlers/query.py#L278-L405)
- [chart_handlers.py](file://bklog/apps/log_search/handlers/search/chart_handlers.py#L484-L502)

**部分来源**
- [views.py](file://bklog/apps/grafana/views.py#L196-L233)
- [query.py](file://bklog/apps/grafana/handlers/query.py#L278-L405)

## 业务监控仪表盘案例
以下是一个构建业务监控仪表盘的实际案例，展示如何可视化关键指标。

### 案例：性能监控仪表盘
构建一个性能监控仪表盘，包含以下关键指标：

```mermaid
flowchart TD
A[性能监控仪表盘] --> B[CPU使用率]
A --> C[内存使用率]
A --> D[磁盘I/O]
A --> E[网络吞吐量]
A --> F[错误率]
B --> G[曲线图]
C --> G
D --> H[柱状图]
E --> H
F --> I[表格]
G --> J[时间范围: 最近1小时]
H --> J
I --> J
J --> K[自动刷新: 30秒]
```

**部分来源**
- [query.py](file://bklog/apps/grafana/handlers/query.py#L278-L405)
- [chart_handlers.py](file://bklog/apps/log_search/handlers/search/chart_handlers.py#L484-L502)

## 性能优化建议
为确保可视化系统的高性能运行，建议采取以下优化措施：

### 查询性能优化
```mermaid
flowchart TD
A[查询性能优化] --> B[合理设置时间范围]
A --> C[使用适当的聚合间隔]
A --> D[避免全表扫描]
A --> E[优化查询条件]
A --> F[使用索引字段]
A --> G[限制返回结果数量]
B --> H[建议时间范围不超过24小时]
C --> I[根据数据量选择合适间隔]
D --> J[避免使用通配符查询]
E --> K[使用精确匹配条件]
F --> L[优先使用索引字段过滤]
G --> M[设置合理的size限制]
```

**部分来源**
- [query.py](file://bklog/apps/grafana/handlers/query.py#L278-L405)
- [chart_handlers.py](file://bklog/apps/log_search/handlers/search/chart_handlers.py#L484-L502)

### 大规模仪表盘管理最佳实践
```mermaid
flowchart TD
A[大规模仪表盘管理] --> B[分类组织]
A --> C[权限控制]
A --> D[版本管理]
A --> E[性能监控]
A --> F[定期维护]
B --> G[按业务/功能分类]
C --> H[设置查看和管理权限]
D --> I[备份重要配置]
E --> J[监控查询性能]
F --> K[清理过期仪表盘]
```

**部分来源**
- [views.py](file://bklog/apps/grafana/views.py#L522-L565)
- [provisioning.py](file://bklog/apps/grafana/provisioning.py#L36-L126)