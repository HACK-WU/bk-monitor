# 收藏管理

<cite>
**本文档引用的文件**   
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py)
- [models.py](file://bklog/apps/log_search/models.py)
- [serializers.py](file://bklog/apps/log_search/serializers.py)
- [urls.py](file://bklog/apps/log_search/urls.py)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py)
- [constants.py](file://bklog/apps/log_search/constants.py)
</cite>

## 目录
1. [收藏功能概述](#收藏功能概述)
2. [核心数据模型](#核心数据模型)
3. [收藏操作实现机制](#收藏操作实现机制)
4. [收藏分组管理](#收藏分组管理)
5. [用户配置集成](#用户配置集成)
6. [用户体验功能](#用户体验功能)
7. [API管理接口](#api管理接口)
8. [性能优化策略](#性能优化策略)
9. [常见问题排查](#常见问题排查)

## 收藏功能概述

收藏管理功能为用户提供了一种高效保存和管理日志检索条件的机制。用户可以将常用的检索条件、搜索模式、显示字段等配置保存为收藏项，以便快速访问和重复使用。该功能支持个人收藏和公开收藏，通过分组管理提高收藏项的组织性。收藏功能与用户配置深度集成，支持权限控制、共享设置和个性化显示配置。

**Section sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L57-L890)
- [models.py](file://bklog/apps/log_search/models.py#L829-L1018)

## 核心数据模型

收藏功能的核心数据模型包括收藏项（Favorite）和收藏组（FavoriteGroup）两个主要实体。

```mermaid
erDiagram
FAVORITE {
int id PK
string space_uid
int index_set_id
string name
int group_id FK
json params
string visible_type
string search_mode
bool is_enable_display_fields
json display_fields
string source_app_code
json index_set_ids
string index_set_type
string favorite_type
}
FAVORITE_GROUP {
int id PK
string name
string group_type
string space_uid
string source_app_code
}
FAVORITE ||--o{ FAVORITE_GROUP : "belongs to"
```

**Diagram sources**
- [models.py](file://bklog/apps/log_search/models.py#L829-L958)

### 收藏项模型

收藏项模型（Favorite）存储用户的检索收藏记录，包含以下关键字段：

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| space_uid | 字符串 | 空间唯一标识 |
| index_set_id | 整数 | 索引集ID |
| name | 字符串 | 收藏名称 |
| group_id | 整数 | 收藏组ID |
| params | JSON | 检索条件 |
| visible_type | 字符串 | 可见类型（个人/公开） |
| search_mode | 字符串 | 检索模式 |
| is_enable_display_fields | 布尔值 | 是否启用显示字段 |
| display_fields | JSON | 显示字段列表 |
| index_set_type | 字符串 | 索引集类型（单个/联合） |

**Section sources**
- [models.py](file://bklog/apps/log_search/models.py#L829-L858)

### 收藏组模型

收藏组模型（FavoriteGroup）用于组织和管理收藏项的分组，包含以下关键字段：

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| name | 字符串 | 收藏组名称 |
| group_type | 字符串 | 收藏组类型（个人/公共/未分组） |
| space_uid | 字符串 | 空间唯一标识 |

**Section sources**
- [models.py](file://bklog/apps/log_search/models.py#L943-L958)

## 收藏操作实现机制

收藏功能提供了完整的CRUD（创建、读取、更新、删除）操作接口，通过RESTful API实现。

### 收藏创建

收藏创建操作通过`CreateFavoriteSerializer`验证输入参数，并调用`FavoriteHandler`的`create_or_update`方法实现。

```mermaid
sequenceDiagram
participant 用户
participant API
participant 处理器
participant 数据库
用户->>API : POST /search/favorite/
API->>处理器 : 调用create_or_update
处理器->>处理器 : 验证参数并构建params
处理器->>处理器 : 确定收藏组和可见类型
处理器->>数据库 : 创建收藏记录
数据库-->>处理器 : 返回创建结果
处理器-->>API : 返回收藏详情
API-->>用户 : 返回成功响应
```

**Diagram sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L206-L293)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L196-L300)

### 收藏编辑

收藏编辑操作通过`UpdateFavoriteSerializer`验证更新参数，并调用`FavoriteHandler`的`create_or_update`方法实现更新。

```mermaid
sequenceDiagram
participant 用户
participant API
participant 处理器
participant 数据库
用户->>API : PUT /search/favorite/{id}/
API->>处理器 : 调用create_or_update
处理器->>数据库 : 查询收藏记录
数据库-->>处理器 : 返回收藏数据
处理器->>处理器 : 验证权限和参数
处理器->>数据库 : 更新收藏记录
数据库-->>处理器 : 返回更新结果
处理器-->>API : 返回收藏详情
API-->>用户 : 返回成功响应
```

**Diagram sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L294-L377)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L196-L300)

### 收藏删除

收藏删除操作通过`FavoriteHandler`的`delete`方法实现软删除。

```mermaid
sequenceDiagram
participant 用户
participant API
participant 处理器
participant 数据库
用户->>API : DELETE /search/favorite/{id}/
API->>处理器 : 调用delete
处理器->>数据库 : 查询收藏记录
数据库-->>处理器 : 返回收藏数据
处理器->>处理器 : 验证删除权限
处理器->>数据库 : 软删除收藏记录
数据库-->>处理器 : 返回删除结果
处理器-->>API : 返回成功
API-->>用户 : 返回成功响应
```

**Diagram sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L442-L462)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L318-L319)

## 收藏分组管理

收藏分组管理功能允许用户将收藏项组织到不同的组中，提高收藏项的可管理性。

### 分组创建

```mermaid
flowchart TD
A[用户请求创建分组] --> B{验证参数}
B --> |有效| C[检查分组名称是否已存在]
C --> |不存在| D[创建新分组]
D --> E[设置分组类型为公共]
E --> F[保存分组记录]
F --> G[返回分组详情]
C --> |已存在| H[抛出异常]
B --> |无效| H
H --> I[返回错误响应]
```

**Diagram sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L629-L665)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L363-L383)

### 分组删除

分组删除操作会将该组内的所有收藏项移动到"未分组"组，然后删除原分组。

```mermaid
sequenceDiagram
participant 用户
participant API
participant 处理器
participant 数据库
用户->>API : DELETE /search/favorite_group/{id}/
API->>处理器 : 调用delete
处理器->>数据库 : 查询分组记录
数据库-->>处理器 : 返回分组数据
处理器->>处理器 : 验证分组类型
处理器->>处理器 : 获取未分组ID
处理器->>数据库 : 更新收藏项的组ID
数据库-->>处理器 : 返回更新结果
处理器->>数据库 : 删除分组记录
数据库-->>处理器 : 返回删除结果
处理器-->>API : 返回成功
API-->>用户 : 返回成功响应
```

**Diagram sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L701-L720)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L385-L395)

## 用户配置集成

收藏功能与用户配置深度集成，支持权限控制、共享设置和个性化配置。

### 权限控制

收藏功能实现了细粒度的权限控制机制：

```mermaid
flowchart TD
A[用户访问收藏] --> B{收藏类型}
B --> |个人收藏| C[检查创建者是否为当前用户]
C --> |是| D[允许访问]
C --> |否| E[拒绝访问]
B --> |公开收藏| F[检查用户是否在同一空间]
F --> |是| G[允许访问]
F --> |否| H[拒绝访问]
```

**Section sources**
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L70-L83)
- [models.py](file://bklog/apps/log_search/models.py#L861-L931)

### 显示字段配置

用户可以为收藏项配置显示字段，系统通过`UserIndexSetConfig`模型存储这些配置。

```mermaid
erDiagram
USER_INDEX_SET_CONFIG {
int index_set_id PK
json display_fields
json sort_list
string scope
}
FAVORITE {
int id PK
string name
int group_id
json params
}
USER_INDEX_SET_CONFIG ||--o{ FAVORITE : "configures"
```

**Diagram sources**
- [models.py](file://bklog/apps/log_search/models.py#L709-L718)

## 用户体验功能

收藏功能提供了丰富的用户体验功能，包括历史记录、快速访问和个性化配置。

### 历史记录管理

系统自动保存用户的检索历史，支持按时间范围查询。

```mermaid
flowchart TD
A[用户执行检索] --> B[系统保存历史记录]
B --> C{是否为全局查询}
C --> |否| D[调用_cache_history]
D --> E[添加时间范围参数]
E --> F[保存到UserIndexSetSearchHistory]
C --> |是| G[不保存]
```

**Section sources**
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L325-L331)
- [models.py](file://bklog/apps/log_search/models.py#L720-L739)

### 快速访问

用户可以通过分组视图快速访问收藏项，系统提供按更新时间、名称等排序选项。

```mermaid
sequenceDiagram
participant 用户
participant API
participant 处理器
participant 数据库
用户->>API : GET /search/favorite/list_by_group/
API->>处理器 : 调用list_group_favorites
处理器->>数据库 : 查询用户分组
数据库-->>处理器 : 返回分组列表
处理器->>数据库 : 查询用户收藏
数据库-->>处理器 : 返回收藏列表
处理器->>处理器 : 按分组组织收藏
处理器-->>API : 返回分组收藏列表
API-->>用户 : 返回响应
```

**Diagram sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L150-L205)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L118-L145)

## API管理接口

收藏功能提供了丰富的API接口，支持通过编程方式管理收藏项。

### 批量操作API

系统支持收藏项的批量创建、更新和删除操作。

```mermaid
flowchart TD
A[客户端] --> B[批量更新API]
B --> C[验证批量参数]
C --> D[遍历每个收藏项]
D --> E[调用单个更新方法]
E --> F{更新成功?}
F --> |是| G[继续下一个]
F --> |否| H[记录错误]
G --> D
D --> |完成| I[返回结果]
I --> J[客户端]
```

**Section sources**
- [favorite_search_views.py](file://bklog/apps/log_search/views/favorite_search_views.py#L378-L441)
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L301-L317)

### 排序设置API

用户可以通过API设置收藏项的排序规则。

```mermaid
flowchart TD
A[用户设置排序] --> B[发送排序请求]
B --> C[验证排序参数]
C --> D{排序字段有效?}
D --> |是| E[更新收藏项排序]
E --> F[保存到数据库]
F --> G[返回成功]
D --> |否| H[返回错误]
```

**Section sources**
- [serializers.py](file://bklog/apps/log_search/serializers.py#L775-L791)

## 性能优化策略

收藏功能采用了多种性能优化策略，确保系统在高并发场景下的稳定性和响应速度。

### 缓存策略

系统使用Redis缓存频繁访问的数据，减少数据库查询压力。

```mermaid
flowchart TD
A[请求收藏列表] --> B{缓存中存在?}
B --> |是| C[从缓存返回数据]
B --> |否| D[查询数据库]
D --> E[将结果存入缓存]
E --> F[返回数据]
```

**Section sources**
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L118-L145)

### 索引优化

数据库表建立了适当的索引，提高查询效率。

```sql
-- 收藏表索引
CREATE INDEX idx_favorite_space_uid ON favorite (space_uid);
CREATE INDEX idx_favorite_group_id ON favorite (group_id);
CREATE INDEX idx_favorite_updated_at ON favorite (updated_at);

-- 收藏组表索引
CREATE INDEX idx_favorite_group_space_uid ON favorite_group (space_uid);
CREATE INDEX idx_favorite_group_updated_at ON favorite_group (updated_at);
```

**Section sources**
- [models.py](file://bklog/apps/log_search/models.py#L857-L858)
- [models.py](file://bklog/apps/log_search/models.py#L956-L957)

### 并发控制

系统通过数据库事务和锁机制确保并发操作的数据一致性。

```mermaid
flowchart TD
A[开始事务] --> B[锁定相关记录]
B --> C[执行业务逻辑]
C --> D{操作成功?}
D --> |是| E[提交事务]
D --> |否| F[回滚事务]
E --> G[释放锁]
F --> G
```

**Section sources**
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L196-L300)

## 常见问题排查

### 收藏丢失

当用户发现收藏项丢失时，可能的原因和解决方案包括：

1. **检查空间标识**：确认当前操作的空间是否正确
2. **检查权限**：确认用户是否有访问该收藏的权限
3. **检查分组**：确认收藏项是否被移动到其他分组
4. **检查软删除**：确认收藏项是否被软删除

**解决方案**：
- 使用管理员权限查询数据库确认收藏项状态
- 检查`is_deleted`字段是否为True
- 如果是软删除，可以通过数据库恢复

### 权限异常

当用户遇到权限异常时，可能的原因和解决方案包括：

1. **检查收藏类型**：个人收藏只能由创建者访问
2. **检查空间范围**：确认用户和收藏项在同一空间
3. **检查应用代码**：确认来源系统代码匹配

**解决方案**：
- 检查`Favorite`表的`visible_type`和`source_app_code`字段
- 确认用户身份和权限配置

### 同步延迟

当收藏项更新后界面未及时刷新时，可能的原因和解决方案包括：

1. **检查缓存**：确认缓存是否及时更新
2. **检查异步任务**：确认相关异步任务是否正常执行
3. **检查网络延迟**：确认网络连接是否稳定

**解决方案**：
- 清除相关缓存
- 检查Redis连接状态
- 重启相关服务

**Section sources**
- [favorite_handlers.py](file://bklog/apps/log_search/handlers/search/favorite_handlers.py#L70-L83)
- [models.py](file://bklog/apps/log_search/models.py#L835-L837)