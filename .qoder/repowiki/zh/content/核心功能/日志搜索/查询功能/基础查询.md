# 基础查询

<cite>
**本文档引用的文件**   
- [dsl_builder.py](file://bklog/apps/log_esquery/esquery/dsl_builder/dsl_builder.py)
- [query_builder_logic.py](file://bklog/apps/log_esquery/esquery/dsl_builder/query_builder/query_builder_logic.py)
- [esquery.py](file://bklog/apps/log_esquery/esquery/esquery.py)
- [esquery_views.py](file://bklog/apps/log_esquery/views/esquery_views.py)
- [lucene.py](file://bklog/apps/utils/lucene.py)
- [constants.py](file://bklog/apps/constants.py)
- [serializers.py](file://bklog/apps/log_esquery/serializers.py)
- [query_time_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_time_builder.py)
- [query_filter_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_filter_builder.py)
- [query_sort_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_sort_builder.py)
- [query_string_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_string_builder.py)
- [query_index_optimizer.py](file://bklog/apps/log_esquery/esquery/builder/query_index_optimizer.py)
</cite>

## 目录
1. [简介](#简介)
2. [查询构建机制](#查询构建机制)
3. [Lucene语法解析器](#lucene语法解析器)
4. [查询参数校验与转换](#查询参数校验与转换)
5. [查询性能优化](#查询性能优化)
6. [常见问题排查](#常见问题排查)

## 简介
本系统提供基于Elasticsearch的高级查询功能，支持复杂的DSL查询构建、时间范围处理、过滤器组装等核心功能。系统通过Lucene语法解析器实现字段查询、布尔操作、通配符、正则表达式等语法支持，并提供查询参数的校验与转换逻辑，包括分页控制、排序规则、高亮显示等特性。系统还实现了查询性能优化策略，如缓存机制、查询超时设置、结果截断等。

## 查询构建机制

系统通过DSL构建器实现Elasticsearch查询的构建。核心组件包括查询字符串、过滤条件、时间范围、排序规则等。

```mermaid
classDiagram
class DslBuilder {
+search_string : str
+filter_dict_list : list
+time_range_dict : dict
+sort_tuple : tuple
+begin : int
+size : int
+aggs : dict
+highlight : dict
+collapse : dict
+search_after : list
+use_time_range : bool
+mappings : list
+time_field : str
+slice_search : bool
+slice_id : int
+slice_max : int
+body : dict
+__init__(self, search_string, filter_dict_list, time_range_dict, sort_tuple, begin, size, aggs, highlight, collapse, search_after, use_time_range, mappings, time_field, slice_search, slice_id, slice_max)
+check_special_string(_str : str)
+build_filter(filter_item)
+build_filter_match_phrase(filter_match_phrase)
+build_time_range()
+build_agg_terms(name, field, size=0)
+build_agg_top_hit(name, size, sort_field, sort="desc")
+build_agg_filter(name, field, field_value_list)
}
class Dsl {
+query_string : type_query_string
+range_dict : type_range
+should_ins : type_should
+__init__(self, query_string, filter_dict_list, range_field_dict, mappings)
+dsl_dict : dict
+divid_filter_list(filter_dict_list : List)
}
class EsQueryBuilder {
+build_query_string(search_string : str, mappings : List) -> Search
+_merge_mappings(mappings)
+build_exists(field : str)
+build_bool(should : type_should) -> type_bool
+build_should(should_list : type_should_list) -> type_should
+build_should_list(field : str, value_list : List[Any]) -> type_should_list
+build_should_list_wildcard(field : str, value_list : List[Any], is_contains : bool = False) -> type_should_list
+build_filter(filter_list : type_filter_list) -> type_filter
+build_filter_list(field : str, value_list : List[Any]) -> type_filter_list
+build_filter_list_wildcard(field : str, value_list : List[Any], is_contains : bool = False) -> type_filter_list
+build_match_phrase(field : str, value : Any) -> type_match_phrase
+build_wildcard(field : str, value : Any, is_contains : bool = False) -> type_wildcard
+build_match_phrase_query(field : str, value : Any) -> type_match_phrase_query
+build_range(range_field_dict : Dict[str, Dict[str, Any]]) -> type_range
+build_range_filter(field : str, operator : str, value : Any) -> type_range
}
DslBuilder --> EsQueryBuilder : "使用"
DslBuilder --> Dsl : "使用"
```

**图源**
- [dsl_builder.py](file://bklog/apps/log_esquery/esquery/dsl_builder/dsl_builder.py#L34-L195)
- [query_builder_logic.py](file://bklog/apps/log_esquery/esquery/dsl_builder/query_builder/query_builder_logic.py#L691-L739)

**节源**
- [dsl_builder.py](file://bklog/apps/log_esquery/esquery/dsl_builder/dsl_builder.py#L34-L195)
- [query_builder_logic.py](file://bklog/apps/log_esquery/esquery/dsl_builder/query_builder/query_builder_logic.py#L691-L739)

## Lucene语法解析器

系统实现了完整的Lucene语法解析器，支持字段查询、布尔操作、通配符、正则表达式等语法。

```mermaid
classDiagram
class LuceneParser {
+keyword : str
+lexer : Lexer
+parsing() -> list[LuceneField]
+_get_method(node)
+parsing_word(node)
+parsing_phrase(node)
+parsing_searchfield(node)
+parsing_fieldgroup(node)
+parsing_group(node)
+parsing_range(node)
+parsing_fuzzy(node)
+parsing_regex(node)
+parsing_proximity(node)
+parsing_oroperation(node)
+parsing_andoperation(node)
+parsing_not(node)
+parsing_plus(node)
+parsing_prohibit(node)
+parsing_unknownoperation(node)
}
class LuceneTransformer {
+lexer : Lexer
+visit_search_field(node, context)
+visit_word(node, context)
+transform(keyword : str, params : list) -> str
}
class LuceneSyntaxResolver {
+REGISTERED_INSPECTORS : List
+keyword : str
+messages : List
+__init__(self, keyword : str)
+inspect()
+resolve()
}
class EnhanceLuceneBase {
+RE : str
+query_string : str
+__init__(self, query_string : str = "")
+match() -> bool
+transform() -> str
}
class CaseInsensitiveLogicalEnhanceLucene {
+RE_STRING : str
+RE : str
+__init__(self, query_string : str = "")
+match() -> bool
+transform() -> str
}
class OperatorEnhanceLucene {
+RE_STRING : str
+RE : str
+ENHANCE_OPERATORS : List
+__init__(self, query_string : str)
+match()
+transform() -> str
}
class ReservedLogicalEnhanceLucene {
+RE_STRING : str
+RE : str
+match()
+transform() -> str
}
LuceneSyntaxResolver --> EnhanceLuceneBase : "继承"
CaseInsensitiveLogicalEnhanceLucene --> EnhanceLuceneBase : "继承"
OperatorEnhanceLucene --> EnhanceLuceneBase : "继承"
ReservedLogicalEnhanceLucene --> EnhanceLuceneBase : "继承"
LuceneParser --> LuceneTransformer : "使用"
```

**图源**
- [lucene.py](file://bklog/apps/utils/lucene.py#L66-L800)
- [constants.py](file://bklog/apps/constants.py#L116-L169)

**节源**
- [lucene.py](file://bklog/apps/utils/lucene.py#L66-L800)
- [constants.py](file://bklog/apps/constants.py#L116-L169)

## 查询参数校验与转换

系统通过序列化器实现查询参数的校验与转换，包括分页控制、排序规则、高亮显示等特性。

```mermaid
classDiagram
class EsQuerySearchAttrSerializer {
+index_set_id : int
+indices : str
+scenario_id : str
+storage_cluster_id : int
+time_field : str
+time_field_type : str
+time_field_unit : str
+use_time_range : bool
+include_start_time : bool
+include_end_time : bool
+start_time : str
+end_time : str
+time_range : str
+time_zone : str
+query_string : str
+filter : list
+sort_list : list
+start : int
+size : int
+dtEventTimeStamp : str
+search_type_tag : str
+aggs : dict
+highlight : dict
+collapse : dict
+bkdata_authentication_method : str
+bkdata_data_token : str
+search_after : list
+track_total_hits : bool
+scroll : str
+include_nested_fields : bool
+slice_search : bool
+slice_id : int
+slice_max : int
+validate(attrs)
+deal_filter(attrs)
}
class EsQuery {
+search_dict : Dict[str, Any]
+include_nested_fields : bool
+__init__(self, search_dict : type_search_dict)
+_enhance()
+_init_common_args()
+_init_time_field_args()
+_init_include_time_args()
+_init_time_args()
+_init_bkdata_args()
+_init_search_after_args()
+_optimizer(indices, scenario_id, start_time, end_time, time_zone, use_time_range)
+_init_other_args()
+compatibility_result(result)
+search()
+scroll()
+dsl()
+mapping()
+indices()
+cluster_stats()
+cluster_nodes_stats()
+get_cluster_info()
+cat_indices()
+es_route()
+_get_client()
+time_start_end_builder(time_range : str, start_time : str, end_time : str, time_zone=None) -> Tuple
}
class QueryTimeBuilder {
+TIME_FIELD_UNIT_RATE_MAP : dict
+GT : str
+GTE : str
+LT : str
+LTE : str
+time_field : str
+start_time : int | datetime
+end_time : int | datetime
+time_field_type : str
+time_field_unit : str
+indices : str
+scenario_id : str
+_time_range_dict : dict
+start_time_filter : str
+end_time_filter : str
+__init__(self, time_field : str = "", start_time : datetime = "", end_time : datetime = "", time_field_type : str = TimeFieldTypeEnum.DATE.value, time_field_unit : str = TimeFieldUnitEnum.SECOND.value, include_start_time : bool = True, include_end_time : bool = True, indices : str = "", scenario_id : str = "")
+time_range_dict : dict
+time_serilizer(start_time : Any, end_time : Any) -> tuple[Any | int, Any | int]
+_start_time_filter(include_start_time)
+_end_time_filter(include_end_time)
+get_storage_retention_time(indices, scenario_id)
+_deal_time(start_time, end_time)
}
class QueryFilterBuilder {
+_filter_dict_list : type_addition
+__init__(self, addition : type_addition)
+filter_dict_list : type_addition
+set_filter_dict_list(addition : type_addition)
}
class QuerySortBuilder {
+DESC : str
+ASC : str
+_sort_final_list : type_sort_multi_dict_list
+__init__(self, sort_list : type_sort_multi_list)
+sort_list : type_sort_multi_dict_list
+build_sort_list(sort_list : type_sort_multi_list) -> type_sort_multi_dict_list
}
class QueryIndexOptimizer {
+_index : str
+__init__(self, indices : type_index_set_string, scenario_id : str, start_time : arrow.Arrow = None, end_time : arrow.Arrow = None, time_zone : str = None, use_time_range : bool = True)
+index : str
+index_filter(result_table_id_list : type_index_set_list, start_time : arrow.Arrow, end_time : arrow.Arrow, time_zone : str) -> list[str]
+index_time_filter(x : str, start_time : arrow.Arrow, end_time : arrow.Arrow, time_zone : str, date_format : str) -> tuple[list[str], str]
+_generate_start_end(now : arrow.Arrow) -> tuple[arrow.Arrow, arrow.Arrow]
}
EsQuery --> EsQuerySearchAttrSerializer : "使用"
EsQuery --> QueryTimeBuilder : "使用"
EsQuery --> QueryFilterBuilder : "使用"
EsQuery --> QuerySortBuilder : "使用"
EsQuery --> QueryIndexOptimizer : "使用"
```

**图源**
- [serializers.py](file://bklog/apps/log_esquery/serializers.py#L39-L459)
- [esquery.py](file://bklog/apps/log_esquery/esquery/esquery.py#L51-L405)
- [query_time_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_time_builder.py#L36-L152)
- [query_filter_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_filter_builder.py#L26-L48)
- [query_sort_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_sort_builder.py#L26-L45)
- [query_index_optimizer.py](file://bklog/apps/log_esquery/esquery/builder/query_index_optimizer.py#L33-L89)

**节源**
- [serializers.py](file://bklog/apps/log_esquery/serializers.py#L39-L459)
- [esquery.py](file://bklog/apps/log_esquery/esquery/esquery.py#L51-L405)
- [query_time_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_time_builder.py#L36-L152)
- [query_filter_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_filter_builder.py#L26-L48)
- [query_sort_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_sort_builder.py#L26-L45)
- [query_index_optimizer.py](file://bklog/apps/log_esquery/esquery/builder/query_index_optimizer.py#L33-L89)

## 查询性能优化

系统实现了多种查询性能优化策略，包括缓存机制、查询超时设置、结果截断等。

```mermaid
classDiagram
class EsQuery {
+search_dict : Dict[str, Any]
+include_nested_fields : bool
+__init__(self, search_dict : type_search_dict)
+_enhance()
+_init_common_args()
+_init_time_field_args()
+_init_include_time_args()
+_init_time_args()
+_init_bkdata_args()
+_init_search_after_args()
+_optimizer(indices, scenario_id, start_time, end_time, time_zone, use_time_range)
+_init_other_args()
+compatibility_result(result)
+search()
+scroll()
+dsl()
+mapping()
+indices()
+cluster_stats()
+cluster_nodes_stats()
+get_cluster_info()
+cat_indices()
+es_route()
+_get_client()
+time_start_end_builder(time_range : str, start_time : str, end_time : str, time_zone=None) -> Tuple
}
class QueryTimeBuilder {
+TIME_FIELD_UNIT_RATE_MAP : dict
+GT : str
+GTE : str
+LT : str
+LTE : str
+time_field : str
+start_time : int | datetime
+end_time : int | datetime
+time_field_type : str
+time_field_unit : str
+indices : str
+scenario_id : str
+_time_range_dict : dict
+start_time_filter : str
+end_time_filter : str
+__init__(self, time_field : str = "", start_time : datetime = "", end_time : datetime = "", time_field_type : str = TimeFieldTypeEnum.DATE.value, time_field_unit : str = TimeFieldUnitEnum.SECOND.value, include_start_time : bool = True, include_end_time : bool = True, indices : str = "", scenario_id : str = "")
+time_range_dict : dict
+time_serilizer(start_time : Any, end_time : Any) -> tuple[Any | int, Any | int]
+_start_time_filter(include_start_time)
+_end_time_filter(include_end_time)
+get_storage_retention_time(indices, scenario_id)
+_deal_time(start_time, end_time)
}
class QueryIndexOptimizer {
+_index : str
+__init__(self, indices : type_index_set_string, scenario_id : str, start_time : arrow.Arrow = None, end_time : arrow.Arrow = None, time_zone : str = None, use_time_range : bool = True)
+index : str
+index_filter(result_table_id_list : type_index_set_list, start_time : arrow.Arrow, end_time : arrow.Arrow, time_zone : str) -> list[str]
+index_time_filter(x : str, start_time : arrow.Arrow, end_time : arrow.Arrow, time_zone : str, date_format : str) -> tuple[list[str], str]
+_generate_start_end(now : arrow.Arrow) -> tuple[arrow.Arrow, arrow.Arrow]
}
class QueryFilterBuilder {
+_filter_dict_list : type_addition
+__init__(self, addition : type_addition)
+filter_dict_list : type_addition
+set_filter_dict_list(addition : type_addition)
}
class QuerySortBuilder {
+DESC : str
+ASC : str
+_sort_final_list : type_sort_multi_dict_list
+__init__(self, sort_list : type_sort_multi_list)
+sort_list : type_sort_multi_dict_list
+build_sort_list(sort_list : type_sort_multi_list) -> type_sort_multi_dict_list
}
EsQuery --> QueryTimeBuilder : "使用"
EsQuery --> QueryIndexOptimizer : "使用"
EsQuery --> QueryFilterBuilder : "使用"
EsQuery --> QuerySortBuilder : "使用"
note right of QueryTimeBuilder
实现时间范围优化和过期数据处理
end note
note right of QueryIndexOptimizer
实现索引优化和查询范围缩小
end note
note right of QueryFilterBuilder
实现过滤条件优化
end note
note right of QuerySortBuilder
实现排序规则优化
end note
```

**图源**
- [esquery.py](file://bklog/apps/log_esquery/esquery/esquery.py#L51-L405)
- [query_time_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_time_builder.py#L36-L152)
- [query_index_optimizer.py](file://bklog/apps/log_esquery/esquery/builder/query_index_optimizer.py#L33-L89)
- [query_filter_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_filter_builder.py#L26-L48)
- [query_sort_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_sort_builder.py#L26-L45)

**节源**
- [esquery.py](file://bklog/apps/log_esquery/esquery/esquery.py#L51-L405)
- [query_time_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_time_builder.py#L36-L152)
- [query_index_optimizer.py](file://bklog/apps/log_esquery/esquery/builder/query_index_optimizer.py#L33-L89)
- [query_filter_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_filter_builder.py#L26-L48)
- [query_sort_builder.py](file://bklog/apps/log_esquery/esquery/builder/query_sort_builder.py#L26-L45)

## 常见问题排查

系统提供了完善的错误处理机制，能够识别和处理各种查询异常情况。

```mermaid
flowchart TD
A[查询请求] --> B{参数校验}
B --> |通过| C[查询构建]
B --> |失败| D[返回参数错误]
C --> E{查询执行}
E --> |成功| F[返回结果]
E --> |失败| G{错误类型判断}
G --> H[字段映射缺失]
G --> I[高亮失败]
G --> J[不支持的操作]
G --> K[服务器不可用]
G --> L[索引映射为空]
G --> M[其他错误]
H --> N[返回字段映射缺失异常]
I --> O[返回高亮异常]
J --> P[返回不支持操作异常]
K --> Q[返回服务器不可用异常]
L --> R[返回索引映射空异常]
M --> S[返回通用查询异常]
F --> T[结果处理]
T --> U[返回最终结果]
style A fill:#f9f,stroke:#333,stroke-width:2px
style D fill:#f96,stroke:#333,stroke-width:2px
style F fill:#9f9,stroke:#333,stroke-width:2px
style N fill:#f96,stroke:#333,stroke-width:2px
style O fill:#f96,stroke:#333,stroke-width:2px
style P fill:#f96,stroke:#333,stroke-width:2px
style Q fill:#f96,stroke:#333,stroke-width:2px
style R fill:#f96,stroke:#333,stroke-width:2px
style S fill:#f96,stroke:#333,stroke-width:2px
style U fill:#9f9,stroke:#333,stroke-width:2px
```

**图源**
- [esquery_views.py](file://bklog/apps/log_esquery/views/esquery_views.py#L86-L254)
- [serializers.py](file://bklog/apps/log_esquery/serializers.py#L108-L157)
- [test_error_message.py](file://bklog/apps/tests/log_search/test_error_message.py#L30-L82)

**节源**
- [esquery_views.py](file://bklog/apps/log_esquery/views/esquery_views.py#L86-L254)
- [serializers.py](file://bklog/apps/log_esquery/serializers.py#L108-L157)
- [test_error_message.py](file://bklog/apps/tests/log_search/test_error_message.py#L30-L82)