# 主机采集配置

<cite>
**本文档引用的文件**   
- [host.py](file://bklog/apps/log_databus/handlers/collector/host.py)
- [base.py](file://bklog/apps/log_databus/handlers/collector/base.py)
- [collector_views.py](file://bklog/apps/log_databus/views/collector_views.py)
- [models.py](file://bklog/apps/log_databus/models.py)
- [check_collector_views.py](file://bklog/apps/log_databus/views/check_collector_views.py)
- [serializers.py](file://bklog/apps/log_databus/serializers.py)
</cite>

## 目录
1. [主机采集配置创建流程](#主机采集配置创建流程)
2. [预检查机制](#预检查机制)
3. [配置部署后的状态监控](#配置部署后的状态监控)
4. [典型应用场景示例](#典型应用场景示例)
5. [配置最佳实践与常见问题解决方案](#配置最佳实践与常见问题解决方案)

## 主机采集配置创建流程

主机采集配置的创建流程涉及多个关键参数的设置，包括目标主机选择、采集路径设置、日志文件格式定义、字符编码配置和采集策略等。

### 目标主机选择

在创建主机采集配置时，首先需要选择目标主机。目标主机的选择可以通过动态或静态方式完成。动态方式基于业务拓扑（TOPO）进行选择，而静态方式则直接指定具体的主机实例。目标主机的选择信息存储在 `CollectorConfig` 模型的 `target_nodes` 字段中，该字段为 JSON 格式，包含主机的 IP 地址、云区域 ID 和供应商 ID 等信息。

### 采集路径设置

采集路径是日志文件在目标主机上的具体位置。采集路径设置通过 `params` 字段中的 `paths` 参数完成，该参数为列表类型，允许配置多个日志文件路径。例如，可以配置 `/var/log/app.log` 和 `/var/log/error.log` 作为采集路径。

### 日志文件格式定义

日志文件格式定义包括文本、JSON 和分隔符等格式。格式定义通过 `params` 字段中的 `conditions` 参数完成。`conditions` 参数支持多种过滤方式，包括匹配（match）和分隔符（separator）。对于分隔符格式，需要指定分隔符字符，并可进一步定义分隔符过滤条件。

### 字符编码配置

字符编码配置用于指定日志文件的字符集，确保日志内容的正确解析。字符编码配置通过 `data_encoding` 字段完成，支持的字符集包括 UTF-8 和 GBK。字符编码信息在创建或更新采集配置时作为参数传递。

### 采集策略

采集策略包括采集频率、文件轮转处理等。采集策略通过 `params` 字段中的多个参数进行配置，如 `scan_frequency`（文件扫描间隔）、`ignore_older`（文件扫描忽略时间）和 `tail_files`（是否增量采集）。这些参数共同决定了采集器的行为，确保日志文件的高效和准确采集。

**Section sources**
- [host.py](file://bklog/apps/log_databus/handlers/collector/host.py#L81-L1399)
- [base.py](file://bklog/apps/log_databus/handlers/collector/base.py#L124-L1634)
- [collector_views.py](file://bklog/apps/log_databus/views/collector_views.py#L98-L2565)
- [models.py](file://bklog/apps/log_databus/models.py#L101-L802)
- [serializers.py](file://bklog/apps/log_databus/serializers.py#L394-L515)

## 预检查机制

主机采集配置的预检查机制确保配置的合法性和可行性，包括路径合法性验证、权限检查和磁盘空间评估。

### 路径合法性验证

路径合法性验证通过检查采集路径是否存在于目标主机上来完成。系统会调用节点管理 API 获取目标主机的文件系统信息，并验证配置的路径是否有效。如果路径不存在或格式不正确，系统将返回错误信息。

### 权限检查

权限检查确保采集器具有读取目标日志文件的权限。系统会检查目标主机上运行采集器的用户是否具有足够的权限访问指定的日志文件。如果权限不足，系统将提示用户调整权限设置。

### 磁盘空间评估

磁盘空间评估用于确保目标主机有足够的磁盘空间存储日志文件。系统会查询目标主机的磁盘使用情况，并根据预估的日志生成速率评估未来的磁盘需求。如果磁盘空间不足，系统将建议用户清理磁盘或增加存储容量。

**Section sources**
- [check_collector_views.py](file://bklog/apps/log_databus/views/check_collector_views.py#L34-L51)
- [host.py](file://bklog/apps/log_databus/handlers/collector/host.py#L1000-L1124)
- [serializers.py](file://bklog/apps/log_databus/serializers.py#L122-L149)

## 配置部署后的状态监控

配置部署后，系统提供多种方式监控采集状态，包括 Agent 状态、采集进度和错误日志查看。

### Agent 状态

Agent 状态反映了采集器在目标主机上的运行情况。系统通过节点管理 API 获取每个目标主机的 Agent 状态，包括运行、停止和异常等状态。用户可以通过管理界面查看每个主机的 Agent 状态，并进行相应的操作。

### 采集进度

采集进度显示了日志文件的采集情况，包括已采集的日志行数和最新采集时间。系统会定期更新采集进度信息，并在管理界面中展示。用户可以通过采集进度了解日志采集的实时情况。

### 错误日志查看

错误日志查看功能允许用户查看采集过程中产生的错误日志。系统会记录所有采集错误，并提供详细的错误信息，包括错误类型、发生时间和相关日志内容。用户可以通过错误日志快速定位和解决问题。

**Section sources**
- [host.py](file://bklog/apps/log_databus/handlers/collector/host.py#L1000-L1124)
- [collector_views.py](file://bklog/apps/log_databus/views/collector_views.py#L98-L2565)
- [models.py](file://bklog/apps/log_databus/models.py#L101-L802)

## 典型应用场景示例

### Nginx 访问日志采集

Nginx 访问日志采集是一个典型的主机采集应用场景。配置步骤如下：
1. 选择目标主机，通常是运行 Nginx 的服务器。
2. 设置采集路径为 `/var/log/nginx/access.log`。
3. 定义日志格式为分隔符格式，分隔符为空格。
4. 配置字符编码为 UTF-8。
5. 设置采集策略，如每分钟扫描一次日志文件，忽略超过 24 小时的日志文件。

### 系统日志采集

系统日志采集用于监控主机的系统运行情况。配置步骤如下：
1. 选择目标主机，通常是所有需要监控的服务器。
2. 设置采集路径为 `/var/log/syslog` 和 `/var/log/messages`。
3. 定义日志格式为文本格式。
4. 配置字符编码为 UTF-8。
5. 设置采集策略，如每 30 秒扫描一次日志文件，保留最近 7 天的日志。

**Section sources**
- [host.py](file://bklog/apps/log_databus/handlers/collector/host.py#L81-L1399)
- [collector_views.py](file://bklog/apps/log_databus/views/collector_views.py#L98-L2565)
- [serializers.py](file://bklog/apps/log_databus/serializers.py#L394-L515)

## 配置最佳实践与常见问题解决方案

### 路径通配符使用

路径通配符允许使用通配符匹配多个日志文件。例如，可以使用 `/var/log/app/*.log` 匹配所有以 `.log` 结尾的日志文件。使用通配符时，应注意避免匹配不必要的文件，以免影响采集性能。

### 大文件采集性能优化

大文件采集可能导致性能问题。优化建议包括：
1. 使用 `ignore_older` 参数忽略长时间未更新的日志文件。
2. 调整 `scan_frequency` 参数，减少文件扫描频率。
3. 使用 `max_bytes` 参数限制单行日志的最大长度，防止内存溢出。

**Section sources**
- [host.py](file://bklog/apps/log_databus/handlers/collector/host.py#L81-L1399)
- [serializers.py](file://bklog/apps/log_databus/serializers.py#L188-L203)