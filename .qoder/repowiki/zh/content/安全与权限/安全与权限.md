# 安全与权限

<cite>
**本文档引用的文件**  
- [permission.py](file://bklog/apps/iam/handlers/permission.py)
- [actions.py](file://bklog/apps/iam/handlers/actions.py)
- [resources.py](file://bklog/apps/iam/handlers/resources.py)
- [models.py](file://bklog/apps/feature_toggle/models.py)
- [audit.py](file://bklog/apps/bk_log_admin/handlers/audit_record.py)
- [log_audit/models.py](file://bklog/apps/log_audit/models.py)
- [desensitize_rule_views.py](file://bklog/apps/log_desensitize/views/desensitize_rule_views.py)
- [desensitize_field_config.py](file://bklog/apps/log_desensitize/models.py)
- [apigw.py](file://bklog/apps/middleware/apigw.py)
- [aes.py](file://bklog/apps/utils/aes.py)
- [token.py](file://bklog/apps/log_commons/token.py)
- [qos.py](file://bklog/apps/log_esquery/qos.py)
</cite>

## 目录
1. [引言](#引言)
2. [IAM集成方案](#iam集成方案)
3. [功能开关机制](#功能开关机制)
4. [审计日志功能](#审计日志功能)
5. [API安全措施](#api安全措施)
6. [数据安全考虑](#数据安全考虑)
7. [安全最佳实践](#安全最佳实践)

## 引言

本文档全面介绍了蓝鲸日志平台的安全与权限机制。系统通过集成蓝鲸权限中心(IAM)实现细粒度的访问控制，采用功能开关(Feature Toggle)机制进行安全功能的灰度发布，提供完整的审计日志记录关键操作，并实施多层次的API安全措施保护系统免受攻击。同时，系统还实现了敏感信息保护、数据加密和脱敏处理等数据安全机制。

## IAM集成方案

蓝鲸日志平台通过与蓝鲸权限中心(IAM)深度集成，实现了基于角色的访问控制(RBAC)和基于属性的访问控制(ABAC)相结合的权限模型。系统定义了清晰的权限模型、角色定义和访问控制策略，确保用户只能访问其被授权的资源和操作。

### 权限模型

系统实现了基于动作(Action)、资源(Resource)和用户(Subject)三要素的权限模型。每个权限请求都包含用户身份、请求的动作和目标资源，通过权限中心进行策略评估和决策。

```mermaid
classDiagram
class ActionMeta {
+id : str
+name : str
+name_en : str
+type : str
+version : int
+related_resource_types : list
+related_actions : list
+description : str
+description_en : str
+is_read_action() bool
}
class ResourceMeta {
+system_id : str
+id : str
+name : str
+selection_mode : str
+related_instance_selections : list
+create_simple_instance(instance_id, attribute) Resource
+create_instance(instance_id, attribute) Resource
}
class Subject {
+type : str
+id : str
}
class Request {
+system : str
+subject : Subject
+action : ActionMeta
+resources : list[Resource]
+environment : dict
}
class Permission {
-username : str
-bk_tenant_id : str
-iam_client : CompatibleIAM
-skip_check : bool
+is_allowed(action, resources, raise_exception) bool
+is_allowed_by_biz(bk_biz_id, action, raise_exception) bool
+batch_is_allowed(actions, resources) dict
+filter_space_list_by_action(action, bk_tenant_id, space_list) list
+grant_creator_action(resource, creator, raise_exception) dict
}
Permission --> Request : "创建"
Request --> ActionMeta : "关联"
Request --> ResourceMeta : "关联"
Request --> Subject : "关联"
Permission --> CompatibleIAM : "使用"
```

**图源**  
- [actions.py](file://bklog/apps/iam/handlers/actions.py#L29-L75)
- [resources.py](file://bklog/apps/iam/handlers/resources.py#L34-L79)
- [permission.py](file://bklog/apps/iam/handlers/permission.py#L57-L444)

**本节源码**  
- [actions.py](file://bklog/apps/iam/handlers/actions.py)
- [resources.py](file://bklog/apps/iam/handlers/resources.py)
- [permission.py](file://bklog/apps/iam/handlers/permission.py)

### 角色定义

系统定义了多种预设角色，每个角色对应一组权限集合。角色定义基于业务场景和职责分离原则，确保权限分配的合理性和安全性。

```mermaid
classDiagram
class ActionEnum {
+VIEW_BUSINESS : ActionMeta
+SEARCH_LOG : ActionMeta
+VIEW_COLLECTION : ActionMeta
+CREATE_COLLECTION : ActionMeta
+MANAGE_COLLECTION : ActionMeta
+CREATE_ES_SOURCE : ActionMeta
+MANAGE_ES_SOURCE : ActionMeta
+CREATE_INDICES : ActionMeta
+MANAGE_INDICES : ActionMeta
+MANAGE_EXTRACT_CONFIG : ActionMeta
+VIEW_DASHBOARD : ActionMeta
+MANAGE_DASHBOARD : ActionMeta
+MANAGE_DESENSITIZE_RULE : ActionMeta
+MANAGE_GLOBAL_DESENSITIZE_RULE : ActionMeta
+DOWNLOAD_CLIENT_LOG : ActionMeta
+CREATE_CLIENT_LOG_TASK : ActionMeta
}
class ResourceEnum {
+BUSINESS : ResourceMeta
+COLLECTION : ResourceMeta
+ES_SOURCE : ResourceMeta
+INDICES : ResourceMeta
}
ActionEnum --> ActionMeta : "包含"
ResourceEnum --> ResourceMeta : "包含"
```

**图源**  
- [actions.py](file://bklog/apps/iam/handlers/actions.py#L76-L237)
- [resources.py](file://bklog/apps/iam/handlers/resources.py#L218-L227)

**本节源码**  
- [actions.py](file://bklog/apps/iam/handlers/actions.py)
- [resources.py](file://bklog/apps/iam/handlers/resources.py)

### 访问控制策略

系统实现了多层次的访问控制策略，包括基于业务的访问控制、批量权限检查和资源创建者权限自动授予等机制。

```mermaid
sequenceDiagram
participant User as "用户"
participant Permission as "权限服务"
participant IAM as "权限中心"
User->>Permission : 请求操作(动作, 资源)
Permission->>Permission : 构建权限请求
Permission->>IAM : is_allowed(请求)
IAM-->>Permission : 返回权限决策
alt 有权限
Permission-->>User : 允许操作
else 无权限
Permission->>Permission : 生成权限申请数据
Permission-->>User : 拒绝并提供申请链接
end
```

**图源**  
- [permission.py](file://bklog/apps/iam/handlers/permission.py#L249-L283)

**本节源码**  
- [permission.py](file://bklog/apps/iam/handlers/permission.py)

## 功能开关机制

系统采用功能开关(Feature Toggle)机制来管理功能的启用状态，特别适用于安全功能的灰度发布和风险控制。

### 功能开关模型

功能开关模型定义了开关的名称、状态、配置和业务范围限制等属性，支持白名单和黑名单机制。

```mermaid
classDiagram
class FeatureToggle {
+name : str
+alias : str
+status : str
+description : str
+is_viewed : bool
+feature_config : JSON
+biz_id_white_list : JSON
+biz_id_black_list : JSON
}
class FeatureToggleAdmin {
+list_display : list
+search_fields : list
}
FeatureToggle --> FeatureToggleAdmin : "管理"
```

**图源**  
- [models.py](file://bklog/apps/feature_toggle/models.py#L29-L46)

**本节源码**  
- [models.py](file://bklog/apps/feature_toggle/models.py)

### 灰度发布流程

功能开关机制支持安全功能的灰度发布，通过业务白名单逐步扩大功能范围，降低新功能带来的安全风险。

```mermaid
flowchart TD
Start([功能开发完成]) --> Configure["配置功能开关"]
Configure --> SetStatus["设置初始状态为'off'"]
SetStatus --> SelectBusiness["选择试点业务(白名单)"]
SelectBusiness --> Enable["在试点业务启用功能"]
Enable --> Monitor["监控功能运行状态"]
Monitor --> Evaluate{"评估功能稳定性"}
Evaluate --> |稳定| Expand["扩大白名单范围"]
Evaluate --> |不稳定| Disable["关闭功能并修复"]
Expand --> FullDeploy["全量发布"]
FullDeploy --> End([功能正式上线])
Disable --> Fix["修复问题"]
Fix --> Configure
```

**本节源码**  
- [models.py](file://bklog/apps/feature_toggle/models.py)

## 审计日志功能

系统提供了完整的审计日志功能，记录所有关键操作，支持安全审计和问题追溯。

### 审计日志模型

审计日志模型记录了操作时间、操作者、业务ID、操作类型、操作对象和请求参数等关键信息。

```mermaid
classDiagram
class UserOperationRecord {
+created_at : DateTime
+created_by : str
+bk_biz_id : int
+record_type : str
+record_sub_type : str
+record_object_id : int
+action : str
+params : JSON
}
class AuditRecordHandler {
+create_audit_record(params) UserOperationRecord
+get_audit_records(filters) QuerySet
}
UserOperationRecord --> AuditRecordHandler : "由...处理"
```

**图源**  
- [models.py](file://bklog/apps/log_audit/models.py#L29-L42)
- [audit_record.py](file://bklog/apps/bk_log_admin/handlers/audit_record.py)

**本节源码**  
- [models.py](file://bklog/apps/log_audit/models.py)
- [audit_record.py](file://bklog/apps/bk_log_admin/handlers/audit_record.py)

### 审计流程

系统在关键操作执行前后记录审计日志，确保所有操作都有迹可循。

```mermaid
sequenceDiagram
participant User as "用户"
participant Controller as "控制器"
participant Handler as "审计处理器"
participant DB as "数据库"
User->>Controller : 执行操作
Controller->>Handler : 开始审计记录
Handler->>DB : 创建审计记录(开始)
DB-->>Handler : 记录ID
Handler-->>Controller : 继续执行
Controller->>Controller : 执行业务逻辑
Controller->>Handler : 结束审计记录
Handler->>DB : 更新审计记录(完成)
DB-->>Handler : 更新结果
Handler-->>Controller : 审计完成
Controller-->>User : 返回结果
```

**本节源码**  
- [audit_record.py](file://bklog/apps/bk_log_admin/handlers/audit_record.py)

## API安全措施

系统实施了多层次的API安全措施，包括认证、授权、速率限制和防攻击策略，确保API接口的安全性。

### 认证机制

系统采用JWT(JSON Web Token)认证机制，通过API网关进行令牌验证和用户身份识别。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant APIGW as "API网关"
participant Server as "服务器"
Client->>APIGW : 请求(含JWT令牌)
APIGW->>APIGW : 验证JWT签名
APIGW->>APIGW : 解码JWT获取用户信息
APIGW->>Server : 转发请求(含用户信息)
Server->>Server : 执行业务逻辑
Server-->>APIGW : 返回响应
APIGW-->>Client : 返回响应
```

**图源**  
- [apigw.py](file://bklog/apps/middleware/apigw.py#L95-L124)

**本节源码**  
- [apigw.py](file://bklog/apps/middleware/apigw.py)

### 速率限制

系统实现了基于Redis的速率限制机制，防止API被滥用和拒绝服务攻击。

```mermaid
flowchart TD
Start([API请求到达]) --> CheckRedis["检查Redis中请求计数"]
CheckRedis --> GetCount["获取当前窗口内请求数"]
GetCount --> Compare{"请求数 >= 限制阈值?"}
Compare --> |是| Reject["拒绝请求并返回429"]
Compare --> |否| Allow["允许请求并增加计数"]
Allow --> Execute["执行API逻辑"]
Execute --> Response["返回响应"]
Reject --> Response
Response --> End([请求处理完成])
```

**图源**  
- [qos.py](file://bklog/apps/log_esquery/qos.py#L118-L144)

**本节源码**  
- [qos.py](file://bklog/apps/log_esquery/qos.py)

## 数据安全考虑

系统在数据安全方面采取了多项措施，包括敏感信息保护、数据加密和脱敏处理，确保数据的机密性和完整性。

### 敏感信息保护

系统对敏感信息进行特殊处理，防止敏感数据泄露。

```mermaid
classDiagram
class BaseTokenHandler {
+get_token_type() str
+create_token_params(**kwargs) dict
+get_or_create_token(space_uid, **kwargs) str
+record_access(username, token) void
+generate_token(space_uid, **kwargs) str
}
class CodeccTokenHandler {
+get_token_type() str
}
class TokenHandlerFactory {
+_HANDLERS : dict
+get_handler(token_type) BaseTokenHandler
}
BaseTokenHandler <|-- CodeccTokenHandler
TokenHandlerFactory --> BaseTokenHandler : "创建"
TokenHandlerFactory --> CodeccTokenHandler : "创建"
```

**图源**  
- [token.py](file://bklog/apps/log_commons/token.py#L11-L90)

**本节源码**  
- [token.py](file://bklog/apps/log_commons/token.py)

### 数据加密

系统使用AES-256加密算法对敏感数据进行加密存储，确保数据在静态状态下的安全性。

```mermaid
classDiagram
class AESCipher {
-bs : int
-iv : bytes
-key : bytes
+__init__(key, iv, bs)
+encrypt(raw) bytes
+decrypt(enc) str
+_pad(s) bytes
+_unpad(s) str
+predict_length(length) int
+get_16bytes_from_string(source_str) bytes
}
class SymmetricKeyConfig {
+key : str
}
class get_default_symmetric_key_config {
+cipher_type : str
+return : SymmetricKeyConfig
}
AESCipher --> SymmetricKeyConfig : "使用"
get_default_symmetric_key_config --> SymmetricKeyConfig : "创建"
```

**图源**  
- [aes.py](file://bklog/apps/utils/aes.py#L35-L132)

**本节源码**  
- [aes.py](file://bklog/apps/utils/aes.py)

### 数据脱敏

系统提供了灵活的数据脱敏机制，支持多种脱敏规则和字段配置，保护敏感信息。

```mermaid
classDiagram
class DesensitizeRule {
+rule_name : str
+operator : str
+params : JSON
+match_pattern : str
+space_uid : str
+is_public : bool
+match_fields : JSON
+is_active : bool
}
class DesensitizeConfig {
+index_set_id : int
+text_fields : JSON
}
class DesensitizeFieldConfig {
+index_set_id : int
+field_name : str
+rule_id : int
+match_pattern : str
+operator : str
+params : JSON
+sort_index : int
}
class DesensitizeOperator {
+TEXT_REPLACE : str
+MASK_SHIELD : str
}
DesensitizeFieldConfig --> DesensitizeRule : "引用"
DesensitizeConfig --> DesensitizeFieldConfig : "包含"
```

**图源**  
- [desensitize_field_config.py](file://bklog/apps/log_desensitize/models.py#L29-L80)

**本节源码**  
- [desensitize_field_config.py](file://bklog/apps/log_desensitize/models.py)
- [desensitize_rule_views.py](file://bklog/apps/log_desensitize/views/desensitize_rule_views.py)

## 安全最佳实践

为确保系统安全运行，建议遵循以下最佳实践：

### 部署安全

- 使用HTTPS加密所有通信
- 定期更新系统和依赖组件
- 最小化服务运行权限
- 配置防火墙规则限制访问

### 使用安全

- 遵循最小权限原则分配用户权限
- 定期审查和清理过期权限
- 启用审计日志并定期审查
- 对敏感操作实施多因素认证
- 使用功能开关机制进行新功能灰度发布
- 定期备份关键数据

### 监控与响应

- 建立安全事件监控和告警机制
- 制定安全事件响应预案
- 定期进行安全审计和渗透测试
- 及时响应和修复安全漏洞