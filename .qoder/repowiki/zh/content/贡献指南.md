# 贡献指南

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [pyproject.toml](file://pyproject.toml)
- [.pre-commit-config.yaml](file://.pre-commit-config.yaml)
- [scripts/pre-commit/check_commit_message.py](file://scripts/pre-commit/check_commit_message.py)
- [scripts/pre-commit/pre-push.py](file://scripts/pre-commit/pre-push.py)
- [scripts/pre-commit/preci.py](file://scripts/pre-commit/preci.py)
- [scripts/pre-commit/preci.sh](file://scripts/pre-commit/preci.sh)
- [docs/CONTRIBUTING.md](file://docs/CONTRIBUTING.md)
- [bkmonitor/apm/tests/conftest.py](file://bkmonitor/apm/tests/conftest.py)
</cite>

## 目录
1. [简介](#简介)
2. [代码风格规范](#代码风格规范)
3. [Git工作流](#git工作流)
4. [单元测试编写与运行](#单元测试编写与运行)
5. [预提交检查脚本](#预提交检查脚本)
6. [依赖管理](#依赖管理)
7. [完整贡献流程示例](#完整贡献流程示例)
8. [结论](#结论)

## 简介

本指南旨在为开发者提供详细的贡献说明，帮助您顺利参与蓝鲸监控平台（BK-MONITOR）的开发。内容涵盖代码风格、Git工作流、测试编写、预提交检查机制以及完整的贡献流程。所有贡献需遵循MIT许可证，并遵守项目既定的开发规范。

**文档来源**  
- [README.md](file://README.md#L43-L45)
- [docs/CONTRIBUTING.md](file://docs/CONTRIBUTING.md#L1-L5)

## 代码风格规范

本项目采用现代化的Python代码格式化与静态检查工具链，确保代码风格统一。主要工具包括：

- **Black**：自动格式化代码，行长度限制为120字符
- **isort**：自动排序import语句，使用black配置
- **ruff**：快速的Python linter和代码格式化工具
- **flake8**：代码质量检查，最大行长度120，复杂度上限25

配置位于`pyproject.toml`文件中，具体包括：
- 代码格式化遵循black标准
- 导入路径配置为`bkmonitor`, `bklog`, `bkmonitor/packages`
- 忽略部分第三方库的导入顺序检查
- 针对特定目录（如配置文件）放宽部分检查规则

开发者无需手动配置，这些规则将通过预提交钩子自动执行。

**文档来源**  
- [pyproject.toml](file://pyproject.toml#L1-L64)

## Git工作流

项目采用标准的Fork-and-Pull开发模式，遵循以下工作流：

### 分支策略
- 所有功能开发应在个人Fork仓库中进行
- 目标分支始终为上游仓库的`master`分支
- 使用特性分支开发，建议命名格式为`<分类>/<issue id>`，例如`feature/#1`

### 提交信息格式
提交信息必须遵循规范格式，以确保自动化工具能正确解析。格式要求如下：

```
<类型>(<范围>)?: <描述> issue #<编号>
```

允许的提交类型包括：
- `feat`：新增功能
- `fix`：修复缺陷
- `docs`：文档变更
- `style`：代码格式调整
- `refactor`：重构
- `perf`：性能优化
- `test`：测试相关
- `chore`：构建或辅助工具变更
- `merge`：分支合并

提交信息将通过`check_commit_message.py`脚本进行验证，不符合规范的提交将被拒绝。

### 合并策略
- 项目遵循*no merge-commit*原则
- 解决冲突时应使用`git rebase`而非`git merge`
- PR合并采用rebase方式，确保提交历史线性整洁
- 开发过程中的零碎提交应在提交PR前通过`git rebase -i`进行压缩

**文档来源**  
- [docs/CONTRIBUTING.md](file://docs/CONTRIBUTING.md#L28-L50)
- [scripts/pre-commit/check_commit_message.py](file://scripts/pre-commit/check_commit_message.py#L19-L29)

## 单元测试编写与运行

### 测试框架
项目使用`pytest`作为主要测试框架，结合`django_db`标记支持Django模型测试。

### 测试编写规范
- 所有测试文件应以`test_`开头或以`_test.py`结尾
- 使用`pytest.mark.django_db`标记需要数据库交互的测试
- 可使用`mock`库进行依赖模拟，如`apm/tests/conftest.py`中对Redis的模拟

### 测试运行
测试可通过以下方式运行：
- 使用`pytest`命令直接运行
- 通过预提交钩子自动执行
- 在CI/CD流水线中集成

测试配置可在各模块的`conftest.py`文件中找到，用于设置测试环境和共享fixture。

**文档来源**  
- [bkmonitor/apm/tests/conftest.py](file://bkmonitor/apm/tests/conftest.py#L1-L23)
- [pyproject.toml](file://pyproject.toml#L32-L38)

## 预提交检查脚本

项目配置了全面的预提交检查机制，通过`.pre-commit-config.yaml`文件定义，确保代码质量。

### 配置文件结构
`.pre-commit-config.yaml`包含以下检查项：

```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.3.0
    hooks:
      - id: check-merge-conflict
      - id: detect-private-key

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.11.6
    hooks:
      - id: ruff
        args: [ --fix ]
      - id: ruff-format

  - repo: local
    hooks:
      - id: check-pre-ci-pipeline
        entry: python3 scripts/pre-commit/pre-push.py
        stages: [ pre-push ]
      - id: check-pre-ci
        entry: python3 scripts/pre-commit/preci.py
      - id: check-commit-message
        entry: python scripts/pre-commit/check_commit_message.py
        stages: [ commit-msg ]
      - id: ip
        entry: python3 scripts/sensitive_info_check/check_ip.py
```

### 核心脚本功能

#### check_commit_message.py
- 验证提交信息是否符合规范
- 使用正则表达式匹配`<类型>: <描述>`格式
- 列出所有允许的提交类型前缀
- 在`commit-msg`阶段执行

#### pre-push.py
- 在`pre-push`阶段执行
- 检测PreCI工具是否存在
- 获取推送分支的差异文件
- 创建临时环境执行PreCI扫描
- 防止包含问题的代码推送到远程仓库

#### preci.py 和 preci.sh
- 包装PreCI扫描命令
- 检查系统是否安装PreCI
- 执行`preci scan --pre-commit`进行代码扫描
- 跨平台兼容性处理

这些脚本共同构成了代码质量的第一道防线，确保只有符合规范的代码才能进入代码库。

**文档来源**  
- [.pre-commit-config.yaml](file://.pre-commit-config.yaml#L1-L66)
- [scripts/pre-commit/check_commit_message.py](file://scripts/pre-commit/check_commit_message.py#L1-L62)
- [scripts/pre-commit/pre-push.py](file://scripts/pre-commit/pre-push.py#L1-L183)
- [scripts/pre-commit/preci.py](file://scripts/pre-commit/preci.py#L1-L26)
- [scripts/pre-commit/preci.sh](file://scripts/pre-commit/preci.sh#L1-L21)

## 依赖管理

项目使用`pyproject.toml`进行依赖管理，这是现代Python项目的标准做法。

### 添加新依赖
要添加新的依赖，请直接编辑`pyproject.toml`文件：
1. 确定依赖的用途（开发依赖或生产依赖）
2. 在相应部分添加依赖项
3. 运行`pip install -e .`更新本地环境
4. 提交更改

### 依赖配置
- 使用`[tool.*]`部分配置各种开发工具
- 工具配置包括black、isort、flake8、ruff等
- 指定了源代码路径和第三方库列表
- 配置了代码检查的排除规则

项目不再使用`requirements.txt`，所有依赖管理集中于`pyproject.toml`。

**文档来源**  
- [pyproject.toml](file://pyproject.toml#L1-L64)

## 完整贡献流程示例

以下是完整的代码贡献流程：

### 1. Fork仓库
在GitHub上Fork `bk-apm`仓库到您的个人账户。

### 2. 克隆代码
```bash
git clone https://github.com/your-username/bk-apm.git
cd bk-apm
```

### 3. 配置预提交钩子
```bash
pip install pre-commit
pre-commit install
pre-commit install -t pre-push
```

### 4. 创建特性分支
```bash
git checkout -b feature/#123
```

### 5. 开发与测试
- 编写代码实现功能
- 编写相应的单元测试
- 运行测试：`pytest bkmonitor/apm/tests/`
- 代码将自动格式化并检查

### 6. 提交代码
```bash
git add .
git commit -m 'feat: 实现新功能 #123'
```

### 7. 推送代码
```bash
git push origin feature/#123
```
推送时将自动执行PreCI检查。

### 8. 创建Pull Request
- 在GitHub上创建PR
- 目标分支选择`master`
- 填写PR描述，关联Issue #123
- 指定代码审查负责人

### 9. 处理审查反馈
- 根据审查意见修改代码
- 使用`fixup!`提交修复
- 审查通过后，压缩提交历史

### 10. 合并与关闭
- 维护者使用rebase方式合并
- 自动关闭关联的Issue

此流程确保了代码质量和协作效率。

**文档来源**  
- [docs/CONTRIBUTING.md](file://docs/CONTRIBUTING.md#L36-L49)
- [.pre-commit-config.yaml](file://.pre-commit-config.yaml)

## 结论

本贡献指南详细说明了参与蓝鲸监控平台开发的各个方面。遵循这些规范不仅能提高代码质量，还能加快PR的审查和合并速度。关键要点包括：
- 严格遵守代码风格规范
- 使用规范的Git工作流
- 编写充分的单元测试
- 理解并利用预提交检查机制
- 遵循完整的贡献流程

通过这些实践，我们可以共同维护一个高质量、可维护的代码库。