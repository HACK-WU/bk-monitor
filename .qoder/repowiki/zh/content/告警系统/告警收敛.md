# 告警收敛

<cite>
**本文档引用的文件**  
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py)
- [shield.py](file://bkmonitor/bkmonitor/utils/shield.py)
- [converge.py](file://bkmonitor/bkmonitor/aiops/incident/operation.py)
</cite>

## 目录
1. [引言](#引言)
2. [告警收敛功能概述](#告警收敛功能概述)
3. [核心组件分析](#核心组件分析)
4. [收敛逻辑实现](#收敛逻辑实现)
5. [告警屏蔽机制](#告警屏蔽机制)
6. [告警实例状态变迁](#告警实例状态变迁)
7. [高频率告警收敛案例分析](#高频率告警收敛案例分析)
8. [结论](#结论)

## 引言
告警收敛功能是监控系统中的关键组件，用于处理大量告警事件，避免告警风暴，提升运维效率。本文档详细分析告警收敛功能的实现机制，包括去重、频率抑制、关联分析和屏蔽配置等核心功能。

## 告警收敛功能概述
告警收敛功能主要通过`service/converge/`处理器处理告警事件，执行去重、频率抑制和关联分析。该功能基于维度（dimension）进行聚合，并利用时间窗口进行抑制，确保告警信息的有效性和可管理性。

## 核心组件分析

**Section sources**
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py#L746-L916)

## 收敛逻辑实现
收敛逻辑在`core/context/converge.py`中实现，主要通过基于维度的聚合和基于时间窗口的抑制来处理告警事件。具体实现包括：

- **基于维度的聚合**：根据策略ID、维度、告警级别、信号、业务ID、通知接收人和通知方式等维度进行聚合。
- **基于时间窗口的抑制**：设置时间窗口和计数阈值，超出后进行汇总处理。

```mermaid
flowchart TD
Start([开始]) --> CheckConvergeConfig["检查收敛配置"]
CheckConvergeConfig --> IsEnabled{"收敛启用?"}
IsEnabled --> |否| End([结束])
IsEnabled --> |是| SetDefaultConfig["设置默认收敛配置"]
SetDefaultConfig --> DefineConvergeParams["定义收敛参数"]
DefineConvergeParams --> SetTimeWindow["设置时间窗口: 60秒"]
SetTimeWindow --> SetCountThreshold["设置计数阈值: 1"]
SetCountThreshold --> DefineDefenseDimensions["定义防御维度"]
DefineDefenseDimensions --> StrategyID["策略ID: self"]
DefineDefenseDimensions --> Dimensions["维度: self"]
DefineDefenseDimensions --> AlertLevel["告警级别: self"]
DefineDefenseDimensions --> Signal["信号: self"]
DefineDefenseDimensions --> BkBizID["业务ID: self"]
DefineDefenseDimensions --> NoticeReceiver["通知接收人: self"]
DefineDefenseDimensions --> NoticeWay["通知方式: self"]
DefineDefenseDimensions --> SetConvergeMethod["设置收敛方法: 超出后汇总"]
SetConvergeMethod --> EnableBizConverge{"需要业务收敛?"}
EnableBizConverge --> |否| End
EnableBizConverge --> |是| DefineSubConverge["定义二级收敛配置"]
DefineSubConverge --> SubTimeWindow["时间窗口: 60秒"]
SubTimeWindow --> SubCountThreshold["计数阈值: 2"]
SubCountThreshold --> SubDefenseDimensions["二级防御维度"]
SubDefenseDimensions --> SubBkBizID["业务ID: self"]
SubDefenseDimensions --> SubNoticeReceiver["通知接收人: self"]
SubDefenseDimensions --> SubNoticeWay["通知方式: self"]
SubDefenseDimensions --> SubAlertLevel["告警级别: self"]
SubDefenseDimensions --> SubSignal["信号: self"]
SubDefenseDimensions --> SubConvergeMethod["收敛方法: 汇总告警"]
SubConvergeMethod --> End
```

**Diagram sources**
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py#L748-L780)

**Section sources**
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py#L746-L916)

## 告警屏蔽机制
告警屏蔽机制通过`cache/shield.py`和`models/shield.py`实现，支持时间范围、目标和条件的配置。屏蔽功能包括：

- **时间范围配置**：支持单次、每天、每周、每月等周期性屏蔽。
- **目标配置**：支持服务实例、主机、节点、业务和动态分组等屏蔽目标。
- **条件配置**：支持基于维度条件的屏蔽。

```mermaid
classDiagram
class BaseShieldDisplayManager {
+get_shield_content(shield, strategy_id_to_name)
+get_strategy_ids(shield)
+get_service_name_list(bk_biz_id, service_instance_id_list)
+get_node_path_list(bk_biz_id, bk_topo_node_list)
+get_dynamic_group_name_list(bk_biz_id, dynamic_group_list)
+get_business_name(bk_biz_id)
+get_cycle_duration(shield)
+get_shield_cycle(shield)
+get_current_cycle_ramaining_time(shield)
+_get_current_begin_and_end_datetime(now_datetime, begin_time, end_time)
+_get_remainint_time(begin_datetime, end_datetime, now_datetime)
+get_category_name(shield)
}
class ScopeType {
+INSTANCE : "instance"
+IP : "ip"
+NODE : "node"
+BIZ : "biz"
+DYNAMIC_GROUP : "dynamic_group"
}
class ShieldStatus {
+SHIELDED : 1
+EXPIRED : 2
+REMOVED : 3
}
class ShieldCategory {
+SCOPE : "scope"
+STRATEGY : "strategy"
+EVENT : "event"
+ALERT : "alert"
+DIMENSION : "dimension"
}
class ShieldCycleType {
+ONCE : 1
+EVERYDAY : 2
+EVERY_WEEK : 3
+EVERY_MONTH : 4
}
class ShieldType {
+SAAS_CONFIG : "saas_config"
+HOST_STATUS : "host_status"
+HOST_TARGET : "host_target"
+ALARM_TIME : "alarm_time"
}
BaseShieldDisplayManager --> ScopeType : "使用"
BaseShieldDisplayManager --> ShieldStatus : "使用"
BaseShieldDisplayManager --> ShieldCategory : "使用"
BaseShieldDisplayManager --> ShieldCycleType : "使用"
BaseShieldDisplayManager --> ShieldType : "使用"
```

**Diagram sources**
- [shield.py](file://bkmonitor/bkmonitor/utils/shield.py#L38-L334)
- [shield.py](file://bkmonitor/constants/shield.py#L14-L74)

**Section sources**
- [shield.py](file://bkmonitor/bkmonitor/utils/shield.py#L1-L334)
- [shield.py](file://bkmonitor/constants/shield.py#L1-L74)

## 告警实例状态变迁
告警实例的状态变迁通过`record_incident_alert_convergence`方法记录，当告警被收敛时，系统会生成相应的操作记录，包括告警名称、告警ID和被收敛的告警事件个数。

```mermaid
sequenceDiagram
participant System as 系统
participant Convergence as 收敛处理器
participant Alert as 告警实例
participant Operation as 操作记录
System->>Convergence : 接收告警事件
Convergence->>Convergence : 执行去重和频率抑制
Convergence->>Convergence : 进行关联分析
Convergence->>Alert : 创建或更新告警实例
Alert->>Alert : 更新状态为"收敛中"
Convergence->>Operation : 调用record_incident_alert_convergence
Operation->>Operation : 记录收敛操作
Operation-->>System : 返回处理结果
Alert->>Alert : 状态变更为"已收敛"
```

**Diagram sources**
- [converge.py](file://bkmonitor/bkmonitor/aiops/incident/operation.py#L345-L366)

**Section sources**
- [converge.py](file://bkmonitor/bkmonitor/aiops/incident/operation.py#L345-L366)

## 高频率告警收敛案例分析
在一个高频率告警场景中，系统每分钟产生数百个相同类型的告警。通过配置收敛规则，系统将这些告警在60秒时间窗口内进行聚合，当告警数量超过阈值时，生成一个汇总告警，有效减少了告警噪音，提高了运维效率。

**Section sources**
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py#L746-L916)
- [converge.py](file://bkmonitor/bkmonitor/aiops/incident/operation.py#L345-L366)

## 结论
告警收敛功能通过维度聚合和时间窗口抑制，有效解决了高频率告警问题。告警屏蔽机制提供了灵活的配置选项，支持多种屏蔽目标和条件。这些功能共同提升了监控系统的可用性和运维效率。