# 告警规则

<cite>
**本文档引用的文件**   
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py)
- [models/strategy.py](file://bkmonitor/bkmonitor/models/strategy.py)
- [serializers.py](file://bkmonitor/bkmonitor/strategy/serializers.py)
- [constants/strategy.py](file://bkmonitor/constants/strategy.py)
</cite>

## 目录
1. [策略与监控项模型](#策略与监控项模型)
2. [策略创建与验证逻辑](#策略创建与验证逻辑)
3. [序列化与配置转换](#序列化与配置转换)
4. [场景差异与常量定义](#场景差异与常量定义)
5. [完整策略配置示例](#完整策略配置示例)

## 策略与监控项模型

`models/strategy.py` 文件定义了告警策略的核心数据模型，主要包括 `StrategyModel` 和 `ItemModel` 两个关键类。

`StrategyModel` 是策略的顶层模型，包含策略的基本信息，如名称（name）、业务ID（bk_biz_id）、场景（scenario）、是否启用（is_enabled）等。它还包含策略的类型（type）、来源系统（source）、失效状态（is_invalid）和失效类型（invalid_type）。策略的优先级（priority）和优先级分组键（priority_group_key）用于策略的排序和分组处理。

`ItemModel` 表示监控项，与 `StrategyModel` 通过 `strategy_id` 字段关联。监控项包含监控项名称（name）、计算公式（expression）、原始查询语句（origin_sql）、无数据配置（no_data_config）和监控目标（target）。`no_data_config` 字段默认配置为持续5个周期无数据触发告警。`target` 字段定义了监控的目标对象，其默认值为空列表。

`DetectModel` 定义了检测配置，包含告警级别（level）、计算公式（expression）、触发条件配置（trigger_config）和恢复条件配置（recovery_config）。触发条件中的 `count` 表示在 `check_window` 周期内需要满足条件的次数。

`AlgorithmModel` 表示检测算法，包含算法类型（type）、算法配置（config）和单位前缀（unit_prefix）。算法类型枚举了多种检测算法，如静态阈值（Threshold）、环比、同比、智能异常检测等。

`QueryConfigModel` 是查询配置基类，定义了数据来源标签（data_source_label）、数据类型标签（data_type_label）和指标ID（metric_id）。不同的数据源和数据类型对应不同的查询配置模型。

**Section sources**
- [models/strategy.py](file://bkmonitor/bkmonitor/models/strategy.py#L335-L403)
- [models/strategy.py](file://bkmonitor/bkmonitor/models/strategy.py#L81-L101)

## 策略创建与验证逻辑

`strategy/strategy.py` 文件中的 `StrategyConfig` 类负责策略的创建、更新和验证逻辑。

策略创建通过 `create` 类方法实现。该方法接收一个策略字典作为参数，首先创建 `Strategy` 记录，然后依次创建关联的 `Item`、`DetectAlgorithm` 和 `Action` 记录。在创建过程中，会调用 `create_result_table_split` 和 `create_cmdb_level_info` 方法，根据策略配置动态创建数据拆分表和补充CMDB层级信息。如果创建过程中发生异常，会回滚已创建的记录并抛出 `CreateStrategyError`。

策略更新通过 `update` 实例方法实现。该方法接收一个新的策略字典，先保存旧的策略配置，然后调用 `update_strategy` 方法更新数据库记录。更新成功后，会执行 `create_result_table_split` 和 `access_aiops` 等后续操作。如果更新失败，会回滚到旧的配置并抛出 `UpdateStrategyError`。

`create_item` 方法负责创建监控项。它会根据数据源类型获取对应的查询配置模型，并创建相应的数据源记录。对于特殊指标（如主机重启、进程端口），会使用特定的查询配置。在创建前，会调用 `handle_advance_condition_method` 和 `handle_target_dimensions` 方法处理高级查询条件和监控目标维度。

**Section sources**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L548-L580)
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L582-L608)
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L656-L703)

## 序列化与配置转换

`serializers.py` 文件定义了用于将策略配置转换为后端可处理格式的序列化器。

`QueryConfigSerializer` 是所有查询配置序列化器的基类。它定义了通用的配置字段，如 `functions`（计算函数）和 `intelligent_detect`（智能监控配置）。具体的查询配置序列化器继承自此类，如 `BkMonitorTimeSeriesSerializer` 用于监控时序数据，`BkLogSearchLogSerializer` 用于日志数据。

`ThresholdSerializer` 用于序列化静态阈值算法配置。它是一个嵌套的 `ListSerializer`，其子元素 `UnitSerializer` 包含 `threshold`（阈值）和 `method`（比较方法）字段。比较方法被限制为预定义的集合，如 "gt"（大于）、"gte"（大于等于）等。

`AdvancedYearRoundSerializer` 和 `AdvancedRingRatioSerializer` 用于高级同比和环比算法。它们包含 `floor`（下限）、`floor_interval`（下限周期）、`ceil`（上限）和 `ceil_interval`（上限周期）等字段。`fetch_type` 字段指定历史数据的获取类型，可以是 "avg"（均值）或 "last"（顺时值）。

`IntelligentDetectSerializer` 用于智能异常检测算法，包含 `args`（算法参数）、`plan_id`（方案ID）和 `visual_type`（可视化类型）等字段。`AIServiceControlMixin` Mixin 提供了 `service_name` 和 `grey_to_bkfara` 等AI服务控制参数。

**Section sources**
- [serializers.py](file://bkmonitor/bkmonitor/strategy/serializers.py#L257-L272)
- [serializers.py](file://bkmonitor/bkmonitor/strategy/serializers.py#L125-L138)
- [serializers.py](file://bkmonitor/bkmonitor/strategy/serializers.py#L40-L72)
- [serializers.py](file://bkmonitor/bkmonitor/strategy/serializers.py#L167-L177)

## 场景差异与常量定义

`constants/strategy.py` 文件定义了不同场景下规则配置的差异。

`DataTarget` 枚举定义了监控的数据目标，包括 `NONE_TARGET`（无目标）、`SERVICE_TARGET`（服务目标）和 `HOST_TARGET`（主机目标）。`DATA_TARGET_MAP` 字典根据数据来源、数据类型和二级标签映射到具体的数据目标。

`HOST_SCENARIO` 和 `SERVICE_SCENARIO` 列表定义了主机和服务场景下的监控场景。主机场景包括 "os"（操作系统）、"host_process"（主机进程）和 "host_device"（主机设备）。服务场景包括 "service_module"（服务模块）、"component"（组件）和 "service_process"（服务进程）。

`EVENT_DETECT_LIST` 字典定义了系统事件对应的检测算法。例如，"os_restart" 对应 "OsRestart" 算法，"proc_port" 对应 "ProcPort" 算法。这些算法是特殊的，不需要配置具体的算法参数。

`EVENT_QUERY_CONFIG_MAP` 字典为系统事件提供了默认的查询配置。例如，"ping-gse" 事件的聚合维度包括 "bk_target_ip" 和 "bk_target_cloud_id"，聚合方法为 "MAX"，结果表ID为 "pingserver.base"。

`SourceType` 枚举定义了数据来源类型，如 "BKMONITOR"（监控采集）、"BKDATA"（计算平台）和 "CUSTOMEVENT"（自定义事件）。

**Section sources**
- [constants/strategy.py](file://bkmonitor/constants/strategy.py#L25-L30)
- [constants/strategy.py](file://bkmonitor/constants/strategy.py#L311-L312)
- [constants/strategy.py](file://bkmonitor/constants/strategy.py#L275-L280)
- [constants/strategy.py](file://bkmonitor/constants/strategy.py#L235-L273)
- [constants/strategy.py](file://bkmonitor/constants/strategy.py#L200-L205)

## 完整策略配置示例

以下是一个从UI创建到后端存储的完整策略配置示例，其JSON结构如下：

```json
{
  "name": "CPU使用率过高",
  "bk_biz_id": 2,
  "scenario": "os",
  "is_enabled": true,
  "item_list": [
    {
      "name": "CPU单核使用率",
      "data_source_label": "bk_monitor",
      "data_type_label": "time_series",
      "result_table_id": "system.cpu",
      "metric_field": "usage",
      "agg_method": "MAX",
      "agg_interval": 60,
      "agg_dimension": ["ip", "bk_cloud_id"],
      "agg_condition": [
        {
          "key": "ip",
          "method": "eq",
          "value": "127.0.0.1"
        }
      ],
      "algorithm_list": [
        {
          "algorithm_type": "Threshold",
          "algorithm_config": [
            [
              {
                "threshold": 90,
                "method": "gt"
              }
            ]
          ],
          "level": 1,
          "trigger_config": {
            "count": 3,
            "check_window": 5
          },
          "recovery_config": {
            "check_window": 5
          }
        }
      ],
      "target": [
        [
          {
            "field": "bk_target_ip",
            "value": "127.0.0.1",
            "method": "eq"
          }
        ]
      ]
    }
  ],
  "action_list": [
    {
      "action_type": "notice",
      "config": {
        "alarm_interval": 300,
        "send_recovery_alarm": true
      },
      "notice_group_list": [1]
    }
  ]
}
```

此配置定义了一个名为 "CPU使用率过高" 的策略，应用于业务ID为2的操作系统场景。它包含一个监控项，监控 "system.cpu" 结果表中的 "usage" 指标，聚合周期为60秒。监控目标为IP地址 "127.0.0.1"。检测算法为静态阈值，当CPU使用率大于90%并持续3个周期（共5分钟）时触发致命级别告警。告警将发送给ID为1的通知组。

**Section sources**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L142-L193)