# 性能监控

<cite>
**本文档引用的文件**   
- [transfer.py](file://bklog/apps/api/modules/transfer.py)
- [models.py](file://bklog/apps/log_measure/models.py)
- [metrics.py](file://bklog/apps/log_measure/handlers/metrics.py)
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py)
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py)
- [prometheus.py](file://bklog/apps/utils/prometheus.py)
</cite>

## 目录
1. [引言](#引言)
2. [性能指标采集机制](#性能指标采集机制)
3. [关键性能指标监控](#关键性能指标监控)
4. [数据模型与存储](#数据模型与存储)
5. [采样频率与聚合策略](#采样频率与聚合策略)
6. [性能趋势分析](#性能趋势分析)
7. [性能告警配置](#性能告警配置)
8. [结论](#结论)

## 引言
本文档详细分析了蓝鲸日志平台中的性能监控机制，重点阐述了基于transfer.py实现的性能指标采集系统。文档详细说明了如何监控关键性能指标，包括单次写入延迟、每秒写入文档数、批量请求成功率和连接池使用率等核心指标。同时，文档还解释了这些性能数据如何通过models.py中定义的数据模型进行存储和查询，以及如何生成分钟级和小时级的性能趋势图。最后，文档提供了基于历史基线的动态阈值告警配置示例，帮助及时发现转发性能劣化问题。

## 性能指标采集机制
性能指标采集机制基于Prometheus监控系统实现，通过在代码中注册指标并定期采集数据来实现对系统性能的全面监控。系统使用自定义的指标注册和采集框架，确保指标数据的准确性和一致性。

```mermaid
classDiagram
class Metric {
+metric_name : str
+metric_value : float
+dimensions : dict
+to_prometheus_text(namespace, timestamp) str
}
class BaseMetricCollector {
+biz_info : dict
+space_info : dict
+collect_interval : int
+report_ts : int
+time_range() tuple
+get_biz_name(bk_biz_id) str
+collect(namespaces, response_format) list
+registered_metrics() list
+list_metric_methods(namespaces) list
+append_total_metric(metrics) list
}
class MetricCollector {
+cluster_infos : dict
+_cluster_clients : dict
+list_cluster_info(cluster_id) list
+get_es_client_by_id(cluster_id) object
+get_es_client(cluster_info) object
+collect_host() list
}
BaseMetricCollector <|-- MetricCollector
MetricCollector --> Metric : "生成"
BaseMetricCollector --> Metric : "生成"
```

**图表来源**
- [metrics.py](file://bklog/apps/log_measure/handlers/metrics.py#L40-L298)

**本节来源**
- [metrics.py](file://bklog/apps/log_measure/handlers/metrics.py#L40-L298)

## 关键性能指标监控
系统监控多个关键性能指标，包括单次写入延迟、每秒写入文档数、批量请求成功率和连接池使用率等。这些指标通过不同的采集器定期收集，并通过Prometheus格式暴露给监控系统。

### 单次写入延迟监控
单次写入延迟指标通过记录每次写入操作的耗时来监控系统的响应性能。系统使用直方图（Histogram）来记录不同区间的延迟分布，便于分析性能瓶颈。

```mermaid
sequenceDiagram
participant 应用系统
participant 指标采集器
participant 监控系统
应用系统->>指标采集器 : 执行写入操作
指标采集器->>指标采集器 : 记录开始时间
应用系统->>应用系统 : 完成写入操作
指标采集器->>指标采集器 : 计算耗时并记录
指标采集器->>监控系统 : 暴露延迟指标
```

**图表来源**
- [metrics.py](file://bklog/apps/log_measure/handlers/metrics.py#L40-L298)

### 每秒写入文档数监控
每秒写入文档数指标通过统计单位时间内的写入请求数量来监控系统的吞吐能力。系统使用计数器（Counter）来累计写入请求数，并计算每秒的增量。

```mermaid
flowchart TD
Start([开始]) --> 记录写入请求["记录每次写入请求"]
记录写入请求 --> 更新计数器["更新总请求数计数器"]
更新计数器 --> 计算增量["计算每秒请求数增量"]
计算增量 --> 暴露指标["暴露每秒请求数指标"]
暴露指标 --> End([结束])
```

**图表来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L147-L167)

### 批量请求成功率监控
批量请求成功率指标通过统计成功和失败的批量请求数量来监控系统的稳定性。系统记录每个批量请求的结果，并计算成功率。

```mermaid
flowchart TD
Start([批量请求开始]) --> 执行请求["执行批量写入操作"]
执行请求 --> 检查结果{"请求成功?"}
检查结果 --> |是| 更新成功计数["成功计数器+1"]
检查结果 --> |否| 更新失败计数["失败计数器+1"]
更新成功计数 --> 计算成功率["计算成功率"]
更新失败计数 --> 计算成功率
计算成功率 --> 暴露指标["暴露成功率指标"]
暴露指标 --> End([结束])
```

**图表来源**
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L140-L169)

### 连接池使用率监控
连接池使用率指标通过监控连接池中活跃连接数和最大连接数的比例来评估系统的资源利用情况。系统定期采集连接池状态，并计算使用率。

```mermaid
flowchart TD
Start([定时任务]) --> 获取连接池状态["获取连接池当前状态"]
获取连接池状态 --> 计算使用率["计算连接池使用率"]
计算使用率 --> 检查阈值{"使用率>阈值?"}
检查阈值 --> |是| 触发告警["触发高使用率告警"]
检查阈值 --> |否| 记录指标["记录连接池使用率"]
触发告警 --> 记录指标
记录指标 --> 暴露指标["暴露连接池使用率指标"]
暴露指标 --> End([结束])
```

**图表来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L226-L257)

**本节来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L55-L516)
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L136-L285)

## 数据模型与存储
性能数据通过models.py中定义的数据模型进行存储和管理。系统使用Django ORM框架来定义数据表结构，并提供数据访问接口。

```mermaid
erDiagram
ACCESS_INDEX_SET {
int project_id PK
int index_set_id PK
int nums
date static_date PK
}
METRIC_DATA_HISTORY {
string metric_id PK
text metric_data
int updated_at
}
ACCESS_INDEX_SET ||--o{ METRIC_DATA_HISTORY : "关联"
```

**图表来源**
- [models.py](file://bklog/apps/log_measure/models.py#L28-L44)

### 数据模型定义
系统定义了两个主要的数据模型：AccessIndexSet用于存储索引集访问统计，MetricDataHistory用于存储指标数据历史。

```mermaid
classDiagram
class AccessIndexSet {
+project_id : int
+index_set_id : int
+nums : int
+static_date : date
+Meta : class
}
class MetricDataHistory {
+metric_id : string
+metric_data : text
+updated_at : int
+Meta : class
}
AccessIndexSet : verbose_name = "索引集搜索统计"
AccessIndexSet : verbose_name_plural = "索引集搜索统计"
AccessIndexSet : unique_together = (("project_id", "index_set_id", "static_date", "created_by"),)
MetricDataHistory : metric_id = models.CharField(_("指标ID"), max_length=128, db_index=True)
MetricDataHistory : metric_data = models.TextField(_("指标数据"))
MetricDataHistory : updated_at = models.IntegerField(_("指标时间戳"))
```

**图表来源**
- [models.py](file://bklog/apps/log_measure/models.py#L28-L44)

### 数据查询机制
系统通过Django ORM提供的查询接口来访问性能数据。查询操作支持按项目ID、索引集ID、日期范围等条件进行过滤。

```mermaid
sequenceDiagram
participant 查询接口
participant ORM框架
participant 数据库
查询接口->>ORM框架 : 构建查询条件
ORM框架->>ORM框架 : 生成SQL语句
ORM框架->>数据库 : 执行查询
数据库-->>ORM框架 : 返回查询结果
ORM框架-->>查询接口 : 返回对象列表
查询接口-->>调用者 : 返回性能数据
```

**图表来源**
- [models.py](file://bklog/apps/log_measure/models.py#L28-L44)

**本节来源**
- [models.py](file://bklog/apps/log_measure/models.py#L28-L44)

## 采样频率与聚合策略
系统采用不同的采样频率和聚合策略来处理不同类型的性能指标，确保既能及时反映系统状态，又不会产生过多的数据存储开销。

### 采样频率配置
系统根据指标的重要性和变化频率设置了不同的采样间隔。核心性能指标采用较短的采样间隔，而统计类指标采用较长的采样间隔。

```mermaid
flowchart TD
Start([指标分类]) --> 核心性能指标["核心性能指标\n(延迟、吞吐量)"]
Start --> 统计类指标["统计类指标\n(访问次数、配置数)"]
Start --> 资源使用指标["资源使用指标\n(连接池、内存)"]
核心性能指标 --> 采样间隔5分钟["采样间隔: 5分钟"]
统计类指标 --> 采样间隔60分钟["采样间隔: 60分钟"]
资源使用指标 --> 采样间隔5分钟["采样间隔: 5分钟"]
采样间隔5分钟 --> 高频采集["高频采集策略"]
采样间隔60分钟 --> 低频采集["低频采集策略"]
采样间隔5分钟 --> 高频采集
```

**图表来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L57-L92)
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L55-L111)

### 聚合策略实现
系统采用多种聚合策略来处理采集到的原始数据，包括求和、平均值、最大值、最小值等，以生成更有意义的性能指标。

```mermaid
flowchart TD
Start([原始数据]) --> 数据分组["按维度分组\n(业务ID、采集场景等)"]
数据分组 --> 聚合计算["执行聚合计算"]
聚合计算 --> 求和["求和(SUM)"]
聚合计算 --> 平均值["平均值(AVG)"]
聚合计算 --> 最大值["最大值(MAX)"]
聚合计算 --> 最小值["最小值(MIN)"]
聚合计算 --> 计数["计数(COUNT)"]
求和 --> 生成指标["生成聚合指标"]
平均值 --> 生成指标
最大值 --> 生成指标
最小值 --> 生成指标
计数 --> 生成指标
生成指标 --> 存储指标["存储聚合指标"]
```

**图表来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L59-L87)
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L142-L168)

**本节来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L55-L516)
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L136-L285)

## 性能趋势分析
系统通过生成分钟级和小时级的性能趋势图来帮助分析系统性能的变化趋势，及时发现潜在的性能问题。

### 分钟级趋势分析
分钟级趋势图用于监控系统在短时间内的性能变化，适合用于实时监控和快速故障排查。

```mermaid
flowchart TD
Start([采集原始数据]) --> 按分钟分组["按分钟对数据分组"]
按分钟分组 --> 计算每分钟指标["计算每分钟的性能指标"]
计算每分钟指标 --> 生成时间序列["生成分钟级时间序列"]
生成时间序列 --> 绘制趋势图["绘制分钟级趋势图"]
绘制趋势图 --> 分析短期趋势["分析短期性能趋势"]
分析短期趋势 --> 检测异常["检测性能异常"]
检测异常 --> 触发告警["触发实时告警"]
```

**图表来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L147-L167)

### 小时级趋势分析
小时级趋势图用于分析系统在较长时间内的性能变化趋势，适合用于容量规划和长期性能优化。

```mermaid
flowchart TD
Start([采集分钟级数据]) --> 按小时聚合["按小时对数据聚合"]
按小时聚合 --> 计算每小时指标["计算每小时的性能指标"]
计算每小时指标 --> 生成时间序列["生成小时级时间序列"]
生成时间序列 --> 绘制趋势图["绘制小时级趋势图"]
绘制趋势图 --> 分析长期趋势["分析长期性能趋势"]
分析长期趋势 --> 识别模式["识别性能模式"]
识别模式 --> 容量规划["支持容量规划决策"]
```

**图表来源**
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L226-L257)

### 趋势图生成流程
系统通过一系列步骤将原始性能数据转换为可视化趋势图，为运维人员提供直观的性能视图。

```mermaid
sequenceDiagram
participant 数据采集器
participant 数据聚合器
participant 图表生成器
participant 可视化系统
数据采集器->>数据聚合器 : 提供原始性能数据
数据聚合器->>数据聚合器 : 按时间粒度聚合数据
数据聚合器->>图表生成器 : 提供聚合后的数据
图表生成器->>图表生成器 : 生成图表数据结构
图表生成器->>可视化系统 : 提供图表数据
可视化系统->>用户 : 显示性能趋势图
```

**图表来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L147-L167)
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L226-L257)

**本节来源**
- [log_databus.py](file://bklog/apps/log_measure/handlers/metric_collectors/log_databus.py#L147-L167)
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L226-L257)

## 性能告警配置
系统支持基于历史基线的动态阈值告警配置，能够根据历史性能数据自动调整告警阈值，减少误报和漏报。

### 动态阈值告警原理
动态阈值告警通过分析历史性能数据的统计特征来确定合理的告警阈值，而不是使用固定的静态阈值。

```mermaid
flowchart TD
Start([历史性能数据]) --> 计算统计量["计算历史数据统计量\n(均值、标准差等)"]
计算统计量 --> 确定基线["确定性能基线"]
确定基线 --> 计算动态阈值["计算动态告警阈值"]
计算动态阈值 --> 监控实时数据["监控实时性能数据"]
监控实时数据 --> 比较阈值{"实时值>动态阈值?"}
比较阈值 --> |是| 触发告警["触发性能劣化告警"]
比较阈值 --> |否| 继续监控["继续监控"]
触发告警 --> 记录告警["记录告警事件"]
记录告警 --> 通知运维["通知运维人员"]
```

**图表来源**
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L58-L107)

### 告警配置示例
以下是一个基于历史基线的动态阈值告警配置示例，用于监控转发性能劣化问题。

```mermaid
classDiagram
class AlertConfig {
+alert_name : str
+metric_name : str
+base_line_days : int
+threshold_multiplier : float
+evaluation_window : int
+alert_severity : str
+notification_channels : list
+enabled : bool
}
class AlertRule {
+rule_id : str
+condition : str
+expression : str
+for_duration : str
+labels : dict
+annotations : dict
}
class AlertHistory {
+alert_id : str
+triggered_at : datetime
+resolved_at : datetime
+duration : int
+severity : str
+description : str
}
AlertConfig --> AlertRule : "生成"
AlertRule --> AlertHistory : "记录"
AlertConfig : alert_name = "转发性能劣化告警"
AlertConfig : metric_name = "transfer_latency"
AlertConfig : base_line_days = 7
AlertConfig : threshold_multiplier = 2.0
AlertConfig : evaluation_window = 300
AlertConfig : alert_severity = "critical"
```

**图表来源**
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L58-L107)

### 告警处理流程
当系统检测到性能劣化时，会按照预定义的流程处理告警事件，确保问题能够及时得到响应。

```mermaid
sequenceDiagram
participant 监控系统
participant 告警引擎
participant 通知系统
participant 运维团队
监控系统->>告警引擎 : 检测到性能异常
告警引擎->>告警引擎 : 验证告警条件
告警引擎->>告警引擎 : 生成告警事件
告警引擎->>通知系统 : 发送告警通知
通知系统->>运维团队 : 通过多种渠道通知
运维团队->>监控系统 : 确认告警
监控系统->>告警引擎 : 更新告警状态
告警引擎->>告警引擎 : 记录处理过程
告警引擎->>监控系统 : 关闭已解决告警
```

**图表来源**
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L58-L107)

**本节来源**
- [business.py](file://bklog/apps/log_measure/handlers/metric_collectors/business.py#L55-L111)

## 结论
本文档详细分析了蓝鲸日志平台的性能监控机制，重点阐述了基于transfer.py实现的性能指标采集系统。系统通过Prometheus监控框架实现了对单次写入延迟、每秒写入文档数、批量请求成功率和连接池使用率等关键性能指标的全面监控。性能数据通过models.py中定义的数据模型进行存储和查询，并采用不同的采样频率和聚合策略来生成分钟级和小时级的性能趋势图。系统还支持基于历史基线的动态阈值告警配置，能够及时发现转发性能劣化问题。这套性能监控机制为系统的稳定运行提供了有力保障，帮助运维人员及时发现和解决性能问题。