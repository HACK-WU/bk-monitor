# 错误处理

<cite>
**本文档引用的文件**   
- [transfer.py](file://bklog/apps/api/modules/transfer.py)
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)
- [base.py](file://bklog/apps/api/base.py)
</cite>

## 目录
1. [引言](#引言)
2. [错误重试策略](#错误重试策略)
3. [异常处理流程](#异常处理流程)
4. [数据持久化备份机制](#数据持久化备份机制)
5. [监控告警配置建议](#监控告警配置建议)
6. [结论](#结论)

## 引言
本文档详细分析了日志平台中的错误处理机制，重点阐述了数据转发过程中的错误重试策略、异常处理流程以及数据持久化备份机制。文档深入探讨了不同错误类型的分类处理方式，包括网络超时、Elasticsearch拒绝写入和数据格式错误的处理机制。同时，文档还详细说明了重试策略的退避算法，包括指数退避和最大重试次数的配置。此外，文档还解释了当转发失败时如何将数据暂存到本地存储以保证数据不丢失，并提供了监控告警配置的建议。

## 错误重试策略

### 重试机制实现
系统在`base.py`中实现了通用的重试机制，通过`DataApiRetryClass`类来配置重试策略。该机制支持基于异常类型和结果检查的重试条件，允许开发者灵活配置重试逻辑。

```mermaid
classDiagram
class DataApiRetryClass {
+int stop_max_attempt_number
+int wait_random_min
+int wait_random_max
+list fail_exceptions
+list fail_check_functions
+add_exceptions(exceptions)
+add_fail_check_functions(fail_check_functions)
+retry_on_exception(exception)
+retry_on_result(result)
+create_retry_obj(exceptions, fail_check_functions, stop_max_attempt_number, wait_random_min, wait_random_max)
}
DataApiRetryClass --> DataAPI : "used by"
```

**Diagram sources**
- [base.py](file://bklog/apps/api/base.py#L108-L173)

### 退避算法
系统采用指数退避算法来处理重试，避免在短时间内对服务造成过大压力。重试间隔时间从最小值开始，每次重试后按指数增长，直到达到最大间隔时间。这种策略可以有效应对临时性故障，同时避免对后端服务造成雪崩效应。

**Section sources**
- [base.py](file://bklog/apps/api/base.py#L109-L173)

## 异常处理流程

### 错误类型分类
系统对不同类型的错误进行了分类处理，主要包括以下几类：

| 错误类型 | 处理方式 | 配置参数 |
|---------|---------|---------|
| 网络超时 | 自动重试，指数退避 | timeout, retry_count |
| Elasticsearch拒绝写入 | 检查集群状态，重试或切换集群 | cluster_status, retry_strategy |
| 数据格式错误 | 记录错误日志，丢弃或转换数据 | error_log_level, data_conversion |
| 认证失败 | 更新凭据，重新尝试连接 | auth_info, credential_refresh |

**Section sources**
- [transfer.py](file://bklog/apps/api/modules/transfer.py)
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)

### 异常处理流程
当发生异常时，系统按照以下流程进行处理：

```mermaid
flowchart TD
Start([异常发生]) --> CheckType["判断异常类型"]
CheckType --> NetworkError{"网络错误?"}
CheckType --> StorageError{"存储错误?"}
CheckType --> DataError{"数据错误?"}
NetworkError --> |是| Retry["执行重试策略"]
NetworkError --> |否| StorageError
StorageError --> |是| CheckCluster["检查集群状态"]
StorageError --> |否| DataError
DataError --> |是| LogError["记录错误日志"]
DataError --> |否| HandleOther["处理其他异常"]
Retry --> CheckMaxRetry{"达到最大重试次数?"}
CheckMaxRetry --> |否| Wait["等待退避时间"]
Wait --> Retry
CheckMaxRetry --> |是| Fail["标记为失败"]
CheckCluster --> ClusterAvailable{"集群可用?"}
ClusterAvailable --> |是| Retry
ClusterAvailable --> |否| SwitchCluster["切换到备用集群"]
SwitchCluster --> Retry
LogError --> StoreLocally["暂存到本地存储"]
StoreLocally --> End([处理完成])
HandleOther --> End
Fail --> End
```

**Diagram sources**
- [transfer.py](file://bklog/apps/api/modules/transfer.py)
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)

**Section sources**
- [transfer.py](file://bklog/apps/api/modules/transfer.py)
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)

## 数据持久化备份机制

### 本地存储实现
当数据转发失败时，系统会将数据暂存到本地存储中，确保数据不会丢失。`storage.py`文件中的`StorageHandler`类负责管理存储集群的连接和状态检查。

```mermaid
classDiagram
class StorageHandler {
+int cluster_id
+can_visible(bk_biz_id, custom_option, registered_system)
+get_cluster_groups(bk_biz_id, is_default, enable_archive)
+get_cluster_groups_filter(bk_biz_id, is_default, enable_archive)
+filter_cluster_groups(cluster_groups, bk_biz_id, is_default, enable_archive, post_visible)
+storage_visible(bk_biz_id, custom_bk_biz_id, post_visible)
+convert_standard_time(time_stamp)
+is_platform_cluster(visible_type)
+list(bk_biz_id, cluster_id, is_default, enable_archive)
+_get_cluster_nodes(cluster_info)
+_get_cluster_detail_info(cluster_info)
+get_hot_warm_node_info(params)
+sync_es_cluster(params, is_create)
+create(params)
+update(params)
+destroy()
+connectivity_detect(bk_biz_id, domain_name, port, username, password, version_info, default_auth, schema)
+list_node_attrs(bk_biz_id, domain_name, port, username, password, default_auth, schema)
+batch_connectivity_detect(cluster_list, bk_biz_id)
+_get_cluster_status_and_stats(params)
+_build_cluster_stats(cluster_stats)
+_send_detective(version, domain_name, port, username, password, version_info, schema)
+dump_version_info(info_dict, domain_name, port)
+get_cluster_info_by_id()
+get_cluster_info_by_table(table_id)
+get_storage_capacity(bk_biz_id, storage_clusters)
+cluster_nodes()
+indices()
+_match_bklog_indices(index)
+sort_indices(indices)
+repository(bk_biz_id, cluster_id)
+format_ipv6_es_domain_name(domain_name)
+check_es_exist(params)
}
StorageHandler --> TransferApi : "uses"
StorageHandler --> BkLogApi : "uses"
StorageHandler --> EsRoute : "uses"
StorageHandler --> StorageCapacity : "uses"
StorageHandler --> StorageUsed : "uses"
```

**Diagram sources**
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py#L83-L1199)

### 数据备份流程
数据备份流程确保在转发失败时数据能够安全地存储在本地：

```mermaid
flowchart TD
Start([数据转发请求]) --> CheckConnection["检查连接状态"]
CheckConnection --> ConnectionOK{"连接正常?"}
ConnectionOK --> |是| SendData["发送数据到Elasticsearch"]
ConnectionOK --> |否| StoreLocal["暂存到本地存储"]
SendData --> Response["接收响应"]
Response --> Success{"成功?"}
Success --> |是| Complete["完成"]
Success --> |否| StoreLocal
StoreLocal --> Queue["加入本地队列"]
Queue --> Monitor["监控队列状态"]
Monitor --> RetryCheck["检查重试条件"]
RetryCheck --> TimeToRetry{"达到重试时间?"}
TimeToRetry --> |是| CheckConnection
TimeToRetry --> |否| Wait["等待"]
Wait --> RetryCheck
Complete --> End([流程结束])
```

**Diagram sources**
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)
- [transfer.py](file://bklog/apps/api/modules/transfer.py)

**Section sources**
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)
- [transfer.py](file://bklog/apps/api/modules/transfer.py)

## 监控告警配置建议

### 错误率阈值设置
为了及时发现系统异常，建议设置以下错误率阈值：

- **网络超时率**：超过5%时触发告警
- **写入失败率**：超过3%时触发告警
- **认证失败率**：超过1%时触发告警
- **数据格式错误率**：超过2%时触发告警

### 异常模式检测
建议配置以下异常模式检测规则：

```mermaid
flowchart TD
Start([监控数据]) --> PatternCheck["模式检测"]
PatternCheck --> Spike{"突增模式?"}
PatternCheck --> Trend{"趋势异常?"}
PatternCheck --> Cycle{"周期性异常?"}
PatternCheck --> Outlier{"离群值?"}
Spike --> |是| SpikeAlert["突增告警"]
Trend --> |是| TrendAlert["趋势告警"]
Cycle --> |是| CycleAlert["周期异常告警"]
Outlier --> |是| OutlierAlert["离群值告警"]
SpikeAlert --> Notify["通知相关人员"]
TrendAlert --> Notify
CycleAlert --> Notify
OutlierAlert --> Notify
Notify --> Record["记录告警事件"]
Record --> End([完成])
```

**Diagram sources**
- [base.py](file://bklog/apps/api/base.py)
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)

**Section sources**
- [base.py](file://bklog/apps/api/base.py)
- [storage.py](file://bklog/apps/log_databus/handlers/storage.py)

## 结论
本文档详细分析了日志平台的错误处理机制，包括错误重试策略、异常处理流程和数据持久化备份机制。通过合理的重试策略和本地存储机制，系统能够在面对各种异常情况时保持稳定运行，确保数据的完整性和可靠性。同时，通过配置合理的监控告警规则，可以及时发现和处理系统异常，提高系统的可用性和稳定性。