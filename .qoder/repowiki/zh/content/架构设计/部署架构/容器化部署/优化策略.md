# 优化策略

<cite>
**本文档引用的文件**
- [Dockerfile](file://bklog/Dockerfile)
- [gunicorn_config.py](file://bklog/gunicorn_config.py)
- [app.yml](file://bklog/app.yml)
- [settings.py](file://bklog/settings.py)
- [prod.py](file://bklog/config/prod.py)
- [default.py](file://bklog/config/default.py)
- [dev.env.yml](file://bklog/dev.env.yml)
- [prod.env.yml](file://bklog/prod.env.yml)
- [healthz.py](file://bklog/home_application/management/commands/healthz.py)
- [metrics.py](file://bklog/apps/log_measure/handlers/metrics.py)
- [prometheus.py](file://bklog/apps/utils/prometheus.py)
</cite>

## 目录
1. [引言](#引言)
2. [Gunicorn工作进程与容器资源匹配](#gunicorn工作进程与容器资源匹配)
3. [健康检查配置最佳实践](#健康检查配置最佳实践)
4. [日志收集策略](#日志收集策略)
5. [资源限制配置示例](#资源限制配置示例)
6. [监控指标暴露配置](#监控指标暴露配置)

## 引言
BK-LOG是一个基于全文检索引擎的日志平台SaaS，通过蓝鲸智云专属agent进行日志采集，实现集中管理所有日志。本文档重点描述BK-LOG在容器化部署环境下的性能优化策略，涵盖Gunicorn工作进程配置、健康检查、日志收集、资源限制和监控指标暴露等关键方面。

## Gunicorn工作进程与容器资源匹配
BK-LOG使用Gunicorn作为WSGI HTTP服务器，其工作进程配置对性能有重要影响。根据`gunicorn_config.py`文件，当前配置了8个工作进程（`workers = 8`），但未指定worker类型。在容器化部署中，应根据CPU和内存配额动态调整worker数量。

建议的优化策略：
- **worker数量计算**：通常设置为 `(2 * CPU核心数) + 1`。对于容器环境，应基于分配的CPU限制而非物理核心数。
- **worker类型选择**：当前配置注释了`worker_class = 'gevent'`，建议在高并发场景下启用gevent异步worker以提高吞吐量。
- **内存考虑**：每个worker进程会消耗一定内存，需确保总内存需求不超过容器内存限制。建议预留至少20%内存给系统和其他进程。

**Section sources**
- [gunicorn_config.py](file://bklog/gunicorn_config.py#L42-L43)
- [default.py](file://bklog/config/default.py#L34)

## 健康检查配置最佳实践
BK-LOG提供了完善的健康检查机制，通过`healthz.py`命令实现。健康检查应合理配置liveness、readiness和startup探针，确保容器的稳定运行。

**liveness探针**：用于检测应用是否存活，失败时会重启容器。建议配置：
- 路径：`/healthz/`
- 初始延迟：60秒（给应用足够启动时间）
- 检查间隔：30秒
- 失败阈值：3次

**readiness探针**：用于检测应用是否准备好接收流量，失败时会从服务端点中移除该实例。建议配置：
- 路径：`/healthz/ready/`
- 初始延迟：30秒
- 检查间隔：10秒
- 失败阈值：3次

**startup探针**：用于检测应用是否完成启动过程，在启动期间会禁用liveness和readiness探针。建议配置：
- 路径：`/healthz/startup/`
- 初始延迟：10秒
- 检查间隔：10秒
- 失败阈值：30次（允许较长的启动时间）

**Section sources**
- [healthz.py](file://bklog/home_application/management/commands/healthz.py#L25-L49)

## 日志收集策略
BK-LOG采用标准输出作为日志输出目标，便于被外部系统（如Filebeat）收集。根据`default.py`中的日志配置，在Kubernetes部署模式下，日志以JSON格式输出到stdout。

关键配置要点：
- **日志格式**：使用JSON格式，包含级别、时间戳、文件路径、行号、函数名等结构化信息。
- **日志级别**：生产环境建议设置为"ERROR"，开发环境可设置为"INFO"。
- **OTLP日志上报**：可通过环境变量`BKAPP_OTLP_LOG=on`启用OTLP日志上报功能。

日志收集流程：
1. 应用将日志输出到stdout/stderr
2. Kubernetes节点上的Filebeat收集容器日志
3. Filebeat将日志发送到日志处理系统（如Elasticsearch）

**Section sources**
- [default.py](file://bklog/config/default.py#L290-L363)

## 资源限制配置示例
合理的资源限制配置对保障应用稳定性和集群资源利用率至关重要。根据`app.yml`文件，BK-LOG默认配置了4096MB内存。

推荐的资源配置示例：
```yaml
resources:
  requests:
    cpu: "2"
    memory: "4Gi"
  limits:
    cpu: "4"
    memory: "8Gi"
```

配置说明：
- **CPU请求**：2核，确保应用有足够CPU资源运行
- **CPU限制**：4核，防止单个实例占用过多CPU影响其他服务
- **内存请求**：4GB，基于`app.yml`中的配置
- **内存限制**：8GB，提供足够的内存缓冲，避免因临时内存 spikes 导致OOMKilled

环境变量配置：
- `BKAPP_REDIS_VERSION`: Redis版本
- `BKAPP_BULK_REQUEST_LIMIT`: 批量请求限制
- `DEPLOY_MODE`: 部署模式，kubernetes时启用特定配置

**Section sources**
- [app.yml](file://bklog/app.yml#L15)
- [default.py](file://bklog/config/default.py#L439-L440)
- [prod.py](file://bklog/config/prod.py#L103-L116)

## 监控指标暴露配置
BK-LOG集成了Prometheus监控指标暴露功能，便于与蓝鲸监控系统集成。通过`prometheus.py`中的自定义注册表实现指标收集和上报。

配置要点：
- **指标注册表**：使用`BkLogRegistry`继承`CollectorRegistry`，在每次收集后清空指标数据，避免多实例部署时的指标累加问题。
- **指标命名空间**：使用`django_prometheus`的命名空间配置。
- **环境标识**：通过`BKPAAS_ENVIRONMENT`环境变量获取部署环境（dev/stag/prod）。

Prometheus指标暴露路径：
- `/metrics/`: 暴露所有注册的Prometheus格式指标
- 支持通过`list_metric_methods`按命名空间筛选指标

监控指标类型：
- Django内置指标（请求计数、响应时间等）
- 自定义业务指标（通过`metrics.py`中的`@metric`装饰器定义）
- 系统指标（CPU、内存使用率等）

**Section sources**
- [prometheus.py](file://bklog/apps/utils/prometheus.py#L1-L42)
- [metrics.py](file://bklog/apps/log_measure/handlers/metrics.py#L145-L186)