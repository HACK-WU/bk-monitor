# 容器化部署

<cite>
**本文档引用文件**  
- [Dockerfile](file://bklog/Dockerfile)
- [settings.py](file://bklog/settings.py)
- [app.yml](file://bklog/app.yml)
- [dev.env.yml](file://bklog/dev.env.yml)
- [stag.env.yml](file://bklog/stag.env.yml)
- [prod.env.yml](file://bklog/prod.env.yml)
- [env.py](file://bklog/config/env.py)
- [default.py](file://bklog/config/default.py)
- [dev.py](file://bklog/config/dev.py)
- [stag.py](file://bklog/config/stag.py)
- [prod.py](file://bklog/config/prod.py)
</cite>

## 目录
1. [Docker镜像构建机制](#docker镜像构建机制)
2. [环境配置与加载机制](#环境配置与加载机制)
3. [多阶段构建与镜像优化](#多阶段构建与镜像优化)
4. [容器运行与启动配置](#容器运行与启动配置)
5. [docker-compose配置示例](#docker-compose配置示例)
6. [日志收集策略](#日志收集策略)
7. [性能调优建议](#性能调优建议)
8. [安全加固措施](#安全加固措施)

## Docker镜像构建机制

BK-LOG系统的Docker镜像构建采用多阶段构建策略，通过`ARG`指令定义基础镜像参数，使用`FROM`指令指定基础镜像为`TencentOS`最小化镜像，确保镜像体积小且安全。构建过程分为两个阶段：构建阶段（builder）和运行阶段。在构建阶段，通过`COPY`指令从外部引入`uv`工具用于Python依赖管理，安装必要的编译工具链（如gcc、make等），并复制项目代码到容器内。随后使用`uv`创建虚拟环境并安装`requirements.txt`中定义的Python依赖，指定腾讯镜像源以加速下载。

**构建指令解析**：
- `ARG PYTHON_BASE_IMAGE`：允许在构建时通过参数覆盖基础镜像
- `COPY --from=ghcr.io/astral-sh/uv:latest /uv /uvx /bin/`：从外部镜像复制uv工具，实现高效的Python包管理
- `RUN uv venv venv --seed --link-mode=copy`：创建虚拟环境并安装依赖，使用copy链接模式避免符号链接问题
- `ENV`指令设置虚拟环境路径和`C_FORCE_ROOT`环境变量，确保Celery等组件在root用户下正常运行

**Section sources**
- [Dockerfile](file://bklog/Dockerfile#L1-L23)

## 环境配置与加载机制

BK-LOG系统采用灵活的环境配置加载机制，通过`settings.py`文件中的环境判断逻辑区分开发、预发布和生产环境。系统优先检查`BKPAAS_ENVIRONMENT`环境变量，若不存在则回退到`BK_ENV`变量，实现与蓝鲸PaaS平台的无缝集成。配置加载流程如下：首先根据环境变量确定配置模块（如`config.dev`、`config.stag`或`config.prod`），然后通过Python的`importlib`动态导入对应配置模块。

环境配置文件（如`dev.env.yml`、`stag.env.yml`、`prod.env.yml`）采用YAML格式，包含系统标题、页脚、API网关地址等前端和后端配置。`config/env.py`中的`load_env()`函数负责加载这些YAML文件，并通过`FancyDict`类实现字典属性访问语法。配置值支持格式化字符串，可引用其他配置项或环境变量，如`{env.BK_PAAS_HOST}`。

`default.py`作为默认配置文件，定义了所有环境共享的配置，包括Django设置、中间件、应用列表、权限配置等。环境特定配置通过`load_settings()`函数合并到默认配置中，实现配置的继承和覆盖。

**Section sources**
- [settings.py](file://bklog/settings.py#L24-L47)
- [env.py](file://bklog/config/env.py#L27-L112)
- [default.py](file://bklog/config/default.py#L22-L800)
- [dev.py](file://bklog/config/dev.py#L22-L112)
- [stag.py](file://bklog/config/stag.py#L22-L106)
- [prod.py](file://bklog/config/prod.py#L22-L121)

## 多阶段构建与镜像优化

BK-LOG系统采用多阶段Docker构建策略，有效分离构建环境和运行环境。构建阶段包含完整的编译工具链和Python开发依赖，而最终镜像仅包含运行时所需的Python解释器、应用代码和生产依赖，显著减小镜像体积。通过使用`TencentOS`最小化基础镜像，避免了通用Linux发行版中不必要的软件包。

镜像优化措施包括：
- 使用`--no-cache-dir`参数避免在镜像中保留pip缓存
- 采用`uv`工具替代传统`pip`，提升依赖安装速度
- 将依赖安装与代码复制分离，利用Docker层缓存机制，仅在`requirements.txt`变更时重新安装依赖
- 通过`--link-mode=copy`确保虚拟环境中文件的独立性，避免容器间依赖冲突

最终镜像仅包含应用运行所需的最小化环境，提高了安全性和部署效率。

**Section sources**
- [Dockerfile](file://bklog/Dockerfile#L1-L23)

## 容器运行与启动配置

容器启动时通过`CMD`指令执行`python manage.py migrate`命令，确保数据库迁移在应用启动前完成。环境变量在容器化部署中扮演关键角色，如`DEPLOY_MODE`用于判断是否为Kubernetes部署模式，`IS_K8S_DEPLOY_MODE`据此设置不同的静态资源路径和数据库配置。

在`prod.py`中，当`DEPLOY_MODE`为"kubernetes"时，数据库配置从环境变量（如`DB_NAME`、`DB_USERNAME`等）动态加载，实现与Kubernetes Secrets的集成。日志级别通过`LOG_LEVEL`环境变量控制，生产环境默认为"ERROR"，预发布环境为"INFO"，便于不同环境下的日志管理。

**Section sources**
- [Dockerfile](file://bklog/Dockerfile#L22)
- [prod.py](file://bklog/config/prod.py#L103-L121)

## docker-compose配置示例

虽然项目中未直接提供`docker-compose.yml`文件，但基于配置文件可以推断出典型的服务编排结构。BK-LOG系统通常需要与MySQL、Redis、Elasticsearch等服务协同工作。一个典型的`docker-compose`配置应包含以下服务：

```yaml
version: '3'
services:
  bklog-web:
    build: .
    environment:
      - BKPAAS_ENVIRONMENT=prod
      - DB_HOST=mysql
      - DB_PORT=3306
      - REDIS_HOST=redis
    depends_on:
      - mysql
      - redis
      - elasticsearch
    ports:
      - "8000:8000"
    networks:
      - bklog-network

  mysql:
    image: mysql:5.7
    environment:
      MYSQL_DATABASE: bklog
      MYSQL_ROOT_PASSWORD: password
    networks:
      - bklog-network

  redis:
    image: redis:6-alpine
    networks:
      - bklog-network

  elasticsearch:
    image: elasticsearch:7.10.1
    environment:
      - discovery.type=single-node
    networks:
      - bklog-network

networks:
  bklog-network:
    driver: bridge
```

此配置展示了服务间的依赖关系（`depends_on`）和自定义网络（`bklog-network`），确保服务间通信的安全性和隔离性。

**Section sources**
- [app.yml](file://bklog/app.yml#L1-L19)
- [prod.py](file://bklog/config/prod.py#L107-L117)

## 日志收集策略

BK-LOG系统在容器化环境下的日志收集遵循"十二要素应用"原则，将所有日志输出到标准输出（stdout）和标准错误（stderr）。在`default.py`中，当`IS_K8S_DEPLOY_MODE`为真时，日志配置被重写为使用`StreamHandler`输出到`sys.stdout`，并采用JSON格式化日志，便于外部系统（如ELK、Prometheus）收集和解析。

日志格式包含关键上下文信息，如日志级别、时间戳、文件路径、行号、函数名、进程ID、线程ID和消息内容。对于分布式追踪，日志中还包含`otelTraceID`和`otelSpanID`字段，实现与OpenTelemetry生态的集成。通过环境变量`BKAPP_OTLP_LOG`可开启OTLP日志上报，将日志直接发送到指定的OTLP接收器。

**Section sources**
- [default.py](file://bklog/config/default.py#L290-L363)

## 性能调优建议

BK-LOG系统的容器化部署提供多项性能调优配置。在`app.yml`中，通过`container.memory: 4096`指定容器内存限制为4GB，防止内存溢出。Celery并发数通过`BK_CELERYD_CONCURRENCY`环境变量控制，默认为2，可根据CPU配额调整。

健康检查配置虽未在代码中直接体现，但建议在Kubernetes或Docker Compose中设置HTTP健康检查探针，检查`/healthz`端点。对于数据库连接，使用`django_dbconn_retry`应用实现连接重试，提高系统稳定性。

在`settings.py`中，`BULK_REQUEST_LIMIT`环境变量控制批量请求的大小，默认为500，可根据网络带宽和处理能力调整。对于高负载场景，建议配置Celery的高优先级队列（通过`BK_LOG_HIGH_PRIORITY_QUEUE`环境变量），确保关键任务及时处理。

**Section sources**
- [app.yml](file://bklog/app.yml#L1-L19)
- [default.py](file://bklog/config/default.py#L196-L206)
- [default.py](file://bklog/config/default.py#L437)

## 安全加固措施

BK-LOG系统的容器化部署包含多项安全加固措施。基础镜像选用`TencentOS`最小化版本，减少攻击面。通过`uv`工具从腾讯镜像源安装Python包，避免依赖供应链攻击。

在配置层面，数据库凭据等敏感信息不硬编码在代码中，而是通过环境变量（如`DB_USERNAME`、`DB_PASSWORD`）注入，建议在生产环境中使用Kubernetes Secrets管理。`FEATURE_TOGGLE`配置允许动态开关功能特性，如日志脱敏、客户端日志采集等，实现按需启用安全功能。

Django的安全中间件（如`SecurityMiddleware`）已启用，提供基础的Web应用安全防护。对于API访问，通过JWT认证和蓝鲸网关实现细粒度的访问控制，确保只有授权服务和用户才能访问系统接口。

**Section sources**
- [Dockerfile](file://bklog/Dockerfile#L1-L23)
- [default.py](file://bklog/config/default.py#L130-L134)
- [default.py](file://bklog/config/default.py#L582-L608)