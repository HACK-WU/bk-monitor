# 监控机制

<cite>
**本文档引用的文件**
- [supervisord.conf](file://support-files/supervisord.conf)
- [#etc#supervisor-bklog-api.conf](file://support-files/templates/#etc#supervisor-bklog-api.conf)
- [#etc#supervisor-bklog-grafana.conf](file://support-files/templates/#etc#supervisor-bklog-grafana.conf)
- [healthz.py](file://home_application/handlers/healthz.py)
- [metrics.py](file://home_application/handlers/metrics.py)
- [monitor.py](file://bk_monitor/handler/monitor.py)
- [metric.py](file://bk_monitor/utils/metric.py)
- [collector.py](file://bk_monitor/utils/collector.py)
- [ai_assistant/metrics.py](file://apps/ai_assistant/metrics.py)
- [log_search/metrics.py](file://apps/log_search/metrics.py)
</cite>

## 目录
1. [引言](#引言)
2. [Supervisor监控配置](#supervisor监控配置)
3. [健康状态检测机制](#健康状态检测机制)
4. [状态监控指标](#状态监控指标)
5. [告警通知配置](#告警通知配置)
6. [与外部监控系统集成](#与外部监控系统集成)
7. [故障诊断流程](#故障诊断流程)
8. [结论](#结论)

## 引言
BK-LOG平台通过多层次的监控机制确保各组件的稳定运行。本系统采用Supervisor作为进程管理工具，结合自定义健康检查和指标采集机制，实现了对API服务、Grafana等核心组件的全面监控。当组件出现异常时，系统能够自动重启服务，并通过多种渠道发送告警通知，确保问题能够被及时发现和处理。

**本节不分析具体源文件，因此不提供来源**

## Supervisor监控配置

BK-LOG平台使用Supervisor作为核心的进程监控和管理工具。Supervisor配置文件定义了对各个组件的监控策略，包括自动重启条件和重试间隔。

```mermaid
graph TD
A[Supervisor主进程] --> B[bklog-api服务]
A --> C[grafana服务]
A --> D[celery工作进程]
A --> E[异步导出进程]
A --> F[管道处理进程]
B --> G[自动重启策略]
C --> H[自动重启策略]
D --> I[自动重启策略]
E --> J[自动重启策略]
F --> K[自动重启策略]
G --> L[autorestart=true]
H --> M[autorestart=true]
I --> N[autorestart=true]
J --> O[autorestart=true]
K --> P[autorestart=true]
```

**Diagram sources**
- [supervisord.conf](file://support-files/supervisord.conf#L1-L75)
- [#etc#supervisor-bklog-api.conf](file://support-files/templates/#etc#supervisor-bklog-api.conf#L1-L31)
- [#etc#supervisor-bklog-grafana.conf](file://support-files/templates/#etc#supervisor-bklog-grafana.conf#L1-L36)

**Section sources**
- [supervisord.conf](file://support-files/supervisord.conf#L1-L75)
- [#etc#supervisor-bklog-api.conf](file://support-files/templates/#etc#supervisor-bklog-api.conf#L1-L31)
- [#etc#supervisor-bklog-grafana.conf](file://support-files/templates/#etc#supervisor-bklog-grafana.conf#L1-L36)

## 健康状态检测机制

BK-LOG平台实现了多层次的健康状态检测机制。系统通过HealthzHandler类收集和处理健康检查指标，确保能够准确判断各组件的运行状态。

```mermaid
sequenceDiagram
participant HealthzHandler as HealthzHandler
participant Collector as HealthzMetricCollector
participant Metric as 健康检查指标
HealthzHandler->>Collector : get_data(format_type, include_namespaces)
Collector->>Collector : collect()
loop 遍历注册的指标
Collector->>Metric : 执行注册的健康检查函数
Metric-->>Collector : 返回健康检查结果
end
Collector-->>HealthzHandler : 返回聚合的健康数据
HealthzHandler->>HealthzHandler : 根据format_type格式化输出
HealthzHandler-->>调用者 : 返回最终的健康状态信息
```

**Diagram sources**
- [healthz.py](file://home_application/handlers/healthz.py#L29-L120)
- [metrics.py](file://home_application/handlers/metrics.py#L103-L158)

**Section sources**
- [healthz.py](file://home_application/handlers/healthz.py#L29-L120)
- [metrics.py](file://home_application/handlers/metrics.py#L36-L158)

## 状态监控指标

系统定义了丰富的状态监控指标，包括进程运行时间、重启次数和资源消耗等关键性能指标。这些指标通过Prometheus客户端库进行注册和采集。

```mermaid
classDiagram
class HealthzMetric {
+bool status
+string metric_name
+string metric_value
+dict dimensions
+string message
+string suggestion
+to_dict() dict
}
class NamespaceData {
+string namespace
+bool status
+list data
+string message
+to_dict() dict
}
class HealthzMetricCollector {
+dict register_metrics
+defaultdict data
+__init__(include_namespaces, exclude_namespaces)
+collect() defaultdict
}
class Metric {
+string metric_name
+string metric_value
+dict dimensions
+int timestamp
+to_bkmonitor_report(prefix, namespace) dict
}
class BKMonitor {
+string _app_id
+string _app_token
+string _monitor_host
+string _report_host
+string _bk_username
+int _bk_biz_id
+Client _client
+custom_metric() CustomReporter
+build_event_trigger(data_name, event_name) EventTrigger
}
class CustomReporter {
+int bk_biz_id
+string app_id
+Client _client
+migrate(data_name_list)
+report(collector_import_paths)
+batch_report(data_name, data)
+metric_id_filter() list
+trigger_event(data_name, event)
+query(data_name, fields, where_conditions, group_by_conditions)
}
HealthzMetricCollector --> HealthzMetric : "收集"
HealthzMetricCollector --> NamespaceData : "包含"
BKMonitor --> CustomReporter : "包含"
CustomReporter --> Metric : "使用"
```

**Diagram sources**
- [metrics.py](file://home_application/handlers/metrics.py#L56-L102)
- [metric.py](file://bk_monitor/utils/metric.py#L49-L86)
- [monitor.py](file://bk_monitor/handler/monitor.py#L39-L87)
- [collector.py](file://bk_monitor/utils/collector.py#L15-L96)

**Section sources**
- [metrics.py](file://home_application/handlers/metrics.py#L56-L158)
- [metric.py](file://bk_monitor/utils/metric.py#L8-L86)
- [collector.py](file://bk_monitor/utils/collector.py#L15-L96)

## 告警通知配置

系统通过BKMonitor组件实现告警通知功能。当检测到异常情况时，系统会触发事件并发送告警信息，支持邮件和消息推送等多种通知方式。

```mermaid
flowchart TD
A[异常检测] --> B{是否达到告警阈值?}
B --> |是| C[构建告警事件]
B --> |否| D[继续监控]
C --> E[触发事件]
E --> F[通过custom_report发送告警]
F --> G[选择通知渠道]
G --> H[邮件通知]
G --> I[消息推送]
G --> J[其他通知方式]
H --> K[运维人员接收告警]
I --> K
J --> K
K --> L[问题处理]
L --> M[状态恢复确认]
M --> N[关闭告警]
```

**Diagram sources**
- [monitor.py](file://bk_monitor/handler/monitor.py#L75-L265)
- [metric.py](file://bk_monitor/utils/metric.py#L49-L86)

**Section sources**
- [monitor.py](file://bk_monitor/handler/monitor.py#L75-L265)

## 与外部监控系统集成

BK-LOG平台与Prometheus等外部监控系统集成，实现统一监控大盘。系统通过注册Prometheus指标，将关键性能数据暴露给外部监控系统。

```mermaid
graph LR
A[BK-LOG组件] --> B[Prometheus指标注册]
B --> C[Prometheus服务器]
C --> D[Grafana可视化]
D --> E[统一监控大盘]
subgraph BK-LOG内部
A --> F[AI助手指标]
A --> G[日志搜索指标]
A --> H[数据总线指标]
F --> B
G --> B
H --> B
end
subgraph 外部系统
C --> I[告警规则]
I --> J[通知渠道]
D --> K[仪表板]
end
```

**Diagram sources**
- [ai_assistant/metrics.py](file://apps/ai_assistant/metrics.py#L1-L39)
- [log_search/metrics.py](file://apps/log_search/metrics.py#L1-L22)
- [metric.py](file://bk_monitor/utils/metric.py#L8-L86)

**Section sources**
- [ai_assistant/metrics.py](file://apps/ai_assistant/metrics.py#L1-L39)
- [log_search/metrics.py](file://apps/log_search/metrics.py#L1-L22)

## 故障诊断流程

当BK-LOG组件出现异常时，运维人员可以按照以下流程进行快速诊断和解决。

```mermaid
flowchart TD
A[服务异常告警] --> B[检查Supervisor状态]
B --> C{进程是否运行?}
C --> |否| D[启动进程]
C --> |是| E[检查健康检查接口]
D --> F[验证服务状态]
F --> G{服务是否正常?}
G --> |是| H[问题解决]
G --> |否| I[检查日志文件]
E --> J{健康检查通过?}
J --> |是| K[检查外部依赖]
J --> |否| I
I --> L[分析错误日志]
L --> M[定位问题原因]
M --> N[应用修复措施]
N --> O[验证修复效果]
O --> P{问题是否解决?}
P --> |是| H
P --> |否| Q[升级问题级别]
Q --> R[寻求技术支持]
R --> M
K --> S[检查数据库连接]
K --> T[检查消息队列]
K --> U[检查缓存服务]
S --> V{依赖服务正常?}
T --> V
U --> V
V --> |否| W[修复依赖服务]
V --> |是| X[检查配置]
W --> Y[验证整体状态]
X --> Z[验证配置正确性]
Z --> AA{配置正确?}
AA --> |否| AB[修正配置]
AA --> |是| AC[检查资源使用]
AB --> AD[重启服务]
AD --> AE[验证服务]
AC --> AF{资源是否充足?}
AF --> |否| AG[扩容资源]
AF --> |是| AH[深入分析]
AG --> AI[验证性能]
AH --> AJ[收集诊断数据]
AJ --> AK[分析根本原因]
AK --> AL[实施解决方案]
AL --> AM[验证最终效果]
AM --> AN{问题解决?}
AN --> |是| H
AN --> |否| AO[重复诊断流程]
```

**Diagram sources**
- [healthz.py](file://home_application/handlers/healthz.py#L29-L120)
- [supervisord.conf](file://support-files/supervisord.conf#L1-L75)

**Section sources**
- [healthz.py](file://home_application/handlers/healthz.py#L29-L120)
- [supervisord.conf](file://support-files/supervisord.conf#L1-L75)

## 结论
BK-LOG平台通过Supervisor进程管理、自定义健康检查、多维度监控指标和外部系统集成，构建了完善的监控体系。该体系能够有效保障各组件的稳定运行，及时发现和处理异常情况，为系统的可靠性和可用性提供了有力保障。建议运维团队熟悉本监控机制，定期检查监控配置，确保监控系统的有效性。

**本节不分析具体源文件，因此不提供来源**