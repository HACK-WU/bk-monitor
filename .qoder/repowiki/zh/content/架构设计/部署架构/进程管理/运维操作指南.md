# 运维操作指南

<cite>
**本文档引用的文件**   
- [supervisord.conf](file://bklog/support-files/supervisord.conf)
- [supervisor-bklog-api.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-api.conf)
- [supervisor-bklog-grafana.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-grafana.conf)
- [environ.sh](file://bklog/support-files/templates/api#bin#environ.sh)
- [gunicorn_config.py](file://bklog/gunicorn_config.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档旨在提供基于Supervisor的蓝鲸日志平台（BK-LOG）的全面运维操作指南。文档详细介绍了服务启停、配置重载、状态查询等日常运维操作，提供了批量管理脚本示例，规范了配置变更流程，并涵盖了日志管理和故障应急处理的最佳实践。

## 项目结构
蓝鲸日志平台采用模块化设计，主要由接入层、场景层、服务层和存储层构成。Supervisor作为进程管理工具，负责管理平台核心服务的生命周期。平台通过Docker容器化部署，在Dockerfile中明确安装了Supervisor组件。

```mermaid
graph TB
subgraph "Supervisor管理"
API[API服务]
Grafana[Grafana服务]
Celery[Celery任务队列]
end
subgraph "核心服务"
API --> Django[Django应用]
Grafana --> GrafanaServer[Grafana Server]
Celery --> CeleryWorker[Celery Worker]
end
subgraph "存储与中间件"
MySQL[(MySQL)]
Redis[(Redis)]
ES[(Elasticsearch)]
end
API --> MySQL
API --> Redis
Grafana --> ES
Celery --> Redis
style API fill:#f9f,stroke:#333
style Grafana fill:#f9f,stroke:#333
style Celery fill:#f9f,stroke:#333
```

**图示来源**
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L1-L75)
- [supervisor-bklog-api.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-api.conf#L1-L31)
- [supervisor-bklog-grafana.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-grafana.conf#L1-L36)

**本节来源**
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L1-L75)
- [Dockerfile.monitor.dev](file://Dockerfile.monitor.dev#L14)

## 核心组件
系统核心由API服务、Grafana可视化服务和Celery异步任务队列组成，均由Supervisor统一管理。API服务基于Django框架，通过Gunicorn作为WSGI服务器运行；Grafana服务提供仪表盘和数据可视化功能；Celery处理后台异步任务。

**本节来源**
- [supervisor-bklog-api.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-api.conf#L8-L21)
- [supervisor-bklog-grafana.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-grafana.conf#L22-L35)
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L16-L75)

## 架构概述
系统采用微服务架构，Supervisor作为进程守护程序，确保关键服务的高可用性。API服务处理所有HTTP请求，Grafana服务提供数据可视化，Celery处理耗时的异步任务。所有服务通过Redis进行通信，并将数据持久化到MySQL和Elasticsearch。

```mermaid
graph TD
Client[客户端] --> API
API --> |HTTP| Grafana
API --> |RPC| Celery
Celery --> |消息队列| Redis
API --> |数据存储| MySQL
API --> |日志检索| ES
Grafana --> |数据源| ES
subgraph "Supervisor监控"
API
Grafana
Celery
end
style Client fill:#ccf,stroke:#333
style API fill:#f96,stroke:#333
style Grafana fill:#6f9,stroke:#333
style Celery fill:#9cf,stroke:#333
```

**图示来源**
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L16-L75)
- [gunicorn_config.py](file://bklog/gunicorn_config.py#L71-L91)

## 详细组件分析

### API服务分析
API服务是系统的入口，负责处理所有业务逻辑和API请求。该服务由Supervisor管理，通过Gunicorn启动，配置了自动重启机制以确保服务的稳定性。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Supervisor as "Supervisor"
participant Gunicorn as "Gunicorn"
participant Django as "Django应用"
Client->>Supervisor : 系统启动
Supervisor->>Gunicorn : 启动进程
Gunicorn->>Django : 加载应用
Django-->>Gunicorn : 应用就绪
Gunicorn-->>Supervisor : 进程运行
Supervisor-->>Client : 服务可用
Client->>Gunicorn : HTTP请求
Gunicorn->>Django : 处理请求
Django-->>Gunicorn : 返回响应
Gunicorn-->>Client : HTTP响应
```

**图示来源**
- [supervisor-bklog-api.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-api.conf#L8-L21)
- [environ.sh](file://bklog/support-files/templates/api#bin#environ.sh#L1-L67)

### Grafana服务分析
Grafana服务提供强大的数据可视化能力，通过Supervisor进行进程管理。服务配置了独立的socket文件和日志文件，便于监控和故障排查。

```mermaid
flowchart TD
Start([服务启动]) --> CheckConfig["检查配置文件"]
CheckConfig --> ConfigValid{"配置有效?"}
ConfigValid --> |否| ReturnError["返回配置错误"]
ConfigValid --> |是| StartProcess["启动Grafana进程"]
StartProcess --> ProcessRunning{"进程运行?"}
ProcessRunning --> |否| RestartProcess["重启进程"]
ProcessRunning --> |是| MonitorHealth["健康检查"]
MonitorHealth --> LogOutput["输出日志到指定文件"]
LogOutput --> End([服务运行中])
RestartProcess --> StartProcess
```

**图示来源**
- [supervisor-bklog-grafana.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-grafana.conf#L22-L35)
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L1-L15)

### Celery任务队列分析
Celery作为异步任务处理的核心，被配置为多个独立的worker进程，分别处理不同优先级的任务队列。Supervisor确保这些后台任务进程的持续运行。

```mermaid
classDiagram
class CeleryWorker {
+string queue_name
+int concurrency
+string log_level
+int max_tasks_per_child
+bool auto_restart
+start() void
+stop() void
+restart() void
+status() string
}
class Supervisor {
+list programs
+start(program) bool
+stop(program) bool
+restart(program) bool
+status(program) string
+reload() bool
}
Supervisor --> CeleryWorker : "管理"
CeleryWorker <|-- UwsgiWorker : "继承"
CeleryWorker <|-- CeleryWorkerDefault : "继承"
CeleryWorker <|-- CeleryWorkerAsyncExport : "继承"
CeleryWorker <|-- CeleryWorkerPipeline : "继承"
class UwsgiWorker {
+command : uwsgi
+queue : none
}
class CeleryWorkerDefault {
+command : celery worker
+queue : default,celery
}
class CeleryWorkerAsyncExport {
+command : celery worker
+queue : async_export
}
class CeleryWorkerPipeline {
+command : celery worker
+queue : pipeline,pipeline_priority
}
```

**图示来源**
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L16-L75)
- [gunicorn_config.py](file://bklog/gunicorn_config.py#L71-L91)

**本节来源**
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L16-L75)
- [supervisor-bklog-api.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-api.conf#L8-L21)
- [supervisor-bklog-grafana.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-grafana.conf#L22-L35)

## 依赖分析
系统依赖于多个外部组件和服务，Supervisor配置中明确指定了这些依赖关系。通过分析配置文件，可以清晰地看到各组件之间的依赖关系和启动顺序。

```mermaid
graph LR
Supervisor[Supervisor] --> API
Supervisor --> Grafana
Supervisor --> Celery
API --> MySQL
API --> Redis
API --> Consul
Grafana --> ES
Grafana --> MySQL
Celery --> Redis
Celery --> MySQL
subgraph "基础设施"
MySQL
Redis
ES
Consul
end
style Supervisor fill:#f9f,stroke:#333,stroke-width:2px
style MySQL fill:#ccf,stroke:#333
style Redis fill:#ccf,stroke:#333
style ES fill:#ccf,stroke:#333
style Consul fill:#ccf,stroke:#333
```

**图示来源**
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L1-L75)
- [environ.sh](file://bklog/support-files/templates/api#bin#environ.sh#L1-L67)

**本节来源**
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L1-L75)
- [environ.sh](file://bklog/support-files/templates/api#bin#environ.sh#L1-L67)

## 性能考虑
Supervisor配置中包含了多项性能优化设置，如进程重启策略、日志轮转和资源限制。这些配置确保了系统在高负载下的稳定运行。

**本节来源**
- [supervisor-bklog-grafana.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-grafana.conf#L5-L7)
- [supervisord.conf](file://bklog/support-files/supervisord.conf#L10-L11)

## 故障排除指南
当服务出现故障时，应首先检查Supervisor管理的状态，然后查看相应的日志文件。常见问题包括配置错误、依赖服务不可用和资源不足等。

**本节来源**
- [supervisor-bklog-api.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-api.conf#L18-L19)
- [supervisor-bklog-grafana.conf](file://bklog/support-files/templates/#etc#supervisor-bklog-grafana.conf#L31-L32)

## 结论
本文档系统地介绍了基于Supervisor的运维操作，涵盖了服务管理、配置变更、日志监控和故障排除等关键方面。通过遵循这些最佳实践，可以确保蓝鲸日志平台的稳定运行和高效维护。