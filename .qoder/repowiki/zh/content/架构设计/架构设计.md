# Architecture Design

<cite>
**Referenced Files in This Document**   
- [settings.py](file://bkmonitor/settings.py)
- [urls.py](file://bkmonitor/urls.py)
- [apps.py](file://bkmonitor/bkmonitor/apps.py)
- [strategy.py](file://bkmonitor/bkmonitor/models/strategy.py)
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py)
- [process.py](file://bkmonitor/alarm_backends/service/detect/process.py)
- [trigger/processor.py](file://bkmonitor/alarm_backends/service/trigger/processor.py)
- [data_source/README.md](file://bkmonitor/bkmonitor/data_source/README.md)
- [apm/core/platform_config.py](file://bkmonitor/apm/core/platform_config.py)
- [apm/task/tasks.py](file://bkmonitor/apm/task/tasks.py)
- [event_plugin/__init__.py](file://bkmonitor/bkmonitor/event_plugin/__init__.py)
- [metadata/models/data_source.py](file://bkmonitor/metadata/models/data_source.py)
- [ai_whale/apps.py](file://bkmonitor/ai_whale/apps.py) - *Added in commit 36a5d5fe1872c9f4f2c91d26f0ccd02eae50db1d*
- [ai_whale/resources/resources.py](file://bkmonitor/ai_whale/resources/resources.py) - *Added in commit 36a5d5fe1872c9f4f2c91d26f0ccd02eae50db1d*
- [ai_whale/urls.py](file://bkmonitor/ai_whale/urls.py) - *Added in commit 36a5d5fe1872c9f4f2c91d26f0ccd02eae50db1d*
- [ai_whale/views.py](file://bkmonitor/ai_whale/views.py) - *Added in commit 36a5d5fe1872c9f4f2c91d26f0ccd02eae50db1d*
- [ai_agent/core/aidev_interface.py](file://ai_agent/core/aidev_interface.py) - *Updated in commit c79e817fad94728835dee22909d782eef6ce7167*
- [config/default.py](file://bkmonitor/config/default.py) - *Updated in commit 36a5d5fe1872c9f4f2c91d26f0ccd02eae50db1d*
- [pyproject.toml](file://bkmonitor/pyproject.toml) - *Updated in commit c79e817fad94728835dee22909d782eef6ce7167*
</cite>

## Update Summary
**Changes Made**   
- Added new section on AI Agent Integration Architecture to document the new AI agent functionality
- Updated project structure diagram to include the new ai_whale module
- Added references to new AI agent configuration settings in settings.py and config/default.py
- Updated dependency analysis to include AI agent SDK dependencies
- Added new sequence diagram for AI agent interaction flow
- Updated document sources to include all new and modified files related to AI agent integration

## Table of Contents
1. [Introduction](#introduction)
2. [Project Structure](#project-structure)
3. [Core Components](#core-components)
4. [Architecture Overview](#architecture-overview)
5. [Detailed Component Analysis](#detailed-component-analysis)
6. [AI Agent Integration Architecture](#ai-agent-integration-architecture)
7. [Dependency Analysis](#dependency-analysis)
8. [Performance Considerations](#performance-considerations)
9. [Troubleshooting Guide](#troubleshooting-guide)
10. [Conclusion](#conclusion)

## Introduction
BlueKing Intelligent Cloud Monitoring Platform (bk-monitor) is a comprehensive monitoring system designed to provide complete solutions from data collection, processing, analysis to alert notification. This architecture design document details the system's layered architecture, modular design, core component responsibilities, and interaction methods between modules. The document specifically focuses on the implementation of the Django MVC pattern, the embodiment of microservice design concepts within a monolithic application, and the system's extensibility design.

## Project Structure
bk-monitor project adopts a modular design based on the Django framework, achieving functional decoupling through independent Django applications (apps). The root directory contains several core modules such as `alarm_backends` (alert backend engine), `apm` (application performance monitoring), `api` (external service interface), and `bkmonitor` (core monitoring logic). This structure clearly delineates different functional domains, facilitating maintenance and extension.

``mermaid
graph TD
subgraph "Core Modules"
A[alarm_backends] --> |Alert Processing| B[bkmonitor]
C[apm] --> |APM Data| B
D[api] --> |External Service Integration| B
E[metadata] --> |Metadata Management| B
F[ai_whale] --> |AI Agent Integration| B
end
subgraph "Foundation Services"
G[config] --> |Configuration Management| H[settings.py]
I[core] --> |Core Utilities| B
J[constants] --> |Constant Definitions| B
end
subgraph "Frontend & Tools"
K[static] --> |Static Resources| L[templates]
M[scripts] --> |Script Tools| N[bin]
end
B --> |Data Source| O[data_source]
B --> |Strategy Management| P[strategy]
B --> |Event Processing| Q[event_plugin]
```

**Diagram sources**
- [settings.py](file://bkmonitor/settings.py)
- [urls.py](file://bkmonitor/urls.py)

**Section sources**
- [settings.py](file://bkmonitor/settings.py)
- [urls.py](file://bkmonitor/urls.py)

## Core Components
The core components of this system include the alert backend engine, strategy management system, data source access layer, APM monitoring module, and the newly introduced AI agent integration. These components work together to implement a complete monitoring workflow from data collection to alert generation. The Django MVC pattern runs throughout the application, with URL routing, view processing, and model definition forming the system's control flow and data flow.

**Section sources**
- [apps.py](file://bkmonitor/bkmonitor/apps.py)
- [strategy.py](file://bkmonitor/bkmonitor/models/strategy.py)

## Architecture Overview
The bk-monitor system adopts a layered architecture design, primarily consisting of access layer, core processing layer, data layer, and external integration layer. The system receives requests through Django's URL routing mechanism, processes them in views, and interacts with models for data operations, perfectly embodying the MVC design pattern. The microservice design concept is realized through independent Django applications, with each application responsible for specific business functions, achieving logical decoupling.

``mermaid
graph TB
subgraph "Access Layer"
A[API Gateway] --> B[URL Routing]
B --> C[View Processing]
end
subgraph "Core Processing Layer"
C --> D[Strategy Management]
C --> E[Alert Processing]
C --> F[APM Monitoring]
C --> G[AI Agent Integration]
D --> H[Data Source Access]
E --> H
F --> H
G --> H
end
subgraph "Data Layer"
H --> I[Time Series Database]
H --> J[Relational Database]
H --> K[Log Storage]
end
subgraph "External Integration"
L[CMDB] --> C
M[Grafana] --> C
N[Node Management] --> C
O[AIDEV Platform] --> G
end
style A fill:#f9f,stroke:#333
style I fill:#ccf,stroke:#333
style L fill:#f96,stroke:#333
style O fill:#69f,stroke:#333
```

**Diagram sources**
- [urls.py](file://bkmonitor/urls.py)
- [apps.py](file://bkmonitor/bkmonitor/apps.py)

## Detailed Component Analysis

### Alert Backend Engine Analysis
The alert backend engine is the core processing unit of the system, responsible for strategy detection, alert triggering, and event convergence. This engine exists as an independent Django application `alarm_backends`, achieving high-concurrency processing through the Celery asynchronous task framework. The engine adopts a pipeline processing architecture, including stages such as data access, anomaly detection, alert generation, and event convergence.

#### Alert Processing Flow
``mermaid
sequenceDiagram
participant DataAccess as Data Access Service
participant DetectionService as Detection Service
participant Trigger as Alert Trigger
participant EventConvergence as Event Convergence Service
DataAccess->>DetectionService : Receive monitoring data
DetectionService->>DetectionService : Execute strategy detection algorithm
alt Anomaly Detected
DetectionService->>Trigger : Generate anomaly detection result
Trigger->>Trigger : Convert to alert event
Trigger->>EventConvergence : Send alert event
EventConvergence->>EventConvergence : Execute convergence strategy
EventConvergence-->>NotificationSystem : Send converged alert
else Normal State
DetectionService->>DataAccess : Continue listening to data
end
```

**Diagram sources**
- [process.py](file://bkmonitor/alarm_backends/service/detect/process.py)
- [trigger/processor.py](file://bkmonitor/alarm_backends/service/trigger/processor.py)

**Section sources**
- [process.py](file://bkmonitor/alarm_backends/service/detect/process.py)
- [trigger/processor.py](file://bkmonitor/alarm_backends/service/trigger/processor.py)

### Strategy Management System Analysis
The strategy management system is responsible for creating, storing, and managing monitoring strategies. The system defines the complete structure of strategies through the `StrategyModel` model, including monitoring items, detection algorithms, and alert actions. Strategy configurations are stored in JSON format, supporting flexible condition combinations and multi-level alerts.

#### Strategy Model Class Diagram
``mermaid
classDiagram
class StrategyModel {
+int id
+int bk_biz_id
+string name
+bool is_enabled
+datetime create_time
+datetime update_time
+to_dict() dict
+convert() void
+restore() void
}
class ItemModel {
+int strategy_id
+string name
+string expression
+json functions
+json no_data_config
+json target
}
class DetectModel {
+int strategy_id
+int level
+string connector
+json trigger_config
+json recovery_config
}
class AlgorithmModel {
+int strategy_id
+int item_id
+int level
+string type
+json config
}
StrategyModel --> ItemModel : "Contains"
StrategyModel --> DetectModel : "Contains"
StrategyModel --> AlgorithmModel : "Contains"
class AlgorithmChoices {
+string Threshold
+string SimpleRingRatio
+string AdvancedYearRound
+string IntelligentDetect
}
AlgorithmModel --> AlgorithmChoices : "References"
```

**Diagram sources**
- [strategy.py](file://bkmonitor/bkmonitor/models/strategy.py)
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py)

**Section sources**
- [strategy.py](file://bkmonitor/bkmonitor/models/strategy.py)
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py)

### Data Source Access Layer Analysis
The data source access layer provides a unified data query entry point, supporting queries for both time series data and log data. This layer adopts a design approach similar to Django ORM, providing a chainable query interface through the `Query` class that encapsulates the complexity of underlying SQL construction and database connections.

#### Data Source Query Flow
``mermaid
flowchart TD
Start([Start Query]) --> LoadBackend["Load Data Source Backend"]
LoadBackend --> CreateQuery["Create Query Object"]
CreateQuery --> ApplyFilters["Apply Filter Conditions"]
ApplyFilters --> CompileSQL["Compile to SQL Statement"]
CompileSQL --> ExecuteQuery["Execute Query"]
ExecuteQuery --> ProcessResult["Process Query Results"]
ProcessResult --> ReturnData["Return Data"]
ReturnData --> End([End])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
```

**Diagram sources**
- [data_source/README.md](file://bkmonitor/bkmonitor/data_source/README.md)
- [metadata/models/data_source.py](file://bkmonitor/metadata/models/data_source.py)

**Section sources**
- [data_source/README.md](file://bkmonitor/bkmonitor/data_source/README.md)
- [metadata/models/data_source.py](file://bkmonitor/metadata/models/data_source.py)

### APM Monitoring Module Analysis
The APM (Application Performance Monitoring) module focuses on application performance monitoring, providing distributed tracing, metric monitoring, and log analysis capabilities. This module is implemented through the `apm` application and supports automatic discovery and configuration management.

#### APM Configuration Refresh Flow
``mermaid
flowchart LR
A[Scheduled Task] --> B{Application List}
B --> C[Application 1]
B --> D[Application 2]
B --> E[...]
C --> F[Refresh Configuration]
D --> F
E --> F
F --> G[Publish Configuration]
G --> H[Probe Receives]
H --> I[Monitoring Data Reporting]
I --> J[Data Processing]
J --> K[Display & Analysis]
```

**Diagram sources**
- [apm/core/platform_config.py](file://bkmonitor/apm/core/platform_config.py)
- [apm/task/tasks.py](file://bkmonitor/apm/task/tasks.py)

**Section sources**
- [apm/core/platform_config.py](file://bkmonitor/apm/core/platform_config.py)
- [apm/task/tasks.py](file://bkmonitor/apm/task/tasks.py)

## AI Agent Integration Architecture
The AI agent integration represents a significant enhancement to the monitoring platform, enabling intelligent interaction and automated operations. This new architecture is implemented through the `ai_whale` Django application, which serves as a bridge between the monitoring system and external AI services.

### AI Agent Module Structure
The AI agent integration consists of several key components:
- **ai_whale**: The main Django application that handles AI agent interactions
- **aidev_interface**: The core interface that communicates with the AIDEV platform
- **local_command_handler**: Local processor for handling specific commands
- **metrics_reporter**: Comprehensive metrics collection for AI operations

``mermaid
graph TD
subgraph "AI Agent Components"
A[ai_whale] --> B[Views]
A --> C[Resources]
A --> D[URLs]
A --> E[Apps]
end
subgraph "Core Services"
F[aidev_interface] --> G[AIDEV API Client]
F --> H[Agent Instance Factory]
F --> I[Local Command Processor]
end
subgraph "External Systems"
G --> J[AIDEV Platform]
I --> K[Local Command Handlers]
end
B --> C
C --> F
F --> L[Metrics Reporter]
L --> M[Prometheus Metrics]
```

**Diagram sources**
- [ai_whale/apps.py](file://bkmonitor/ai_whale/apps.py)
- [ai_whale/resources/resources.py](file://bkmonitor/ai_whale/resources/resources.py)
- [ai_agent/core/aidev_interface.py](file://ai_agent/core/aidev_interface.py)
- [ai_agent/services/metrics_reporter.py](file://ai_agent/services/metrics_reporter.py)

**Section sources**
- [ai_whale/apps.py](file://bkmonitor/ai_whale/apps.py)
- [ai_whale/resources/resources.py](file://bkmonitor/ai_whale/resources/resources.py)
- [ai_agent/core/aidev_interface.py](file://ai_agent/core/aidev_interface.py)

### AI Agent Interaction Flow
The AI agent interaction follows a well-defined sequence of operations, from session creation to chat completion. The system supports both streaming and non-streaming responses, with comprehensive metrics collection throughout the process.

``mermaid
sequenceDiagram
participant User as User
participant Frontend as Frontend
participant AIWhale as AIWhale Service
participant AIDEV as AIDEV Platform
participant Metrics as Metrics System
User->>Frontend : Initiate AI Session
Frontend->>AIWhale : CreateChatSessionResource
AIWhale->>AIDEV : Create session via API
AIDEV-->>AIWhale : Session created
AIWhale-->>Frontend : Session details
Frontend->>AIWhale : CreateChatCompletionResource
AIWhale->>AIWhale : Extract agent_code by scenario
alt Agent Code Changed
AIWhale->>AIWhale : Set switch_agent_by_scene=true
end
AIWhale->>Metrics : Report request start
AIWhale->>AIDEV : Build Agent Instance
AIWhale->>AIDEV : Execute with streaming
alt Streaming Response
AIDEV-->>AIWhale : Stream chunks
AIWhale->>Metrics : Track first chunk
AIWhale->>Metrics : Track subsequent chunks
AIWhale-->>Frontend : Stream response
Frontend-->>User : Display streaming content
else Non-Streaming
AIDEV-->>AIWhale : Complete response
AIWhale->>Metrics : Report completion
AIWhale-->>Frontend : Complete response
Frontend-->>User : Display complete response
end
```

**Diagram sources**
- [ai_whale/resources/resources.py](file://bkmonitor/ai_whale/resources/resources.py)
- [ai_agent/core/aidev_interface.py](file://ai_agent/core/aidev_interface.py)
- [ai_agent/services/metrics_reporter.py](file://ai_agent/services/metrics_reporter.py)

**Section sources**
- [ai_whale/resources/resources.py](file://bkmonitor/ai_whale/resources/resources.py)
- [ai_agent/core/aidev_interface.py](file://ai_agent/core/aidev_interface.py)

### Configuration and Settings
The AI agent integration is configured through several key settings in the system configuration. These settings are defined in the config/default.py file and can be overridden by environment variables.

```python
# AI Agent Configuration (config/default.py)
AIDEV_AGENT_APP_CODE = os.getenv("BK_AIDEV_AGENT_APP_CODE")
AIDEV_AGENT_APP_SECRET = os.getenv("BK_AIDEV_AGENT_APP_SECRET")
AIDEV_AGENT_API_URL_TMPL = os.getenv("BK_AIDEV_AGENT_API_URL_TMPL")
AIDEV_AGENT_LLM_GW_ENDPOINT = os.getenv("BK_AIDEV_AGENT_LLM_GW_ENDPOINT")
AIDEV_AGENT_LLM_DEFAULT_TEMPERATURE = 0.3  # Default temperature
AIDEV_AGENT_ENABLE_LANGFUSE = False  # Whether to enable langfuse reporting
AIDEV_AGENT_AI_GENERATING_KEYWORD = "Generating"
```

The system also supports scenario-based agent switching through the AIDEV_SCENE_AGENT_CODE_MAPPING setting, allowing different AI agents to be used for different monitoring scenarios.

**Section sources**
- [config/default.py](file://bkmonitor/config/default.py)
- [ai_whale/utils.py](file://bkmonitor/ai_whale/utils.py)

## Dependency Analysis
The system's components interact through clear interfaces with well-defined dependencies. The core monitoring logic depends on the alert backend engine for data processing and on the API module for integration with external systems. The data source access layer serves as a public service, depended upon by multiple upper-layer modules. The newly added AI agent integration introduces dependencies on the AIDEV platform SDK and related services.

``mermaid
graph TD
A[bkmonitor] --> B[alarm_backends]
A --> C[api]
A --> D[data_source]
A --> E[apm]
A --> F[ai_whale]
B --> G[celery]
C --> H[cmdb]
C --> I[grafana]
C --> J[node_man]
D --> K[influxdb]
D --> L[elasticsearch]
E --> M[deepflow]
F --> N[aidev_agent_sdk]
F --> O[AIDEV Platform]
N --> P[langfuse]
N --> Q[pydantic]
```

**Diagram sources**
- [settings.py](file://bkmonitor/settings.py)
- [apps.py](file://bkmonitor/bkmonitor/apps.py)
- [pyproject.toml](file://bkmonitor/pyproject.toml)

**Section sources**
- [settings.py](file://bkmonitor/settings.py)
- [apps.py](file://bkmonitor/bkmonitor/apps.py)
- [pyproject.toml](file://bkmonitor/pyproject.toml)

## Performance Considerations
The system was designed with performance considerations in mind. The alert backend engine uses asynchronous processing to avoid blocking the main thread. The data source access layer optimizes database access performance through connection pooling and caching mechanisms. The APM module uses scheduled tasks to batch process configuration updates, reducing system overhead. The system also integrates continuous performance analysis tools for monitoring and optimization. The AI agent integration includes comprehensive metrics collection through the AIMetricsReporter class, tracking request duration, status, and other key performance indicators.

## Troubleshooting Guide
When system anomalies occur, follow these steps for troubleshooting:
1. Check Django logs and Celery task logs
2. Verify database connections and data source configurations
3. Check the availability of external services (such as CMDB, Grafana, AIDEV Platform)
4. Confirm the correctness of strategy configurations
5. Review system monitoring metrics to identify performance bottlenecks
6. For AI agent issues, check the AIDEV platform connectivity and credentials

**Section sources**
- [apps.py](file://bkmonitor/bkmonitor/apps.py)
- [settings.py](file://bkmonitor/settings.py)

## Conclusion
The bk-monitor system achieves a powerful and extensible monitoring platform through carefully designed layered architecture and modular components. The system successfully integrates microservice design concepts into a monolithic application, achieving functional decoupling through independent Django applications. The rational application of the Django MVC pattern ensures code maintainability and testability. The recent addition of AI agent integration expands the platform's capabilities, enabling intelligent monitoring and automated operations. Future architectural evolution could consider further microservices decomposition, separating core components into independent services to enhance system scalability and deployment flexibility.