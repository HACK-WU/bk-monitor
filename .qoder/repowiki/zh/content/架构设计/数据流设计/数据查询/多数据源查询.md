# 多数据源查询

<cite>
**本文档引用的文件**   
- [builder.py](file://bkmonitor\bkmonitor\data_source\unify_query\builder.py)
- [query.py](file://bkmonitor\bkmonitor\data_source\unify_query\query.py)
- [__init__.py](file://bkmonitor\bkmonitor\data_source\data_source\__init__.py)
- [default.py](file://bkmonitor\api\unify_query\default.py)
- [resources.py](file://bkmonitor\packages\monitor_web\data_explorer\resources.py)
</cite>

## 目录
1. [多数据源查询](#多数据源查询)
2. [架构概述](#架构概述)
3. [核心组件分析](#核心组件分析)
4. [查询执行流程](#查询执行流程)
5. [数据源适配器实现](#数据源适配器实现)
6. [最佳实践](#最佳实践)

## 架构概述

```mermaid
graph TD
A[前端/服务层] --> B[UnifyQuerySet]
B --> C[UnifyQueryConfig]
C --> D[UnifyQueryCompiler]
D --> E[UnifyQuery]
E --> F{use_unify_query?}
F --> |是| G[调用统一查询API]
F --> |否| H[调用原始数据源API]
G --> I[InfluxDB/Elasticsearch/Prometheus]
H --> I
```

**图示来源**
- [builder.py](file://bkmonitor\bkmonitor\data_source\unify_query\builder.py#L400-L533)
- [query.py](file://bkmonitor\bkmonitor\data_source\unify_query\query.py#L596-L625)

## 核心组件分析

### 统一查询构建器 (UnifyQuerySet)

`UnifyQuerySet` 类提供了类ORM的查询接口，允许通过链式调用构建复杂的查询请求。

```mermaid
classDiagram
class UnifyQuerySet {
+using : str
+_result_cache : list
+query : UnifyQueryConfig
+_clone() UnifyQuerySet
+scope(bk_biz_id : int) UnifyQuerySet
+after(after_key : dict) UnifyQuerySet
+instant(instant : bool) UnifyQuerySet
+time_agg(is_time_agg : bool) UnifyQuerySet
+time_align(is_time_align : bool) UnifyQuerySet
+func(_id : str, params : list) UnifyQuerySet
+expression(expression : str) UnifyQuerySet
+add_query(q : QueryConfigBuilder) UnifyQuerySet
+start_time(start_time : int) UnifyQuerySet
+end_time(end_time : int) UnifyQuerySet
}
class CompilerMixin {
+query_config : dict
+config : dict
}
class IterMixin {
+__iter__()
+__len__()
}
UnifyQuerySet --> CompilerMixin : "实现"
UnifyQuerySet --> IterMixin : "实现"
```

**图示来源**
- [builder.py](file://bkmonitor\bkmonitor\data_source\unify_query\builder.py#L400-L533)

### 查询配置构建器 (QueryConfigBuilder)

`QueryConfigBuilder` 类用于构建单个数据源的查询配置。

```mermaid
classDiagram
class QueryConfigBuilder {
+alias(alias : str) QueryConfigBuilder
+metric(field : str, method : str) QueryConfigBuilder
+func(_id : str, params : list) QueryConfigBuilder
+conditions(conditions : list) QueryConfigBuilder
+tag_values(*fields) QueryConfigBuilder
+interval(interval : int) QueryConfigBuilder
+table(table_name : str) QueryConfigBuilder
+values(*fields) QueryConfigBuilder
+filter(*args, **kwargs) QueryConfigBuilder
+group_by(*fields) QueryConfigBuilder
+order_by(*fields) QueryConfigBuilder
+time_field(field : str) QueryConfigBuilder
+query_string(query_string : str) QueryConfigBuilder
}
class BaseDataQuery {
+query : QueryConfig
+_clone() QueryConfigBuilder
}
class QueryMixin {
+table(table_name : str) QueryConfigBuilder
+values(*fields) QueryConfigBuilder
+filter(*args, **kwargs) QueryConfigBuilder
+group_by(*fields) QueryConfigBuilder
+order_by(*fields) QueryConfigBuilder
}
class DslMixin {
+dsl_raw_query_string(query_string : str) QueryConfigBuilder
}
QueryConfigBuilder --> BaseDataQuery : "继承"
QueryConfigBuilder --> QueryMixin : "实现"
QueryConfigBuilder --> DslMixin : "实现"
```

**图示来源**
- [builder.py](file://bkmonitor\bkmonitor\data_source\unify_query\builder.py#L200-L400)

## 查询执行流程

### 统一查询执行流程

```mermaid
sequenceDiagram
participant Client as "客户端"
participant UnifyQuery as "UnifyQuery"
participant API as "统一查询API"
participant Backend as "后端存储"
Client->>UnifyQuery : query_data()
UnifyQuery->>UnifyQuery : use_unify_query()
alt 使用统一查询
UnifyQuery->>UnifyQuery : get_unify_query_params()
UnifyQuery->>API : query_data()
API->>Backend : 分发到InfluxDB/Elasticsearch等
Backend-->>API : 返回数据
API-->>UnifyQuery : 返回数据
UnifyQuery->>UnifyQuery : process_unify_query_data()
UnifyQuery-->>Client : 返回处理后的数据
else 使用原始数据源
UnifyQuery->>UnifyQuery : _query_data_using_datasource()
UnifyQuery->>Backend : 直接查询
Backend-->>UnifyQuery : 返回数据
UnifyQuery-->>Client : 返回数据
end
```

**图示来源**
- [query.py](file://bkmonitor\bkmonitor\data_source\unify_query\query.py#L596-L625)
- [query.py](file://bkmonitor\bkmonitor\data_source\unify_query\query.py#L400-L600)

### 查询路由决策流程

```mermaid
flowchart TD
Start([开始]) --> CheckDataSource["检查数据源是否支持统一查询"]
CheckDataSource --> |不支持| UseOriginal["使用原始数据源API"]
CheckDataSource --> |支持| CheckMultiMetrics["是否多指标查询?"]
CheckMultiMetrics --> |是| UseUnifyQuery["使用统一查询API"]
CheckMultiMetrics --> |否| CheckExpression["是否有表达式?"]
CheckExpression --> |是| UseUnifyQuery
CheckExpression --> |否| CheckFunctions["是否有查询函数?"]
CheckFunctions --> |是| UseUnifyQuery
CheckFunctions --> |否| CheckAggMethods["是否使用特殊聚合方法?"]
CheckAggMethods --> |是| UseUnifyQuery
CheckAggMethods --> |否| UseOriginal
UseUnifyQuery --> End([结束])
UseOriginal --> End
```

**图示来源**
- [query.py](file://bkmonitor\bkmonitor\data_source\unify_query\query.py#L200-L400)

## 数据源适配器实现

### 数据源加载与适配

```mermaid
classDiagram
class DataSource {
+data_source_label : str
+data_type_label : str
+bk_biz_id : int
+metrics : list
+group_by : list
+interval : int
+query_data() list[dict]
+query_log() tuple[list[dict], int]
+query_dimensions() list
+to_unify_query_config() list[dict]
+set_bk_tenant_id(bk_tenant_id : str)
}
class TimeSeriesDataSource {
+table_name : str
+time_field : str
+filter_dict : dict
+where : WhereNode
+query_string : str
}
class BkMonitorTimeSeriesDataSource {
+_is_system_disk() bool
+_is_system_net() bool
}
class PrometheusTimeSeriesDataSource {
+promql : str
}
class ElasticSearchDataSource {
+index_set_id : int
+scenario_id : str
}
DataSource <|-- TimeSeriesDataSource : "继承"
TimeSeriesDataSource <|-- BkMonitorTimeSeriesDataSource : "继承"
TimeSeriesDataSource <|-- PrometheusTimeSeriesDataSource : "继承"
TimeSeriesDataSource <|-- ElasticSearchDataSource : "继承"
```

**图示来源**
- [__init__.py](file://bkmonitor\bkmonitor\data_source\data_source\__init__.py#L0-L200)
- [builder.py](file://bkmonitor\bkmonitor\data_source\unify_query\builder.py#L200-L400)

## 最佳实践

### 性能考量

1. **合理使用统一查询**：当查询涉及多个数据源、复杂表达式或特殊聚合函数时，应使用统一查询。
2. **时间对齐**：启用时间对齐功能可以确保不同数据源的时间戳对齐，提高查询结果的准确性。
3. **分页查询**：对于大量数据的查询，使用 `after` 方法进行分页，避免内存溢出。

### 一致性保证

1. **租户ID管理**：通过 `bk_tenant_id` 确保跨业务查询的一致性。
2. **空间标识**：使用 `space_uid` 进行路由决策，确保查询请求被正确路由到相应的查询服务。
3. **监控指标**：通过 `DATASOURCE_QUERY_TIME` 和 `DATASOURCE_QUERY_COUNT` 监控查询性能和频率。

### 错误处理策略

1. **异常捕获**：在 `query_data` 方法中捕获所有异常，并通过监控指标上报。
2. **部分结果**：当 `is_partial` 为 `True` 时，表示查询结果不完整，需要进行重试或告警。
3. **超时处理**：设置合理的超时时间（60秒），避免长时间阻塞。

**本节来源**
- [query.py](file://bkmonitor\bkmonitor\data_source\unify_query\query.py#L600-L755)
- [default.py](file://bkmonitor\api\unify_query\default.py#L0-L199)