# 系统集成

<cite>
**本文档引用的文件**   
- [README.md](file://README.md)
- [bkmonitor\api\cmdb\default.py](file://bkmonitor\api\cmdb\default.py)
- [bkmonitor\api\gse\default.py](file://bkmonitor\api\gse\default.py)
- [bkmonitor\api\job\default.py](file://bkmonitor\api\job\default.py)
- [bkmonitor\api\bk_apigateway\default.py](file://bkmonitor\api\bk_apigateway\default.py)
- [bkmonitor\api\cmdb\client.py](file://bkmonitor\api\cmdb\client.py)
- [wiki\GSE(通用服务引擎).md](file://wiki\GSE(通用服务引擎).md)
- [README_BCS_CLUSTER_CHECK_ENHANCED.md](file://README_BCS_CLUSTER_CHECK_ENHANCED.md) - *新增，增强BCS集群检查功能*
- [bkmonitor\metadata\management\commands\check_bcs_cluster_status.py](file://bkmonitor\metadata\management\commands\check_bcs_cluster_status.py) - *新增，BCS集群状态检查命令*
- [ai_agent\core\aidev_interface.py](file://ai_agent\core\aidev_interface.py) - *重构，AI小鲸SDK交互句柄*
</cite>

## 更新摘要
**变更内容**   
- 新增 **与BCS系统的集成** 章节，详细说明增强版BCS集群状态检查功能。
- 新增 **与AI小鲸系统的集成** 章节，阐述重构后的SDK交互逻辑。
- 在 **最佳实践与常见问题** 章节中，增加了与BCS和AI小鲸相关的实践建议。
- 更新了文档引用文件列表，包含新增和重构的文件。

## 目录
1. [引言](#引言)
2. [与配置管理数据库的集成](#与配置管理数据库的集成)
3. [与通用服务引擎的集成](#与通用服务引擎的集成)
4. [与作业平台的集成](#与作业平台的集成)
5. [API网关的使用与权限控制](#api网关的使用与权限控制)
6. [集成开发指南](#集成开发指南)
7. [与BCS系统的集成](#与bcs系统的集成)
8. [与AI小鲸系统的集成](#与ai小鲸系统的集成)
9. [最佳实践与常见问题](#最佳实践与常见问题)

## 引言
蓝鲸智云监控平台（BlueKing - Monitor）是蓝鲸生态中的核心监控产品，旨在提供全面的数据采集、大规模数据处理和智能化监控能力。该平台深度集成于蓝鲸PaaS体系，能够与蓝鲸生态内的多个关键系统（如CMDB、GSE、Job平台等）以及外部系统进行无缝协作，形成一个完整的监控闭环。本系统集成文档旨在全面阐述bk-monitor与这些系统的集成方式，为开发者和运维人员提供详细的配置、开发和最佳实践指导。

## 与配置管理数据库的集成
bk-monitor与蓝鲸配置管理数据库（CMDB）的集成是其核心功能之一，主要通过`bkmonitor/api/cmdb/`目录下的模块实现。这种集成确保了监控系统能够实时获取准确的主机信息和业务拓扑结构。

### 主机信息同步
系统通过调用CMDB的API来同步主机信息。核心实现位于`cmdb/default.py`文件中。`get_host_dict_by_biz`函数是获取指定业务下所有主机信息的主要入口。它利用`batch_request`工具批量调用`list_biz_hosts_topo` API，以提高效率。返回的原始数据经过`_host_from_raw`函数处理，提取出IP地址、云区域ID、所属集群（Set）和模块（Module）等关键信息，并对IP地址进行格式化处理。
```python
def get_host_dict_by_biz(bk_biz_id, fields):
    """
    按业务查询主机（未实例化）
    :param bk_biz_id: 业务ID
    :type bk_biz_id: int
    :param fields: 查询字段
    :type fields: list
    :return: 主机列表
    :rtype: list
    """
    records = batch_request(client.list_biz_hosts_topo, {"bk_biz_id": bk_biz_id, "fields": fields})
    hosts = []
    for record in records:
        host = _host_from_raw(record, bk_biz_id)
        if host is not None:
            hosts.append(host)
    return hosts
```

### 拓扑关系获取
获取业务的完整拓扑树是实现基于拓扑的监控和告警的基础。`_get_topo_tree`函数负责此任务。它首先调用`search_biz_inst_topo` API获取基础拓扑数据，然后通过`get_biz_internal_module` API获取空闲机集群和模块的信息，并将其合并到主拓扑树中。最后，通过`sort_topo_tree_by_pinyin`函数按拼音对拓扑节点进行排序，以提供一致的用户体验。
```python
def _get_topo_tree(bk_biz_id):
    """
    获取业务拓扑树（未实例化）
    :param bk_biz_id: 业务ID
    :type bk_biz_id: int
    :return: 拓扑树
    :rtype: Dict
    """
    response_data = client.search_biz_inst_topo(bk_biz_id=bk_biz_id)
    # ... (处理空闲机集群)
    return sort_topo_tree_by_pinyin([response_data])[0]
```

**实际应用场景**：在创建监控策略时，用户可以选择“业务拓扑”作为监控目标。系统会调用上述接口获取该业务的拓扑树，用户可以直观地勾选特定的集群或模块，系统会自动将选中的所有主机纳入监控范围。

**配置示例**：集成主要通过Django的`settings.py`文件中的配置项控制，例如`CMDB_API_BASE_URL`用于指定CMDB API的地址，`CMDB_USE_APIGW`用于决定是否通过API网关访问。

**集成点**：`bkmonitor/api/cmdb/client.py`定义了与CMDB交互的基础API资源类`CMDBBaseResource`，它处理了API网关的切换逻辑和请求参数的封装。

**Section sources**
- [bkmonitor\api\cmdb\default.py](file://bkmonitor\api\cmdb\default.py#L0-L200)
- [bkmonitor\api\cmdb\client.py](file://bkmonitor\api\cmdb\client.py#L30-L65)

## 与通用服务引擎的集成
通用服务引擎（GSE）是bk-monitor实现数据采集和自动化操作的“神经系统”。它为监控平台提供了跨网络、高并发的指令下发和数据传输能力。

### 命令执行与数据采集
GSE通过部署在目标主机上的Agent（代理）与GSE Server集群进行通信。当bk-monitor需要执行一个脚本或采集特定数据时，它会通过GSE的API将指令下发到GSE Server，再由Server转发给指定主机的Agent执行。Agent执行完成后，将结果（如脚本输出、采集的数据）通过GSE的通道回传给bk-monitor。

`bkmonitor/api/gse/default.py`文件定义了与GSE交互的API资源。例如，`AddStreamTo`类用于配置数据接收端，这实际上是为GSE Agent指定数据上报的目标（如Kafka、Redis）。`QueryAgentStatus`类用于查询Agent的在线状态。

``mermaid
flowchart TD
A["bk-monitor (监控平台)"] --> |1. 下发指令/配置| B["GSE Server (管控中心)"]
B --> |2. 转发指令| C["GSE Agent (主机1)"]
B --> |2. 转发指令| D["GSE Agent (主机2)"]
B --> |2. 转发指令| E["GSE Agent (主机N)"]
C --> |3. 执行并上报数据| B
D --> |3. 执行并上报数据| B
E --> |3. 执行并上报数据| B
B --> |4. 数据汇聚| A
```

**Diagram sources**
- [bkmonitor\api\gse\default.py](file://bkmonitor\api\gse\default.py#L26-L64)
- [wiki\GSE(通用服务引擎).md](file://wiki\GSE(通用服务引擎).md#L67-L82)

**实际应用场景**：
1.  **实时数据采集**：GSE Agent持续采集主机的CPU、内存、磁盘等指标，并通过GSE的数据通道实时传输到bk-monitor进行处理和存储。
2.  **故障自愈**：当发生告警时，bk-monitor可以触发一个预设的“故障自愈”动作，该动作通过GSE执行一个修复脚本（如重启服务）。
3.  **批量运维**：运维人员可以通过监控平台的界面，选择一批主机并执行一个命令（如查看某个日志文件），这个操作最终由GSE来完成。

**配置示例**：在`settings.py`中，`USE_GSE_AGENT_STATUS_NEW_API`配置项决定了使用GSE的旧版还是新版API。`BKGSE_APIGW_BASE_URL`用于指定通过API网关访问GSE的基地址。

**Section sources**
- [bkmonitor\api\gse\default.py](file://bkmonitor\api\gse\default.py#L0-L200)
- [wiki\GSE(通用服务引擎).md](file://wiki\GSE(通用服务引擎).md#L21-L144)

## 与作业平台的集成
bk-monitor与作业平台（Job）的集成主要用于触发复杂的自动化运维任务。当监控系统检测到特定事件时，可以调用Job平台的API来执行一个预定义的作业方案。

### 自动化运维任务触发
`bkmonitor/api/job/default.py`文件封装了与Job平台交互的API。`JobBaseResource`类是所有Job API的基类，它处理了多租户模式下的API网关切换逻辑和权限问题。`ExecuteJobPlanResource`类用于执行一个作业方案，`GetJobInstanceStatusResource`类用于查询任务的执行状态。

```python
class ExecuteJobPlanResource(JobBaseResource):
    """
    执行作业方案
    """
    action = "execute_job_plan"
    method = "POST"

    class RequestSerializer(serializers.Serializer):
        bk_biz_id = serializers.IntegerField(label="业务ID")
        job_plan_id = serializers.IntegerField(label="作业执行方案")
        assignee = serializers.ListField(label="执行人", required=False, child=serializers.CharField())
        global_var_list = serializers.ListField(child=serializers.JSONField(), label="全局变量")
```

**实际应用场景**：在告警处理流程中，可以配置一个“执行作业”的动作。例如，当数据库连接数过高时，系统可以自动调用Job平台执行一个“数据库连接分析与清理”的作业方案，该方案可能包含多个步骤，如导出连接信息、分析慢查询、Kill异常连接等。

**配置示例**：在`settings.py`中，`JOB_API_BASE_URL`用于指定Job平台的API地址，`JOB_USE_APIGW`用于启用通过API网关的访问。

**Section sources**
- [bkmonitor\api\job\default.py](file://bkmonitor\api\job\default.py#L0-L200)

## API网关的使用与权限控制
API网关（bk-apigateway）是蓝鲸生态中统一的API入口，它为所有SaaS应用提供API的发布、鉴权、限流和监控功能。bk-monitor通过API网关与其他系统进行安全、可控的交互。

### 使用方式
`bkmonitor/api/bk_apigateway/default.py`文件定义了访问API网关本身的API。`BkApiGatewayResource`是基类，它通过`settings.APIGATEWAY_API_BASE_URL`或`BK_COMPONENT_API_URL`来构建API请求的基地址。`GetPublicKeyResource`类用于获取某个API的公钥，这通常用于API调用方进行数据加密。

```python
class BkApiGatewayResource(APIResource, metaclass=abc.ABCMeta):
    base_url = settings.APIGATEWAY_API_BASE_URL or "%s/api/bk-apigateway/prod/" % settings.BK_COMPONENT_API_URL
    module_name = "bk-apigateway"
```

### 权限控制机制
API网关的权限控制是多层次的：
1.  **应用级认证**：每个调用API的应用（App）都必须拥有一个唯一的应用ID（AppCode）和密钥（AppSecret）。在请求API时，需要通过`x-bkapi-authorization`头传递这些信息，以证明应用的身份。
2.  **用户级认证**：对于需要用户上下文的API，还需要传递用户的登录票据（如Cookie中的bk_token），API网关会验证用户身份和权限。
3.  **资源级权限**：API网关与蓝鲸权限中心（IAM）集成，可以对具体的API资源（如“执行作业”）进行细粒度的权限控制。例如，可以配置只有特定角色的用户才能调用某个高危API。

**实际应用场景**：当bk-monitor需要调用CMDB的API时，它会通过API网关进行。在`settings.py`中配置`CMDB_USE_APIGW=True`后，所有对CMDB的API调用都会被路由到API网关。API网关会验证bk-monitor应用的身份，并检查当前操作用户是否有权访问所请求的CMDB数据。

**Section sources**
- [bkmonitor\api\bk_apigateway\default.py](file://bkmonitor\api\bk_apigateway\default.py#L0-L42)

## 集成开发指南
为了帮助开发者快速上手，本节提供集成开发的关键指南。

### SDK使用
bk-monitor项目本身就是一个SDK的集合。开发者应使用`bkmonitor/api/`目录下各系统对应的模块（如`api/cmdb`, `api/gse`）来发起API调用。这些模块已经封装了认证、序列化、错误处理等逻辑，开发者只需关注业务参数。

### 认证流程
1.  **应用认证**：确保`settings.py`中配置了正确的`BK_APP_CODE`和`BK_APP_SECRET`。
2.  **用户认证**：在Web请求上下文中，用户的登录状态通常由Django中间件自动处理。在后台任务中，可能需要使用`get_backend_username`等工具函数获取后台服务账号。
3.  **API网关认证**：当`USE_APIGW`系列配置项为True时，认证信息会自动通过`x-bkapi-authorization`头传递。

### 错误处理
所有API调用都应进行异常捕获。常见的错误包括：
-  **网络错误**：使用`try-except`捕获`requests.exceptions.RequestException`。
-  **API业务错误**：捕获`core.errors.api.BKAPIError`，该异常包含了API返回的错误码和错误信息。
-  **权限错误**：捕获`core.errors.iam.APIPermissionDeniedError`。

```python
from core.errors.api import BKAPIError
from core.errors.iam import APIPermissionDeniedError

try:
    result = api.job.execute_job_plan(bk_biz_id=123, job_plan_id=456)
except BKAPIError as e:
    logger.error(f"API调用失败: {e}")
except APIPermissionDeniedError as e:
    logger.error(f"权限不足: {e}")
```

## 与BCS系统的集成
本次更新增强了与蓝鲸容器服务（BCS）系统的集成能力，通过`check_bcs_cluster_status.py`命令实现了对BCS集群监控链路的全面检查。

### BCS集群状态检查
`bkmonitor/metadata/management/commands/check_bcs_cluster_status.py`命令行工具是与BCS系统集成的核心。它从15个维度对BCS集群的监控链路进行健康检查，确保数据采集、存储和处理的完整性。

**核心检查项**：
1.  **数据库记录检查**：验证集群在`BCSClusterInfo`模型中的基础配置。
2.  **BCS API连接测试**：通过`api.kubernetes.fetch_k8s_cluster_list`验证与BCS服务的通信。
3.  **Kubernetes集群连接**：使用`k8s_client`库测试K8s API的可用性。
4.  **数据源配置验证**：检查`DataSource`模型中K8s指标、自定义指标和事件的数据源配置。
5.  **监控资源状态**：验证`ServiceMonitorInfo`和`PodMonitorInfo`等CRD资源的存在。
6.  **数据存储链路**：检查InfluxDB和Elasticsearch存储集群的健康状态。
7.  **Consul配置检查**：通过`consul.BKConsul()`验证配置中心的数据同步。
8.  **数据采集配置**：检查替换规则（`ReplaceConfig`）和时序数据组（`TimeSeriesGroup`）的配置。
9.  **联邦集群关系**：对于联邦集群，验证`BcsFederalClusterInfo`中的拓扑和命名空间映射。
10. **数据路由配置**：检查数据源到Transfer和MQ集群的路由配置。
11. **集群资源使用**：通过K8s API获取节点和Pod的资源使用情况。
12. **初始化资源检查**：验证`EventGroup`、`TimeSeriesGroup`和`SpaceDataSource`的关联状态。
13. **bk-collector配置**：检查DaemonSet部署、Pod运行状态和ConfigMap配置。
14. **业务权限检查**：验证数据源与业务空间（Space）的授权关系。
15. **API Token与云区域**：检查BCS API Token和云区域ID的配置。

``mermaid
graph TD
A[check_bcs_cluster_status] --> B[数据库记录检查]
A --> C[BCS API连接测试]
A --> D[Kubernetes集群连接]
A --> E[数据源配置验证]
A --> F[监控资源状态检查]
A --> G[数据存储链路检查]
A --> H[Consul配置检查]
A --> I[数据采集配置检查]
A --> J[联邦集群关系检查]
A --> K[数据路由配置检查]
A --> L[集群资源使用情况检查]
A --> M[初始化资源检查]
A --> N[bk-collector配置]
A --> O[业务权限检查]
A --> P[API Token配置]
A --> Q[云区域ID配置]
```

**Diagram sources**
- [bkmonitor\metadata\management\commands\check_bcs_cluster_status.py](file://bkmonitor\metadata\management\commands\check_bcs_cluster_status.py#L0-L1522) - *定义了完整的检查流程*
- [README_BCS_CLUSTER_CHECK_ENHANCED.md](file://README_BCS_CLUSTER_CHECK_ENHANCED.md#L0-L252) - *提供了增强功能的详细说明*

**实际应用场景**：运维人员可以定期执行此命令，生成BCS集群的健康报告，及时发现监控链路中的配置缺失或服务异常，确保容器化应用的监控数据完整可靠。

**配置示例**：
```bash
# 检查指定集群状态
python manage.py check_bcs_cluster_status --cluster-id BCS-K8S-00001
# 以JSON格式输出，便于程序化处理
python manage.py check_bcs_cluster_status --cluster-id BCS-K8S-00001 --format json
```

**Section sources**
- [bkmonitor\metadata\management\commands\check_bcs_cluster_status.py](file://bkmonitor\metadata\management\commands\check_bcs_cluster_status.py#L0-L1522) - *新增，BCS集群状态检查命令*
- [README_BCS_CLUSTER_CHECK_ENHANCED.md](file://README_BCS_CLUSTER_CHECK_ENHANCED.md#L0-L252) - *新增，增强BCS集群检查功能*

## 与AI小鲸系统的集成
本次更新重构了与AI小鲸（AIWhale）系统的集成逻辑，通过提取SDK交互句柄，使其能被日志平台等其他系统复用。

### SDK交互句柄
`ai_agent/core/aidev_interface.py`文件定义了`AIDevInterface`类，作为与AI小鲸平台交互的统一SDK。该类被移至项目外层，便于其他模块（如日志平台）直接导入和使用。

**核心功能**：
- **Agent管理**：`get_agent_info`方法用于获取智能体（Agent）的配置信息。
- **会话管理**：提供`create_chat_session`、`retrieve_chat_session`、`destroy_chat_session`等方法，用于全生命周期管理聊天会话。
- **会话内容管理**：`create_chat_session_content`方法在创建会话内容时，会先尝试通过`LocalCommandProcessor`进行本地指令处理，再将结果上报至平台。
- **发起对话**：`create_chat_completion`方法是发起对话的核心。它使用`AgentInstanceFactory`工厂模式构建Agent实例，并支持流式和非流式响应。对于流式响应，它通过`handle_streaming_response_with_metrics`包装器增强处理，可以上报性能指标。

```python
class AIDevInterface:
    def __init__(self, app_code, app_secret, metrics_reporter=None):
        self.api_client = BKAidevApi.get_client(app_code=app_code, app_secret=app_secret)
        self.local_command_processor = LocalCommandProcessor()  # 本地指令处理器
        self.metrics_reporter = metrics_reporter  # 指标上报器

    def create_chat_completion(self, session_code, execute_kwargs, agent_code, username):
        """发起流式/非流式会话"""
        callbacks = [get_langfuse_callback()]  # 添加Langfuse回调
        agent_instance = AgentInstanceFactory.build_agent(
            build_type=AgentBuildType.SESSION,
            session_code=session_code,
            resource_manager=self.api_client,
            callbacks=callbacks,
        )
        # ... (流式/非流式处理逻辑)
```

**实际应用场景**：监控平台可以利用此SDK，为用户提供智能问答、故障分析等AI能力。当用户在监控界面提问时，前端调用此SDK与AI小鲸后端通信，将分析结果返回给用户。同时，日志平台也可以直接复用此SDK，无需重复开发。

**配置示例**：在初始化`AIDevInterface`时，需要传入蓝鲸应用的`app_code`和`app_secret`进行认证。

**Section sources**
- [ai_agent\core\aidev_interface.py](file://ai_agent\core\aidev_interface.py#L0-L122) - *重构，AI小鲸SDK交互句柄*

## 最佳实践与常见问题
### 最佳实践
1.  **使用批量请求**：对于需要获取大量数据的场景（如获取所有主机），优先使用`batch_request`工具，避免单次请求过多数据导致超时。
2.  **合理利用缓存**：对于不经常变动的数据（如业务拓扑），使用`@using_cache`装饰器进行缓存，减少对后端系统的压力。
3.  **优雅处理失败**：在调用Job等关键API时，实现重试机制，并在失败时提供清晰的错误日志。
4.  **定期执行BCS集群检查**：建议将`check_bcs_cluster_status`命令加入定时任务，每日执行，及时发现容器监控链路的潜在问题。
5.  **复用AI小鲸SDK**：新开发需要AI能力的系统时，应优先考虑复用`ai_agent/core/aidev_interface.py`中的`AIDevInterface`，避免重复造轮子。

### 常见问题解决方案
-  **问题**：调用API返回“权限不足”。
  **解决方案**：检查`settings.py`中的应用ID/密钥是否正确，并在蓝鲸权限中心确认该应用是否有权访问目标API。
-  **问题**：GSE Agent无法连接。
  **解决方案**：检查目标主机的网络是否能访问GSE Server的端口，确认Agent进程是否正常运行。
-  **问题**：CMDB拓扑数据不完整。
  **解决方案**：确认CMDB中该业务的主机和拓扑关系是否已正确录入，并检查`list_biz_hosts_topo` API的调用参数是否正确。
-  **问题**：BCS集群检查报告中出现“数据源未启用”。
  **解决方案**：进入监控平台的数据源管理页面，找到对应的数据源并启用。
-  **问题**：AI对话流式响应中断。
  **解决方案**：检查网络连接稳定性，并确认`metrics_reporter`配置正确，以便收集流式传输的性能指标用于分析。