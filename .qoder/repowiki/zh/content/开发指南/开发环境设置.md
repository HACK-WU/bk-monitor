# 开发环境设置

<cite>
**本文档引用的文件**  
- [dev.py](file://bklog/config/dev.py)
- [env.py](file://bklog/config/env.py)
- [default.py](file://bklog/config/default.py)
- [requirements_dev.txt](file://bklog/requirements_dev.txt)
- [requirements.txt](file://bklog/requirements.txt)
- [Dockerfile](file://bklog/Dockerfile)
- [Dockerfile.monitor.dev](file://Dockerfile.monitor.dev)
- [Makefile](file://bklog/Makefile)
- [env.sh](file://bklog/scripts/env.sh)
- [test_env.sh](file://bklog/scripts/test_env.sh)
- [dev.env.yml](file://bklog/dev.env.yml)
- [stag.env.yml](file://bklog/stag.env.yml)
- [prod.env.yml](file://bklog/prod.env.yml)
</cite>

## 目录
1. [Python环境配置](#python环境配置)
2. [依赖安装](#依赖安装)
3. [数据库配置](#数据库配置)
4. [Elasticsearch测试环境搭建](#elasticsearch测试环境搭建)
5. [配置文件设置](#配置文件设置)
6. [Docker开发环境使用方法](#docker开发环境使用方法)
7. [环境验证步骤](#环境验证步骤)
8. [常见环境问题排查](#常见环境问题排查)

## Python环境配置

本项目推荐使用Python 3.8及以上版本进行开发。根据Dockerfile.monitor.dev文件中的配置，开发环境基于Python 3.6.15构建，但建议在本地开发时使用更高版本的Python 3.8+以获得更好的性能和兼容性。

在设置Python环境时，需要确保安装了正确的Python版本，并配置好虚拟环境。可以通过以下命令检查Python版本：

```bash
python --version
```

如果系统中未安装Python 3.8+，建议使用pyenv等版本管理工具进行安装和管理。

**Section sources**
- [Dockerfile.monitor.dev](file://Dockerfile.monitor.dev#L1-L47)

## 依赖安装

项目依赖通过pip进行管理，开发环境所需的依赖定义在requirements_dev.txt文件中。要安装所有开发依赖，请执行以下命令：

```bash
pip install -r requirements.txt
pip install -r requirements_dev.txt
```

根据requirements_dev.txt文件内容，开发依赖主要包括：
- virtualenv==15.2
- virtualenv-clone==0.2.6
- virtualenvwrapper==4.7.1
- pre-commit==1.18.2
- flake8==3.7.8
- seed-isort-config==1.9.2
- coverage==4.5.4
- mistune==0.8.4
- pyproject-flake8==0.0.1-alpha.2

此外，主依赖文件requirements.txt包含了项目运行所需的所有包，包括Django、celery、redis、elasticsearch等关键组件。

**Section sources**
- [requirements_dev.txt](file://bklog/requirements_dev.txt#L1-L13)
- [requirements.txt](file://bklog/requirements.txt#L1-L143)

## 数据库配置

项目使用MySQL作为主要数据库，Redis作为缓存和消息队列。根据dev.py配置文件，本地开发环境的数据库配置如下：

- MySQL主机：127.0.0.1
- 端口：3306
- 用户名：root
- 密码：空
- 数据库名：由APP_CODE变量决定
- 引擎：django.db.backends.mysql

Redis配置用于Celery消息队列：
- Redis主机：localhost
- 端口：6379
- 数据库：0
- 连接URL：redis://localhost:6379/0

在本地环境中，需要确保MySQL和Redis服务已启动并正确配置。可以通过以下命令启动服务（以Ubuntu为例）：

```bash
sudo service mysql start
sudo service redis-server start
```

**Section sources**
- [dev.py](file://bklog/config/dev.py#L43-L62)

## Elasticsearch测试环境搭建

项目使用Elasticsearch作为日志存储和查询引擎。虽然配置文件中没有直接的Elasticsearch连接配置，但从代码结构和依赖可以看出，项目支持Elasticsearch作为数据源。

根据requirements.txt文件，项目依赖了多个版本的elasticsearch包：
- elasticsearch==7.17.9
- elasticsearch5==5.5.6
- elasticsearch6==6.4.2
- elasticsearch_dsl==7.0.0

建议在本地开发环境中使用Docker来快速搭建Elasticsearch测试环境：

```bash
# 启动Elasticsearch容器
docker run -d --name elasticsearch -p 9200:9200 -p 9300:9300 -e "discovery.type=single-node" elasticsearch:7.17.9

# 验证Elasticsearch是否正常运行
curl http://localhost:9200
```

**Section sources**
- [requirements.txt](file://bklog/requirements.txt#L37-L42)

## 配置文件设置

项目的配置文件位于config目录下，主要包括dev.py、env.py和default.py三个核心配置文件。

### dev.py配置

dev.py是开发环境的主要配置文件，定义了开发模式下的各项设置：
- 运行模式：DEVELOP
- 调试模式：DEBUG = True
- Celery消息队列使用Redis
- 数据库配置指向本地MySQL
- 包含GRAFANA、IAM等服务的配置

### env.py配置

env.py负责加载环境特定的配置，通过YAML文件动态加载不同环境的设置。它定义了：
- 环境判断逻辑（通过BKPAAS_ENVIRONMENT或BK_ENV环境变量）
- YAML配置文件加载机制
- 环境变量格式化功能

### 环境YAML文件

项目提供了三个环境YAML配置文件：
- dev.env.yml：开发环境配置
- stag.env.yml：预发布环境配置
- prod.env.yml：生产环境配置

这些YAML文件包含特定于环境的设置，如API网关根路径、文档URL等。例如，dev.env.yml中定义了：
- 各个API网关的根路径
- 文档和帮助链接
- 初始超级用户设置

配置加载流程为：default.py提供默认值 → env.py根据环境加载对应的YAML文件 → dev.py等环境配置文件应用具体设置。

**Section sources**
- [dev.py](file://bklog/config/dev.py#L1-L112)
- [env.py](file://bklog/config/env.py#L1-L112)
- [default.py](file://bklog/config/default.py#L1-L800)
- [dev.env.yml](file://bklog/dev.env.yml#L1-L87)
- [stag.env.yml](file://bklog/stag.env.yml#L1-L87)
- [prod.env.yml](file://bklog/prod.env.yml#L1-L86)

## Docker开发环境使用方法

项目提供了Docker开发环境支持，主要通过Dockerfile和Dockerfile.monitor.dev两个文件定义。

### 主要Docker配置

Dockerfile定义了应用的基础镜像和构建过程：
- 基础镜像：tencentos/tencentos4-minimal:4.4-v20250922
- 安装必要的构建工具（curl, vim, gcc等）
- 使用uv工具创建虚拟环境并安装依赖
- 设置环境变量（C_FORCE_ROOT, VIRTUAL_ENV等）

### 开发专用Docker配置

Dockerfile.monitor.dev为开发环境提供了更完整的工具链：
- 基础镜像：python:3.6.15
- 安装开发工具（curl, wget, git, vim, supervisor等）
- 配置code-server作为Web IDE
- 安装Node.js v18.18.2和npm
- 安装VS Code扩展（Python, Material主题等）
- 复制开发脚本和配置文件

### 容器启动和端口映射

要启动Docker开发环境，可以使用以下命令：

```bash
# 构建镜像
docker build -f Dockerfile.monitor.dev -t bk-monitor-dev .

# 运行容器并映射端口
docker run -d \
  -p 8080:8080 \
  -p 2358:2358 \
  -p 9200:9200 \
  -p 6379:6379 \
  -p 3306:3306 \
  --name bk-monitor-dev \
  bk-monitor-dev
```

关键端口映射包括：
- 8080：应用服务端口
- 2358：code-server端口
- 9200：Elasticsearch端口
- 6379：Redis端口
- 3306：MySQL端口

**Section sources**
- [Dockerfile](file://bklog/Dockerfile#L1-L23)
- [Dockerfile.monitor.dev](file://Dockerfile.monitor.dev#L1-L47)

## 环境验证步骤

完成环境搭建后，需要进行一系列验证确保所有服务正常运行。

### 服务状态检查

1. **Python环境验证**：
```bash
python --version
pip list | grep django
```

2. **数据库连接验证**：
```bash
# 测试MySQL连接
mysql -h 127.0.0.1 -u root -p -e "SHOW DATABASES;"

# 测试Redis连接
redis-cli ping
```

3. **Elasticsearch验证**：
```bash
curl http://localhost:9200
```

### 应用启动验证

1. **安装依赖并迁移数据库**：
```bash
pip install -r requirements.txt
python manage.py migrate
```

2. **创建超级用户**：
```bash
python manage.py createsuperuser
```

3. **启动开发服务器**：
```bash
python manage.py runserver 0.0.0.0:8000
```

4. **验证Celery工作进程**：
```bash
python manage.py celery worker -l info
```

### 配置完整性检查

通过检查配置文件加载是否正常，确保所有环境变量和配置项都已正确设置。特别是要验证：
- dev.py中的DEBUG模式是否启用
- 数据库连接参数是否正确
- Redis连接是否配置
- 环境YAML文件是否被正确加载

**Section sources**
- [Makefile](file://bklog/Makefile#L1-L19)
- [env.sh](file://bklog/scripts/env.sh#L1-L53)
- [test_env.sh](file://bklog/scripts/test_env.sh#L1-L5)

## 常见环境问题排查

### 依赖冲突问题

当出现依赖冲突时，可以采取以下措施：

1. **使用虚拟环境隔离**：
```bash
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

2. **检查依赖版本冲突**：
```bash
pip check
```

3. **清理并重新安装**：
```bash
pip uninstall -y $(pip freeze | cut -d'=' -f1)
pip install -r requirements.txt
```

### 端口占用问题

当遇到端口被占用的情况，可以：

1. **检查端口占用情况**：
```bash
# 检查常用端口
lsof -i :3306
lsof -i :6379
lsof -i :9200
lsof -i :8000
```

2. **终止占用进程**：
```bash
# 终止占用3306端口的进程
lsof -i :3306 | grep LISTEN | awk '{print $2}' | xargs kill -9
```

3. **修改配置使用其他端口**：
在dev.py中修改数据库端口：
```python
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.mysql",
        "NAME": APP_CODE,
        "USER": "root",
        "PASSWORD": "",
        "HOST": "127.0.0.1",
        "PORT": "3307",  # 修改为未被占用的端口
    },
}
```

### 配置加载问题

如果配置未正确加载，检查：

1. **环境变量设置**：
```bash
echo $BKPAAS_ENVIRONMENT
echo $BK_ENV
```

2. **YAML文件路径**：
确保dev.env.yml等文件位于正确路径

3. **配置优先级**：
理解default.py → env.py → dev.py的配置加载优先级

### Docker相关问题

1. **镜像构建失败**：
检查网络连接，确保能访问镜像仓库

2. **容器启动失败**：
查看容器日志：
```bash
docker logs bk-monitor-dev
```

3. **端口映射问题**：
确保主机端口未被其他服务占用

通过以上步骤，可以有效排查和解决开发环境中常见的各种问题，确保开发工作顺利进行。

**Section sources**
- [dev.py](file://bklog/config/dev.py#L1-L112)
- [env.py](file://bklog/config/env.py#L1-L112)
- [Dockerfile](file://bklog/Dockerfile#L1-L23)
- [Dockerfile.monitor.dev](file://Dockerfile.monitor.dev#L1-L47)