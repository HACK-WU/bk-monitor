# 时序数据采集

<cite>
**本文档引用的文件**  
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py)
- [query.py](file://bkmonitor/bkmonitor/data_source/models/query.py)
- [data_source.py](file://bkmonitor/bkmonitor/data_source/data_source.py)
- [compiler.py](file://bkmonitor/bkmonitor/data_source/backends/base/compiler.py)
- [connection.py](file://bkmonitor/bkmonitor/data_source/backends/base/connection.py)
- [operations.py](file://bkmonitor/bkmonitor/data_source/backends/base/operations.py)
- [time_series.py](file://bkmonitor/bkmonitor/data_source/handler/time_series.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细描述了蓝鲸监控平台中时序数据采集的实现机制，重点分析了如何通过统一查询框架（UnifyQuery）从时序数据库（如InfluxDB）中获取数据。文档涵盖了数据源后端实现、查询构建逻辑、参数解析、结果格式化以及扩展新数据源的方法。

## 项目结构
时序数据采集功能主要分布在`bkmonitor/data_source/`目录下，采用模块化设计，分离了数据源定义、查询构建、编译执行和结果处理等职责。

```mermaid
graph TD
subgraph "数据源模块"
A[backends] --> B[base]
B --> C[compiler.py]
B --> D[connection.py]
B --> E[operations.py]
A --> F[time_series]
G[handler] --> H[time_series.py]
I[models] --> J[query.py]
K[unify_query] --> L[builder.py]
end
```

**图示来源**  
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py)
- [query.py](file://bkmonitor/bkmonitor/data_source/models/query.py)
- [compiler.py](file://bkmonitor/bkmonitor/data_source/backends/base/compiler.py)

## 核心组件
时序数据采集系统的核心组件包括查询模型、统一查询构建器、数据源处理器和后端连接器。这些组件共同实现了从高层查询请求到具体数据库查询的转换与执行。

**本节来源**  
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py#L1-L555)
- [query.py](file://bkmonitor/bkmonitor/data_source/models/query.py#L1-L243)

## 架构概述
系统采用类ORM的设计模式，将时序数据查询抽象为可组合的对象，通过统一查询接口与底层数据源进行交互。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Handler as "time_series.py"
participant Builder as "QueryConfigBuilder"
participant Compiler as "UnifyQueryCompiler"
participant Connection as "DatabaseConnection"
participant DataSource as "数据源后端"
Client->>Handler : 发起时序数据查询请求
Handler->>Builder : 构建查询配置
Builder->>Builder : 添加指标、条件、分组等
Builder->>Compiler : 生成查询语句
Compiler->>Connection : 执行查询
Connection->>DataSource : 访问InfluxDB等时序数据库
DataSource-->>Connection : 返回原始数据
Connection-->>Compiler : 数据处理
Compiler-->>Builder : 结果封装
Builder-->>Handler : 返回格式化结果
Handler-->>Client : 返回最终数据
```

**图示来源**  
- [time_series.py](file://bkmonitor/bkmonitor/data_source/handler/time_series.py)
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py)
- [connection.py](file://bkmonitor/bkmonitor/data_source/backends/base/connection.py)

## 详细组件分析

### 查询模型分析
`models/query.py`文件定义了时序数据查询的基础模型和混合类，提供了数据遍历、查询构造和DSL操作等核心功能。

```mermaid
classDiagram
class IterMixin {
+__getitem__(k)
+__len__()
+__iter__()
+all()
+limit(k)
+offset(o)
+_fetch_all()
+raw_data
+data
+iterator()
+original_data
+first()
}
class QueryMixin {
+table(table_name)
+values(*fields)
+time_field(field)
+filter(*args, **kwargs)
+group_by(*fields)
+order_by(*fields)
+distinct(field)
}
class DslMixin {
+use_full_index_names(use_full_index_names)
+dsl_raw_query_string(query_string, nested_paths)
+dsl_index_set_id(index_set_id)
+dsl_group_hits(size)
+dsl_search_after(search_after_key)
+dsl_date_histogram(enable)
}
class BaseDataQuery {
+TYPE
+QUERY_CLASS
+__init__(using, query)
+_clone()
}
class DataQuery {
+target_type(target_type)
+bk_tenant_id(bk_tenant_id)
+raw(raw_query, params)
+metrics(metrics)
+agg_condition(agg_condition)
}
BaseDataQuery <|-- DataQuery
DataQuery <|-- QueryMixin
DataQuery <|-- IterMixin
DataQuery <|-- DslMixin
```

**图示来源**  
- [query.py](file://bkmonitor/bkmonitor/data_source/models/query.py#L19-L243)

### 统一查询构建器分析
`unify_query/builder.py`实现了统一查询的构建器模式，提供了流畅的API来构造复杂的时序数据查询。

```mermaid
classDiagram
class QueryConfig {
+data_label : str
+reference_name : str
+interval : int | None
+metrics : list[dict]
+dimension_fields : list[str]
+functions : list[dict]
+conditions : list[dict]
+clone()
+set_data_label(data_label)
+set_reference_name(reference_name)
+set_interval(interval)
+add_metric(field, method, alias)
+add_func(_id, params)
+add_condition(condition)
+add_dimension_fields(field)
}
class QueryConfigBuilder {
+QUERY_CLASS
+data_label(data_label)
+alias(alias)
+metric(field, method, alias)
+func(_id, params)
+conditions(conditions)
+tag_values(*fields)
+interval(interval)
+index_set_id(index_set_id)
+table(table_name)
+values(*fields)
+filter(*args, **kwargs)
+group_by(*fields)
+order_by(*fields)
+time_field(field)
+query_string(query_string, nested_paths)
}
class UnifyQueryConfig {
+bk_biz_id : int | None
+instant : bool
+is_time_agg : bool
+is_time_align : bool
+expression : str
+functions : list[dict]
+query_configs : list[QueryConfig]
+start_time : int
+end_time : int
+offset : int
+low_mark : int
+high_mark : int | None
+search_after_key : dict | None
+clone()
+set_search_after_key(search_after_key)
+set_scope(bk_biz_id)
+set_instant(instant)
+set_time_agg(is_time_agg)
+set_time_align(is_time_align)
+set_expression(expression)
+add_func(_id, params)
+add_q(query_config)
+set_start_time(start_time)
+set_end_time(end_time)
+set_offset(offset)
+set_limits(low, high)
+get_limit()
+get_compiler(using)
}
class UnifyQuerySet {
+using
+_result_cache
+query
+_clone()
+scope(bk_biz_id)
+after(after_key)
+instant(instant, align_interval)
+time_agg(is_time_agg)
+time_align(is_time_align)
+func(_id, params)
+expression(expression)
+add_query(q)
+start_time(start_time)
+end_time(end_time)
}
QueryConfigBuilder <|-- QueryMixin
QueryConfigBuilder <|-- DslMixin
UnifyQuerySet <|-- IterMixin
UnifyQuerySet <|-- CompilerMixin
```

**图示来源**  
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py#L54-L555)

### 时序数据处理器分析
`handler/time_series.py`负责处理时序数据的HTTP请求，解析参数并调用相应的查询构建器。

```mermaid
flowchart TD
Start([开始]) --> ParseParams["解析请求参数"]
ParseParams --> ValidateParams["验证参数有效性"]
ValidateParams --> BuildQuery["构建查询配置"]
BuildQuery --> AddMetrics["添加指标"]
BuildQuery --> AddConditions["添加查询条件"]
BuildQuery --> AddGroupBy["添加分组字段"]
BuildQuery --> SetTimeRange["设置时间范围"]
SetTimeRange --> ExecuteQuery["执行查询"]
ExecuteQuery --> FormatResult["格式化结果"]
FormatResult --> ReturnResult["返回响应"]
ReturnResult --> End([结束])
style Start fill:#9f9,stroke:#333
style End fill:#f9f,stroke:#333
```

**图示来源**  
- [time_series.py](file://bkmonitor/bkmonitor/data_source/handler/time_series.py)

## 依赖分析
时序数据采集模块依赖于多个核心组件和外部服务，形成了清晰的依赖关系。

```mermaid
graph LR
A[time_series.py] --> B[QueryConfigBuilder]
B --> C[UnifyQueryConfig]
C --> D[DatabaseConnection]
D --> E[BaseDatabaseOperations]
D --> F[UnifyQueryCompiler]
F --> G[Query]
G --> H[WhereNode]
A --> I[load_data_source]
I --> J[DataSource]
J --> K[InfluxDBBackend]
K --> L[InfluxDBClient]
```

**图示来源**  
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py)
- [data_source.py](file://bkmonitor/bkmonitor/data_source/data_source.py)
- [connection.py](file://bkmonitor/bkmonitor/data_source/backends/base/connection.py)

## 性能考虑
在设计时序数据查询时，需要考虑以下性能优化建议：

1. **合理设置时间范围**：避免查询过长的时间跨度，建议使用分页或滚动查询
2. **优化查询条件**：使用索引字段作为查询条件，减少扫描的数据量
3. **控制返回数据量**：通过limit和offset控制单次查询返回的数据点数量
4. **合理使用聚合**：在数据库层面进行聚合计算，减少网络传输数据量
5. **缓存机制**：对频繁查询的静态数据使用缓存
6. **并行查询**：对于多个独立的查询，可以考虑并行执行

## 故障排除指南
当遇到时序数据采集问题时，可以按照以下步骤进行排查：

**本节来源**  
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py#L254-L273)
- [connection.py](file://bkmonitor/bkmonitor/data_source/backends/base/connection.py#L345-L346)

## 结论
本文档详细介绍了蓝鲸监控平台中时序数据采集的实现机制。系统通过统一查询框架提供了灵活、可扩展的数据访问能力，支持多种时序数据库。通过类ORM的设计模式，使得复杂的时序数据查询变得简单易用，同时保持了良好的性能和可维护性。