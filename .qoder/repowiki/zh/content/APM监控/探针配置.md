# 探针配置

<cite>
**本文档引用的文件**   
- [application_config.py](file://bkmonitor/apm/core/application_config.py)
- [cluster_config.py](file://bkmonitor/apm/core/cluster_config.py)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py)
- [config.py](file://bkmonitor/apm/models/config.py)
- [constants.py](file://bkmonitor/apm/constants.py)
</cite>

## 目录
1. [引言](#引言)
2. [配置模型与数据结构](#配置模型与数据结构)
3. [配置层次结构与继承关系](#配置层次结构与继承关系)
4. [配置动态更新机制](#配置动态更新机制)
5. [配置优先级决策流程](#配置优先级决策流程)
6. [配置推送机制](#配置推送机制)
7. [多层级配置冲突处理策略](#多层级配置冲突处理策略)
8. [总结](#总结)

## 引言

探针配置管理系统是蓝鲸监控平台（BlueKing - Monitor）中应用性能管理（APM）模块的核心组件，负责管理应用级、集群级和平台级的配置。该系统通过三个主要配置模块——`application_config.py`、`cluster_config.py`和`platform_config.py`——实现配置的分层管理、动态更新和推送。本文档详细说明这三个配置模块的层次结构、继承关系、配置模型、动态更新机制以及配置优先级的决策流程。

**Section sources**
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L1-L614)
- [cluster_config.py](file://bkmonitor/apm/core/cluster_config.py#L1-L54)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L1-L552)

## 配置模型与数据结构

配置模型定义了应用级、集群级和平台级配置的存储和管理方式。这些配置通过`models/config.py`中的模型类进行定义和管理。

```mermaid
classDiagram
class AppConfigBase {
+int bk_biz_id
+str app_name
+str config_level
+str config_key
+configs(bk_biz_id, app_name, config_level) AppConfigBase[]
+refresh_config(bk_biz_id, app_name, config_level, config_key, refresh_configs, need_delete_config) void
+delete_config(bk_biz_id, app_name, delete_configs) void
}
class ApdexConfig {
+str span_kind
+str predicate_key
+int apdex_t
+to_config_json() dict
}
class SamplerConfig {
+str sampler_type
+int sampling_percentage
+to_config_json() dict
}
class NormalTypeValueConfig {
+str type
+str value
+get_app_value(bk_biz_id, app_name, config_type) str
}
class QpsConfig {
+int qps
+get_application_qps(bk_biz_id, app_name) int
}
class LicenseConfig {
+bool enabled
+int expire_time
+str tolerable_expire
+int number_nodes
+float tolerable_num_ratio
+get_application_license_config(bk_biz_id, app_name) dict
+to_config_json() dict
}
class ProbeConfig {
+str sn
+dict rules
+get_config(bk_biz_id, app_name) ProbeConfig
}
class ApmInstanceDiscover {
+str discover_key
+int rank
+to_json() dict
}
class ApmMetricDimension {
+str span_kind
+str predicate_key
+str dimension_key
+to_json() dict
}
AppConfigBase <|-- ApdexConfig
AppConfigBase <|-- SamplerConfig
AppConfigBase <|-- NormalTypeValueConfig
AppConfigBase <|-- QpsConfig
AppConfigBase <|-- LicenseConfig
AppConfigBase <|-- ProbeConfig
AppConfigBase <|-- ApmInstanceDiscover
AppConfigBase <|-- ApmMetricDimension
```

**Diagram sources **
- [config.py](file://bkmonitor/apm/models/config.py#L614-L894)

**Section sources**
- [config.py](file://bkmonitor/apm/models/config.py#L614-L894)

## 配置层次结构与继承关系

探针配置系统采用分层结构，分为应用级、集群级和平台级三个层次。每个层次的配置都有其特定的作用范围和优先级。

```mermaid
graph TD
PlatformConfig[平台级配置] --> |继承| ClusterConfig[集群级配置]
ClusterConfig --> |继承| ApplicationConfig[应用级配置]
ApplicationConfig --> |覆盖| PlatformConfig
ApplicationConfig --> |覆盖| ClusterConfig
```

**Diagram sources **
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L52-L614)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L42-L552)

**Section sources**
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L52-L614)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L42-L552)

## 配置动态更新机制

配置动态更新机制允许在不重启探针的情况下更新配置。当配置发生变化时，系统会自动检测并更新配置。

```mermaid
sequenceDiagram
participant User as 用户
participant API as 配置API
participant ConfigDB as 配置数据库
participant ConfigManager as 配置管理器
participant Probe as 探针
User->>API : 更新配置
API->>ConfigDB : 存储新配置
ConfigDB-->>API : 确认存储
API-->>User : 配置更新成功
API->>ConfigManager : 通知配置变更
ConfigManager->>ConfigManager : 检查配置变化
ConfigManager->>Probe : 推送新配置
Probe-->>ConfigManager : 确认接收
ConfigManager-->>API : 确认推送成功
```

**Diagram sources **
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L58-L84)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L53-L70)

**Section sources**
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L58-L84)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L53-L70)

## 配置优先级决策流程

配置优先级决策流程决定了在多层级配置冲突时，哪个配置会被最终采用。以下是配置优先级的决策流程图。

```mermaid
flowchart TD
Start([开始]) --> CheckAppConfig["检查应用级配置"]
CheckAppConfig --> AppConfigExists{"应用级配置存在?"}
AppConfigExists --> |是| UseAppConfig["使用应用级配置"]
AppConfigExists --> |否| CheckClusterConfig["检查集群级配置"]
CheckClusterConfig --> ClusterConfigExists{"集群级配置存在?"}
ClusterConfigExists --> |是| UseClusterConfig["使用集群级配置"]
ClusterConfigExists --> |否| CheckPlatformConfig["检查平台级配置"]
CheckPlatformConfig --> PlatformConfigExists{"平台级配置存在?"}
PlatformConfigExists --> |是| UsePlatformConfig["使用平台级配置"]
PlatformConfigExists --> |否| UseDefault["使用默认配置"]
UseAppConfig --> End([结束])
UseClusterConfig --> End
UsePlatformConfig --> End
UseDefault --> End
```

**Diagram sources **
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L146-L220)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L103-L123)

**Section sources**
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L146-L220)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L103-L123)

## 配置推送机制

配置推送机制负责将更新后的配置推送到各个探针实例。系统通过节点管理和Kubernetes两种方式实现配置推送。

```mermaid
sequenceDiagram
participant ConfigManager as 配置管理器
participant NodeMan as 节点管理
participant K8S as Kubernetes
participant Probe as 探针
ConfigManager->>NodeMan : 下发配置到主机
NodeMan->>Probe : 安装或更新插件
Probe-->>NodeMan : 确认安装
NodeMan-->>ConfigManager : 确认推送成功
ConfigManager->>K8S : 下发配置到K8S集群
K8S->>Probe : 更新Secret或ConfigMap
Probe-->>K8S : 重新加载配置
K8S-->>ConfigManager : 确认推送成功
```

**Diagram sources **
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L545-L614)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L489-L552)

**Section sources**
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L545-L614)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L489-L552)

## 多层级配置冲突处理策略

在多层级配置冲突时，系统采用以下处理策略：

1. **应用级配置优先**：当应用级配置存在时，无论集群级或平台级配置如何，都优先使用应用级配置。
2. **集群级配置次之**：当应用级配置不存在时，使用集群级配置。
3. **平台级配置作为默认**：当应用级和集群级配置都不存在时，使用平台级配置。
4. **默认配置兜底**：当所有层级的配置都不存在时，使用系统默认配置。

例如，假设某个应用的QPS限制在应用级配置中设置为1000，在集群级配置中设置为500，在平台级配置中设置为200。根据上述策略，该应用的QPS限制将被设置为1000，因为应用级配置具有最高优先级。

**Section sources**
- [application_config.py](file://bkmonitor/apm/core/application_config.py#L259-L265)
- [platform_config.py](file://bkmonitor/apm/core/platform_config.py#L196-L197)

## 总结

探针配置管理系统通过分层结构和继承关系，实现了灵活且高效的配置管理。系统支持动态更新和推送，确保配置变更能够及时生效。通过明确的优先级决策流程和冲突处理策略，保证了配置的一致性和可靠性。这些机制共同构成了一个健壮的配置管理体系，为蓝鲸监控平台的稳定运行提供了有力支持。