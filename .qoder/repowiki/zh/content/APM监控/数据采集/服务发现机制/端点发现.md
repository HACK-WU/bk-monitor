# 端点发现

<cite>
**本文档引用的文件**   
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py)
- [base.py](file://bkmonitor/apm/core/discover/base.py)
- [application.py](file://bkmonitor/apm/models/application.py)
- [config.py](file://bkmonitor/apm/models/config.py)
- [apm_cache_handler.py](file://bkmonitor/apm/core/handlers/apm_cache_handler.py)
- [apm.py](file://bkmonitor/constants/apm.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细阐述了蓝鲸监控平台（BlueKing - Monitor）中端点发现功能的实现机制。该功能通过分析分布式追踪数据，自动发现和管理服务端点（Endpoints），为生成调用链拓扑图提供关键数据支持。

## 项目结构
端点发现功能主要位于`bkmonitor/apm/core/discover/`目录下，其核心逻辑由`endpoint.py`模块实现。该模块依赖于`base.py`中的基类、`models`中的数据模型以及`handlers`中的缓存处理机制。

```mermaid
graph TB
subgraph "端点发现模块"
endpoint[endpoint.py]
base[base.py]
end
subgraph "数据模型"
application[application.py]
config[config.py]
end
subgraph "处理与工具"
cache[apm_cache_handler.py]
constants[apm.py]
end
endpoint --> base
endpoint --> application
endpoint --> config
endpoint --> cache
endpoint --> constants
```

**图示来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L1-L307)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L1-L502)
- [application.py](file://bkmonitor/apm/models/application.py#L304-L318)
- [config.py](file://bkmonitor/apm/models/config.py#L35-L229)
- [apm_cache_handler.py](file://bkmonitor/apm/core/handlers/apm_cache_handler.py#L18-L153)

**章节来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L1-L307)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L1-L502)

## 核心组件
端点发现功能的核心是`EndpointDiscover`类，它继承自`DiscoverBase`基类，负责从Kafka消费的Span数据中提取服务和端点信息，并将其持久化到数据库中。该功能还利用Redis缓存来提高性能和处理数据过期。

**章节来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L30-L307)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L152-L265)

## 架构概述
端点发现功能的架构主要包括数据输入、处理逻辑、存储和缓存四个部分。系统从Kafka消费Span数据，经过处理后将端点信息存储到MySQL数据库，并使用Redis缓存来记录端点的最后更新时间。

```mermaid
graph LR
Kafka[Kafka] --> |Span数据| Processor[端点发现处理器]
Processor --> |写入| MySQL[MySQL数据库]
Processor --> |更新| Redis[Redis缓存]
Redis --> |读取| Processor
MySQL --> |读取| Processor
```

**图示来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L231-L307)
- [apm_cache_handler.py](file://bkmonitor/apm/core/handlers/apm_cache_handler.py#L42-L70)

## 详细组件分析

### 端点发现分析
`EndpointDiscover`类是端点发现功能的核心，它实现了从Span数据中提取端点信息的完整流程。

#### 对象导向组件
```mermaid
classDiagram
class EndpointDiscover {
+MAX_COUNT : int
+model : Model
-_build_endpoint_dict(endpoint_obj, include_updated_at) dict
+list_exists() dict, list
+to_instance_key(...) str
+_extract_instance_key_params(inst) tuple
+to_id_and_key(instances) set, set
+merge_data(endpoint_data, cache_data) list
+instance_clear_if_overflow(instances) list, list
+instance_clear_expired(instances) list, list
+query_cache_data() dict
+clear_data(cache_data, instance_data) set
+refresh_cache_data(...) void
+get_remain_data() tuple
+discover_with_remain_data(origin_data, remain_data) void
+discover(origin_data) void
+_do_discover(...) void
}
class DiscoverBase {
+MAX_COUNT : int
+model : Model
+DISCOVERY_ALL_SPANS : bool
+__init__(bk_biz_id, app_name) void
+application : ApmApplication
-_get_key_pair(key) tuple
+join_keys(keys) str
+get_rules(_type) list, ApmTopoDiscoverRuleCls
+filter_rules(rule_kind) list
+get_service_name(span) str
+get_match_rule(span, rules, other_rule, extra_cond) ApmTopoDiscoverRuleCls
+clear_if_overflow() void
+clear_expired() void
+get_and_clear_if_repeat(exists_mapping) dict
+discover(origin_data) abstract
+discover_with_remain_data(origin_data, remain_data) void
+get_remain_data() any
}
EndpointDiscover --|> DiscoverBase
```

**图示来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L30-L307)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L152-L265)

#### 服务组件
```mermaid
sequenceDiagram
participant Kafka as Kafka
participant Processor as EndpointDiscover
participant MySQL as MySQL
participant Redis as Redis
Kafka->>Processor : 发送Span数据
Processor->>MySQL : 查询现有端点
MySQL-->>Processor : 返回现有端点列表
Processor->>Redis : 查询缓存数据
Redis-->>Processor : 返回缓存数据
loop 处理每个Span
Processor->>Processor : 解析Span数据
Processor->>Processor : 匹配发现规则
Processor->>Processor : 提取端点信息
alt 端点已存在
Processor->>Processor : 标记为需要更新
else 端点不存在
Processor->>Processor : 标记为需要创建
end
end
Processor->>MySQL : 批量创建新端点
Processor->>MySQL : 清理过期和超量数据
Processor->>Redis : 更新缓存
```

**图示来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L231-L307)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L180-L224)

#### 复杂逻辑组件
```mermaid
flowchart TD
Start([开始]) --> QueryExists["查询数据库中的现有端点"]
QueryExists --> QueryCache["查询Redis缓存"]
QueryCache --> ProcessSpans["处理Span数据"]
ProcessSpans --> LoopStart{遍历每个Span}
LoopStart --> ExtractService["提取服务名<br/>service_name"]
ExtractService --> ExtractEndpoint["提取端点名<br/>endpoint_name"]
ExtractEndpoint --> MatchRule["匹配发现规则"]
MatchRule --> CheckExists{"端点已存在?"}
CheckExists --> |是| MarkUpdate["标记为需要更新"]
CheckExists --> |否| MarkCreate["标记为需要创建"]
MarkUpdate --> LoopEnd
MarkCreate --> LoopEnd
LoopEnd --> LoopContinue{还有更多Span?}
LoopContinue --> |是| LoopStart
LoopContinue --> |否| BatchCreate["批量创建新端点"]
BatchCreate --> ClearData["清理数据"]
ClearData --> CheckExpired{"有过期数据?"}
CheckExpired --> |是| DeleteExpired["删除过期端点"]
CheckExpired --> |否| CheckOverflow
DeleteExpired --> CheckOverflow
CheckOverflow --> |有超量数据| DeleteOverflow["删除超量端点"]
CheckOverflow --> |无超量数据| UpdateCache
DeleteOverflow --> UpdateCache
UpdateCache --> RefreshRedis["更新Redis缓存"]
RefreshRedis --> End([结束])
```

**图示来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L220-L307)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L180-L224)

**章节来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L1-L307)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L1-L502)

## 依赖分析
端点发现功能依赖于多个核心组件，包括数据模型、缓存处理、常量定义和基类功能。

```mermaid
graph TD
EndpointDiscover[EndpointDiscover] --> DiscoverBase[DiscoverBase]
EndpointDiscover --> Endpoint[Endpoint]
EndpointDiscover --> ApmTopoDiscoverRule[ApmTopoDiscoverRule]
EndpointDiscover --> ApmCacheHandler[ApmCacheHandler]
EndpointDiscover --> OtlpKey[OtlpKey]
DiscoverBase --> ApmApplication[ApmApplication]
DiscoverBase --> ApmTopoDiscoverRule
DiscoverBase --> OtlpKey
ApmCacheHandler --> Redis[Redis]
```

**图示来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L18-L27)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L27-L32)
- [apm_cache_handler.py](file://bkmonitor/apm/core/handlers/apm_cache_handler.py#L18-L153)

## 性能考虑
端点发现功能在设计时考虑了多项性能优化措施：
1. 使用Redis缓存来避免频繁的数据库查询
2. 实现了数据清理机制，防止数据库和缓存无限增长
3. 采用批量操作来减少数据库交互次数
4. 通过分布式锁防止并发冲突

## 故障排除指南
当端点发现功能出现问题时，可以检查以下方面：
1. Kafka数据流是否正常
2. Redis缓存是否可用
3. MySQL数据库连接是否正常
4. 发现规则配置是否正确
5. 日志中是否有相关错误信息

**章节来源**
- [endpoint.py](file://bkmonitor/apm/core/discover/endpoint.py#L291-L293)
- [apm_cache_handler.py](file://bkmonitor/apm/core/handlers/apm_cache_handler.py#L42-L49)
- [base.py](file://bkmonitor/apm/core/discover/base.py#L439-L449)

## 结论
端点发现功能是蓝鲸监控平台分布式追踪系统的核心组件之一。它通过自动化的方式从Span数据中提取服务和端点信息，为生成调用链拓扑图提供了基础数据支持。该功能设计合理，具有良好的性能和可扩展性。