# 上报协议

<cite>
**本文档引用的文件**
- [serializers.py](file://bkmonitor/apm/serializers.py)
- [base.py](file://bkmonitor/apm/utils/base.py)
- [resources.py](file://bkmonitor/apm/resources.py)
- [apm.py](file://bkmonitor/constants/apm.py)
- [constants.py](file://bkmonitor/apm/constants.py)
</cite>

## 目录
1. [引言](#引言)
2. [数据序列化结构](#数据序列化结构)
3. [HTTP通信协议](#http通信协议)
4. [基类处理器与协议控制](#基类处理器与协议控制)
5. [错误码定义](#错误码定义)

## 引言
本文档详细说明了APM探针数据上报所采用的通信协议和数据格式。重点解析了`serializers.py`中定义的Trace、Metric和Log数据的序列化结构，包括字段含义、数据类型及嵌套关系。同时描述了HTTP请求的头部信息、认证机制（如Token验证）、内容编码（如gzip压缩）以及批量上报的JSON数组格式。结合`base.py`中的基类处理器，解释了协议版本控制、数据校验规则和错误码定义，确保开发者能够正确实现自定义探针的数据上报逻辑。

## 数据序列化结构

APM探针上报的数据主要通过Django REST framework的`serializers.Serializer`进行结构定义和验证。核心的序列化器定义在`serializers.py`文件中，主要包括Trace、Metric和Log三种数据类型的序列化结构。

### Trace数据序列化结构
Trace数据的序列化结构主要由`BaseTraceRequestSerializer`和`BaseTraceFilterSerializer`等基类构成。`BaseTraceRequestSerializer`定义了Trace请求的基本参数，包括业务ID（bk_biz_id）、应用名称（app_name）和是否使用mock数据（is_mock）等字段。`BaseTraceFilterSerializer`则定义了查询过滤条件，包括过滤器列表（filters）、查询字符串（query_string）、查询视角（mode）、开始时间（start_time）和结束时间（end_time）等。

`TraceFieldsTopkRequestSerializer`继承了上述两个基类，并增加了查询字段列表（fields）和数量限制（limit）字段，用于获取指定字段的TopK值。`TraceFieldStatisticsInfoRequestSerializer`和`TraceFieldStatisticsGraphRequestSerializer`则用于获取字段的统计信息和趋势图数据，它们都包含一个`field`字段，该字段是一个`TraceStatisticsFieldSerializer`实例，定义了字段类型（field_type）、字段名称（field_name）和查询过滤条件值列表（values）。

**Section sources**
- [serializers.py](file://bkmonitor/apm/serializers.py#L31-L77)

### Metric和Log数据序列化结构
虽然`serializers.py`文件中没有直接定义Metric和Log的序列化器，但通过`resources.py`文件中的`QueryMetricDimensionsResource`和`QueryLogRelationByIndexSetIdResource`等资源类，可以推断出Metric和Log数据的结构。`QueryMetricDimensionsResource`用于查询Metric的维度配置，返回的数据结构包括维度类型（kind）、谓词键（predicate_key）和维度键列表（dimensions）。`QueryLogRelationByIndexSetIdResource`则用于根据索引集ID获取关联的APM应用信息，返回的数据结构包括业务ID（bk_biz_id）、应用名称（app_name）和服务名称（service_name）等。

**Section sources**
- [resources.py](file://bkmonitor/apm/resources.py#L1640-L1659)
- [resources.py](file://bkmonitor/apm/resources.py#L1510-L1525)

## HTTP通信协议

### 请求头部信息
APM探针上报数据时，HTTP请求的头部信息包含必要的认证和内容编码信息。请求头中必须包含`Authorization`字段，用于传递Token进行身份验证。此外，为了提高传输效率，请求体通常采用gzip压缩，因此请求头中会包含`Content-Encoding: gzip`。

### 认证机制
APM探针使用Token进行身份验证。Token通常通过`ApplicationInfoResource`资源获取，该资源返回的应用信息中包含一个`token`字段。探针在上报数据时，需要将此Token放在HTTP请求头的`Authorization`字段中，格式为`Bearer <token>`。

### 内容编码与批量上报
为了减少网络传输开销，APM探针上报的数据通常采用gzip压缩。请求头中设置`Content-Encoding: gzip`，请求体为压缩后的JSON数据。数据以JSON数组的形式批量上报，每个数组元素代表一条Trace、Metric或Log数据。这种批量上报的方式可以有效减少HTTP请求的次数，提高数据上报的效率。

**Section sources**
- [resources.py](file://bkmonitor/apm/resources.py#L298-L322)
- [resources.py](file://bkmonitor/apm/resources.py#L1706-L1725)

## 基类处理器与协议控制

### 基类处理器
`base.py`文件中定义了一些通用的工具函数，如`divide_biscuit`和`balanced_biscuit`，用于对数据进行分段和切分。这些函数在处理大量数据时非常有用，可以将数据分成多个小块进行处理，避免内存溢出。`rt_id_to_index`函数用于将结果表ID转换为Elasticsearch索引名称，`get_bar_interval_number`函数用于计算柱状图的时间间隔。

### 协议版本控制
虽然在提供的代码中没有直接看到协议版本控制的实现，但通过`resources.py`文件中的`Resource`类和其`RequestSerializer`属性，可以推断出协议版本控制是通过不同的资源类和序列化器来实现的。每个资源类对应一个特定的API端点，其`RequestSerializer`定义了该端点的请求参数结构。当需要更新协议时，可以通过创建新的资源类和序列化器来实现，而不会影响现有的API。

### 数据校验规则
数据校验主要通过Django REST framework的序列化器来完成。序列化器中的字段定义了数据类型、是否必填、默认值等约束条件。例如，`BaseTraceRequestSerializer`中的`bk_biz_id`字段是一个`IntegerField`，表示业务ID必须是一个整数。`validate`方法可以用于实现更复杂的校验逻辑，如`TraceFieldStatisticsGraphRequestSerializer`中的`validate`方法，用于验证数值类型查询条件是否足够。

**Section sources**
- [base.py](file://bkmonitor/apm/utils/base.py#L18-L52)
- [serializers.py](file://bkmonitor/apm/serializers.py#L68-L77)

## 错误码定义

### 错误码
在`resources.py`文件中，通过`CustomException`和`ValidationError`等异常类来定义和抛出错误。例如，`ApplicationInfoResource`在找不到应用时会抛出`ValidationError`，`QueryBuiltinProfileDatasourceResource`在找不到内置数据源时会抛出`ValueError`。这些异常会被框架捕获并转换为相应的HTTP状态码和错误消息，返回给客户端。

### 错误处理
错误处理主要通过`perform_request`方法中的异常捕获来实现。当发生错误时，会抛出相应的异常，框架会将其转换为标准的错误响应。例如，`CreateApplicationResource`在创建应用时，如果应用已存在，会抛出`ValueError`，框架会将其转换为400 Bad Request响应。

**Section sources**
- [resources.py](file://bkmonitor/apm/resources.py#L298-L322)
- [resources.py](file://bkmonitor/apm/resources.py#L1706-L1725)