# 策略共享与复用机制

<cite>
**本文档引用的文件**   
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py)
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py)
- [strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [global_config.py](file://bkmonitor\bkmonitor\define\global_config.py)
- [v2.py](file://bkmonitor\packages\monitor_web\strategies\resources\v2.py)
- [resources.py](file://bkmonitor\packages\monitor_web\export_import\resources.py)
- [resources.py](file://bkmonitor\packages\monitor_web\as_code\resources.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档全面介绍了跨业务策略共享和复用的技术实现，包括全局策略标识的生成规则、策略模板的抽象方法以及版本管理机制。详细说明了如何通过策略克隆、导入导出实现配置复用，并解析了策略迁移过程中的兼容性处理。最后提供了最佳实践建议，指导用户在多环境间高效复用监控策略。

## 项目结构
项目采用分层模块化设计，主要包含监控核心模块、API接口、策略管理、数据源处理等组件。策略共享与复用功能主要集中在`bkmonitor/bkmonitor/strategy`目录下。

```mermaid
graph TD
subgraph "策略管理模块"
Strategy[策略模块]
Convert[转换模块]
Migrate[迁移模块]
end
subgraph "模型层"
Model[策略模型]
Config[配置模型]
end
subgraph "全局配置"
GlobalConfig[全局配置]
end
subgraph "导入导出"
ExportImport[导入导出模块]
AsCode[AsCode模块]
end
Strategy --> Model
Convert --> Strategy
Migrate --> Strategy
GlobalConfig --> Strategy
ExportImport --> Strategy
AsCode --> Strategy
```

**图示来源**
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)
- [models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [global_config.py](file://bkmonitor\bkmonitor\define\global_config.py)

## 核心组件
策略共享与复用的核心组件包括策略配置管理、转换器、迁移工具和导入导出功能。这些组件共同实现了策略的标准化、版本控制和跨环境迁移。

**组件来源**
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py#L0-L199)
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py#L0-L199)
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py#L0-L126)

## 架构概述
系统采用分层架构，从数据模型到业务逻辑再到API接口，形成了完整的策略管理闭环。策略共享与复用功能通过标准化的数据结构和转换机制实现。

```mermaid
graph TB
subgraph "数据层"
DB[(数据库)]
StrategyModel[策略模型]
end
subgraph "逻辑层"
StrategyConfig[策略配置]
Convertors[转换器]
Migrators[迁移器]
end
subgraph "服务层"
ExportImport[导入导出服务]
AsCode[AsCode服务]
Clone[克隆服务]
end
subgraph "接口层"
API[REST API]
end
DB --> StrategyModel
StrategyModel --> StrategyConfig
StrategyConfig --> Convertors
StrategyConfig --> Migrators
Convertors --> ExportImport
Migrators --> ExportImport
StrategyConfig --> AsCode
StrategyConfig --> Clone
ExportImport --> API
AsCode --> API
Clone --> API
```

**图示来源**
- [models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py#L0-L199)
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py#L0-L199)
- [v2.py](file://bkmonitor\packages\monitor_web\strategies\resources\v2.py#L2950-L3000)

## 详细组件分析

### 策略配置分析
策略配置组件负责管理策略的完整数据结构，包括策略基本信息、监控项、检测算法和动作配置。

```mermaid
classDiagram
class StrategyConfig {
+int id
+int bk_biz_id
+list STRATEGY_FIELDS
+list ITEM_FIELDS
+list DETECT_ALGORITHM_FIELDS
+list ACTION_FIELDS
+dict DATA_SOURCE_MODEL
+dict INSTANCE_DISPLAY_NAME
+__init__(bk_biz_id, strategy_id)
+create()
+update_algorithm()
+strategy_dict()
+create_cmdb_level_info()
+conversion_result_table_id()
+get_data_source_model()
}
class StrategyModel {
+int id
+int bk_biz_id
+str name
+str scenario
+bool is_enabled
+datetime create_time
+datetime update_time
+str create_user
+str update_user
}
StrategyConfig --> StrategyModel : "使用"
```

**图示来源**
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py#L0-L199)
- [models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py#L0-L199)

### 策略转换分析
策略转换组件实现了特殊策略类型的转换逻辑，确保不同策略类型之间的兼容性和一致性。

```mermaid
classDiagram
class UptimeCheckConvert {
+convert(strategy)
+restore(strategy)
}
class CMDBTopoNodeAggConvert {
+convert(strategy)
+restore(strategy)
}
class Convertors {
+list CONVERTORS
+convert(strategy)
+restore(strategy)
}
Convertors --> UptimeCheckConvert
Convertors --> CMDBTopoNodeAggConvert
UptimeCheckConvert ..> Strategy : "处理"
CMDBTopoNodeAggConvert ..> Strategy : "处理"
```

**图示来源**
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py#L0-L199)

### 策略迁移分析
策略迁移组件提供了批量更新和兼容性处理功能，确保策略在不同环境间的平滑迁移。

```mermaid
sequenceDiagram
participant Apps as "Django Apps"
participant Migrate as "迁移模块"
participant Strategy as "策略模型"
participant Action as "动作配置"
Migrate->>Apps : fetch_action_configs()
Apps-->>Migrate : 动作配置生成器
Migrate->>Migrate : get_action_configs_generator()
loop 分批处理
Migrate->>Action : values("id", "execute_config")
Action-->>Migrate : 动作配置列表
Migrate->>Migrate : update_notice_template()
loop 更新模板
Migrate->>Action : bulk_update()
end
Migrate->>Strategy : update(hash="", snippet="")
end
```

**图示来源**
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py#L0-L126)

### 策略克隆分析
策略克隆功能通过复制现有策略并修改关键字段来实现快速配置复用。

```mermaid
flowchart TD
Start([开始克隆]) --> LoadStrategy["加载策略模型"]
LoadStrategy --> ResetId["重置ID为0"]
ResetId --> ModifyName["修改名称添加_copy"]
ModifyName --> CheckName{"名称是否重复?"}
CheckName --> |是| AppendCopy["名称追加_copy"]
CheckName --> |否| SaveStrategy["保存新策略"]
AppendCopy --> CheckName
SaveStrategy --> ResetAsCode["重置AsCode配置"]
ResetAsCode --> End([克隆完成])
```

**图示来源**
- [v2.py](file://bkmonitor\packages\monitor_web\strategies\resources\v2.py#L2950-L3000)

### 策略导入导出分析
导入导出模块实现了策略配置的打包、解包和迁移功能，支持跨环境配置复用。

```mermaid
flowchart LR
subgraph "导出流程"
SelectConfig["选择配置"] --> Package["打包配置"]
Package --> Compress["压缩为tar.gz"]
Compress --> Save["保存文件"]
end
subgraph "导入流程"
Upload["上传文件"] --> Extract["解压文件"]
Extract --> Parse["解析配置"]
Parse --> Validate["验证配置"]
Validate --> Import["导入数据库"]
end
Save --> |文件传输| Upload
```

**图示来源**
- [resources.py](file://bkmonitor\packages\monitor_web\export_import\resources.py#L0-L199)

## 依赖分析
策略共享与复用功能依赖于多个核心模块，形成了复杂的依赖关系网络。

```mermaid
graph TD
StrategyConfig --> StrategyModel
StrategyConfig --> DataSourceLabel
StrategyConfig --> DataTypeLabel
StrategyConfig --> AlgorithmModel
StrategyConfig --> Action
StrategyConfig --> NoticeGroup
Convert --> StrategyConfig
Convert --> AlgorithmModel
Migrate --> StrategyModel
Migrate --> ActionConfig
ExportImport --> StrategyModel
ExportImport --> CollectConfigMeta
AsCode --> StrategyModel
AsCode --> ActionConfig
AsCode --> UserGroup
AsCode --> DutyRule
```

**图示来源**
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py#L0-L199)
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py#L0-L199)
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py#L0-L126)
- [resources.py](file://bkmonitor\packages\monitor_web\export_import\resources.py#L0-L199)
- [resources.py](file://bkmonitor\packages\monitor_web\as_code\resources.py#L0-L199)

## 性能考虑
策略共享与复用功能在设计时考虑了性能优化，主要体现在以下几个方面：
1. 使用生成器分批处理大量数据，避免内存溢出
2. 采用批量数据库操作减少IO开销
3. 实现缓存机制提高查询效率
4. 通过异步任务处理耗时操作

## 故障排除指南
常见问题及解决方案：
1. **策略克隆失败**：检查目标业务下是否存在同名策略
2. **导入导出错误**：验证文件格式和权限设置
3. **迁移兼容性问题**：确认源和目标环境的版本兼容性
4. **转换逻辑异常**：检查特殊策略类型的配置是否符合要求

**问题来源**
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py#L0-L199)
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py#L0-L199)
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py#L0-L126)

## 结论
本文档详细介绍了策略共享与复用的技术实现，涵盖了从全局标识生成到版本管理的完整生命周期。通过策略克隆、导入导出和迁移工具，用户可以在多环境间高效复用监控策略，大大提升了运维效率。建议在实际使用中遵循最佳实践，确保策略配置的一致性和可靠性。