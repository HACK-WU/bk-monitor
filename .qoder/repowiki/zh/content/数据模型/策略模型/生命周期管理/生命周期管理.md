# 生命周期管理

<cite>
**本文档引用的文件**   
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py)
- [models.py](file://bkmonitor/bkmonitor/models/strategy.py)
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py)
- [serializers.py](file://bkmonitor/bkmonitor/strategy/serializers.py)
- [constants.py](file://constants/strategy.py)
</cite>

## 目录
1. [生命周期管理](#生命周期管理)
2. [策略创建流程](#策略创建流程)
3. [策略编辑与更新](#策略编辑与更新)
4. [启用/禁用与删除](#启用禁用与删除)
5. [版本控制与审计日志](#版本控制与审计日志)
6. [环境迁移与同步](#环境迁移与同步)
7. [批量操作API示例](#批量操作api示例)
8. [性能优化建议](#性能优化建议)

## 策略创建流程

策略创建流程通过`StrategyConfig.create`方法实现，该方法接收策略配置字典并创建完整的策略实例。创建过程遵循严格的事务性操作，确保数据一致性。

```mermaid
flowchart TD
Start([开始创建策略]) --> ValidateInput["验证输入参数"]
ValidateInput --> CreateStrategy["创建策略主记录"]
CreateStrategy --> CreateItems["创建监控项"]
CreateItems --> CreateAlgorithms["创建检测算法"]
CreateAlgorithms --> CreateActions["创建动作配置"]
CreateActions --> HandleSplit["处理结果表拆分"]
HandleSplit --> AccessAIOPS["智能监控接入"]
AccessAIOPS --> End([策略创建完成])
CreateStrategy --> Rollback["创建失败回滚"]
CreateItems --> Rollback
CreateAlgorithms --> Rollback
CreateActions --> Rollback
```

**图示来源**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L500-L550)

**本节来源**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L500-L550)

## 策略编辑与更新

策略编辑功能通过`StrategyConfig.update`方法实现，支持对策略的全面修改。系统采用快照对比机制，在更新前保存原始配置，若更新失败则自动回滚到原始状态。

```mermaid
sequenceDiagram
participant 用户 as "用户"
participant 策略配置 as "StrategyConfig"
participant 数据库 as "数据库"
用户->>策略配置 : 提交更新请求
策略配置->>策略配置 : 保存原始配置快照
策略配置->>数据库 : 更新策略主记录
策略配置->>数据库 : 更新监控项配置
策略配置->>数据库 : 更新检测算法
策略配置->>数据库 : 更新动作配置
策略配置->>策略配置 : 处理结果表拆分
策略配置->>策略配置 : 智能监控接入
策略配置-->>用户 : 返回成功响应
alt 更新失败
策略配置->>策略配置 : 回滚到原始配置
策略配置-->>用户 : 返回错误信息
end
```

**图示来源**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L550-L600)

**本节来源**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L550-L600)

## 启用/禁用与删除

策略的启用/禁用状态通过`is_enabled`字段控制，删除操作则通过`delete`方法实现。删除过程会级联删除所有关联的配置对象，确保数据完整性。

```mermaid
classDiagram
class StrategyConfig {
+id : int
+bk_biz_id : int
+strategy : StrategyModel
+item_data : dict
+data_source_data : dict
+detect_algorithm_data : dict
+action_data : dict
+notice_template_data : dict
+action_notice_mappings : dict
+delete() void
+update_strategy() void
+create() void
}
class StrategyModel {
+name : str
+bk_biz_id : int
+is_enabled : bool
+is_invalid : bool
+invalid_type : str
+create_user : str
+create_time : datetime
+update_user : str
+update_time : datetime
}
StrategyConfig --> StrategyModel : "包含"
StrategyConfig --> ItemModel : "包含多个"
StrategyConfig --> DetectModel : "包含多个"
StrategyConfig --> ActionModel : "包含多个"
```

**图示来源**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L600-L650)
- [models.py](file://bkmonitor/bkmonitor/models/strategy.py#L800-L900)

**本节来源**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L600-L650)

## 版本控制与审计日志

系统通过`StrategyHistoryModel`实现完整的变更审计功能。每次策略变更都会记录操作类型、内容、操作者和时间戳，支持完整的版本追溯。

```mermaid
erDiagram
STRATEGY_HISTORY {
int strategy_id PK
datetime create_time
string create_user
json content
string operate
bool status
text message
}
STRATEGY_MODEL {
int id PK
string name
int bk_biz_id
bool is_enabled
string create_user
datetime create_time
string update_user
datetime update_time
}
STRATEGY_MODEL ||--o{ STRATEGY_HISTORY : "有历史记录"
```

**图示来源**
- [models.py](file://bkmonitor/bkmonitor/models/strategy.py#L300-L400)

**本节来源**
- [models.py](file://bkmonitor/bkmonitor/models/strategy.py#L300-L400)

## 环境迁移与同步

策略在不同环境间的迁移通过配置导出/导入机制实现。系统支持将策略配置序列化为标准格式，便于在开发、测试和生产环境间同步。

```mermaid
flowchart LR
Dev[开发环境] --> |导出配置| Export["生成配置文件"]
Export --> |传输| Test[测试环境]
Test --> |导入配置| Import["创建新策略"]
Import --> Prod[生产环境]
style Dev fill:#f9f,stroke:#333
style Test fill:#bbf,stroke:#333
style Prod fill:#f96,stroke:#333
```

**本节来源**
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py#L1000-L1500)

## 批量操作API示例

系统提供RESTful API支持策略的批量操作。以下为批量创建策略的示例代码：

```python
import requests
import json

# 批量创建策略API
def batch_create_strategies(biz_id, strategies):
    """
    批量创建策略
    :param biz_id: 业务ID
    :param strategies: 策略配置列表
    :return: 创建结果
    """
    url = "http://api.monitor.example.com/strategies/batch"
    headers = {
        "Content-Type": "application/json",
        "Authorization": "Bearer your_token"
    }
    
    payload = {
        "bk_biz_id": biz_id,
        "strategies": strategies
    }
    
    response = requests.post(url, headers=headers, data=json.dumps(payload))
    return response.json()

# 使用示例
strategies_config = [
    {
        "name": "CPU使用率监控",
        "scenario": "host",
        "is_enabled": True,
        "item_list": [
            {
                "name": "CPU使用率",
                "metric_id": "bk_monitor.system.cpu_usage",
                "data_source_label": "bk_monitor",
                "data_type_label": "time_series",
                "algorithm_list": [
                    {
                        "algorithm_type": "Threshold",
                        "algorithm_config": {"threshold": 80},
                        "level": 1
                    }
                ]
            }
        ]
    }
]

result = batch_create_strategies(biz_id=123, strategies=strategies_config)
print(result)
```

**本节来源**
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py#L2000-L2500)

## 性能优化建议

为确保策略管理操作的高性能，建议采取以下优化措施：

1. **批量操作**：尽量使用批量API而非单个操作，减少网络往返次数
2. **异步处理**：对于耗时操作（如智能监控接入），采用异步任务处理
3. **缓存机制**：合理使用缓存减少数据库查询
4. **索引优化**：确保关键字段有适当的数据库索引

```mermaid
flowchart TD
A[性能优化策略] --> B[批量操作]
A --> C[异步处理]
A --> D[缓存机制]
A --> E[索引优化]
B --> F["减少网络开销"]
C --> G["提高响应速度"]
D --> H["降低数据库负载"]
E --> I["加快查询速度"]
```

**本节来源**
- [strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py)
- [new_strategy.py](file://bkmonitor/bkmonitor/strategy/new_strategy.py)