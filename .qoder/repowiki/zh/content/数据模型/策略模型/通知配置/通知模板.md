# 通知模板

<cite>
**本文档引用的文件**   
- [template.py](file://bkmonitor/bkmonitor/utils/template.py)
- [send.py](file://bkmonitor/bkmonitor/utils/send.py)
- [action.py](file://bkmonitor/constants/action.py)
- [default.py](file://bkmonitor/config/default.py)
- [base.yaml](file://bkmonitor/bkmonitor/as_code/tests/configs/notice/snippets/base.yaml)
- [ops.yaml](file://bkmonitor/bkmonitor/as_code/tests/data/notice/ops.yaml)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档详细记录了蓝鲸监控平台中通知模板的设计与实现。文档涵盖了模板变量体系、内容格式化规则、多语言支持机制和模板继承结构。说明了如何创建和管理自定义模板，提供了标准模板语法和示例。解释了模板如何根据告警类型、严重程度和通知渠道自动适配内容，记录了模板渲染流程和性能优化策略。

## 项目结构
通知模板系统主要分布在`bkmonitor/bkmonitor/utils/template.py`文件中，该文件实现了核心的模板渲染逻辑。系统通过Jinja2模板引擎提供强大的模板功能，并结合Django的模板系统进行多语言支持。模板配置可以通过YAML文件进行声明式管理，位于`as_code`模块中。

```mermaid
graph TD
subgraph "模板系统"
Template[template.py]
Send[send.py]
Action[action.py]
Config[default.py]
end
subgraph "配置管理"
AsCode[as_code]
YAML[yaml配置]
end
Template --> Send : "使用"
Template --> Action : "引用"
Template --> Config : "读取"
AsCode --> YAML : "包含"
YAML --> Template : "配置"
```

**图示来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py)
- [send.py](file://bkmonitor/bkmonitor/utils/send.py)

**本节来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py)
- [as_code](file://bkmonitor/bkmonitor/as_code)

## 核心组件
通知模板系统的核心组件包括`AlarmNoticeTemplate`、`Jinja2Renderer`、`NoticeRowRenderer`等类。这些组件共同构成了一个灵活、可扩展的模板渲染系统，支持自定义模板、多语言和多种通知方式。

**本节来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py#L191-L278)

## 架构概述
通知模板系统采用分层架构设计，从上到下分为模板接口层、渲染引擎层和格式化层。系统支持多种渲染器链式调用，允许在不同阶段对模板内容进行处理。

```mermaid
graph TB
subgraph "模板接口层"
AlarmNoticeTemplate[AlarmNoticeTemplate]
AlarmOperateNoticeTemplate[AlarmOperateNoticeTemplate]
end
subgraph "渲染引擎层"
CustomTemplateRenderer[CustomTemplateRenderer]
Jinja2Renderer[Jinja2Renderer]
CustomOperateTemplateRenderer[CustomOperateTemplateRenderer]
end
subgraph "格式化层"
NoticeRowRenderer[NoticeRowRenderer]
escape_markdown[escape_markdown]
end
subgraph "环境配置"
jinja2_environment[jinja2_environment]
DynAutoEscapeEnvironment[DynAutoEscapeEnvironment]
end
AlarmNoticeTemplate --> CustomTemplateRenderer
AlarmNoticeTemplate --> Jinja2Renderer
AlarmOperateNoticeTemplate --> CustomTemplateRenderer
AlarmOperateNoticeTemplate --> CustomOperateTemplateRenderer
AlarmOperateNoticeTemplate --> Jinja2Renderer
CustomTemplateRenderer --> NoticeRowRenderer
Jinja2Renderer --> jinja2_environment
jinja2_environment --> DynAutoEscapeEnvironment
NoticeRowRenderer --> escape_markdown
```

**图示来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py)

## 详细组件分析

### 模板渲染器分析
通知模板系统采用链式渲染器模式，多个渲染器按顺序处理模板内容。这种设计提供了高度的灵活性和可扩展性。

#### 模板类结构
```mermaid
classDiagram
class AlarmNoticeTemplate {
+list Renderers
+str template
+__init__(template_path, template_content, language_suffix)
+render(context) str
+get_template_source(template_path) str
+get_default_path(template_path, language_suffix) str
+get_template(template_path, language_suffix) str
}
class AlarmOperateNoticeTemplate {
+list Renderers
}
class CustomTemplateRenderer {
+render(content, context) str
}
class CustomOperateTemplateRenderer {
+render(content, context) str
}
class Jinja2Renderer {
+render(content, context) str
}
class NoticeRowRenderer {
+dict LineTemplateMapping
+format(notice_way, title, content) str
+render_line(line, context) str
+render(content, context) str
}
AlarmNoticeTemplate <|-- AlarmOperateNoticeTemplate : "继承"
CustomTemplateRenderer ..> NoticeRowRenderer : "使用"
Jinja2Renderer ..> jinja2_environment : "使用"
CustomTemplateRenderer ..> Jinja2Renderer : "使用"
CustomOperateTemplateRenderer ..> Jinja2Renderer : "使用"
```

**图示来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py#L191-L286)

**本节来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py#L191-L286)

### 模板渲染流程分析
模板渲染流程是一个多阶段处理过程，每个阶段由不同的渲染器负责。系统首先尝试使用用户自定义模板，如果渲染失败则回退到默认模板。

#### 渲染流程图
```mermaid
flowchart TD
Start([开始渲染]) --> CheckCustomTemplate["检查自定义模板"]
CheckCustomTemplate --> HasCustomTemplate{"有自定义模板?"}
HasCustomTemplate --> |是| RenderCustomContent["渲染自定义内容"]
HasCustomTemplate --> |否| UseDefaultContent["使用默认内容模板"]
RenderCustomContent --> CustomSuccess{"渲染成功?"}
CustomSuccess --> |否| UseDefaultContentWithError["使用默认模板并添加错误信息"]
CustomSuccess --> |是| ProcessContent["处理内容"]
UseDefaultContent --> ProcessContent
UseDefaultContentWithError --> ProcessContent
ProcessContent --> FormatRows["行格式化"]
FormatRows --> CheckLength["检查内容长度"]
CheckLength --> TooLong{"超过长度限制?"}
TooLong --> |是| CutContent["截断内容"]
TooLong --> |否| KeepContent["保持原内容"]
CutContent --> SetUserContent["设置用户内容"]
KeepContent --> SetUserContent
SetUserContent --> RenderTitle["渲染标题"]
RenderTitle --> HasCustomTitle{"有自定义标题?"}
HasCustomTitle --> |是| RenderCustomTitle["渲染自定义标题"]
HasCustomTitle --> |否| UseDefaultTitle["使用默认标题模板"]
RenderCustomTitle --> TitleSuccess{"渲染成功?"}
TitleSuccess --> |否| UseDefaultTitle
TitleSuccess --> |是| SetUserTitle["设置用户标题"]
UseDefaultTitle --> SetUserTitle
SetUserTitle --> End([结束])
```

**图示来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py#L103-L150)

**本节来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py#L103-L150)

### 多语言支持机制
系统通过语言后缀机制实现多语言支持。当请求特定语言的模板时，系统会先尝试加载带语言后缀的模板文件，如果不存在则回退到基础模板。

#### 多语言处理流程
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Send as "Send类"
participant Template as "AlarmNoticeTemplate"
Client->>Send : 请求发送通知
Send->>Send : get_language_template_path()
alt 语言模板存在
Send->>Template : 使用语言模板路径
Note over Send,Template : 加载如 template_zh-cn.html 的文件
else 语言模板不存在
Send->>Template : 使用基础模板路径
Note over Send,Template : 加载如 template.html 的文件
end
Template->>Template : get_template()
Template->>Template : 渲染模板
Template-->>Send : 返回渲染内容
Send-->>Client : 发送通知
```

**图示来源**
- [send.py](file://bkmonitor/bkmonitor/utils/send.py#L116-L149)
- [template.py](file://bkmonitor/bkmonitor/utils/template.py#L246-L276)

**本节来源**
- [send.py](file://bkmonitor/bkmonitor/utils/send.py#L116-L149)

## 依赖分析
通知模板系统依赖于多个核心模块和外部库，形成了复杂的依赖关系网络。

```mermaid
graph TD
Template[template.py] --> Django[django.template]
Template --> Jinja2[jinja2.sandbox]
Template --> Arrow[arrow]
Template --> Json[built-in json]
Template --> Re[built-in re]
Template --> Settings[django.conf.settings]
Send[send.py] --> Template
Send --> Path[os.path]
Send --> Logger[logging]
Action[action.py] --> Constants[constants]
Default[default.py] --> Settings[django.conf.settings]
AsCode[as_code] --> YAML[PyYAML]
Template --> Text[bkmonitor.utils.text]
style Template fill:#f9f,stroke:#333
style Send fill:#f9f,stroke:#333
style Action fill:#f9f,stroke:#333
style Default fill:#f9f,stroke:#333
```

**图示来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py)
- [send.py](file://bkmonitor/bkmonitor/utils/send.py)
- [action.py](file://bkmonitor/constants/action.py)
- [default.py](file://bkmonitor/config/default.py)

**本节来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py)
- [send.py](file://bkmonitor/bkmonitor/utils/send.py)

## 性能考虑
通知模板系统在设计时考虑了多项性能优化策略：

1. **异常处理优化**：系统在模板渲染失败时不会中断，而是自动回退到默认模板，确保通知不会因模板问题而丢失。
2. **内容长度控制**：系统实现了内容长度检查和自动截断功能，防止过长的通知内容影响性能。
3. **缓存机制**：虽然文档中未直接体现，但基于Django模板系统的特性，模板编译结果会被缓存，提高重复渲染的效率。
4. **安全沙箱**：使用Jinja2的SandboxedEnvironment确保模板执行的安全性，防止恶意代码执行。

## 故障排除指南
当通知模板出现问题时，可以按照以下步骤进行排查：

1. **检查模板路径**：确认模板文件路径是否正确，文件是否存在。
2. **验证模板语法**：检查Jinja2模板语法是否正确，避免语法错误导致渲染失败。
3. **查看日志信息**：系统会在`logger.error`中记录模板渲染失败的详细信息，包括错误类型和模板内容。
4. **确认上下文变量**：确保传递给模板的上下文包含所有必需的变量。
5. **测试默认模板**：如果自定义模板有问题，系统会自动使用默认模板，可以对比两者差异。

**本节来源**
- [template.py](file://bkmonitor/bkmonitor/utils/template.py#L103-L150)
- [send.py](file://bkmonitor/bkmonitor/utils/send.py#L116-L149)

## 结论
蓝鲸监控平台的通知模板系统是一个功能强大、设计精良的组件。系统通过链式渲染器模式提供了高度的灵活性，支持自定义模板、多语言和多种通知方式。模板继承结构清晰，异常处理机制完善，确保了系统的稳定性和可靠性。通过Jinja2和Django模板系统的结合，系统既提供了强大的模板功能，又保证了安全性和性能。该系统为监控告警通知提供了坚实的基础，能够满足各种复杂的业务需求。