# 策略模型

<cite>
**本文档引用的文件**
- [strategy.py](file://bkmonitor/constants/strategy.py)
- [models/strategy.py](file://bkmonitor/models/strategy.py)
- [strategy/strategy.py](file://bkmonitor/strategy/strategy.py)
- [strategy/new_strategy.py](file://bkmonitor/strategy/new_strategy.py)
- [strategy/serializers.py](file://bkmonitor/strategy/serializers.py)
- [strategy/convert.py](file://bkmonitor/strategy/convert.py)
</cite>

## 目录
1. [策略模型核心字段解析](#策略模型核心字段解析)
2. [检测算法实体结构](#检测算法实体结构)
3. [策略类型与条件枚举](#策略类型与条件枚举)
4. [策略配置序列化与转换](#策略配置序列化与转换)
5. [策略生命周期](#策略生命周期)
6. [策略创建与查询示例](#策略创建与查询示例)

## 策略模型核心字段解析

策略模型（StrategyModel）是监控系统中的核心配置实体，用于定义监控告警的规则和行为。其核心字段包括：

- **name**: 策略名称，用于标识和描述该策略的用途，最大长度为128个字符。
- **bk_biz_id**: 业务ID，表示该策略所属的业务范围，用于多业务隔离和权限控制。
- **scenario**: 监控场景，标识策略的应用场景，如主机、服务等，用于分类管理。
- **is_enabled**: 是否启用，布尔值，控制策略是否处于激活状态并参与告警检测。

这些字段共同构成了策略的基本信息，决定了策略的归属、可见性和执行状态。

**Section sources**
- [models/strategy.py](file://bkmonitor/models/strategy.py#L335-L403)

## 检测算法实体结构

检测算法（DetectAlgorithm）是策略中用于判断异常的核心逻辑单元。其结构包含算法类型、配置和检测窗口等关键信息。

### 算法类型

算法类型（type）定义了检测的逻辑方式，主要分为静态阈值和动态基线两大类：

- **静态阈值算法 (Threshold)**: 基于预设的固定阈值进行判断，如CPU使用率大于90%。
- **动态基线算法**: 包括环比（RingRatio）、同比（YearRound）等，通过历史数据动态生成基线进行异常检测。

### 阈值配置与检测窗口

- **阈值配置 (config)**: 存储算法的具体参数，如阈值大小、比较方法（大于、小于等）。
- **检测窗口**: 通过聚合周期（agg_interval）和聚合方法（agg_method）定义，决定了数据采样的频率和计算方式，影响检测的灵敏度和准确性。

**Section sources**
- [models/strategy.py](file://bkmonitor/models/strategy.py#L151-L232)
- [strategy/serializers.py](file://bkmonitor/strategy/serializers.py#L125-L225)

## 策略类型与条件枚举

在 `constants/strategy.py` 文件中，通过枚举类定义了策略相关的常量，确保了系统的一致性和可维护性。

### 策略类型

策略类型（StrategyType）枚举了策略的分类：
- **Monitor (监控)**: 基础监控策略。
- **FTASolution (故障自愈)**: 与故障自愈系统集成的策略。
- **Dashboard (仪表盘)**: 用于数据可视化的策略。

### 触发与恢复条件

触发条件（trigger_config）和恢复条件（recovery_config）定义了告警的激活和解除逻辑。这些条件通常包含：
- **连续周期数 (consecutive)**: 需要连续多少个检测周期满足条件才触发告警。
- **告警级别 (level)**: 定义告警的严重程度，如致命、预警、提醒。

这些枚举和配置共同构成了策略的决策逻辑。

**Section sources**
- [strategy.py](file://bkmonitor/constants/strategy.py#L340-L367)

## 策略配置序列化与转换

策略配置的序列化与反序列化过程由 `serializers.py` 文件中的序列化器处理，确保了配置在存储和传输过程中的格式统一。

### 序列化过程

使用 `StrategyConfig` 类将数据库模型对象转换为字典结构，便于JSON序列化和API传输。该过程会递归处理策略、监控项、检测算法和查询配置等关联对象。

### 新旧策略格式转换

`convert.py` 文件实现了新旧策略格式的转换逻辑，主要用于系统升级时的兼容性处理。例如：
- **UptimeCheckConvert**: 处理拨测策略的特殊转换，将响应码等条件映射为内部指标。
- **FakeEventConvert**: 将伪系统事件（如PING不可达）转换为真实的时序数据查询和特定检测算法。

这些转换器确保了不同版本策略配置的平滑迁移。

**Section sources**
- [strategy/serializers.py](file://bkmonitor/strategy/serializers.py#L257-L420)
- [strategy/convert.py](file://bkmonitor/strategy/convert.py#L41-L468)

## 策略生命周期

策略从创建到执行的完整生命周期如下：

1. **创建**: 用户通过API或界面提交策略配置，系统进行校验并持久化到数据库。
2. **生效**: 策略启用后，系统会根据其配置（如查询配置、检测算法）开始采集和分析数据。
3. **检测**: 在每个检测周期，系统执行数据查询，应用检测算法，并根据结果判断是否产生告警。
4. **通知与处理**: 当触发告警时，系统根据关联的通知组和处理套餐执行通知和自动化处理动作。
5. **恢复**: 当指标恢复正常并满足恢复条件后，告警状态被关闭。

此生命周期确保了监控策略能够持续、自动地保障系统稳定性。

**Section sources**
- [strategy/strategy.py](file://bkmonitor/strategy/strategy.py#L548-L608)

## 策略创建与查询示例

以下是在代码中创建和查询策略的典型示例：

### 创建策略

```python
# 使用 StrategyConfig 类创建新策略
strategy_config = StrategyConfig(bk_biz_id=2, strategy_id=None)
strategy_dict = {
    "name": "CPU使用率过高",
    "bk_biz_id": 2,
    "scenario": "os",
    "is_enabled": True,
    "item_list": [
        {
            "name": "CPU单核使用率",
            "metric_id": "bk_monitor.system.cpu_usage",
            "data_source_label": "bk_monitor",
            "data_type_label": "time_series",
            "algorithm_list": [
                {
                    "type": "Threshold",
                    "level": 1,
                    "config": [[{"method": "gte", "threshold": 90}]]
                }
            ]
        }
    ]
}
strategy_config.create(strategy_dict)
```

### 查询策略

```python
# 查询特定业务下的所有启用策略
strategies = StrategyModel.objects.filter(bk_biz_id=2, is_enabled=True)
for strategy in strategies:
    print(f"策略名称: {strategy.name}, 场景: {strategy.scenario}")
```

这些示例展示了如何通过编程方式与策略模型进行交互。

**Section sources**
- [strategy/strategy.py](file://bkmonitor/strategy/strategy.py#L548-L580)
- [models/strategy.py](file://bkmonitor/models/strategy.py#L335-L403)