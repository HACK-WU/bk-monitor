# 自定义数据采集

<cite>
**本文档引用的文件**   
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py)
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py)
- [serializers.py](file://bkmonitor/packages/monitor_web/plugin/serializers.py)
- [constant.py](file://bkmonitor/packages/monitor_web/plugin/constant.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档详细说明了蓝鲸监控平台中自定义数据采集的扩展机制。文档涵盖了插件化架构设计、采集器接口规范、注册机制以及自定义采集器的开发和部署流程。通过分析核心代码文件，本文档为开发者提供了从零开始创建自定义采集器的完整指南，包括数据格式定义、采集逻辑实现、错误处理、调试方法、安全验证和版本兼容性要求。

## 项目结构
自定义数据采集功能主要位于`bkmonitor/packages/monitor_web/plugin/`目录下，包含管理器、序列化器和常量定义等核心模块。

```mermaid
graph TD
subgraph "插件管理"
base[base.py<br/>基础管理类]
script[script.py<br/>脚本插件管理]
end
subgraph "数据定义"
serializers[serializers.py<br/>序列化器]
constant[constant.py<br/>常量定义]
end
base --> serializers
base --> constant
script --> base
serializers --> constant
```

**图源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py)
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py)
- [serializers.py](file://bkmonitor/packages/monitor_web/plugin/serializers.py)
- [constant.py](file://bkmonitor/packages/monitor_web/plugin/constant.py)

**本节来源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py)
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py)

## 核心组件
自定义数据采集系统的核心组件包括插件管理基类、具体插件管理器、序列化器和常量定义。这些组件共同构成了一个完整的插件化采集框架。

**本节来源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py#L1-L50)
- [serializers.py](file://bkmonitor/packages/monitor_web/plugin/serializers.py#L1-L30)

## 架构概述
自定义数据采集系统采用插件化架构设计，通过基类定义通用接口，具体插件类型继承基类实现特定功能。系统通过序列化器验证数据格式，通过常量定义统一配置标准。

```mermaid
classDiagram
class BasePluginManager {
+plugin : CollectorPluginMeta
+operator : str
+tmp_path : str
+version : PluginVersionHistory
+make_package()
+data_access()
+update_metric()
+release()
+create_version()
}
class PluginManager {
+config_files : list
+templates_dirname : str
+serializer_class : class
+_render_config()
+_run_debug()
+_get_debug_config_context()
+get_deploy_steps_params()
}
class ScriptPluginManager {
+fetch_collector_file()
+_get_collector_json()
}
BasePluginManager <|-- PluginManager
PluginManager <|-- ScriptPluginManager
PluginManager --> Serializer : "使用"
PluginManager --> Constant : "引用"
```

**图源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py#L100-L200)
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py#L10-L50)

## 详细组件分析

### 插件管理基类分析
`BasePluginManager`是所有插件管理器的基类，定义了插件管理的核心接口和通用功能。

```mermaid
flowchart TD
Start([开始]) --> ValidateConfig["验证配置信息"]
ValidateConfig --> SaveLogo["保存Logo文件"]
SaveLogo --> StartDebug["开始调试"]
StartDebug --> StopDebug["停止调试"]
StopDebug --> QueryDebug["查询调试信息"]
QueryDebug --> DataAccess["数据接入"]
DataAccess --> UpdateMetric["更新指标"]
UpdateMetric --> CreateVersion["创建版本"]
CreateVersion --> UpdateVersion["更新版本"]
UpdateVersion --> MakePackage["制作插件包"]
MakePackage --> Release["发布插件"]
Release --> RunExport["运行导出"]
RunExport --> End([结束])
```

**图源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py#L50-L100)

**本节来源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py#L1-L1170)

### 脚本插件管理器分析
`ScriptPluginManager`是脚本类型插件的具体实现，处理脚本采集器的特殊逻辑。

```mermaid
classDiagram
class ScriptPluginManager {
+templates_dirname : str = "script_templates"
+serializer_class : ScriptSerializer
+fetch_collector_file()
+make_package()
+_get_debug_config_context()
+get_deploy_steps_params()
+_get_collector_json()
}
class PluginManager {
+config_files : list
+templates_dirname : str
+serializer_class : class
}
PluginManager <|-- ScriptPluginManager
ScriptPluginManager --> ScriptSerializer : "使用"
ScriptSerializer --> ParamMode : "引用"
ScriptSerializer --> SCRIPT_TYPE_CHOICES : "引用"
```

**图源**
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py#L10-L30)

**本节来源**
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py#L1-L273)

### 序列化器分析
序列化器定义了插件配置的数据结构和验证规则，确保数据格式的正确性。

```mermaid
classDiagram
class CollectorPluginMixin {
+config_json : ConfigJsonSeriliazer[]
+plugin_display_name : str
+description_md : str
+logo : str
+config_version : int
+info_version : int
+signature : str
+is_support_remote : bool
+version_log : str
+validate()
}
class CollectorMetaSerializer {
+plugin_id : RegexField
+data_label : str
+bk_biz_id : int
+bk_supplier_id : int
+plugin_type : ChoiceField
+tag : str
+label : str
+import_plugin_metric_json : MetricJsonSerializer[]
+create()
+update()
}
class ScriptSerializer {
+collector_json : DictField
+validate_collector_json()
}
CollectorPluginMixin <|-- CollectorMetaSerializer
CollectorMetaSerializer <|-- ScriptSerializer
ScriptSerializer --> SCRIPT_TYPE_CHOICES : "引用"
```

**图源**
- [serializers.py](file://bkmonitor/packages/monitor_web/plugin/serializers.py#L50-L100)

**本节来源**
- [serializers.py](file://bkmonitor/packages/monitor_web/plugin/serializers.py#L1-L318)

### 常量定义分析
常量文件定义了系统中使用的所有常量，包括插件类型、参数模式、错误代码等。

```mermaid
classDiagram
class PluginType {
+EXPORTER : str
+SCRIPT : str
+JMX : str
+DATADOG : str
+PUSHGATEWAY : str
+BUILT_IN : str
+LOG : str
+PROCESS : str
+SNMP_TRAP : str
+SNMP : str
+K8S : str
}
class ParamMode {
+COLLECTOR : str
+OPT_CMD : str
+POS_CMD : str
+ENV : str
+DMS_INSERT : str
}
class DebugStatus {
+INSTALL : str
+FETCH_DATA : str
+FAILED : str
+SUCCESS : str
}
class ConflictMap {
+VersionBelow
+PluginType
+RemoteCollectorConfig
+RelatedCollectorConfig
+DuplicatedPlugin
}
PluginType --> ParamMode
ParamMode --> DebugStatus
DebugStatus --> ConflictMap
```

**图源**
- [constant.py](file://bkmonitor/packages/monitor_web/plugin/constant.py#L100-L150)

**本节来源**
- [constant.py](file://bkmonitor/packages/monitor_web/plugin/constant.py#L1-L204)

## 依赖分析
自定义数据采集系统的组件之间存在清晰的依赖关系，形成了一个层次化的架构。

```mermaid
graph TD
constant[constant.py<br/>常量定义] --> serializers[serializers.py<br/>序列化器]
serializers --> base[base.py<br/>基础管理类]
base --> script[script.py<br/>脚本插件管理]
script --> base
base --> serializers
serializers --> constant
style constant fill:#f9f,stroke:#333
style serializers fill:#bbf,stroke:#333
style base fill:#f96,stroke:#333
style script fill:#6f9,stroke:#333
```

**图源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py)
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py)
- [serializers.py](file://bkmonitor/packages/monitor_web/plugin/serializers.py)
- [constant.py](file://bkmonitor/packages/monitor_web/plugin/constant.py)

**本节来源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py)
- [script.py](file://bkmonitor/packages/monitor_web/plugin/manager/script.py)

## 性能考虑
自定义数据采集系统在设计时考虑了性能因素，通过以下机制确保系统的高效运行：
- 使用MD5哈希值检测配置变更，避免不必要的重新打包
- 异步处理数据接入和指标缓存更新
- 批量处理配置文件发布
- 缓存频繁访问的数据

## 故障排除指南
当自定义采集器出现问题时，可以按照以下步骤进行排查：

```mermaid
flowchart TD
Start([问题出现]) --> CheckLog["检查日志文件"]
CheckLog --> LogError{"日志中有错误?"}
LogError --> |是| ParseError["解析错误信息"]
LogError --> |否| CheckConfig["检查配置"]
ParseError --> IdentifyError["识别错误类型"]
IdentifyError --> BEAT_ERR{"BEAT错误?"}
BEAT_ERR --> |是| HandleBeatError["处理BEAT错误"]
BEAT_ERR --> |否| HandleOtherError["处理其他错误"]
CheckConfig --> ValidateConfig["验证配置格式"]
ValidateConfig --> ConfigValid{"配置有效?"}
ConfigValid --> |否| FixConfig["修正配置"]
ConfigValid --> |是| CheckNetwork["检查网络连接"]
FixConfig --> TestConfig["测试配置"]
TestConfig --> End([问题解决])
HandleBeatError --> End
HandleOtherError --> End
```

**本节来源**
- [base.py](file://bkmonitor/packages/monitor_web/plugin/manager/base.py#L600-L800)
- [constant.py](file://bkmonitor/packages/monitor_web/plugin/constant.py#L10-L50)

## 结论
蓝鲸监控平台的自定义数据采集系统提供了一个强大而灵活的插件化架构，允许开发者轻松创建和管理自定义采集器。通过遵循本文档中描述的接口规范和最佳实践，开发者可以高效地开发、部署和维护自定义采集器，满足各种监控需求。