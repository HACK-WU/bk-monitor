# 数据模型

<cite>
**本文档引用的文件**   
- [bkmonitor\bkmonitor\models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py) - *监控策略模型定义*
- [bkmonitor\metadata\models\result_table.py](file://bkmonitor\metadata\models\result_table.py) - *结果表模型定义*
- [bkmonitor\bkmonitor\models\base.py](file://bkmonitor\bkmonitor\models\base.py) - *基础告警事件模型*
- [bkmonitor\alarm_backends\core\alert\alert.py](file://bkmonitor\alarm_backends\core\alert\alert.py) - *告警处理核心逻辑*
- [bkmonitor\metadata\models\data_link\data_link.py](file://bkmonitor\metadata\models\data_link\data_link.py) - *数据链路配置模型*
- [bkmonitor\metadata\models\bcs\cluster.py](file://bkmonitor\metadata\models\bcs\cluster.py) - *BCS集群多租户支持*
</cite>

## 更新摘要
**变更内容**   
- 更新了**结果表模型**中关于`bk_tenant_id`字段的说明，反映其在多租户架构中的核心作用
- 新增了**数据链路模型**章节，详细描述了数据流转的配置结构和策略
- 更新了**实体关系与数据流**图，整合了数据链路（DataLink）作为核心流转组件
- 更新了相关文件的引用源，增加了新分析的文件

## 目录
1. [引言](#引言)
2. [核心数据实体](#核心数据实体)
3. [监控策略模型](#监控策略模型)
4. [查询配置模型](#查询配置模型)
5. [用户组模型](#用户组模型)
6. [结果表模型](#结果表模型)
7. [告警事件模型](#告警事件模型)
8. [数据链路模型](#数据链路模型)
9. [实体关系与数据流](#实体关系与数据流)
10. [索引与性能优化](#索引与性能优化)

## 引言
本数据模型文档详细描述了bk-monitor系统的数据库设计和实体关系。文档深入解析了系统的核心数据模型，包括监控策略、告警事件、数据源配置、用户组等关键实体的字段定义、数据类型和约束条件。通过分析表间关系，如外键关联、一对多/多对多关系等，全面展示了系统的数据架构。文档还解释了数据生命周期管理，涵盖数据采集、处理、存储和归档策略，并记录了索引设计、性能优化考虑和查询模式，为开发者提供了数据访问的最佳实践和常见查询示例。

## 核心数据实体
bk-monitor系统的核心数据实体包括监控策略（StrategyModel）、查询配置（QueryConfigModel）、用户组（UserGroup）、结果表（ResultTable）和数据链路（DataLink）。这些实体构成了系统监控和告警功能的基础。监控策略实体定义了监控的规则和条件，查询配置实体描述了数据查询的具体参数，用户组实体管理了告警通知的接收者和权限，结果表实体则代表了数据存储的逻辑表，而数据链路实体则负责管理从数据源到存储的完整配置流转。这些实体通过外键和JSON字段相互关联，形成了一个灵活且可扩展的数据模型。

## 监控策略模型
监控策略模型（StrategyModel）是系统中定义监控规则的核心实体。该模型存储了策略的名称、业务ID、来源系统、监控场景、策略类型、启用状态等基本信息。策略可以是监控、故障自愈或仪表盘类型，并且可以设置优先级。模型还包含了策略的创建人、创建时间、最后修改人和最后修改时间等审计信息。策略的失效状态和失效类型也被记录，以便于系统管理和故障排查。

``mermaid
erDiagram
STRATEGY {
int id PK
string name
int bk_biz_id
string source
string scenario
string type
bool is_enabled
bool is_invalid
string invalid_type
string create_user
string update_user
datetime create_time
datetime update_time
int priority
string priority_group_key
}
```

**节源**
- [bkmonitor\bkmonitor\models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py#L333-L422)

## 查询配置模型
查询配置模型（QueryConfigModel）定义了监控策略中用于数据查询的具体配置。每个查询配置关联一个策略ID和一个监控项ID，并包含数据来源标签、数据类型标签和指标ID。查询的具体参数以JSON格式存储在config字段中，这使得模型能够灵活地支持各种复杂的查询需求。该模型是实现动态监控和灵活数据检索的关键。

``mermaid
erDiagram
QUERY_CONFIG {
int id PK
int strategy_id FK
int item_id
string alias
string data_source_label
string data_type_label
string metric_id
json config
}
```

**节源**
- [bkmonitor\bkmonitor\models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py#L242-L285)

## 用户组模型
用户组模型（UserGroup）用于管理告警处理组的配置。它定义了用户组的名称、业务ID、时区、说明、来源系统等基本信息。模型还包含了告警通知渠道配置、提醒人员、通知配置、轮值规则等与告警处理相关的详细设置。用户组可以配置是否需要轮值，并指定对应的轮值规则。该模型通过JSON字段存储复杂的配置信息，提供了高度的灵活性。

``mermaid
erDiagram
USER_GROUP {
int id PK
string name
int bk_biz_id
string timezone
text desc
string source
bool need_duty
json channels
json mention_list
int mention_type
json alert_notice
json action_notice
json duty_notice
int webhook_action_id
json duty_rules
string app
string path
string hash
text snippet
}
```

**节源**
- [bkmonitor\bkmonitor\models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py#L464-L579)

## 结果表模型
结果表模型（ResultTable）是系统中用于数据存储的核心实体。它代表了一个逻辑结果表，包含了表名、中文名、是否为自定义表、schema配置方案、默认存储方案等信息。模型还记录了创建者、创建时间、最后修改者、最后修改时间等审计信息。结果表可以配置为不同的存储方案，如ES、InfluxDB等，并且支持多租户。该模型通过REAL_STORAGE_DICT字典管理了所有支持的实际存储类型。**重要更新**：`bk_tenant_id`字段的逻辑已优化，作为多租户架构的核心标识，确保了租户间数据的隔离与正确路由。

``mermaid
erDiagram
RESULT_TABLE {
bigint id PK
string table_id
string bk_tenant_id
string table_name_zh
bool is_custom_table
string schema_type
string default_storage
string creator
datetime create_time
string last_modify_user
datetime last_modify_time
int bk_biz_id
bool is_deleted
bool is_enable
string label
string data_label
bool is_builtin
string bk_biz_id_alias
}
```

**节源**
- [bkmonitor\metadata\models\result_table.py](file://bkmonitor\metadata\models\result_table.py#L50-L1722)

## 告警事件模型
告警事件模型（Alert）用于表示系统中的告警通知。该模型记录了通知方式、通知接收人、通知接收人角色、通知时间、状态、原因、动作ID、关联事件ID和汇总ID等信息。告警的状态可以是“通知中”、“通知成功”或“通知失败”。该模型是系统告警通知功能的核心，用于跟踪和管理所有告警的发送状态。

``mermaid
erDiagram
ALERT {
int id PK
string method
string username
string role
datetime create_time
string status
text message
int action_id FK
string event_id FK
int alert_collect_id FK
}
```

**节源**
- [bkmonitor\bkmonitor\models\base.py](file://bkmonitor\bkmonitor\models\base.py#L728-L754)

## 数据链路模型
数据链路模型（DataLink）是本次更新的核心，用于管理从数据源到最终存储的完整配置流转。该模型定义了链路名称、租户ID（bk_tenant_id）、命名空间和链路策略（data_link_strategy）。链路策略决定了数据流转的模式，例如“标准单指标单表时序数据链路”或“基础事件链路”。DataLink通过`compose_configs`方法，根据策略动态组装出VMResultTableConfig、VMStorageBindingConfig、DataBusConfig等一系列具体的资源配置。该模型还负责调用`apply_data_link`方法将配置下发，并通过`sync_metadata`同步元数据，确保了数据链路的完整性和一致性。此模型是实现灵活数据接入和多租户支持的关键。

``mermaid
erDiagram
DATALINK {
string data_link_name PK
string bk_tenant_id
string namespace
string data_link_strategy
datetime create_time
datetime last_modify_time
}
```

**节源**
- [bkmonitor\metadata\models\data_link\data_link.py](file://bkmonitor\metadata\models\data_link\data_link.py#L1-L906)

## 实体关系与数据流
系统中的核心实体通过外键和逻辑关联形成一个完整的数据流。数据源（DataSource）通过其配置关联到数据链路（DataLink），数据链路根据策略组装出完整的配置并下发。配置的结果数据被存储在结果表（ResultTable）中，结果表通过table_id与数据源关联，形成了数据采集和存储的完整链路。监控策略（StrategyModel）通过关联的查询配置（QueryConfigModel）从结果表中获取数据，当监控条件触发时，系统会生成告警事件（Alert），告警事件通过event_id关联到具体的事件，并通过用户组（UserGroup）确定通知的接收者。这种设计实现了从数据采集、处理、存储到告警通知的完整闭环。

``mermaid
graph TD
A[数据源 DataSource] --> B(数据链路 DataLink)
B --> |组装配置| C[VM/ES存储配置]
C --> D(结果表 ResultTable)
D --> |提供数据| E[查询配置 QueryConfigModel]
E --> |触发| F(监控策略 StrategyModel)
F --> |产生| G[告警事件 Alert]
G --> |通知| H(用户组 UserGroup)
```

**图源**
- [bkmonitor\bkmonitor\models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [bkmonitor\metadata\models\result_table.py](file://bkmonitor\metadata\models\result_table.py)
- [bkmonitor\bkmonitor\models\base.py](file://bkmonitor\bkmonitor\models\base.py)
- [bkmonitor\metadata\models\data_link\data_link.py](file://bkmonitor\metadata\models\data_link\data_link.py)

## 索引与性能优化
为了确保系统的高性能，数据模型中定义了多个索引。监控策略模型在is_enabled、bk_biz_id和scenario字段上创建了组合索引，以加速策略的查询和过滤。查询配置模型在data_source_label和data_type_label字段上创建了组合索引，以优化数据源和数据类型的查询性能。结果表模型在table_id和bk_tenant_id字段上创建了唯一组合索引，以确保结果表在租户内的唯一性。此外，系统还使用了Redis和ES等缓存和搜索引擎来进一步提升查询性能。

**节源**
- [bkmonitor\bkmonitor\models\strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [bkmonitor\metadata\models\result_table.py](file://bkmonitor\metadata\models\result_table.py)