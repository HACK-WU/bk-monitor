# 快速入门

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [Dockerfile](file://bkmonitor/Dockerfile)
- [pyproject.toml](file://bkmonitor/pyproject.toml)
- [manage.py](file://bkmonitor/manage.py)
- [bin/manage.sh](file://bkmonitor/bin/manage.sh)
- [bin/environ.sh](file://bkmonitor/bin/environ.sh)
- [settings.py](file://bkmonitor/settings.py)
- [config/dev.py](file://bkmonitor/config/dev.py)
- [bkmonitor/strategy/strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py)
</cite>

## 目录
1. [简介](#简介)
2. [系统要求与依赖](#系统要求与依赖)
3. [开发环境配置](#开发环境配置)
4. [数据库配置](#数据库配置)
5. [服务启动](#服务启动)
6. [核心功能演示：创建CPU使用率监控策略](#核心功能演示：创建cpu使用率监控策略)
7. [关键配置文件说明](#关键配置文件说明)
8. [常见问题与解决方案](#常见问题与解决方案)

## 简介

蓝鲸智云监控平台（BlueKing - Monitor）是一款由腾讯蓝鲸推出的综合性监控解决方案，具备强大的数据采集、大规模数据处理和平台扩展能力。本快速入门指南旨在帮助新用户快速搭建开发环境，理解核心工作流程，并成功运行基本功能。

本指南基于项目实际文件结构和配置要求，提供从环境搭建到功能演示的完整路径，确保开发者能够顺利开始基于bk-monitor的开发工作。

## 系统要求与依赖

在搭建bk-monitor开发环境之前，请确保您的系统满足以下要求。

### 操作系统与基础环境
- **操作系统**：推荐使用Linux或macOS。Windows系统可通过WSL2或Docker进行支持。
- **Python版本**：项目明确要求Python 3.11（`pyproject.toml`中`requires-python = "==3.11.*"`）。
- **Node.js版本**：前端构建需要Node.js 20（`Dockerfile`中`FROM node:20-bullseye-slim`）。
- **包管理工具**：推荐使用`uv`作为Python包管理器（`Dockerfile`中从`ghcr.io/astral-sh/uv:latest`复制），或使用`pip`。

### 核心依赖服务
bk-monitor依赖多个外部服务，开发环境需确保以下服务可用：
- **MySQL**：用于存储核心业务数据。
- **Redis**：用作缓存和Celery消息队列。
- **RabbitMQ**（可选）：可替代Redis作为Celery消息队列。
- **InfluxDB**：用于时序数据存储。
- **Elasticsearch**：用于日志和指标的全文检索。

**Section sources**
- [Dockerfile](file://bkmonitor/Dockerfile#L0-L92)
- [pyproject.toml](file://bkmonitor/pyproject.toml#L0-L207)

## 开发环境配置

本节将指导您完成开发环境的配置，包括代码获取、依赖安装和环境变量设置。

### 1. 获取代码
```bash
git clone https://github.com/TencentBlueKing/bk-monitor.git
cd bk-monitor
```

### 2. 安装Python依赖
项目使用`pyproject.toml`管理依赖。建议使用虚拟环境：
```bash
# 创建并激活虚拟环境
python -m venv venv
source venv/bin/activate  # Linux/macOS
# 或 venv\Scripts\activate  # Windows

# 安装生产依赖
pip install -r requirements.txt  # 如果存在
# 或根据pyproject.toml手动安装
pip install -e .
```

### 3. 配置开发环境变量
项目通过`bin/environ.sh`和`settings.py`进行环境配置。

- **`bin/environ.sh`**：此脚本设置`DJANGO_CONF_MODULE`环境变量，决定加载哪个配置文件。
  ```bash
  # 文件内容
  ENVIRONMENT="development"
  export DJANGO_CONF_MODULE="conf.worker.${ENVIRONMENT}.${PLATFORM}"
  ```
  该脚本将`ENVIRONMENT`设为`development`，并导出`DJANGO_CONF_MODULE`变量。

- **`settings.py`**：此文件是Django的主配置文件。它会根据`ENVIRONMENT`变量动态加载`config/`目录下的配置。
  ```python
  DJANGO_CONF_MODULE = "config.{env}".format(
      env={"development": "dev", "testing": "stag", "production": "prod"}.get(ENVIRONMENT)
  )
  ```
  在开发模式下，它会加载`config/dev.py`。

**Section sources**
- [bin/environ.sh](file://bkmonitor/bin/environ.sh#L0-L12)
- [settings.py](file://bkmonitor/settings.py#L0-L73)

## 数据库配置

数据库配置位于`config/dev.py`文件中，专为本地开发环境设计。

### 配置详情
```python
# config/dev.py
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.mysql",
        "NAME": APP_CODE,  # 数据库名，通常与应用代码一致
        "USER": "root",    # 数据库用户名
        "PASSWORD": "",    # 数据库密码（开发环境可为空）
        "HOST": "localhost", # 数据库主机
        "PORT": "3306",    # 数据库端口
    },
    "monitor_api": { # 另一个数据库连接，用于特定API
        "ENGINE": "django.db.backends.mysql",
        "NAME": APP_CODE,
        "USER": "root",
        "PASSWORD": "",
        "HOST": "localhost",
        "PORT": "3306",
    },
}
```

### 配置步骤
1.  **启动MySQL服务**：确保本地MySQL服务正在运行。
2.  **创建数据库**：根据注释中的SQL语句创建数据库。
    ```sql
    CREATE DATABASE `framework_py` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;
    ```
    注意：`APP_CODE`是一个变量，实际值可能在环境变量或`default.py`中定义。
3.  **验证配置**：检查`HOST`和`PORT`是否与您的MySQL服务匹配。

**Section sources**
- [config/dev.py](file://bkmonitor/config/dev.py#L0-L74)

## 服务启动

项目提供了`manage.sh`脚本作为服务启动的统一入口。

### 使用`manage.sh`脚本
该脚本位于`bkmonitor/bin/manage.sh`。

```bash
#!/bin/bash
SCRIPT_DIR=`dirname $0`
cd $SCRIPT_DIR && cd .. || exit 1

source bin/environ.sh # 加载环境变量

echo "[ INFO ] DJANGO_CONF_MODULE: \"$DJANGO_CONF_MODULE\"" >&2

${PYTHON_BIN:-python} manage.py $@ # 执行Django命令
```

#### 启动开发服务器
```bash
# 进入项目根目录
cd bkmonitor

# 使用manage.sh启动Django开发服务器
./bin/manage.sh runserver 0.0.0.0:8000
```
此命令会启动Django内置的开发服务器，监听8000端口。

#### 其他常用命令
```bash
# 执行数据库迁移
./bin/manage.sh migrate

# 创建超级用户
./bin/manage.sh createsuperuser

# 启动Celery Worker（用于异步任务）
./bin/manage.sh celery worker -l info
```

**Section sources**
- [bin/manage.sh](file://bkmonitor/bin/manage.sh#L0-L13)
- [manage.py](file://bkmonitor/manage.py#L0-L48)

## 核心功能演示：创建CPU使用率监控策略

本节将通过一个简单的示例，演示如何创建一个监控主机CPU使用率的策略。

### 1. 理解策略结构
监控策略的核心逻辑在`bkmonitor/strategy/strategy.py`中定义。一个策略（`Strategy`）包含以下关键组件：
- **监控项（Item）**：定义采集的数据，如`cpu_usage`。
- **检测算法（DetectAlgorithm）**：定义告警规则，如阈值超过90%。
- **通知动作（Action）**：定义告警触发后的处理，如发送邮件。

### 2. 创建策略的代码逻辑
以下是创建策略的核心代码片段（简化版）：

```python
# 来自 bkmonitor/strategy/strategy.py
class StrategyConfig(object):
    def __init__(self, bk_biz_id, strategy_id):
        # 初始化策略配置
        self.bk_biz_id = bk_biz_id
        # ... 其他初始化逻辑

    def save(self):
        # 保存策略到数据库
        try:
            strategy = Strategy.objects.create(
                name=self.name,
                bk_biz_id=self.bk_biz_id,
                is_enabled=True
            )
            # 创建监控项
            item = Item.objects.create(
                strategy=strategy,
                metric_id="cpu_usage", # 指标ID
                data_source_label="BK_MONITOR", # 数据来源
                target=[{"ip": "127.0.0.1"}] # 监控目标
            )
            # 创建检测算法
            DetectAlgorithm.objects.create(
                item=item,
                algorithm_type="Threshold", # 算法类型：阈值
                algorithm_config=[{"threshold": 90}], # 配置：阈值90%
                level=1 # 告警级别
            )
        except Exception as e:
            raise CreateStrategyError(f"创建策略失败: {e}")
```

### 3. 操作流程
1.  **访问Web界面**：启动服务后，通过浏览器访问`http://localhost:8000`。
2.  **导航至策略管理**：在监控平台的Web界面中找到“策略管理”或类似功能。
3.  **创建新策略**：
    - **选择场景**：选择“主机”监控场景。
    - **填写策略名称**：如“CPU使用率监控”。
    - **添加监控项**：选择指标“CPU使用率”(`cpu_usage`)。
    - **配置告警规则**：设置“阈值算法”，条件为“> 90%”。
    - **设置通知组**：选择一个通知组，用于接收告警。
4.  **保存并启用**：保存策略并确保其处于启用状态。

完成以上步骤后，系统将开始监控指定主机的CPU使用率，并在超过90%时触发告警。

**Section sources**
- [bkmonitor/strategy/strategy.py](file://bkmonitor/bkmonitor/strategy/strategy.py#L0-L199)

## 关键配置文件说明

| 文件路径 | 作用 |
| :--- | :--- |
| `README.md` | 项目总览，包含项目介绍、许可证和快速入门指引。 |
| `Dockerfile` | 定义了项目的容器化构建流程，包含基础镜像、依赖安装和启动命令。 |
| `pyproject.toml` | Python项目的依赖管理和构建配置，列出了所有必需的Python包。 |
| `manage.py` | Django项目的命令行工具入口，所有Django管理命令都通过此文件执行。 |
| `bin/manage.sh` | 项目自定义的管理脚本，封装了`manage.py`并自动加载环境变量。 |
| `bin/environ.sh` | 环境变量配置脚本，用于设置`DJANGO_CONF_MODULE`等关键变量。 |
| `settings.py` | Django主配置文件，负责加载环境特定的配置。 |
| `config/dev.py` | 开发环境的具体配置，包含数据库、Redis等服务的连接信息。 |

## 常见问题与解决方案

### 1. 数据库连接失败
**问题**：启动服务时出现`django.db.utils.OperationalError`。
**原因**：MySQL服务未启动，或`config/dev.py`中的`HOST`、`PORT`、`USER`、`PASSWORD`配置错误。
**解决方案**：
- 确认MySQL服务已启动。
- 检查`config/dev.py`中的数据库配置是否正确。
- 确认数据库`NAME`对应的数据库已创建。

### 2. 服务启动异常（ImportError）
**问题**：出现`ImportError: Could not import config 'config.role.development'`。
**原因**：`settings.py`尝试加载`config.role.{ROLE}`模块，但`ROLE`环境变量未设置或模块不存在。
**解决方案**：
- 检查`bin/environ.sh`中是否正确设置了`ROLE`变量。
- 确认`config/role/`目录下存在`development.py`文件。

### 3. 依赖安装失败
**问题**：`pip install`时出现包下载失败。
**原因**：网络问题或PyPI源访问受限。
**解决方案**：
- 使用国内镜像源，如`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt`。
- 或在`Dockerfile`中设置`pypi_index_url`参数。

### 4. 符号链接创建失败（Windows）
**问题**：在Windows上运行`manage.py`时，创建`ai_agent`软链接失败。
**原因**：`manage.py`脚本尝试创建符号链接，但可能因权限不足而失败。
**解决方案**：
- 以管理员身份运行命令行。
- 或手动将`../ai_agent`目录复制到`bkmonitor/ai_agent`。