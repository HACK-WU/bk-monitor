# 快速入门

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [pyproject.toml](file://pyproject.toml)
- [settings.py](file://bkmonitor/settings.py)
- [manage.py](file://bkmonitor/manage.py)
- [Dockerfile](file://bkmonitor/Dockerfile)
- [0001_initial.py](file://bkmonitor/apm/migrations/0001_initial.py)
- [application.py](file://bkmonitor/apm/models/application.py)
- [views.py](file://bkmonitor/apm/views.py)
</cite>

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [代码克隆与依赖安装](#代码克隆与依赖安装)
4. [数据库初始化](#数据库初始化)
5. [服务启动](#服务启动)
6. [使用示例：配置主机存活监控策略](#使用示例配置主机存活监控策略)
7. [关键配置说明](#关键配置说明)
8. [本地开发环境搭建](#本地开发环境搭建)
9. [测试与调试](#测试与调试)

## 简介

bk-apm 是蓝鲸智云监控平台（BlueKing - Monitor）的一部分，提供应用性能监控（APM）功能，支持 Trace、Metric、Log 和 Profiling 等多种遥测数据类型的采集与分析。本指南旨在帮助新用户快速搭建和运行 bk-apm 项目，完成从环境准备到实际使用的完整流程。

**Section sources**
- [README.md](file://README.md)

## 环境准备

在开始搭建 bk-apm 项目之前，请确保您的系统满足以下环境要求：

- **Python 版本**：建议使用 Python 3.10，项目配置中明确指定了目标版本。
- **Docker**：用于容器化部署，建议安装最新稳定版本。
- **MySQL**：作为主数据库，建议使用 MySQL 5.7 或更高版本。项目代码中包含对 MySQL 5.7 的兼容性补丁。
- **Elasticsearch**：用于存储和查询 Trace 数据，建议使用与项目兼容的版本（通常为 5.x 或 7.x）。
- **Node.js**：前端构建需要 Node.js 环境，Dockerfile 中使用了 node:20 镜像。
- **其他工具**：`pip`、`uv`（Python 包管理工具）、`pnpm`（Node.js 包管理工具）等。

**Section sources**
- [pyproject.toml](file://pyproject.toml#L42)
- [Dockerfile](file://bkmonitor/Dockerfile#L38)
- [settings.py](file://bkmonitor/settings.py#L74-L89)

## 代码克隆与依赖安装

1. **克隆代码仓库**：
   ```bash
   git clone https://github.com/TencentBlueKing/bk-monitor.git bk-apm
   cd bk-apm
   ```

2. **安装 Python 依赖**：
   项目使用 `pyproject.toml` 和 `uv.lock` 文件管理依赖。推荐使用 `uv` 工具进行快速依赖同步。
   ```bash
   # 安装 uv（如果尚未安装）
   pip install uv

   # 同步生产环境依赖
   uv sync --locked --no-dev
   ```

   `pyproject.toml` 文件中定义了代码格式化和检查工具（如 black、isort、ruff），这些开发依赖在生产环境中不会安装。

**Section sources**
- [pyproject.toml](file://pyproject.toml)
- [Dockerfile](file://bkmonitor/Dockerfile#L32-L35)

## 数据库初始化

bk-apm 使用 Django 框架，其数据库迁移由 Django 的 `migrate` 命令管理。

1. **确保数据库服务已启动**：
   确认 MySQL 服务正在运行，并且已创建好目标数据库。

2. **执行数据库迁移**：
   ```bash
   python manage.py migrate
   ```

   此命令会应用 `apm/migrations/` 目录下的所有迁移文件，创建或更新数据库表结构。例如，`0001_initial.py` 文件定义了 `ApmApplication`、`TraceDataSource`、`MetricDataSource` 等核心模型的初始表结构。

3. **创建超级用户（可选）**：
   为了访问 Django 管理后台，可以创建一个超级用户。
   ```bash
   python manage.py createsuperuser
   ```

**Section sources**
- [manage.py](file://bkmonitor/manage.py#L44-L48)
- [0001_initial.py](file://bkmonitor/apm/migrations/0001_initial.py)
- [application.py](file://bkmonitor/apm/models/application.py)

## 服务启动

您可以选择通过 Docker 或直接运行 `manage.py` 来启动服务。

### 方法一：使用 Docker 启动

1. **构建镜像**：
   ```bash
   docker build -t bk-apm .
   ```

2. **运行容器**：
   ```bash
   docker run -d -p 8000:80 --name bk-apm-container bk-apm
   ```

   Dockerfile 的 `CMD` 指令定义了默认启动命令为 `python manage.py runserver 0.0.0.0:80`。

### 方法二：直接运行（开发模式）

1. **设置环境变量**：
   确保设置了必要的环境变量，如数据库连接信息。项目通过 `dotenv` 加载 `.env` 文件。
   ```bash
   echo "DATABASE_URL=mysql://user:password@localhost:3306/dbname" > .env
   ```

2. **启动开发服务器**：
   ```bash
   python manage.py runserver 0.0.0.0:8000
   ```

   服务启动后，默认可通过 `http://localhost:8000` 访问。

**Section sources**
- [Dockerfile](file://bkmonitor/Dockerfile#L83)
- [manage.py](file://bkmonitor/manage.py#L44-L48)
- [settings.py](file://bkmonitor/settings.py#L14-L16)

## 使用示例：配置主机存活监控策略

以下是一个“Hello World”级别的使用示例，演示如何配置一个简单的主机存活监控策略并查看告警。

1. **创建 APM 应用**：
   调用 `CreateApplicationResource` API 创建一个新的 APM 应用。
   ```python
   # 示例调用（可通过 API 或管理后台）
   data = {
       "bk_tenant_id": "default",
       "bk_biz_id": 1,
       "app_name": "host-monitor-demo",
       "app_alias": "主机监控示例",
       "description": "用于演示主机存活监控",
       "es_storage_config": {"cluster_id": "es-cluster-1"},
       "options": {"is_enabled_trace": True, "is_enabled_metric": True}
   }
   # 发送 POST 请求到 /api/apm/applications/create_application/
   ```

   此操作会调用 `ApmApplication.create_application` 方法，创建应用并异步初始化数据源。

2. **配置监控策略**：
   - 在应用创建成功后，进入应用详情页面。
   - 导航至“监控策略”或“告警策略”配置页面。
   - 创建一个新的策略，选择“主机存活”作为监控类型。
   - 配置目标主机 IP 或主机名，并设置告警阈值（如：连续 3 次 ping 失败）。

3. **查看告警**：
   - 模拟主机宕机（如关闭目标主机）。
   - 系统会根据策略检测到异常，并生成告警事件。
   - 在“告警中心”或“事件列表”中查看新产生的告警。

此流程涉及 `ApplicationViewSet` 中定义的 `CreateApplicationResource` 和 `ApplyDatasourceResource` 等资源视图。

**Section sources**
- [application.py](file://bkmonitor/apm/models/application.py#L224-L250)
- [views.py](file://bkmonitor/apm/views.py#L78-L82)

## 关键配置说明

`settings.py` 是 Django 项目的核心配置文件，以下是其中的关键设置项：

- **数据库配置**：通过 `DJANGO_CONF_MODULE` 动态加载 `config.{env}` 模块（如 `config.dev`），实现不同环境的配置分离。
- **环境变量注入**：以 `BKAPP_SETTINGS_` 为前缀的环境变量会被自动加载到 Django 设置中，便于容器化部署时进行配置覆盖。
- **路径配置**：`sys.path` 被修改以包含 `packages` 和 `ai_agent/sdk` 目录，确保项目能正确导入内部包。
- **MySQL 兼容性**：代码中包含对 Django 4.2+ 不再官方支持 MySQL 5.7 的补丁，通过修改 `DatabaseFeatures.minimum_database_version` 来兼容 MySQL 5.7。

**Section sources**
- [settings.py](file://bkmonitor/settings.py)

## 本地开发环境搭建

为了进行本地开发，建议遵循以下步骤：

1. **创建虚拟环境**：
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   # 或 venv\Scripts\activate  # Windows
   ```

2. **安装开发依赖**：
   ```bash
   uv sync --locked  # 安装包括开发依赖在内的所有包
   ```

3. **配置本地设置**：
   在项目根目录创建 `local_settings.py` 文件，覆盖 `settings.py` 中的开发专用配置，如数据库连接、调试开关等。`settings.py` 中的代码会自动导入此文件（仅在 `RUN_MODE == "DEVELOP"` 时）。

4. **前端开发**：
   前端代码位于 `webpack/` 目录。使用 `npm run dev` 启动前端开发服务器，实现热重载。

**Section sources**
- [settings.py](file://bkmonitor/settings.py#L68-L72)
- [Dockerfile](file://bkmonitor/Dockerfile#L45-L48)

## 测试与调试

1. **运行测试**：
   项目使用标准的 Django 测试框架。运行所有测试用例：
   ```bash
   python manage.py test
   ```

   您也可以运行特定应用的测试：
   ```bash
   python manage.py test apm
   ```

2. **调试**：
   - **日志**：通过 Django 的 `logging` 模块输出日志，可在 `settings.py` 中配置日志级别和输出位置。
   - **开发服务器**：使用 `runserver` 命令时，代码更改会自动重启服务器，并在出错时显示详细的调试信息。
   - **Python 调试器**：在代码中插入 `import pdb; pdb.set_trace()` 或使用 `breakpoint()` 函数进行断点调试。

**Section sources**
- [manage.py](file://bkmonitor/manage.py#L46-L48)