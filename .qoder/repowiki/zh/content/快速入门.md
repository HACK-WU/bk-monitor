# 快速入门

<cite>
**本文档中引用的文件**  
- [README.md](file://README.md)
- [requirements.txt](file://bklog/requirements.txt)
- [Dockerfile](file://bklog/Dockerfile)
- [settings.py](file://bklog/settings.py)
- [default.py](file://bklog/config/default.py)
- [manage.py](file://bklog/manage.py)
- [app.yml](file://bklog/app.yml)
- [dev.env.yml](file://bklog/dev.env.yml)
- [prod.env.yml](file://bklog/prod.env.yml)
- [stag.env.yml](file://bklog/stag.env.yml)
</cite>

## 目录
1. [简介](#简介)
2. [环境准备](#环境准备)
3. [安装方式](#安装方式)
   - [Docker部署](#docker部署)
   - [传统方式安装](#传统方式安装)
4. [最小化配置示例](#最小化配置示例)
5. [第一个日志采集任务](#第一个日志采集任务)
6. [安装验证](#安装验证)
7. [本地开发环境搭建](#本地开发环境搭建)

## 简介

蓝鲸智云监控平台（BK-MONITOR）是一款功能丰富的监控平台产品，具备强大的数据采集和处理能力。本快速入门指南旨在帮助新用户快速搭建和运行bk-monitor环境，提供清晰的安装步骤和配置说明。

**Section sources**
- [README.md](file://README.md#L1-L52)

## 环境准备

在开始安装bk-monitor之前，请确保您的系统满足以下环境要求：

### Python版本
- Python 3.8 或更高版本
- 推荐使用Python 3.9，项目依赖中包含的Django 4.2.22版本与Python 3.9兼容性最佳

### 数据库服务
- **MySQL**: 用于存储应用数据和配置信息
- **Redis**: 用于缓存和消息队列，支持Redis 2.0及以上版本
- **Elasticsearch**: 用于日志存储和全文检索，支持ES 5.x、6.x和7.x版本

### 其他依赖服务
- **Kafka**: 用于消息队列和数据流处理
- **Consul**: 用于服务发现和配置管理
- **RabbitMQ**: 用于异步任务队列

### 系统要求
- 操作系统：Linux（推荐使用CentOS 7+或Ubuntu 18.04+）
- 内存：建议至少4GB RAM
- 存储：建议至少20GB可用磁盘空间
- 网络：需要访问互联网以下载依赖包

**Section sources**
- [requirements.txt](file://bklog/requirements.txt#L1-L143)
- [default.py](file://bklog/config/default.py#L1-L800)

## 安装方式

### Docker部署

使用Docker是部署bk-monitor最简单的方式。以下是详细的Docker部署步骤：

1. **克隆项目仓库**
```bash
git clone https://github.com/TencentBlueKing/bk-monitor.git
cd bk-monitor
```

2. **构建Docker镜像**
```bash
cd bklog
docker build -t bk-monitor:latest .
```

3. **创建Docker网络**
```bash
docker network create bk-monitor-network
```

4. **启动依赖服务**
```bash
# 启动MySQL
docker run -d --name mysql-bk \
  --network bk-monitor-network \
  -e MYSQL_ROOT_PASSWORD=your_password \
  -e MYSQL_DATABASE=bk_monitor \
  -p 3306:3306 \
  mysql:5.7

# 启动Redis
docker run -d --name redis-bk \
  --network bk-monitor-network \
  -p 6379:6379 \
  redis:6.2

# 启动Elasticsearch
docker run -d --name elasticsearch-bk \
  --network bk-monitor-network \
  -p 9200:9200 \
  -p 9300:9300 \
  -e "discovery.type=single-node" \
  -e "xpack.security.enabled=false" \
  docker.elastic.co/elasticsearch/elasticsearch:7.17.9
```

5. **配置环境变量**
创建`.env`文件：
```bash
BK_PAAS_HOST=http://localhost:8000
BK_COMPONENT_API_URL=http://localhost:8000
BKAPP_BKLOG_API_HOST=http://bk-log-search-api
BKAPP_GRAFANA_URL=http://localhost:3000
BKAPP_REDIS_VERSION=2
```

6. **启动bk-monitor容器**
```bash
docker run -d --name bk-monitor \
  --network bk-monitor-network \
  --env-file .env \
  -p 8000:8000 \
  bk-monitor:latest
```

7. **执行数据库迁移**
```bash
docker exec -it bk-monitor python manage.py migrate
```

**Section sources**
- [Dockerfile](file://bklog/Dockerfile#L1-L23)
- [default.py](file://bklog/config/default.py#L1-L800)

### 传统方式安装

如果您选择传统方式安装bk-monitor，请按照以下步骤操作：

1. **安装系统依赖**
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install python3 python3-pip python3-dev mysql-server redis-server

# CentOS/RHEL
sudo yum install python3 python3-pip python3-devel mysql-server redis
```

2. **安装Python虚拟环境**
```bash
pip3 install virtualenv
virtualenv venv
source venv/bin/activate
```

3. **克隆项目并安装依赖**
```bash
git clone https://github.com/TencentBlueKing/bk-monitor.git
cd bk-monitor/bklog
pip install -r requirements.txt
```

4. **配置数据库**
```bash
# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 创建数据库
mysql -u root -p
CREATE DATABASE bk_monitor CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'bk_monitor'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON bk_monitor.* TO 'bk_monitor'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

5. **配置Redis**
```bash
# 启动Redis服务
sudo systemctl start redis
sudo systemctl enable redis
```

6. **配置Elasticsearch**
```bash
# 下载并安装Elasticsearch
wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.9-linux-x86_64.tar.gz
tar -xzf elasticsearch-7.17.9-linux-x86_64.tar.gz
cd elasticsearch-7.17.9

# 启动Elasticsearch
./bin/elasticsearch -d
```

7. **配置项目环境**
编辑`config/default.py`文件，设置数据库连接：
```python
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'bk_monitor',
        'USER': 'bk_monitor',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
            'sql_mode': 'STRICT_TRANS_TABLES',
        },
    }
}
```

8. **执行数据库迁移**
```bash
python manage.py migrate
```

9. **创建超级用户**
```bash
python manage.py createsuperuser
```

10. **启动服务**
```bash
python manage.py runserver 0.0.0.0:8000
```

**Section sources**
- [settings.py](file://bklog/settings.py#L1-L47)
- [manage.py](file://bklog/manage.py#L1-L31)
- [requirements.txt](file://bklog/requirements.txt#L1-L143)

## 最小化配置示例

为了帮助您快速启动bk-monitor，以下是最小化配置示例：

1. **创建最小化配置文件**
在`config/`目录下创建`minimal.py`文件：
```python
from .default import *

# 数据库配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'bk_monitor',
        'USER': 'bk_monitor',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '3306',
        'OPTIONS': {
            'charset': 'utf8mb4',
        },
    }
}

# Redis配置
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/0',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# Elasticsearch配置
ELASTICSEARCH_HOSTS = ['127.0.0.1:9200']

# 调试模式
DEBUG = True

# 允许的主机
ALLOWED_HOSTS = ['*']

# 特性开关
FEATURE_TOGGLE = {
    'scenario_log': 'on',
    'scenario_bkdata': 'off',
    'scenario_es': 'on',
    'log_desensitize': 'on',
    'monitor_report': 'on',
}
```

2. **设置环境变量**
```bash
export DJANGO_SETTINGS_MODULE=config.minimal
export BK_PAAS_HOST=http://localhost:8000
```

3. **应用最小化配置**
```bash
python manage.py migrate
python manage.py runserver 0.0.0.0:8000
```

**Section sources**
- [default.py](file://bklog/config/default.py#L1-L800)
- [settings.py](file://bklog/settings.py#L1-L47)

## 第一个日志采集任务

完成安装后，让我们创建第一个日志采集任务：

1. **登录系统**
访问`http://localhost:8000`，使用之前创建的超级用户账号登录。

2. **进入日志采集页面**
在左侧导航栏中，点击"管理" -> "日志接入" -> "日志采集"。

3. **创建采集项**
- 点击"新建采集项"按钮
- 填写采集项名称，如"My Application Log"
- 选择数据源类型为"文件"
- 设置日志路径为`/var/log/myapp/*.log`

4. **配置日志格式**
- 选择日志格式为"JSON"
- 配置字段映射：
  - `timestamp`: 时间戳字段
  - `level`: 日志级别字段
  - `message`: 日志内容字段

5. **设置采集策略**
- 采集频率：实时
- 编码格式：UTF-8
- 多行日志识别：启用

6. **部署采集器**
- 选择目标主机
- 点击"部署"按钮
- 等待采集器安装完成

7. **验证采集结果**
- 返回日志检索页面
- 选择刚刚创建的索引集
- 查看是否有日志数据流入

**Section sources**
- [default.py](file://bklog/config/default.py#L1-L800)
- [app.yml](file://bklog/app.yml#L1-L19)

## 安装验证

为了确保bk-monitor安装成功，请按照以下清单进行验证：

### 服务状态检查
```bash
# 检查Django服务
curl -I http://localhost:8000/healthz

# 检查Celery worker
docker exec -it bk-monitor celery -A bklog inspect ping

# 检查Redis连接
redis-cli ping

# 检查Elasticsearch状态
curl -X GET "localhost:9200/_cluster/health?pretty"
```

### API端点测试
```bash
# 测试健康检查API
curl http://localhost:8000/healthz/

# 测试版本信息API
curl http://localhost:8000/api/v1/version/

# 测试用户信息API
curl http://localhost:8000/api/v1/user/
```

### 数据库连接验证
```bash
# 进入Python shell
python manage.py shell

# 测试数据库连接
from django.db import connection
cursor = connection.cursor()
cursor.execute("SELECT 1;")
print(cursor.fetchone())
```

### 日志采集验证
1. 在系统中创建一个测试日志文件：
```bash
echo '{"timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'", "level": "INFO", "message": "Test log entry"}' > /tmp/test.log
```

2. 配置采集项指向`/tmp/test.log`

3. 在日志检索界面查看是否能查询到该日志

**Section sources**
- [default.py](file://bklog/config/default.py#L1-L800)
- [dev.env.yml](file://bklog/dev.env.yml#L1-L87)

## 本地开发环境搭建

为了进行本地开发，需要搭建完整的开发环境：

1. **安装开发依赖**
```bash
pip install -r requirements_dev.txt
```

2. **配置开发环境**
创建`config/dev.py`文件：
```python
from .default import *

# 开发环境设置
DEBUG = True
ALLOWED_HOSTS = ['*']

# 开发数据库
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# 开发Redis
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
    }
}

# 开发特性开关
FEATURE_TOGGLE = {
    'scenario_log': 'on',
    'scenario_bkdata': 'on',
    'scenario_es': 'on',
    'log_desensitize': 'on',
    'monitor_report': 'on',
    'trace': 'on',
}
```

3. **设置环境变量**
```bash
export DJANGO_SETTINGS_MODULE=config.dev
export ENVIRONMENT=dev
```

4. **执行数据库迁移**
```bash
python manage.py migrate
```

5. **创建开发用户**
```bash
python manage.py createsuperuser --username=devuser --email=dev@example.com
```

6. **启动开发服务器**
```bash
python manage.py runserver 0.0.0.0:8000
```

7. **启动Celery worker**
```bash
python manage.py celery worker -l info
```

8. **启动Celery beat**
```bash
python manage.py celery beat -l info
```

9. **运行单元测试**
```bash
python manage.py test
```

10. **代码格式化**
```bash
# 使用flake8检查代码风格
flake8 .

# 使用black格式化代码
black .
```

**Section sources**
- [requirements.txt](file://bklog/requirements.txt#L1-L143)
- [manage.py](file://bklog/manage.py#L1-L31)
- [dev.env.yml](file://bklog/dev.env.yml#L1-L87)
- [prod.env.yml](file://bklog/prod.env.yml)
- [stag.env.yml](file://bklog/stag.env.yml)