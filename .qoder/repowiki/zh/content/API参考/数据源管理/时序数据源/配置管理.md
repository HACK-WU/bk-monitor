# 配置管理

<cite>
**本文档引用的文件**   
- [data_source.py](file://bkmonitor/metadata/models/data_source.py#L122-L140)
- [influxdb_cluster.py](file://bkmonitor/metadata/models/influxdb_cluster.py#L597-L634)
- [default.py](file://bkmonitor/config/default.py#L1296-L1326)
- [cipher.py](file://bkmonitor/bkmonitor/utils/cipher.py#L33-L70)
- [resources.py](file://bkmonitor/packages/monitor_web/as_code/resources.py#L124-L150)
- [check_bcs_cluster_status.py](file://bkmonitor/metadata/management/commands/check_bcs_cluster_status.py#L119-L148)
- [parse.py](file://bkmonitor/bkmonitor/as_code/parse.py#L188-L227)
- [consul_tools.py](file://bkmonitor/metadata/utils/consul_tools.py#L96-L121)
</cite>

## 目录
1. [引言](#引言)
2. [数据源类型配置](#数据源类型配置)
3. [连接信息配置](#连接信息配置)
4. [认证方式配置](#认证方式配置)
5. [配置验证与测试连接](#配置验证与测试连接)
6. [配置导入导出功能](#配置导入导出功能)
7. [敏感信息加密存储](#敏感信息加密存储)
8. [配置版本控制](#配置版本控制)
9. [配置变更生效与热更新](#配置变更生效与热更新)
10. [配置管理最佳实践](#配置管理最佳实践)

## 引言
本文档详细介绍了时序数据源配置管理的各个方面，包括数据源类型配置、连接信息配置、认证方式配置、配置验证与测试连接、配置导入导出功能、敏感信息加密存储、配置版本控制、配置变更生效与热更新等。通过本文档，用户可以全面了解如何配置和管理数据源，确保系统的稳定性和安全性。

## 数据源类型配置
数据源类型配置是数据源管理的基础，不同的数据源类型有不同的配置参数和管理方式。常见的数据源类型包括InfluxDB、Prometheus等。

### InfluxDB 数据源配置
InfluxDB 是一种时间序列数据库，常用于存储和查询时间序列数据。其配置参数包括：
- **数据类型标签**：表明数据是时序数据、时间数据、事件数据。
- **数据源标签**：表明数据是从渠道上来的，可能有bk_monitor, bk_data, custom。
- **自定义标签信息**：供各个信息注入各种自定义内容使用。
- **请求来源的系统**：请求来源的系统，如SAAS_APP_CODE。
- **是否启用数据源**：数据源是否启用。

```python
class DataSource(models.Model):
    last_modify_time = models.DateTimeField("最后更新时间", auto_now=True)
    type_label = models.CharField(verbose_name="数据类型标签", max_length=128, default=Label.RESULT_TABLE_LABEL_OTHER)
    source_label = models.CharField(verbose_name="数据源标签", max_length=128, default=Label.RESULT_TABLE_LABEL_OTHER)
    custom_label = models.CharField(verbose_name="自定义标签信息", max_length=256, default=None, null=True)
    source_system = models.CharField(verbose_name="请求来源的系统", max_length=256, default=settings.SAAS_APP_CODE)
    is_enable = models.BooleanField(verbose_name="数据源是否启用", default=True)
    transfer_cluster_id = models.CharField(verbose_name="transfer集群ID", default=settings.DEFAULT_TRANSFER_CLUSTER_ID, max_length=50)
```

### Prometheus 数据源配置
Prometheus 是一种开源监控系统，常用于监控和报警。其配置参数包括：
- **数据类型标签**：表明数据是时序数据、时间数据、事件数据。
- **数据源标签**：表明数据是从渠道上来的，可能有bk_monitor, bk_data, custom。
- **自定义标签信息**：供各个信息注入各种自定义内容使用。
- **请求来源的系统**：请求来源的系统，如SAAS_APP_CODE。
- **是否启用数据源**：数据源是否启用。

```python
class DataSource(models.Model):
    last_modify_time = models.DateTimeField("最后更新时间", auto_now=True)
    type_label = models.CharField(verbose_name="数据类型标签", max_length=128, default=Label.RESULT_TABLE_LABEL_OTHER)
    source_label = models.CharField(verbose_name="数据源标签", max_length=128, default=Label.RESULT_TABLE_LABEL_OTHER)
    custom_label = models.CharField(verbose_name="自定义标签信息", max_length=256, default=None, null=True)
    source_system = models.CharField(verbose_name="请求来源的系统", max_length=256, default=settings.SAAS_APP_CODE)
    is_enable = models.BooleanField(verbose_name="数据源是否启用", default=True)
    transfer_cluster_id = models.CharField(verbose_name="transfer集群ID", default=settings.DEFAULT_TRANSFER_CLUSTER_ID, max_length=50)
```

**Section sources**
- [data_source.py](file://bkmonitor/metadata/models/data_source.py#L122-L140)

## 连接信息配置
连接信息配置包括主机地址、端口、数据库名称等网络参数，确保数据源能够正确连接到目标系统。

### InfluxDB 连接信息配置
InfluxDB 的连接信息配置包括：
- **域名**：InfluxDB 服务器的域名或IP地址。
- **端口**：InfluxDB 服务器的端口号。
- **用户名**：连接 InfluxDB 服务器的用户名。
- **密码**：连接 InfluxDB 服务器的密码。
- **状态**：InfluxDB 服务器的状态。
- **备份速率限制**：备份速率限制。
- **gRPC 端口**：gRPC 服务的端口号。
- **协议**：使用的协议。
- **读取速率限制**：读取速率限制。

```python
class InfluxDBCluster(models.Model):
    domain_name = models.CharField(verbose_name="域名", max_length=256)
    port = models.IntegerField(verbose_name="端口")
    username = models.CharField(verbose_name="用户名", max_length=256, null=True, blank=True)
    password = models.CharField(verbose_name="密码", max_length=256, null=True, blank=True)
    status = models.CharField(verbose_name="状态", max_length=50, default="true")
    backup_rate_limit = models.IntegerField(verbose_name="备份速率限制", default=0)
    grpc_port = models.IntegerField(verbose_name="gRPC 端口", null=True, blank=True)
    protocol = models.CharField(verbose_name="协议", max_length=50, default="http")
    read_rate_limit = models.IntegerField(verbose_name="读取速率限制", default=0)
```

**Section sources**
- [influxdb_cluster.py](file://bkmonitor/metadata/models/influxdb_cluster.py#L597-L634)

## 认证方式配置
认证方式配置包括用户名密码、Token、证书等多种认证机制的设置方法，确保数据源的安全性。

### 用户名密码认证
用户名密码认证是最常见的认证方式，适用于大多数场景。配置参数包括：
- **用户名**：连接数据源的用户名。
- **密码**：连接数据源的密码。

### Token 认证
Token 认证适用于需要更高安全性的场景。配置参数包括：
- **Token**：连接数据源的 Token。
- **协议**：使用的协议，如 Bearer。

### 证书认证
证书认证适用于需要最高安全性的场景。配置参数包括：
- **证书文件**：客户端证书文件。
- **私钥文件**：客户端私钥文件。
- **CA 证书文件**：CA 证书文件。

```python
class TokenAuthentication:
    def __init__(self, token, scheme="Bearer"):
        self.token = token
        self.scheme = scheme

    def authenticate(self, options):
        options.headers['Authorization'] = f"{self.scheme} {self.token}"
        return options
```

**Section sources**
- [cipher.py](file://bkmonitor/bkmonitor/utils/cipher.py#L33-L70)

## 配置验证与测试连接
配置验证与测试连接功能确保数据源配置的正确性和可用性，避免因配置错误导致的数据采集失败。

### 配置验证
配置验证通过校验配置参数的合法性，确保配置的正确性。常见的验证包括：
- **参数类型校验**：确保配置参数的类型正确。
- **必填项校验**：确保必填项不为空。
- **格式校验**：确保配置参数的格式正确。

### 测试连接
测试连接功能通过实际连接数据源，验证配置的可用性。常见的测试包括：
- **数据库连接测试**：测试与数据库的连接。
- **API 连接测试**：测试与 API 的连接。
- **Kubernetes 集群连接测试**：测试与 Kubernetes 集群的连接。

```python
def check_database_record(cluster_id):
    try:
        db_check = self.check_database_record(cluster_id)
        if not db_check["exists"]:
            return {"status": "NOT_FOUND", "errors": ["集群在数据库中不存在"]}
        return db_check
    except Exception as e:
        return {"status": "ERROR", "errors": [str(e)]}

def check_bcs_api_connection(cluster_info, timeout):
    try:
        bcs_api_check = self.check_bcs_api_connection(cluster_info, timeout)
        return bcs_api_check
    except Exception as e:
        return {"status": "ERROR", "errors": [str(e)]}

def check_kubernetes_connection(cluster_info, timeout):
    try:
        k8s_check = self.check_kubernetes_connection(cluster_info, timeout)
        return k8s_check
    except Exception as e:
        return {"status": "ERROR", "errors": [str(e)]}
```

**Section sources**
- [check_bcs_cluster_status.py](file://bkmonitor/metadata/management/commands/check_bcs_cluster_status.py#L119-L148)

## 配置导入导出功能
配置导入导出功能允许用户将配置导出为文件，或将文件中的配置导入到系统中，方便配置的备份和迁移。

### 导出配置
导出配置功能将系统中的配置导出为文件，支持多种格式，如 YAML、JSON 等。常见的导出参数包括：
- **业务ID**：导出配置的业务ID。
- **应用**：导出配置的应用。
- **策略ID列表**：导出配置的策略ID列表。
- **通知组ID列表**：导出配置的通知组ID列表。
- **分配组ID列表**：导出配置的分配组ID列表。
- **仪表盘UID列表**：导出配置的仪表盘UID列表。
- **是否导出外部仪表盘**：是否导出外部仪表盘。
- **是否锁定文件名**：是否锁定文件名。
- **是否带上ID**：是否带上ID。

```python
class ExportConfigResource(Resource):
    class RequestSerializer(BkBizIdSerializer):
        app = serializers.CharField(default=None, allow_blank=True, allow_null=True)
        action_ids = serializers.ListField(child=serializers.IntegerField(), allow_null=True, default=None)
        rule_ids = serializers.ListField(child=serializers.IntegerField(), allow_null=True, default=None)
        notice_group_ids = serializers.ListField(child=serializers.IntegerField(), allow_null=True, default=None)
        assign_group_ids = serializers.ListField(child=serializers.IntegerField(), default=None, allow_null=True)
        dashboard_uids = serializers.ListField(child=serializers.CharField(), allow_null=True, default=None)
        dashboard_for_external = serializers.BooleanField(label="仪表盘导出", default=False)
        lock_filename = serializers.BooleanField(label="锁定文件名", default=False)
        with_id = serializers.BooleanField(label="带上ID", default=False)

    @classmethod
    def transform_configs(cls, parser, configs: list[dict], with_id: bool, lock_filename: bool):
        for config in configs:
            name = config["name"].replace("/", "-")
            if config["path"]:
                path, filename = os.path.split(config["path"])
```

### 导入配置
导入配置功能将文件中的配置导入到系统中，支持多种格式，如 YAML、JSON 等。常见的导入参数包括：
- **业务ID**：导入配置的业务ID。
- **配置文件**：导入配置的文件路径。
- **是否生成配置文件**：是否生成配置文件。

```python
class ImportConfigResource(Resource):
    class RequestSerializer(BkBizIdSerializer):
        file_path = serializers.CharField(required=True, label="配置文件路径")
        generate = serializers.BooleanField(label="是否生成配置文件", default=False)

    def perform_request(self, params: dict[str, Any]):
        file_path = params["file_path"]
        generate = params.get("generate", False)
        if generate:
            replace_configs = ReplaceConfig.export_data()
            data = {
                "replace_configs": replace_configs,
            }
            with open(file_path, mode="w+") as f:
                yaml.dump(data, f, default_flow_style=False)
            return
        with open(file_path) as f:
            data = yaml.load(f, Loader=yaml.FullLoader)
            replace_configs = data.get("replace_configs", None)
            if replace_configs is not None and isinstance(replace_configs, list):
                ReplaceConfig.import_data(replace_configs)
            refresh_bcs_monitor_info()
```

**Section sources**
- [resources.py](file://bkmonitor/packages/monitor_web/as_code/resources.py#L124-L150)

## 敏感信息加密存储
敏感信息加密存储机制确保配置中的敏感信息（如密码、Token 等）在存储时被加密，防止信息泄露。

### 对称加密
对称加密使用相同的密钥进行加密和解密，常见的算法包括 AES、SM4 等。配置参数包括：
- **密钥**：加密和解密的密钥。
- **初始化向量**：初始化向量，用于增加加密的随机性。
- **模式**：加密模式，如 CBC、CTR 等。

```python
class AESCipher(object):
    def __init__(self, key, iv=None):
        self.bs = 16
        self.iv = iv
        self.key = hashlib.sha256(key.encode("utf-8")).digest()

    def encrypt(self, raw):
        if isinstance(raw, str):
            raw = raw.encode("utf-8")
        raw = self._pad(raw)
        iv = new().read(AES.block_size) if not self.iv else self.iv
        cipher = AES.new(self.key, AES.MODE_CBC, iv)
        result = base64.b64encode(iv + cipher.encrypt(raw))
        return result

    def decrypt(self, enc):
        if isinstance(enc, str):
            enc = enc.encode("utf-8")
        enc = base64.b64decode(enc)
        iv = enc[: AES.block_size] if not self.iv else self.iv
        cipher = AES.new(self.key, AES.MODE_CBC, iv)
        if not self.iv:
            return self._unpad(cipher.decrypt(enc[AES.block_size:])).decode("utf-8")
        else:
            return self._unpad(cipher.decrypt(enc[len(iv):])).decode("utf-8")
```

### 非对称加密
非对称加密使用公钥和私钥进行加密和解密，常见的算法包括 RSA 等。配置参数包括：
- **公钥**：用于加密的公钥。
- **私钥**：用于解密的私钥。

```python
class RSACipher(object):
    def __init__(self, pub_key, pri_key):
        self.pub_key = pub_key
        self.pri_key = pri_key

    def encrypt(self, encrypt_message):
        encrypt_result = b""
        max_length = self.get_max_length(self.pub_key)
        cipher = PKCS1_v1_5.new(self.pub_key)
        while encrypt_message:
            input_data = encrypt_message[:max_length]
            encrypt_message = encrypt_message[max_length:]
            out_data = cipher.encrypt(input_data)
            encrypt_result += out_data
        encrypt_result = base64.b64encode(encrypt_result)
        return encrypt_result

    def decrypt(self, decrypt_message):
        decrypt_result = b""
        max_length = self.get_max_length(self.pri_key, False)
        decrypt_message = base64.b64decode(decrypt_message)
        cipher = PKCS1_v1_5.new(self.pri_key)
        while decrypt_message:
            input_data = decrypt_message[:max_length]
            decrypt_message = decrypt_message[max_length:]
            out_data = cipher.decrypt(input_data, "")
            decrypt_result += out_data
        return decrypt_result
```

**Section sources**
- [cipher.py](file://bkmonitor/bkmonitor/utils/cipher.py#L33-L70)

## 配置版本控制
配置版本控制机制确保配置的变更可以追溯，支持配置的回滚和审计。

### 版本管理
版本管理通过记录每次配置变更的版本号，确保配置的可追溯性。常见的版本管理参数包括：
- **配置版本**：配置的版本号。
- **信息版本**：信息的版本号。
- **发布状态**：配置的发布状态，如 DEBUG、RELEASE 等。

```python
class PluginVersionHistory(models.Model):
    config_version = models.CharField(verbose_name="配置版本", max_length=50)
    info_version = models.CharField(verbose_name="信息版本", max_length=50)
    stage = models.CharField(verbose_name="发布状态", max_length=50, choices=Stage.Choices)
    is_packaged = models.BooleanField(verbose_name="是否打包", default=False)
    version_log = models.TextField(verbose_name="版本日志", default="")
```

### 回滚机制
回滚机制允许用户将配置恢复到之前的版本，确保配置的稳定性。常见的回滚操作包括：
- **获取特定版本**：获取指定版本的配置。
- **回滚版本状态**：将配置回滚到指定版本。

```python
def get_version(self, config_version, info_version):
    return self.versions.get(config_version=config_version, info_version=info_version)

def rollback_version_status(self, config_version):
    version = self.versions.filter(
        config_version=config_version, stage=PluginVersionHistory.Stage.RELEASE, is_packaged=True
    )
    if not version:
        self.versions.filter(config_version=config_version, stage=PluginVersionHistory.Stage.RELEASE).update(
            stage=PluginVersionHistory.Stage.UNREGISTER
        )
```

**Section sources**
- [parse.py](file://bkmonitor/bkmonitor/as_code/parse.py#L188-L227)

## 配置变更生效与热更新
配置变更生效与热更新机制确保配置变更能够立即生效，无需重启服务。

### 配置变更生效
配置变更生效通过监听配置变更事件，确保配置的实时更新。常见的生效机制包括：
- **Consul 配置更新**：通过 Consul 更新配置。
- **Redis 缓存更新**：通过 Redis 更新缓存。

```python
def notify_consul_changed(cls, prefix_path, cluster):
    consul_client = consul.BKConsul(host=cls.host, port=cls.port, scheme=cls.scheme, verify=cls.verify)
    old_value = consul_client.kv.get(prefix_path)[1]
    if old_value is None:
        logger.info("old_value is missing, will refresh consul.")
        return consul_client.kv.put(key=prefix_path, value=json.dumps(cluster), *args, **kwargs)
    old_hash = hashlib.md5(json.dumps(old_value).encode()).hexdigest()
    new_hash = hashlib.md5(json.dumps(cluster).encode()).hexdigest()
    if old_hash != new_hash:
        logger.info("config changed, will refresh consul.")
        return consul_client.kv.put(key=prefix_path, value=json.dumps(cluster), *args, **kwargs)
```

### 热更新
热更新通过实时通知机制，确保配置变更能够立即生效。常见的热更新机制包括：
- **Consul 通知**：通过 Consul 发送通知。
- **Redis Pub/Sub**：通过 Redis 发送通知。

```python
def push_redis_data(is_publish):
    redis_client = RedisTools.get_client()
    if is_publish:
        redis_client.publish(constants.INFLUXDB_KEY_PREFIX, service_name_list)
```

**Section sources**
- [consul_tools.py](file://bkmonitor/metadata/utils/consul_tools.py#L96-L121)

## 配置管理最佳实践
配置管理最佳实践包括敏感信息加密存储、配置版本控制、多环境配置管理等，确保配置的稳定性和安全性。

### 敏感信息加密存储
- **使用对称加密**：使用 AES 等对称加密算法加密敏感信息。
- **使用非对称加密**：使用 RSA 等非对称加密算法加密敏感信息。
- **密钥管理**：妥善管理加密密钥，避免密钥泄露。

### 配置版本控制
- **版本号管理**：为每次配置变更分配唯一的版本号。
- **版本日志**：记录每次配置变更的详细日志。
- **回滚机制**：提供配置回滚功能，确保配置的稳定性。

### 多环境配置管理
- **环境隔离**：为不同环境（如开发、测试、生产）提供独立的配置。
- **配置同步**：定期同步不同环境的配置，确保一致性。
- **配置审计**：记录配置变更的历史，便于审计和追溯。

**Section sources**
- [default.py](file://bkmonitor/config/default.py#L1296-L1326)
- [cipher.py](file://bkmonitor/bkmonitor/utils/cipher.py#L33-L70)
- [resources.py](file://bkmonitor/packages/monitor_web/as_code/resources.py#L124-L150)
- [check_bcs_cluster_status.py](file://bkmonitor/metadata/management/commands/check_bcs_cluster_status.py#L119-L148)
- [parse.py](file://bkmonitor/bkmonitor/as_code/parse.py#L188-L227)
- [consul_tools.py](file://bkmonitor/metadata/utils/consul_tools.py#L96-L121)