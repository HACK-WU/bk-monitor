# 日志数据源

<cite>
**本文档引用的文件**   
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py)
- [storage.py](file://bkmonitor/metadata/models/storage.py)
- [elasticsearch.py](file://bkmonitor/config/tools/elasticsearch.py)
- [elasticsearch.py](file://bkmonitor/constants/elasticsearch.py)
- [connection.py](file://bkmonitor/bkmonitor/data_source/backends/log_search/connection.py)
- [compiler.py](file://bkmonitor/bkmonitor/data_source/backends/log_search/compiler.py)
</cite>

## 目录
1. [简介](#简介)
2. [日志存储系统接入配置](#日志存储系统接入配置)
3. [日志查询DSL语法](#日志查询dsl语法)
4. [索引管理策略与生命周期管理](#索引管理策略与生命周期管理)
5. [日志查询性能优化](#日志查询性能优化)
6. [连接测试与查询调试](#连接测试与查询调试)

## 简介
本文档详细介绍了日志数据源的完整配置与管理，涵盖Elasticsearch等日志存储系统的接入、日志查询DSL语法、索引生命周期管理(ILM)、查询性能优化以及连接测试和查询调试技巧。文档旨在为用户提供全面的技术指导，帮助用户高效地管理和使用日志数据。

## 日志存储系统接入配置

### Elasticsearch接入配置
Elasticsearch的接入配置主要通过环境变量来定义，这些配置包括主机地址、端口、用户名和密码等信息。以下是具体的配置方法：

```python
def get_es7_settings(fta=True) -> Tuple[str, int, int, str, str]:
    if fta:
        host = os.getenv("BKAPP_FTA_ES7_HOST") or os.getenv("BK_FTA_ES7_HOST") or "es7.service.consul"
        rest_port = int(os.getenv("BKAPP_FTA_ES7_REST_PORT") or os.getenv("BK_FTA_ES7_REST_PORT") or "9200")
        transport_port = int(
            os.getenv("BKAPP_FTA_ES7_TRANSPORT_PORT") or os.getenv("BK_FTA_ES7_TRANSPORT_PORT") or "9301"
        )
        user = os.getenv("BKAPP_FTA_ES7_USER") or os.getenv("BK_FTA_ES7_USER") or ""
        password = os.getenv("BKAPP_FTA_ES7_PASSWORD") or os.getenv("BK_FTA_ES7_PASSWORD") or ""
    else:
        host = os.getenv("BK_MONITOR_ES7_HOST", "es7.service.consul")
        rest_port = int(os.getenv("BK_MONITOR_ES7_REST_PORT", "9200"))
        transport_port = int(os.getenv("BK_MONITOR_ES7_TRANSPORT_PORT", "9301"))
        user = os.getenv("BK_MONITOR_ES7_USER", "")
        password = os.getenv("BK_MONITOR_ES7_PASSWORD", "")
    return host, rest_port, transport_port, user, password
```

**配置说明**:
- `host`: Elasticsearch主机地址。
- `rest_port`: REST API端口，默认为9200。
- `transport_port`: Transport端口，默认为9301。
- `user`: 用户名。
- `password`: 密码。

**Section sources**
- [elasticsearch.py](file://bkmonitor/config/tools/elasticsearch.py#L1-L30)

## 日志查询DSL语法

### 查询构建器
日志查询DSL语法的实现主要通过`QueryConfigBuilder`类来完成。该类提供了多种方法来构建查询条件，如`table`、`values`、`filter`、`group_by`、`order_by`等。

```python
class QueryConfigBuilder(CompilerMixin):
    def table(self, table_name: str) -> "QueryConfigBuilder":
        return super().table(table_name)

    def values(self, *fields) -> "QueryConfigBuilder":
        return super().values(*fields)

    def filter(self, *args, **kwargs) -> "QueryConfigBuilder":
        return super().filter(*args, **kwargs)

    def group_by(self, *fields) -> "QueryConfigBuilder":
        return super().group_by(*fields)

    def order_by(self, *fields) -> "QueryConfigBuilder":
        return super().order_by(*fields)

    def time_field(self, field: str) -> "QueryConfigBuilder":
        return super().time_field(field)

    def query_string(self, query_string: str, nested_paths: dict[str, str] | None = None) -> "QueryConfigBuilder":
        return super().dsl_raw_query_string(query_string, nested_paths)
```

**方法说明**:
- `table(table_name)`: 指定查询的表名。
- `values(*fields)`: 指定返回的字段。
- `filter(*args, **kwargs)`: 添加过滤条件。
- `group_by(*fields)`: 按指定字段分组。
- `order_by(*fields)`: 按指定字段排序。
- `time_field(field)`: 指定时间字段。
- `query_string(query_string, nested_paths)`: 使用查询字符串进行全文搜索。

**Section sources**
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py#L124-L161)

### 查询字符串语法
查询字符串语法支持多种操作符，包括逻辑运算符（AND、OR、NOT）、比较运算符（=、!=、>、<、>=、<=）和通配符（*、?）。此外，还支持正则表达式匹配。

```python
class QueryStringOperators:
    EXISTS = "exists"
    NOT_EXISTS = "not_exists"
    EQUAL = "equal"
    NOT_EQUAL = "not_equal"
    INCLUDE = "include"
    NOT_INCLUDE = "not_include"
    GT = "gt"
    LT = "lt"
    GTE = "gte"
    LTE = "lte"
    BETWEEN = "between"
    REG = "reg"
    NREG = "nreg"

    OPERATOR_TEMPLATE_MAPPING = {
        EXISTS: "{field}: *",
        NOT_EXISTS: "NOT {field}: *",
        EQUAL: "{field}: {value}",
        NOT_EQUAL: "NOT {field}: {value}",
        INCLUDE: "{field}: {value}",
        NOT_INCLUDE: "NOT {field}: {value}",
        GT: "{field}: >{value}",
        LT: "{field}: <{value}",
        GTE: "{field}: >={value}",
        LTE: "{field}: <={value}",
        BETWEEN: "{field}: [{start_value} TO {end_value}]",
        REG: "{field}: /{value}/",
        NREG: "NOT {field}: /{value}/",
    }
```

**操作符说明**:
- `EXISTS`: 字段存在。
- `NOT_EXISTS`: 字段不存在。
- `EQUAL`: 字段等于某个值。
- `NOT_EQUAL`: 字段不等于某个值。
- `INCLUDE`: 字段包含某个值。
- `NOT_INCLUDE`: 字段不包含某个值。
- `GT`: 字段大于某个值。
- `LT`: 字段小于某个值。
- `GTE`: 字段大于等于某个值。
- `LTE`: 字段小于等于某个值。
- `BETWEEN`: 字段在某个范围内。
- `REG`: 字段匹配正则表达式。
- `NREG`: 字段不匹配正则表达式。

**Section sources**
- [elasticsearch.py](file://bkmonitor/constants/elasticsearch.py#L0-L75)

## 索引管理策略与生命周期管理

### 索引配置
索引配置主要包括索引设置、映射设置、存储集群ID、数据源类型、索引集等。这些配置可以通过`ESStorage`类来管理。

```python
class ESStorage(models.Model):
    index_settings = models.TextField("索引配置信息", blank=True, null=True)
    mapping_settings = models.TextField("别名配置信息", blank=True, null=True)
    storage_cluster_id = models.IntegerField("存储集群")
    source_type = models.CharField(
        "数据源类型", max_length=16, default="log", help_text="数据源类型，仅对日志内置集群索引进行生命周期管理"
    )
    index_set = models.TextField("索引集", blank=True, null=True)
    need_create_index = models.BooleanField("是否需要创建索引", default=True)
    archive_index_days = models.IntegerField("索引归档天数", null=True, default=0)

    class Meta:
        unique_together = ("table_id", "bk_tenant_id")

    @classmethod
    def create_table(
        cls,
        table_id,
        bk_tenant_id=DEFAULT_TENANT_ID,
        is_sync_db=True,
        date_format="%Y%m%d%H",
        slice_size=500,
        slice_gap=120,
        index_settings=None,
        mapping_settings=None,
        cluster_id=None,
        retention=30,
        warm_phase_days=0,
        warm_phase_settings=None,
        time_zone=0,
        enable_create_index=True,
        source_type=constants.EsSourceType.LOG.value,
        index_set=None,
        need_create_index=True,
        origin_table_id=None,
        **kwargs,
    ):
        # 参数校验和创建逻辑
        pass
```

**配置说明**:
- `index_settings`: 索引配置信息，JSON格式。
- `mapping_settings`: 映射配置信息，JSON格式。
- `storage_cluster_id`: 存储集群ID。
- `source_type`: 数据源类型，仅对日志内置集群索引进行生命周期管理。
- `index_set`: 索引集。
- `need_create_index`: 是否需要创建索引。
- `archive_index_days`: 索引归档天数。

**Section sources**
- [storage.py](file://bkmonitor/metadata/models/storage.py#L1942-L2141)

### 生命周期管理
索引生命周期管理(ILM)通过`warm_phase_days`和`warm_phase_settings`参数来配置。`warm_phase_days`表示暖数据阶段的等待天数，`warm_phase_settings`包含具体的分配配置。

```python
if warm_phase_days > 0:
    if not warm_phase_settings:
        logger.error(f"result_table->[{table_id}] warm_phase_settings is empty, but min_days > 0.")
        raise ValueError(_("warm_phase_settings 不能为空"))
    for required_field in ["allocation_attr_name", "allocation_attr_value", "allocation_type"]:
        if not warm_phase_settings.get(required_field):
            raise ValueError(_("warm_phase_settings.{} 不能为空").format(required_field))
```

**配置说明**:
- `warm_phase_days`: 暖数据阶段的等待天数。
- `warm_phase_settings`: 暖数据切换配置，包含`allocation_attr_name`、`allocation_attr_value`和`allocation_type`三个必填字段。

**Section sources**
- [storage.py](file://bkmonitor/metadata/models/storage.py#L1942-L2141)

## 日志查询性能优化

### 分片策略
合理的分片策略可以显著提升查询性能。建议根据数据量和查询频率来调整分片数量。通常情况下，每个分片的大小应控制在50GB左右。

### 缓存配置
启用缓存可以减少重复查询的开销。可以通过配置`index_settings`中的`cache`参数来启用缓存。

```python
index_settings = {
    "cache": {
        "query": {
            "enabled": True
        },
        "request": {
            "enabled": True
        }
    }
}
```

**配置说明**:
- `cache.query.enabled`: 启用查询缓存。
- `cache.request.enabled`: 启用请求缓存。

**Section sources**
- [storage.py](file://bkmonitor/metadata/models/storage.py#L1942-L2141)

## 连接测试与查询调试

### 连接测试
在配置完成后，可以通过简单的查询来测试连接是否正常。例如，使用`QueryHelper`类执行一个基本的查询：

```python
from bkmonitor.bkmonitor.data_source.unify_query.builder import QueryHelper

query_body = {
    "bk_biz_id": 1,
    "query_configs": [
        {
            "data_type_label": "log",
            "data_source_label": "bk_log_search",
            "table": "2_bklog_test",
            "query_string": "log:system",
            "start_time": "2023-01-01T00:00:00Z",
            "end_time": "2023-01-01T01:00:00Z",
            "limit": 100,
            "offset": 0
        }
    ]
}

result = QueryHelper.query("2_bklog_test", query_body)
print(result)
```

### 查询调试
在调试查询时，可以查看生成的SQL语句和参数，以确保查询条件正确无误。

```python
_, params = qs.query.sql_with_params()
print(params)
```

**调试技巧**:
- 查看生成的SQL语句和参数。
- 使用日志记录查询过程中的关键信息。
- 逐步增加查询条件，确保每一步都正确。

**Section sources**
- [builder.py](file://bkmonitor/bkmonitor/data_source/unify_query/builder.py#L124-L161)
- [connection.py](file://bkmonitor/bkmonitor/data_source/backends/log_search/connection.py#L32-L45)
- [compiler.py](file://bkmonitor/bkmonitor/data_source/backends/log_search/compiler.py#L28-L70)