# 删除与禁用屏蔽规则

<cite>
**本文档引用的文件**   
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)
- [shield.py](file://bkmonitor/bkmonitor/models/base.py#L780-L979)
- [shield.yaml](file://bkmonitor/support-files/apigw/resources/external/app/shield.yaml#L0-L91)
- [frontend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/frontend_resources.py#L120-L319)
- [shield.py](file://bkmonitor/constants/shield.py#L30-L73)
</cite>

## 目录
1. [引言](#引言)
2. [API端点与操作类型](#api端点与操作类型)
3. [禁用操作实现](#禁用操作实现)
4. [数据模型与状态管理](#数据模型与状态管理)
5. [权限与安全验证](#权限与安全验证)
6. [响应示例](#响应示例)
7. [审计日志与通知](#审计日志与通知)

## 引言
本文档详细说明了屏蔽规则的删除与禁用操作。系统通过"禁用"操作实现软删除，保留数据但使其失效，而非物理删除。文档涵盖RESTful API端点、权限要求、状态转换、数据清理策略及审计机制，为用户提供完整的操作指南。

## API端点与操作类型

```mermaid
graph TB
A[屏蔽规则操作] --> B[禁用操作]
A --> C[查询操作]
B --> D[/app/shield/disable/]
C --> E[/app/shield/detail/]
C --> F[/app/shield/search/]
D --> G[POST请求]
E --> H[GET请求]
F --> I[POST请求]
```

**图示来源**
- [shield.yaml](file://bkmonitor/support-files/apigw/resources/external/app/shield.yaml#L0-L91)

**本节来源**
- [shield.yaml](file://bkmonitor/support-files/apigw/resources/external/app/shield.yaml#L0-L91)

## 禁用操作实现

```mermaid
sequenceDiagram
participant 客户端
participant API网关
participant DisableShieldResource
participant 数据库
客户端->>API网关 : POST /app/shield/disable/
API网关->>DisableShieldResource : 转发请求
DisableShieldResource->>DisableShieldResource : 验证用户权限
DisableShieldResource->>数据库 : 查询屏蔽记录
数据库-->>DisableShieldResource : 返回记录
DisableShieldResource->>DisableShieldResource : 更新is_enabled字段
DisableShieldResource->>DisableShieldResource : 设置failure_time
DisableShieldResource->>数据库 : 批量更新
数据库-->>DisableShieldResource : 更新成功
DisableShieldResource-->>API网关 : 返回"success"
API网关-->>客户端 : 返回成功响应
```

**图示来源**
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)

**本节来源**
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)

## 数据模型与状态管理

```mermaid
classDiagram
class Shield {
+int bk_biz_id
+string category
+string scope_type
+datetime begin_time
+datetime end_time
+datetime failure_time
+JsonField dimension_config
+JsonField cycle_config
+bool is_enabled
+int status
}
class ShieldStatus {
+int SHIELDED = 1
+int EXPIRED = 2
+int REMOVED = 3
}
Shield --> ShieldStatus : "状态映射"
```

**图示来源**
- [shield.py](file://bkmonitor/bkmonitor/models/base.py#L780-L979)
- [shield.py](file://bkmonitor/constants/shield.py#L30-L73)

**本节来源**
- [shield.py](file://bkmonitor/bkmonitor/models/base.py#L780-L979)
- [shield.py](file://bkmonitor/constants/shield.py#L30-L73)

## 权限与安全验证

```mermaid
flowchart TD
Start([开始]) --> CheckAuth["检查用户权限"]
CheckAuth --> AuthValid{"权限有效?"}
AuthValid --> |否| ReturnError["返回权限错误"]
AuthValid --> |是| FindShields["查询屏蔽记录"]
FindShields --> ShieldsExist{"记录存在?"}
ShieldsExist --> |否| LogWarning["记录不存在警告"]
ShieldsExist --> |是| UpdateStatus["更新状态"]
UpdateStatus --> SetDisabled["设置is_enabled=False"]
SetDisabled --> SetFailureTime["设置failure_time=now()"]
SetFailureTime --> BulkUpdate["批量更新数据库"]
BulkUpdate --> End([结束])
ReturnError --> End
```

**图示来源**
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)

**本节来源**
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)

## 响应示例

### 成功响应
```json
{
    "result": true,
    "code": 200,
    "message": "OK",
    "data": "success"
}
```

### 失败响应
```json
{
    "result": false,
    "code": 403,
    "message": "当前用户无权限解除2业务屏蔽配置",
    "data": null
}
```

**本节来源**
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)

## 审计日志与通知

```mermaid
graph TD
A[禁用操作] --> B[记录操作人]
A --> C[记录操作时间]
A --> D[更新update_user字段]
A --> E[设置failure_time]
B --> F[数据库审计日志]
C --> F
D --> F
E --> F
F --> G[系统审计追踪]
G --> H[操作历史查询]
```

**图示来源**
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)

**本节来源**
- [backend_resources.py](file://bkmonitor/packages/monitor_web/shield/resources/backend_resources.py#L530-L611)