# 策略权限控制

<cite>
**本文档引用的文件**   
- [action.py](file://bkmonitor\bkmonitor\iam\action.py)
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py)
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)
- [constants.py](file://bkmonitor\constants\strategy.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档详细阐述了蓝鲸监控平台中策略权限控制的实现机制。重点介绍基于IAM（身份与访问管理）的权限模型，涵盖策略操作的权限管理体系，包括创建、修改、启用、停用、删除等操作的权限控制机制。文档详细说明了权限模型的定义、权限验证的实现流程以及权限异常的处理方式，并提供权限配置的最佳实践。

## 项目结构
蓝鲸监控平台的项目结构清晰，核心功能模块位于`bkmonitor/bkmonitor`目录下。与策略权限控制直接相关的模块主要分布在`iam`和`strategy`子目录中。

```mermaid
graph TD
subgraph "核心模块"
IAM["iam<br/>权限管理"]
Strategy["strategy<br/>策略管理"]
Models["models<br/>数据模型"]
end
subgraph "IAM模块"
Action["action.py<br/>权限操作定义"]
Permission["permission.py<br/>权限验证"]
Resource["resource.py<br/>资源定义"]
end
subgraph "策略模块"
StrategyCore["strategy.py<br/>策略核心逻辑"]
Serializers["serializers.py<br/>序列化"]
end
IAM --> Action
IAM --> Permission
IAM --> Resource
Strategy --> StrategyCore
Strategy --> Serializers
```

**图示来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py)
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py)
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)

**本节来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py)
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py)

## 核心组件
策略权限控制的核心组件包括权限操作定义、资源实例定义和权限验证服务。这些组件共同构成了基于IAM的权限管理体系。

**本节来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py#L0-L199)
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py#L0-L200)
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py#L0-L200)

## 架构概述
策略权限控制采用分层架构，由权限定义层、权限验证层和业务逻辑层组成。权限定义层负责定义操作和资源，权限验证层提供统一的鉴权接口，业务逻辑层在执行策略操作前调用鉴权服务。

```mermaid
graph TD
A["业务逻辑层<br/>策略创建/修改/启停"]
B["权限验证层<br/>Permission类"]
C["权限定义层<br/>Action & Resource"]
D["IAM服务<br/>外部权限中心"]
A --> |调用| B
B --> |查询| C
B --> |请求| D
C --> |提供| B
D --> |返回| B
B --> |结果| A
style A fill:#f9f,stroke:#333
style B fill:#bbf,stroke:#333
style C fill:#f96,stroke:#333
style D fill:#9f9,stroke:#333
```

**图示来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py)
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py)
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)

## 详细组件分析

### 权限操作定义分析
权限操作定义模块（`action.py`）通过`ActionMeta`类和`ActionEnum`枚举类来定义系统中的所有权限操作。

#### 权限操作类图
```mermaid
classDiagram
class ActionMeta {
+id : string
+name : string
+name_en : string
+type : string
+version : int
+related_resource_types : list
+related_actions : list
+description : string
+description_en : string
+to_json() dict
+is_read_action() bool
}
class ActionEnum {
+VIEW_BUSINESS : ActionMeta
+MANAGE_RULE : ActionMeta
+VIEW_RULE : ActionMeta
+MANAGE_COLLECTION : ActionMeta
+VIEW_COLLECTION : ActionMeta
+MANAGE_DOWNTIME : ActionMeta
+VIEW_DOWNTIME : ActionMeta
+MANAGE_NOTIFY_TEAM : ActionMeta
+VIEW_NOTIFY_TEAM : ActionMeta
+MANAGE_CUSTOM_METRIC : ActionMeta
+VIEW_CUSTOM_METRIC : ActionMeta
+MANAGE_CUSTOM_EVENT : ActionMeta
+VIEW_CUSTOM_EVENT : ActionMeta
+MANAGE_DASHBOARD : ActionMeta
+VIEW_DASHBOARD : ActionMeta
+MANAGE_APM_APPLICATION : ActionMeta
+VIEW_APM_APPLICATION : ActionMeta
+MANAGE_INCIDENT : ActionMeta
+VIEW_INCIDENT : ActionMeta
}
ActionEnum --> ActionMeta : "包含"
```

**图示来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py#L0-L621)

**本节来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py#L0-L621)

### 权限验证流程分析
权限验证流程由`Permission`类实现，提供统一的鉴权接口。验证流程包括初始化、权限检查、申请URL生成等步骤。

#### 权限验证序列图
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Business as "业务逻辑"
participant Permission as "Permission类"
participant IAM as "IAM服务"
Client->>Business : 请求策略操作
Business->>Permission : is_allowed(action, resources)
Permission->>Permission : 检查skip_check标志
alt 跳过检查
Permission-->>Business : 返回true
else 需要检查
Permission->>IAM : make_request()
IAM-->>Permission : 返回Request对象
Permission->>IAM : is_allowed(request)
IAM-->>Permission : 返回鉴权结果
alt 鉴权失败
Permission->>Permission : get_apply_data()
Permission->>Permission : get_apply_url()
Permission-->>Business : 抛出PermissionDeniedError
else 鉴权成功
Permission-->>Business : 返回true
end
end
Business-->>Client : 返回操作结果
```

**图示来源**
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py#L0-L517)

**本节来源**
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py#L0-L517)

### 资源实例定义分析
资源实例定义模块（`resource.py`）负责定义系统中的各种资源类型，如业务、APM应用、仪表盘等。

#### 资源定义类图
```mermaid
classDiagram
class ResourceMeta {
+id : string
+system_id : string
+name : string
+name_en : string
+selection_mode : string
+related_instance_selections : list
+create_instance(instance_id) Resource
+create_simple_instance(instance_id) Resource
}
class ResourceEnum {
+BUSINESS : ResourceMeta
+APM_APPLICATION : ResourceMeta
+GRAFANA_DASHBOARD : ResourceMeta
}
ResourceEnum --> ResourceMeta : "包含"
```

**图示来源**
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)

**本节来源**
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)

## 依赖分析
策略权限控制模块依赖于多个核心组件，形成清晰的依赖关系。

```mermaid
graph TD
A["策略操作<br/>创建/修改/启停"] --> B["权限验证<br/>Permission"]
B --> C["权限定义<br/>ActionEnum"]
B --> D["资源定义<br/>ResourceEnum"]
C --> E["IAM客户端<br/>CompatibleIAM"]
D --> E
B --> F["空间服务<br/>SpaceApi"]
B --> G["用户服务<br/>get_local_username"]
H["API令牌<br/>ApiAuthToken"] --> B
style A fill:#f9f,stroke:#333
style B fill:#bbf,stroke:#333
style C fill:#f96,stroke:#333
style D fill:#f96,stroke:#333
style E fill:#9f9,stroke:#333
style F fill:#9f9,stroke:#333
style G fill:#9f9,stroke:#333
style H fill:#9f9,stroke:#333
```

**图示来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py)
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py)
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)

**本节来源**
- [action.py](file://bkmonitor\bkmonitor\iam\action.py)
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py)
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)

## 性能考虑
权限验证系统在设计时考虑了性能优化，主要体现在以下几个方面：
1. **缓存机制**：对读权限操作使用缓存，减少对IAM服务的频繁调用。
2. **批量操作**：提供批量鉴权接口`batch_is_allowed`，减少网络请求次数。
3. **本地跳过检查**：在特定环境下（如后台任务）可配置跳过权限检查，提升性能。
4. **资源预加载**：通过`setup_meta`方法预加载权限元数据，避免重复初始化。

## 故障排除指南
当遇到权限相关问题时，可参考以下排查步骤：

**本节来源**
- [permission.py](file://bkmonitor\bkmonitor\iam\permission.py#L200-L400)
- [action.py](file://bkmonitor\bkmonitor\iam\action.py#L400-L621)

## 结论
蓝鲸监控平台的策略权限控制系统基于IAM实现了细粒度的权限管理。系统通过清晰的权限操作定义、资源实例定义和统一的权限验证服务，为策略的创建、修改、启用、停用、删除等操作提供了安全可靠的权限控制机制。该系统具有良好的扩展性和可维护性，能够满足复杂场景下的权限管理需求。