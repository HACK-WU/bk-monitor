# 策略生命周期管理

<cite>
**本文档引用文件**  
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py)
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py)
- [resource.py](file://bkmonitor\bkmonitor\iam\resource.py)
- [serializers.py](file://bkmonitor\bkmonitor\strategy\serializers.py)
- [strategy_v3.py](file://bkmonitor\kernel_api\views\v4\strategy_v3.py)
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py)
- [strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档旨在全面阐述蓝鲸监控平台中策略的全生命周期管理机制。涵盖策略的创建、修改、启用、停用、删除等操作，以及版本控制、迁移、权限管理等高级功能。通过深入分析代码结构和实现逻辑，为开发者和运维人员提供详尽的技术参考。

## 项目结构
蓝鲸监控平台的项目结构清晰，采用模块化设计。策略管理功能主要集中在`bkmonitor`模块下的`strategy`子模块中，相关文件包括模型定义、序列化器、视图、权限控制等。

```mermaid
graph TD
bkmonitor[bkmonitor]
strategy[strategy]
models[models]
serializers[serializers]
views[views]
iam[iam]
migrate[migrate.py]
convert[convert.py]
strategy_py[strategy.py]
new_strategy[new_strategy.py]
bkmonitor --> strategy
bkmonitor --> models
bkmonitor --> serializers
bkmonitor --> views
bkmonitor --> iam
strategy --> migrate
strategy --> convert
strategy --> strategy_py
strategy --> new_strategy
models --> strategy_model[strategy.py]
serializers --> strategy_serializers[strategy.py]
views --> strategy_views[strategy_v3.py]
iam --> resource[resource.py]
```

**图示来源**
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py)
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py)
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py)
- [models/strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [serializers/strategy.py](file://bkmonitor\bkmonitor\strategy\serializers.py)
- [views/strategy_v3.py](file://bkmonitor\kernel_api\views\v4\strategy_v3.py)
- [iam/resource.py](file://bkmonitor\bkmonitor\iam\resource.py)

## 核心组件

策略生命周期管理的核心组件包括策略模型、序列化器、视图、权限管理器和迁移工具。这些组件协同工作，实现了策略的完整生命周期管理。

**组件来源**
- [models/strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [serializers/strategy.py](file://bkmonitor\bkmonitor\strategy\serializers.py)
- [views/strategy_v3.py](file://bkmonitor\kernel_api\views\v4\strategy_v3.py)
- [iam/resource.py](file://bkmonitor\bkmonitor\iam\resource.py)

## 架构概述

策略管理系统的架构分为数据层、服务层和接口层。数据层由Django模型构成，服务层封装了业务逻辑，接口层提供RESTful API。

```mermaid
graph TD
A[客户端] --> B[API接口层]
B --> C[服务层]
C --> D[数据层]
D --> E[数据库]
B -.-> F[权限控制]
C -.-> G[版本管理]
C -.-> H[迁移工具]
style A fill:#f9f,stroke:#333
style E fill:#bbf,stroke:#333
```

**图示来源**
- [views/strategy_v3.py](file://bkmonitor\kernel_api\views\v4\strategy_v3.py)
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py)
- [models/strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)

## 详细组件分析

### 策略模型分析

策略模型定义了策略的核心数据结构，包括策略、监控项、检测算法等。

```mermaid
classDiagram
class StrategyModel {
+int id
+str name
+int bk_biz_id
+str scenario
+bool is_enabled
+datetime create_time
+datetime update_time
}
class ItemModel {
+int id
+int strategy_id
+str name
+str expression
+JSONField no_data_config
+JSONField target
}
class DetectModel {
+int id
+int strategy_id
+int level
+str expression
+JSONField trigger_config
+JSONField recovery_config
}
class AlgorithmModel {
+int id
+int strategy_id
+int item_id
+int level
+str type
+str unit_prefix
+JSONField config
}
class QueryConfigModel {
+int id
+int item_id
+str data_source_label
+str data_type_label
+str result_table_id
+str metric_field
+str agg_method
+int agg_interval
+JSONField agg_dimension
+JSONField agg_condition
}
StrategyModel "1" *-- "0..*" ItemModel
ItemModel "1" *-- "0..*" DetectModel
ItemModel "1" *-- "0..*" AlgorithmModel
ItemModel "1" *-- "0..*" QueryConfigModel
```

**图示来源**
- [models/strategy.py](file://bkmonitor\bkmonitor\models\strategy.py#L0-L200)

**组件来源**
- [models/strategy.py](file://bkmonitor\bkmonitor\models\strategy.py#L0-L200)

### API接口分析

策略API接口提供了策略的增删改查和状态切换功能。

```mermaid
sequenceDiagram
participant Client
participant ViewSet
participant Resource
participant Service
Client->>ViewSet : POST /strategy/save
ViewSet->>Resource : save_strategy_v2()
Resource->>Service : Strategy.save()
Service-->>Resource : 策略ID
Resource-->>ViewSet : 成功响应
ViewSet-->>Client : 返回结果
Client->>ViewSet : POST /strategy/delete
ViewSet->>Resource : delete_strategy_config()
Resource->>Service : Strategy.delete()
Service-->>Resource : 删除结果
Resource-->>ViewSet : 成功响应
ViewSet-->>Client : 返回结果
Client->>ViewSet : POST /strategy/switch
ViewSet->>Resource : bulk_switch_strategy()
Resource->>Service : Strategy.switch()
Service-->>Resource : 切换结果
Resource-->>ViewSet : 成功响应
ViewSet-->>Client : 返回结果
```

**图示来源**
- [views/strategy_v3.py](file://bkmonitor\kernel_api\views\v4\strategy_v3.py#L0-L104)
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py#L0-L300)

**组件来源**
- [views/strategy_v3.py](file://bkmonitor\kernel_api\views\v4\strategy_v3.py#L0-L104)

### 策略版本管理

策略版本管理通过`StrategyHistoryModel`实现，每次策略变更都会创建历史记录。

```mermaid
flowchart TD
Start([策略变更]) --> Validate["验证策略配置"]
Validate --> IsValid{"配置有效?"}
IsValid --> |否| ReturnError["返回错误"]
IsValid --> |是| CreateHistory["创建历史记录"]
CreateHistory --> SaveConfig["保存新配置"]
SaveConfig --> UpdateHash["更新哈希值"]
UpdateHash --> End([完成])
ReturnError --> End
```

**图示来源**
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py#L0-L300)

**组件来源**
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py#L0-L300)

### 策略迁移功能

策略迁移功能支持策略在不同环境间的导入导出。

```mermaid
flowchart TD
Export([导出策略]) --> Serialize["序列化策略配置"]
Serialize --> Encrypt["加密敏感信息"]
Encrypt --> Compress["压缩为文件"]
Compress --> SaveFile["保存为JSON文件"]
Import([导入策略]) --> ReadFile["读取JSON文件"]
ReadFile --> Decrypt["解密敏感信息"]
Decrypt --> Validate["验证配置"]
Validate --> ImportToDB["导入数据库"]
ImportToDB --> End([完成])
```

**图示来源**
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py#L0-L200)
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py#L0-L126)

**组件来源**
- [convert.py](file://bkmonitor\bkmonitor\strategy\convert.py#L0-L200)
- [migrate.py](file://bkmonitor\bkmonitor\strategy\migrate.py#L0-L126)

### 权限管理分析

权限管理通过IAM系统实现，定义了策略相关的资源类型和操作权限。

```mermaid
classDiagram
class ResourceMeta {
+str system_id
+str id
+str name
+str selection_mode
+list related_instance_selections
+create_simple_instance(instance_id, attribute)
+create_instance(instance_id, attribute)
}
class Business {
+create_simple_instance(instance_id, attribute)
+create_instance(instance_id, attribute)
}
class ApmApplication {
+create_instance_by_info(item)
+create_simple_instance(instance_id, attribute)
}
class GrafanaDashboard {
+create_simple_instance(instance_id, attribute)
}
class ResourceEnum {
+BUSINESS
+APM_APPLICATION
+GRAFANA_DASHBOARD
}
ResourceMeta <|-- Business
ResourceMeta <|-- ApmApplication
ResourceMeta <|-- GrafanaDashboard
```

**图示来源**
- [iam/resource.py](file://bkmonitor\bkmonitor\iam\resource.py#L0-L200)

**组件来源**
- [iam/resource.py](file://bkmonitor\bkmonitor\iam\resource.py#L0-L200)

## 依赖分析

策略管理模块依赖于多个核心组件，包括数据源、告警处理、权限控制等。

```mermaid
graph TD
Strategy[策略管理] --> DataSource[数据源]
Strategy --> Alert[告警处理]
Strategy --> IAM[权限控制]
Strategy --> Cache[缓存]
Strategy --> DB[数据库]
DataSource --> BKMonitor[BKMonitor]
DataSource --> Prometheus[Prometheus]
DataSource --> Custom[自定义]
Alert --> Action[动作]
Alert --> Notice[通知]
IAM --> BKIAM[蓝鲸IAM]
Cache --> Redis[Redis]
DB --> MySQL[MySQL]
```

**图示来源**
- [models/strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [serializers/strategy.py](file://bkmonitor\bkmonitor\strategy\serializers.py)
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py)

**组件来源**
- [models/strategy.py](file://bkmonitor\bkmonitor\models\strategy.py)
- [serializers/strategy.py](file://bkmonitor\bkmonitor\strategy\serializers.py)
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py)

## 性能考虑

策略管理系统的性能主要受数据库查询和序列化操作影响。建议采用以下优化措施：

1. 使用分页查询避免全量拉取
2. 合理使用缓存减少数据库访问
3. 批量操作减少网络往返
4. 优化查询条件避免全表扫描

## 故障排除指南

### 常见问题

1. **策略无法启用**：检查策略配置是否完整，权限是否足够
2. **导入失败**：检查文件格式是否正确，敏感信息是否已解密
3. **性能下降**：检查是否有大量策略同时触发，数据库连接是否正常

### 调试方法

1. 查看系统日志定位错误
2. 使用调试工具逐步执行
3. 检查数据库状态和索引

**组件来源**
- [new_strategy.py](file://bkmonitor\bkmonitor\strategy\new_strategy.py)
- [strategy.py](file://bkmonitor\bkmonitor\strategy\strategy.py)

## 结论

本文档详细介绍了蓝鲸监控平台中策略生命周期管理的各个方面。通过深入分析代码结构和实现逻辑，为开发者提供了全面的技术参考。策略管理功能完善，支持完整的生命周期操作、版本控制、迁移和权限管理，能够满足复杂的监控需求。