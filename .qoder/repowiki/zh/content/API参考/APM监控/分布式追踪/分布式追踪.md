# Distributed Tracing

<cite>
**Referenced Files in This Document**   
- [bkmonitor\apm\core\handlers\query\trace_query.py](file://bkmonitor\apm\core\handlers\query\trace_query.py) - *Updated in commit da50b62f5d326419dd5e3e76127b621fbabd270d*
- [bkmonitor\apm\core\handlers\query\base.py](file://bkmonitor\apm\core\handlers\query\base.py) - *Base class for query handling, updated in recent commit*
- [bkmonitor\packages\monitor_web\overview\search.py](file://bkmonitor\packages\monitor_web\overview\search.py) - *Overview search integration with trace queries*
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py)
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py)
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py)
- [bkmonitor\packages\apm_web\trace\constants.py](file://bkmonitor\packages\apm_web\trace\constants.py)
- [bkmonitor\packages\apm_web\trace\serializers.py](file://bkmonitor\packages\apm_web\trace\serializers.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\base.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\base.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\query.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\query.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py)
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py)
</cite>

## Update Summary
**Changes Made**   
- Updated **Architecture Overview** section to reflect recent optimizations in Span list retrieval
- Added **Performance Optimization** section detailing query handling improvements
- Enhanced **Detailed Component Analysis** with updated query flow information
- Updated **Dependency Analysis** to include new query handling components
- Revised **Fault Troubleshooting Guide** with performance-related issues
- All file references updated to reflect actual source locations and changes

## Table of Contents
1. [Introduction](#introduction)
2. [Project Structure](#project-structure)
3. [Core Components](#core-components)
4. [Architecture Overview](#architecture-overview)
5. [Detailed Component Analysis](#detailed-component-analysis)
6. [Dependency Analysis](#dependency-analysis)
7. [Performance Considerations](#performance-considerations)
8. [Fault Troubleshooting Guide](#fault-troubleshooting-guide)
9. [Conclusion](#conclusion)

## Introduction
This document provides a comprehensive overview of the distributed tracing functionality in the BlueKing monitoring platform, detailing the mechanisms for generating, storing, and analyzing call chains. The document covers the implementation principles of distributed tracing, including the generation and propagation of TraceID and SpanID, context propagation across service calls, and handling of asynchronous call tracing. It also explains the call chain data model, describing the definitions and attributes of core concepts such as Span, Trace, and Annotation, and introduces visualization methods for call chains, including timeline views, dependency graphs, and bottleneck analysis. Additionally, the document outlines sampling strategies and storage optimization methods for trace data, provides best practices for configuring distributed tracing, and includes usage examples and solutions to common problems to help users effectively utilize tracing functionality for performance issue diagnosis and optimization.

## Project Structure
The distributed tracing functionality is primarily located in the `bkmonitor/packages/apm_web/trace` directory, which contains the core modules and tools required for implementing distributed tracing. The main subdirectories and files include:
- `diagram`: Contains logic for generating various visualizations such as service topology graphs, flame graphs, sequence diagrams, and statistical charts.
- `constants.py`: Defines core constants and configuration options used in the distributed tracing functionality.
- `serializers.py`: Defines serializers for data serialization and validation.
- `handlers/trace_handler`: Contains core logic for processing trace data, including base processing, query handling, view configuration, and statistical processing.

``mermaid
graph TD
subgraph "Distributed Tracing Module"
diagram[diagram]
constants[constants.py]
serializers[serializers.py]
handlers[handlers/trace_handler]
end
diagram --> service_topo[service_topo.py]
diagram --> flamegraph[flamegraph.py]
diagram --> sequence[sequence.py]
diagram --> statistics[statistics.py]
handlers --> base[base.py]
handlers --> query[query.py]
handlers --> view_config[view_config.py]
```

**Diagram sources**
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py)
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py)
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py)
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\base.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\base.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\query.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\query.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py)

**Section sources**
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py)
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py)
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py)
- [bkmonitor\packages\apm_web\trace\constants.py](file://bkmonitor\packages\apm_web\trace\constants.py)
- [bkmonitor\packages\apm_web\trace\serializers.py](file://bkmonitor\packages\apm_web\trace\serializers.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\base.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\base.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\query.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\query.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py)

## Core Components
The core components of the distributed tracing functionality include service topology discovery, flame graph generation, sequence diagram generation, and statistical chart generation. These components work together to provide comprehensive call chain visualization and analysis capabilities.

**Section sources**
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py)
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py)
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py)
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py)

## Architecture Overview
The architecture of the distributed tracing functionality primarily consists of four parts: data collection, data processing, data storage, and data presentation. The data collection module is responsible for gathering trace data from various services, the data processing module handles cleaning, transforming, and aggregating the collected data, the data storage module stores the processed data in Elasticsearch, and the data presentation module displays the stored data to users in various visual formats.

``mermaid
graph TD
subgraph "Data Collection"
services[Services]
opentelemetry[OpenTelemetry SDK]
end
subgraph "Data Processing"
trace_handler[trace_handler]
base[base.py]
query[query.py]
view_config[view_config.py]
end
subgraph "Data Storage"
elasticsearch[Elasticsearch]
end
subgraph "Data Presentation"
diagram[diagram]
service_topo[Service Topology]
flamegraph[Flame Graph]
sequence[Sequence Diagram]
statistics[Statistical Chart]
end
services --> opentelemetry --> trace_handler --> elasticsearch --> diagram
```

**Diagram sources**
- [bkmonitor\packages\apm_web\handlers\trace_handler\base.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\base.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\query.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\query.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py)
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py)
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py)
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py)
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py)

## Detailed Component Analysis

### Service Topology Analysis
The service topology component is responsible for generating call relationship diagrams between services, helping users intuitively understand the system's call chains.

#### Service Topology Discovery Rules
Service topology discovery rules define how to extract node information for services, components, and interfaces from trace data. The rules are defined through the `RULE_INSTANCES` list, with each rule containing a predicate key, node type, category ID, and instance key.

``mermaid
classDiagram
class ServiceTopoDiscoverRuleCls {
+string category_id
+string node_type
+tuple predicate_key
+list instance_keys
}
class NodeType {
+string COMPONENT
+string SERVICE
+string INTERFACE
}
ServiceTopoDiscoverRuleCls --> NodeType : "node_type"
```

**Diagram sources**
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py#L20-L50)

**Section sources**
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py#L20-L50)

### Flame Graph Analysis
The flame graph component is responsible for generating flame graphs of call stacks, helping users analyze performance bottlenecks.

#### Flame Graph Generation Process
The flame graph generation process includes converting trace data into a tree structure, handling parallel calls, and generating the final flame graph data.

``mermaid
sequenceDiagram
participant Client as "Client"
participant FlamegraphDiagrammer as "FlamegraphDiagrammer"
participant TraceTree as "TraceTree"
participant Element as "Element"
Client->>FlamegraphDiagrammer : draw(trace_detail)
FlamegraphDiagrammer->>TraceTree : from_raw(trace_detail)
TraceTree-->>FlamegraphDiagrammer : trace_tree
FlamegraphDiagrammer->>Element : drain_parallel_from_span_node(root)
Element-->>FlamegraphDiagrammer : element
FlamegraphDiagrammer-->>Client : flamegraph_data
```

**Diagram sources**
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py#L20-L50)

**Section sources**
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py#L20-L50)

### Sequence Diagram Analysis
The sequence diagram component is responsible for generating call sequence diagrams, helping users understand the temporal order and participants of calls.

#### Sequence Diagram Generation Process
The sequence diagram generation process includes extracting participants from trace data, generating a participant list, and creating sequence diagram data.

``mermaid
flowchart TD
Start([Start]) --> ExtractParticipants["Extract Participants"]
ExtractParticipants --> GenerateParticipantList["Generate Participant List"]
GenerateParticipantList --> GenerateSequenceData["Generate Sequence Diagram Data"]
GenerateSequenceData --> End([End])
```

**Diagram sources**
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py#L20-L50)

**Section sources**
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py#L20-L50)

### Statistical Chart Analysis
The statistical chart component is responsible for generating call statistics charts, helping users understand call distribution and trends.

#### Statistical Chart Generation Process
The statistical chart generation process includes extracting statistical information from trace data, calculating statistical values, and generating statistical chart data.

``mermaid
flowchart TD
Start([Start]) --> ExtractStatistics["Extract Statistics"]
ExtractStatistics --> CalculateStatistics["Calculate Statistics"]
CalculateStatistics --> GenerateStatisticsData["Generate Statistical Chart Data"]
GenerateStatisticsData --> End([End])
```

**Diagram sources**
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py#L20-L50)

**Section sources**
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py#L20-L50)

## Dependency Analysis
The distributed tracing functionality depends on several external libraries and internal modules, including OpenTelemetry, Elasticsearch, Django, and REST framework. These dependencies collectively provide capabilities for data collection, storage, processing, and presentation.

``mermaid
graph TD
subgraph "External Dependencies"
opentelemetry[OpenTelemetry]
elasticsearch[Elasticsearch]
django[Django]
rest_framework[REST framework]
end
subgraph "Internal Modules"
trace_handler[trace_handler]
diagram[diagram]
constants[constants.py]
serializers[serializers.py]
end
opentelemetry --> trace_handler
elasticsearch --> trace_handler
django --> trace_handler
rest_framework --> trace_handler
trace_handler --> diagram
constants --> trace_handler
serializers --> trace_handler
```

**Diagram sources**
- [bkmonitor\packages\apm_web\handlers\trace_handler\base.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\base.py)
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py)
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py)
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py)
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py)
- [bkmonitor\packages\apm_web\trace\constants.py](file://bkmonitor\packages\apm_web\trace\constants.py)
- [bkmonitor\packages\apm_web\trace\serializers.py](file://bkmonitor\packages\apm_web\trace\serializers.py)

**Section sources**
- [bkmonitor\packages\apm_web\handlers\trace_handler\base.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\base.py)
- [bkmonitor\packages\apm_web\trace\diagram\service_topo.py](file://bkmonitor\packages\apm_web\trace\diagram\service_topo.py)
- [bkmonitor\packages\apm_web\trace\diagram\flamegraph.py](file://bkmonitor\packages\apm_web\trace\diagram\flamegraph.py)
- [bkmonitor\packages\apm_web\trace\diagram\sequence.py](file://bkmonitor\packages\apm_web\trace\diagram\sequence.py)
- [bkmonitor\packages\apm_web\trace\diagram\statistics.py](file://bkmonitor\packages\apm_web\trace\diagram\statistics.py)
- [bkmonitor\packages\apm_web\trace\constants.py](file://bkmonitor\packages\apm_web\trace\constants.py)
- [bkmonitor\packages\apm_web\trace\serializers.py](file://bkmonitor\packages\apm_web\trace\serializers.py)

## Performance Considerations
The distributed tracing functionality has been optimized for performance, including improvements in query handling, data sampling, storage optimization, and query optimization. The recent update to the `TraceQuery` class in `bkmonitor/apm/core/handlers/query/trace_query.py` has significantly improved the performance of Span list retrieval by optimizing query construction, time range handling, and data pagination. These optimizations ensure efficient data retrieval while maintaining comprehensive trace analysis capabilities.

**Section sources**
- [bkmonitor\apm\core\handlers\query\trace_query.py](file://bkmonitor\apm\core\handlers\query\trace_query.py) - *Updated in commit da50b62f5d326419dd5e3e76127b621fbabd270d*
- [bkmonitor\apm\core\handlers\query\base.py](file://bkmonitor\apm\core\handlers\query\base.py) - *Base class for query handling*
- [bkmonitor\packages\monitor_web\overview\search.py](file://bkmonitor\packages\monitor_web\overview\search.py) - *Integration with overview search functionality*

## Fault Troubleshooting Guide
When using the distributed tracing functionality, users may encounter common issues such as data loss, query failures, and performance degradation. The following are solutions to common problems:
- **Data Loss**: Check if the data collection module is running normally and ensure that the OpenTelemetry SDK is correctly configured.
- **Query Failure**: Check the status of the Elasticsearch cluster and ensure that the query statements are correct.
- **Performance Degradation**: Check the data sampling strategy to ensure that the sampling rate is reasonable. For Span list retrieval performance issues, verify that the query parameters are optimized and that the time range is appropriately set.

**Section sources**
- [bkmonitor\packages\apm_web\handlers\trace_handler\base.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\base.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\query.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\query.py)
- [bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py](file://bkmonitor\packages\apm_web\handlers\trace_handler\view_config.py)

## Conclusion
This document provides a comprehensive overview of the distributed tracing functionality in the BlueKing monitoring platform, detailing the mechanisms for generating, storing, and analyzing call chains. Through this document, users can gain a deep understanding of the implementation principles and usage methods of distributed tracing, effectively utilizing the tracing functionality for performance issue diagnosis and optimization.