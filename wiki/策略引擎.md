## ä¸€ã€ğŸ“ **ç­–ç•¥å¼•æ“æ ¸å¿ƒä»£ç ä½ç½®**

### ğŸ¯ **1. ç­–ç•¥ç®¡ç†å’Œé…ç½®æ¨¡å—**

**ä¸»è¦ä½ç½®ï¼š** `bkmonitor/bkmonitor/strategy/`

- **[new_strategy.py](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\strategy\new_strategy.py)** - æ–°ç‰ˆç­–ç•¥æ ¸å¿ƒå®ç°
  - [Strategy](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\strategy\new_strategy.py#L1702-L3032) ç±»ï¼šç­–ç•¥é¢†åŸŸå¯¹è±¡ï¼ŒåŒ…å«å®Œæ•´çš„ç­–ç•¥é…ç½®ä¿¡æ¯
  - [Item](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\strategy\new_strategy.py#L1437-L1699) ç±»ï¼šç›‘æ§é¡¹å¯¹è±¡
  - [Algorithm](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\strategy\new_strategy.py#L931-L1057) ç±»ï¼šæ£€æµ‹ç®—æ³•å¯¹è±¡
  - [QueryConfig](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\strategy\new_strategy.py#L1185-L1434) ç±»ï¼šæŸ¥è¯¢é…ç½®å¯¹è±¡

- **[strategy.py](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\core\cache\strategy.py)** - ç­–ç•¥é…ç½®ç®¡ç†ï¼ˆå·²æœ‰ç‰ˆæœ¬ï¼‰
  - [StrategyConfig](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\strategy\strategy.py#L53-L915) ç±»ï¼šç­–ç•¥é…ç½®ä¸šåŠ¡é€»è¾‘å¤„ç†

- **[serializers.py](file://d:\projects\bk-monitor\bkmonitor\apm\serializers.py)** - ç­–ç•¥é…ç½®éªŒè¯å’Œåºåˆ—åŒ–

### ğŸ¯ **2. ç­–ç•¥æ£€æµ‹å’Œæ‰§è¡Œå¼•æ“**

**ä¸»è¦ä½ç½®ï¼š** `bkmonitor/alarm_backends/service/detect/`

- **[process.py](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\detect\process.py)** - **ç­–ç•¥æ£€æµ‹å¤„ç†æ ¸å¿ƒ**

  ```python
  class DetectProcess(BaseAbnormalPushProcessor):
      """ç­–ç•¥æ£€æµ‹å¤„ç†å™¨ - ç­–ç•¥å¼•æ“çš„æ‰§è¡Œæ ¸å¿ƒ"""
  ```

- **[handler.py](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\trigger\handler.py)** - æ£€æµ‹å¤„ç†å™¨è°ƒåº¦

- **`strategy/`** - å„ç§æ£€æµ‹ç®—æ³•å®ç°

  - [threshold.py](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\detect\strategy\threshold.py) - é˜ˆå€¼æ£€æµ‹
  - [intelligent_detect.py](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\dataflow\task\intelligent_detect.py) - æ™ºèƒ½æ£€æµ‹
  - [advanced_year_round.py](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\tests\service\detect\test_advanced_year_round.py) - é«˜çº§ç¯æ¯”æ£€æµ‹
  - ç­‰å¤šç§æ£€æµ‹ç­–ç•¥

### ğŸ¯ **3. ç­–ç•¥è§¦å‘å’Œå‘Šè­¦ç”Ÿæˆ**

**ä¸»è¦ä½ç½®ï¼š** `bkmonitor/alarm_backends/service/trigger/`

- **[processor.py](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\alert\processor.py)** - ç­–ç•¥è§¦å‘å¤„ç†å™¨

  ```python
  class TriggerProcessor:
      """ç­–ç•¥è§¦å‘å¤„ç†å™¨ - è´Ÿè´£å°†æ£€æµ‹ç»“æœè½¬åŒ–ä¸ºå‘Šè­¦"""
  ```

- **[handler.py](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\trigger\handler.py)** - è§¦å‘å¤„ç†è°ƒåº¦å™¨

### ğŸ¯ **4. ç­–ç•¥APIå’Œè§†å›¾å±‚**

**ä¸»è¦ä½ç½®ï¼š** `bkmonitor/packages/monitor_web/strategies/`

- **`resources/v2.py`** - ç­–ç•¥ç®¡ç†APIèµ„æº
  - [GetStrategyListV2Resource](file://d:\projects\bk-monitor\bkmonitor\packages\monitor_web\strategies\resources\v2.py#L106-L1582) - è·å–ç­–ç•¥åˆ—è¡¨
  - [SaveStrategyV2Resource](file://d:\projects\bk-monitor\bkmonitor\packages\monitor_web\strategies\resources\v2.py#L2365-L2435) - ä¿å­˜ç­–ç•¥é…ç½®
  - [UpdatePartialStrategyV2Resource](file://d:\projects\bk-monitor\bkmonitor\packages\monitor_web\strategies\resources\v2.py#L2438-L2963) - æ‰¹é‡æ›´æ–°ç­–ç•¥

- **[views.py](file://d:\projects\bk-monitor\bkmonitor\apm\views.py)** - ç­–ç•¥ç®¡ç†è§†å›¾é›†
- **`resources/v1.py`** - å…¼å®¹æ€§APIèµ„æº

### ğŸ¯ **5. ç­–ç•¥æ•°æ®æ¨¡å‹**

**ä¸»è¦ä½ç½®ï¼š** `bkmonitor/bkmonitor/models/strategy.py`

- **[StrategyModel](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\models\strategy.py#L333-L422)** - ç­–ç•¥æ•°æ®æ¨¡å‹
- **[ItemModel](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\models\strategy.py#L79-L98)** - ç›‘æ§é¡¹æ•°æ®æ¨¡å‹  
- **[AlgorithmModel](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\models\strategy.py#L149-L229)** - æ£€æµ‹ç®—æ³•æ•°æ®æ¨¡å‹
- **[QueryConfigModel](file://d:\projects\bk-monitor\bkmonitor\bkmonitor\models\strategy.py#L242-L285)** - æŸ¥è¯¢é…ç½®æ•°æ®æ¨¡å‹

## ğŸ”„ **ç­–ç•¥å¼•æ“æ‰§è¡Œæµç¨‹æ—¶åºå›¾**

```mermaid
sequenceDiagram
    participant UI as å‰ç«¯ç•Œé¢
    participant API as ç­–ç•¥API
    participant Strategy as ç­–ç•¥å¼•æ“
    participant Detect as æ£€æµ‹å¼•æ“
    participant Trigger as è§¦å‘å¼•æ“
    participant Alert as å‘Šè­¦æ¨¡å—
    
    Note over UI,Alert: ç­–ç•¥é…ç½®é˜¶æ®µ
    UI->>API: åˆ›å»º/æ›´æ–°ç­–ç•¥
    API->>Strategy: ä¿å­˜ç­–ç•¥é…ç½®
    Strategy->>Strategy: éªŒè¯é…ç½®æœ‰æ•ˆæ€§
    Strategy-->>API: è¿”å›ç­–ç•¥ID
    API-->>UI: é…ç½®æˆåŠŸ
    
    Note over Strategy,Alert: ç­–ç•¥æ‰§è¡Œé˜¶æ®µ
    Strategy->>Detect: æ‹‰å–ç›‘æ§æ•°æ®
    Detect->>Detect: æ‰§è¡Œæ£€æµ‹ç®—æ³•
    Detect->>Detect: ç”Ÿæˆå¼‚å¸¸è®°å½•
    Detect->>Trigger: æ¨é€å¼‚å¸¸æ•°æ®
    Trigger->>Trigger: åˆ¤æ–­è§¦å‘æ¡ä»¶
    Trigger->>Alert: ç”Ÿæˆå‘Šè­¦äº‹ä»¶
    Alert->>Alert: æ‰§è¡Œå¤„ç†åŠ¨ä½œ
```

## ğŸ’¡ **ç­–ç•¥å¼•æ“å…³é”®ç»„ä»¶è¯´æ˜**

1. **ç­–ç•¥é…ç½®å±‚**ï¼šè´Ÿè´£ç­–ç•¥çš„åˆ›å»ºã€æ›´æ–°ã€éªŒè¯å’Œå­˜å‚¨
2. **ç­–ç•¥æ‰§è¡Œå±‚**ï¼šè´Ÿè´£æ ¹æ®ç­–ç•¥é…ç½®è¿›è¡Œæ•°æ®æ£€æµ‹å’Œå¼‚å¸¸è¯†åˆ«  
3. **ç­–ç•¥è§¦å‘å±‚**ï¼šè´Ÿè´£å°†æ£€æµ‹ç»“æœè½¬åŒ–ä¸ºå…·ä½“çš„å‘Šè­¦äº‹ä»¶
4. **ç­–ç•¥ç®¡ç†å±‚**ï¼šæä¾›ç­–ç•¥çš„æŸ¥è¯¢ã€ç®¡ç†å’Œæ“ä½œæ¥å£

è¿™äº›æ¨¡å—å…±åŒæ„æˆäº†bkmonitorçš„**ç­–ç•¥å¼•æ“**ï¼Œå®ç°äº†ä»ç­–ç•¥é…ç½®åˆ°å¼‚å¸¸æ£€æµ‹å†åˆ°å‘Šè­¦ç”Ÿæˆçš„å®Œæ•´æµç¨‹ã€‚

---

## äºŒã€ğŸ” **ç­–ç•¥æ£€æµ‹è§¦å‘æœºåˆ¶åˆ†æ**

ç­–ç•¥æ£€æµ‹**ä¸æ˜¯**é€šè¿‡å®šæ—¶ä»»åŠ¡ç›´æ¥è§¦å‘çš„ï¼Œè€Œæ˜¯é‡‡ç”¨**äº‹ä»¶é©±åŠ¨**çš„æ–¹å¼ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š

### ğŸ“Š **ç­–ç•¥æ£€æµ‹è§¦å‘æµç¨‹æ—¶åºå›¾**

```mermaid
sequenceDiagram
    participant DataSource as æ•°æ®æº
    participant AccessProcess as æ•°æ®æ¥å…¥å¤„ç†å™¨
    participant RedisQueue as Redisé˜Ÿåˆ—
    participant DetectHandler as æ£€æµ‹å¤„ç†å™¨
    participant CeleryTask as Celeryä»»åŠ¡
    participant DetectProcess as ç­–ç•¥æ£€æµ‹å¤„ç†å™¨
    
    Note over DataSource,DetectProcess: æ•°æ®é©±åŠ¨çš„ç­–ç•¥æ£€æµ‹è§¦å‘æµç¨‹
    
    DataSource->>AccessProcess: ç›‘æ§æ•°æ®åˆ°è¾¾
    AccessProcess->>AccessProcess: å¤„ç†å¹¶éªŒè¯æ•°æ®
    AccessProcess->>RedisQueue: æ¨é€æ•°æ®åˆ°DATA_LIST_KEY
    Note right of RedisQueue: æ ¼å¼: access.data.{strategy_id}.{item_id}
    
    AccessProcess->>RedisQueue: æ¨é€ç­–ç•¥ä¿¡å·åˆ°DATA_SIGNAL_KEY
    Note right of RedisQueue: ç­–ç•¥IDåˆ—è¡¨ï¼Œè§¦å‘æ£€æµ‹ä¿¡å·
    
    Note over DetectHandler,CeleryTask: æ£€æµ‹å¤„ç†å™¨ç›‘å¬ä¿¡å·é˜Ÿåˆ—
    
    DetectHandler->>RedisQueue: ç›‘å¬DATA_SIGNAL_KEYé˜Ÿåˆ—
    Note right of DetectHandler: brpopé˜»å¡ç­‰å¾…5ç§’
    
    RedisQueue-->>DetectHandler: è¿”å›ç­–ç•¥ID
    
    alt ç›´æ¥å¤„ç†æ¨¡å¼
        DetectHandler->>DetectProcess: ç›´æ¥è°ƒç”¨run_detect(strategy_id)
    else Celeryå¼‚æ­¥æ¨¡å¼
        DetectHandler->>CeleryTask: åˆ†å‘åˆ°Celeryé˜Ÿåˆ—
        CeleryTask->>DetectProcess: å¼‚æ­¥æ‰§è¡Œrun_detect(strategy_id)
    end
    
    DetectProcess->>RedisQueue: æ‹‰å–DATA_LIST_KEYä¸­çš„æ•°æ®
    DetectProcess->>DetectProcess: æ‰§è¡Œç­–ç•¥æ£€æµ‹ç®—æ³•
    DetectProcess->>DetectProcess: ç”Ÿæˆå¼‚å¸¸æ£€æµ‹ç»“æœ
    
    Note over DetectProcess: å¦‚æœå¤„ç†ç¹å¿™ï¼Œä¼šé‡æ–°æäº¤ä»»åŠ¡
    alt å¤„ç†å™¨ç¹å¿™
        DetectProcess->>CeleryTask: apply_asyncé‡æ–°æäº¤
    end
    
    Note over DetectProcess: å¦‚æœè·å–é”å¤±è´¥ï¼Œå»¶è¿Ÿé‡è¯•
    alt è·å–é”å¤±è´¥
        DetectProcess->>RedisQueue: å»¶è¿Ÿ20ç§’é‡æ–°æ¨é€ä¿¡å·
    end
```

### ğŸ”§ **æ ¸å¿ƒè§¦å‘æœºåˆ¶è¯¦è§£**

#### **1. æ•°æ®æ¥å…¥è§¦å‘ - äº‹ä»¶é©±åŠ¨**

- **è§¦å‘æº**: [AccessDataProcess](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\access\data\processor.py#L241-L247) æ•°æ®æ¥å…¥å¤„ç†å™¨

- **è§¦å‘æ¡ä»¶**: å½“ç›‘æ§æ•°æ®é€šè¿‡æ•°æ®æ¥å…¥æ¨¡å—å¤„ç†å®Œæˆå

- **ä¿¡å·æ¨é€**: 

  ```python
  # æ¨é€æ•°æ®å¤„ç†ä¿¡å·
  if records:
      client = output_client or key.DATA_SIGNAL_KEY.client
      if strategy_ids:
          client.lpush(key.DATA_SIGNAL_KEY.get_key(), *list(strategy_ids))
  ```

#### **2. æ£€æµ‹å¤„ç†å™¨ç›‘å¬ - æ¶ˆè´¹è€…æ¨¡å¼**

- **ç›‘å¬å™¨**: [DetectHandler](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\detect\handler.py#L25-L37)
- **ç›‘å¬æ–¹å¼**: Redisé˜»å¡å¼¹å‡º `brpop(data_signal_key, 5)` (5ç§’è¶…æ—¶)
- **å¤„ç†æ¨¡å¼**: æ”¯æŒä¸¤ç§å¤„ç†æ–¹å¼
  - **ç›´æ¥å¤„ç†**: [DetectHandler](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\detect\handler.py#L25-L37) - åŒæ­¥è°ƒç”¨
  - **å¼‚æ­¥å¤„ç†**: [DetectCeleryHandler](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\detect\handler.py#L40-L87) - Celeryä»»åŠ¡é˜Ÿåˆ—

#### **3. Celeryä»»åŠ¡æ‰§è¡Œ - å¼‚æ­¥å¤„ç†**

- **ä»»åŠ¡å®šä¹‰**: [run_detect](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\detect\tasks.py#L22-L46) Celeryä»»åŠ¡
- **é˜Ÿåˆ—é…ç½®**: `celery_service` é˜Ÿåˆ—
- **å¼‚å¸¸å¤„ç†**: åŒ…å«é”å†²çªé‡è¯•ã€å¤„ç†å™¨ç¹å¿™é‡æ–°æäº¤ç­‰æœºåˆ¶

### ğŸ¯ **å…³é”®ç‰¹æ€§è¯´æ˜**

#### **1. æ•°æ®é©±åŠ¨ vs å®šæ—¶é©±åŠ¨**

```python
# âŒ ä¸æ˜¯è¿™æ ·çš„å®šæ—¶ä»»åŠ¡è§¦å‘
@periodic_task(run_every=crontab(minute='*/1'))  # è¿™ä¸æ˜¯ç­–ç•¥æ£€æµ‹çš„æ–¹å¼

# âœ… å®é™…æ˜¯äº‹ä»¶é©±åŠ¨è§¦å‘
def handle(self):
    ret = self.client.brpop(self.data_signal_key, 5)  # ç›‘å¬é˜Ÿåˆ—
    if ret is None:
        return
    run_detect(ret[1])  # å¤„ç†ç­–ç•¥æ£€æµ‹
```

#### **2. è‡ªé€‚åº”å¤„ç†æœºåˆ¶**

```python
# å¤„ç†å™¨ç¹å¿™æ—¶é‡æ–°æäº¤
if processor.is_busy:
    run_detect.apply_async(args=(strategy_id,))
    
# è·å–é”å¤±è´¥æ—¶å»¶è¿Ÿé‡è¯•  
except LockError:
    client.delay("lpush", data_signal_key, strategy_id, delay=20)
```

#### **3. äºŒæ¬¡ç¡®è®¤æœºåˆ¶**

```python
# åœ¨process.pyä¸­çš„äºŒæ¬¡ç¡®è®¤é€»è¾‘
def double_check(self, item):
    """äºŒæ¬¡ç¡®è®¤æœºåˆ¶ï¼Œä»…é’ˆå¯¹é…ç½®äº†ç°åº¦çš„ç­–ç•¥"""
    if int(self.strategy_id) not in settings.DOUBLE_CHECK_SUM_STRATEGY_IDS:
        return
    item.double_check(outputs=self.outputs[item.id])
```

### ğŸ’¡ **æ€»ç»“**

ç­–ç•¥æ£€æµ‹çš„è§¦å‘æœºåˆ¶æ˜¯**æ•°æ®é©±åŠ¨çš„äº‹ä»¶æ¨¡å¼**ï¼Œä¸æ˜¯ä¼ ç»Ÿçš„å®šæ—¶ä»»åŠ¡ï¼š

1. **è§¦å‘æº**: ç›‘æ§æ•°æ®åˆ°è¾¾æ—¶é€šè¿‡æ•°æ®æ¥å…¥å¤„ç†å™¨æ¨é€ä¿¡å·
2. **å¤„ç†æ–¹å¼**: Redisé˜Ÿåˆ— + äº‹ä»¶ç›‘å¬å™¨ + Celeryå¼‚æ­¥ä»»åŠ¡
3. **æ‰§è¡Œç‰¹ç‚¹**: å®æ—¶å“åº”ã€è‡ªé€‚åº”é‡è¯•ã€æ”¯æŒå¹¶å‘å¤„ç†
4. **ä¼˜åŠ¿**: å‡å°‘ä¸å¿…è¦çš„æ£€æµ‹æ‰§è¡Œï¼Œæé«˜ç³»ç»Ÿæ•ˆç‡ï¼Œå®ç°æŒ‰éœ€æ£€æµ‹

è¿™ç§è®¾è®¡ç¡®ä¿äº†ç­–ç•¥æ£€æµ‹èƒ½å¤ŸåŠæ—¶å“åº”æ•°æ®å˜åŒ–ï¼ŒåŒæ—¶é¿å…äº†å®šæ—¶ä»»åŠ¡å¯èƒ½å¸¦æ¥çš„èµ„æºæµªè´¹å’Œå»¶è¿Ÿé—®é¢˜ã€‚

---



## ä¸‰ã€ğŸ” **AccessCeleryHandler åœ¨ç›‘æ§é¡¹ç›®ä¸­çš„ä½œç”¨**

### ğŸ“‹ **æ ¸å¿ƒåŠŸèƒ½è¯´æ˜**

**AccessCeleryHandler** æ˜¯æ•°æ®æ¥å…¥æ¨¡å—çš„ **Celery å¼‚æ­¥å¤„ç†å™¨**ï¼Œå®ƒç»§æ‰¿è‡ª [AccessHandler](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\access\handler.py#L181-L268)ï¼Œä¸»è¦ä½œç”¨æ˜¯å°†æ•°æ®æ¥å…¥ä»»åŠ¡**å¼‚æ­¥åŒ–å¤„ç†**ã€‚

### ğŸ”§ **å…³é”®ä»£ç åˆ†æ**

```python
class AccessCeleryHandler(AccessHandler):
    """
    AccessCeleryHandler(run by celery worker)  
    é€šè¿‡ Celery Worker è¿è¡Œçš„æ•°æ®æ¥å…¥å¤„ç†å™¨
    """

    @staticmethod
    def run_access(access_func, *args):
        """
        æ ¸å¿ƒå·®å¼‚ï¼šå°†åŒæ­¥è°ƒç”¨è½¬æ¢ä¸ºå¼‚æ­¥ Celery ä»»åŠ¡
        - AccessHandler: access_func(*args)  # ç›´æ¥åŒæ­¥æ‰§è¡Œ  
        - AccessCeleryHandler: access_func.delay(*args)  # å¼‚æ­¥ Celery ä»»åŠ¡
        """
        access_func.delay(*args)
```

### ğŸ”„ **å·¥ä½œæ¨¡å¼å¯¹æ¯”æ—¶åºå›¾**

```mermaid
sequenceDiagram
    participant Scheduler as è°ƒåº¦å™¨
    participant Handler as å¤„ç†å™¨
    participant Task as ä»»åŠ¡
    participant Worker as Celery Worker
    participant DataSource as æ•°æ®æº
    
    Note over Scheduler,DataSource: AccessHandler (åŒæ­¥æ¨¡å¼)
    
    Scheduler->>Handler: è§¦å‘æ•°æ®æ¥å…¥
    Handler->>Task: access_func(*args)
    Note right of Task: ç›´æ¥åŒæ­¥æ‰§è¡Œ
    Task->>DataSource: æ‹‰å–ç›‘æ§æ•°æ®
    DataSource-->>Task: è¿”å›æ•°æ®
    Task-->>Handler: å¤„ç†å®Œæˆ
    Handler-->>Scheduler: æ‰§è¡Œç»“æŸ
    
    Note over Scheduler,DataSource: AccessCeleryHandler (å¼‚æ­¥æ¨¡å¼)
    
    Scheduler->>Handler: è§¦å‘æ•°æ®æ¥å…¥
    Handler->>Worker: access_func.delay(*args)
    Note right of Worker: å¼‚æ­¥Celeryä»»åŠ¡
    Handler-->>Scheduler: ç«‹å³è¿”å›
    
    Note over Worker,DataSource: å¼‚æ­¥æ‰§è¡Œé˜¶æ®µ
    Worker->>Task: æ‰§è¡Œå…·ä½“ä»»åŠ¡
    Task->>DataSource: æ‹‰å–ç›‘æ§æ•°æ®
    DataSource-->>Task: è¿”å›æ•°æ®
    Task-->>Worker: ä»»åŠ¡å®Œæˆ
```

### ğŸš€ **å…·ä½“ä½¿ç”¨åœºæ™¯**

#### **1. å¯åŠ¨å‘½ä»¤é…ç½®**

åœ¨ [supervisor é…ç½®](file://d:\projects\bk-monitor\bkmonitor\support-files\templates\#etc#supervisor-bkmonitorv3-monitor.conf#L63-L73) ä¸­ï¼š

```bash
# ä½¿ç”¨ AccessCeleryHandler çš„å¯åŠ¨å‘½ä»¤
python manage.py run_access -s access -H celery --access-type=data --hash-ring=1
```

#### **2. å¤„ç†å™¨ç±»å‹é€‰æ‹©**

é€šè¿‡ [load_handler_cls](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\management\base\loaders.py#L34-L44) å‡½æ•°æ ¹æ®å‚æ•°åŠ¨æ€é€‰æ‹©ï¼š

```python
# è‡ªåŠ¨å‘ç°å¤„ç†å™¨è§„åˆ™
def autodiscover_handlers():
    """
    è‡ªåŠ¨å‘ç°å¤„ç†å™¨ç±»å‹ï¼š
    - ä»¥ "CeleryHandler" ç»“å°¾çš„ç±» â†’ celery å¤„ç†å™¨
    - å…¶ä»– Handler ç±» â†’ process å¤„ç†å™¨
    """
    for attr, val in handler_module.__dict__.items():
        if inspect.isclass(val) and issubclass(val, base.BaseHandler):
            if attr.endswith("CeleryHandler"):
                service_handlers.setdefault(service_type, {})["celery"] = val
            else:
                service_handlers.setdefault(service_type, {})["process"] = val
```

#### **3. å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæµç¨‹**

**AccessCeleryHandler** ä¸»è¦å¤„ç†ä»¥ä¸‹ç±»å‹çš„å¼‚æ­¥ä»»åŠ¡ï¼š

1. **æ•°æ®æ¥å…¥ä»»åŠ¡**: [run_access_data](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\access\tasks.py#L31-L49)
2. **äº‹ä»¶å¤„ç†ä»»åŠ¡**: [run_access_event_handler](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\access\tasks.py#L59-L75)
3. **å®æ—¶æ•°æ®å¤„ç†**: å®æ—¶æ•°æ®æµå¤„ç†
4. **å‘Šè­¦äº‹ä»¶å¤„ç†**: å‘Šè­¦å’Œå¼‚å¸¸äº‹ä»¶å¤„ç†

### ğŸ¯ **å…·ä½“åº”ç”¨ç¤ºä¾‹**

#### **äº‹ä»¶æ•°æ®å¤„ç†**

```python
def handle_event(self):
    """å¤„ç† GSE äº‹ä»¶æ•°æ®"""
    data_ids = [
        settings.GSE_BASE_ALARM_DATAID,     # GSE åŸºç¡€å‘Šè­¦æ•°æ®ID
        settings.GSE_CUSTOM_EVENT_DATAID,   # GSE è‡ªå®šä¹‰äº‹ä»¶æ•°æ®ID  
        settings.GSE_PROCESS_REPORT_DATAID, # GSE è¿›ç¨‹æŠ¥å‘Šæ•°æ®ID
    ]
    
    for data_id in data_ids:
        # AccessHandler: run_access_event_handler(data_id)  # åŒæ­¥æ‰§è¡Œ
        # AccessCeleryHandler: run_access_event_handler.delay(data_id)  # å¼‚æ­¥æ‰§è¡Œ
        self.run_access(run_access_event_handler, data_id)
```

#### **å®šæ—¶æ•°æ®æ¥å…¥**

```python
def batch_access_data(self, interval_key):
    """æ‰¹é‡è¿è¡Œæ•°æ®æ¥å…¥ä»»åŠ¡"""
    strategy_group_keys = self.interval_map.get(interval_key) or []
    
    for strategy_group_key in strategy_group_keys:
        # æ ¹æ®æ˜¯å¦ä¸º QoS é˜Ÿåˆ—é€‰æ‹©ä¸åŒä»»åŠ¡
        run_task = run_access_data_with_qos_queue if strategy_group_key in self.qos_keys else run_access_data
        
        # AccessCeleryHandler ä¼šå¼‚æ­¥æ‰§è¡Œ
        run_task.delay(strategy_group_key, interval=interval_key)
```

### ğŸ’¡ **æ ¸å¿ƒä¼˜åŠ¿**

1. **é«˜å¹¶å‘å¤„ç†**: é€šè¿‡ Celery å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¤§é‡æ•°æ®æ¥å…¥ä»»åŠ¡çš„å¹¶å‘å¤„ç†
2. **ç³»ç»Ÿè§£è€¦**: å°†æ•°æ®æ¥å…¥ä»»åŠ¡ä»ä¸»è°ƒåº¦å™¨ä¸­åˆ†ç¦»ï¼Œé¿å…é˜»å¡ä¸»è¦æµç¨‹
3. **å®¹é”™èƒ½åŠ›**: ä»»åŠ¡å¤±è´¥æ—¶å¯ä»¥é‡è¯•ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§
4. **èµ„æºä¼˜åŒ–**: åˆç†åˆ†é… Worker èµ„æºï¼Œé¿å…å•ç‚¹æ€§èƒ½ç“¶é¢ˆ
5. **æ‰©å±•æ€§**: å¯ä»¥æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´ Celery Worker æ•°é‡

### ğŸ”§ **é…ç½®ç®¡ç†**

é€šè¿‡ [ä»¤ç‰Œæ¡¶æœºåˆ¶](file://d:\projects\bk-monitor\bkmonitor\alarm_backends\service\access\data\token.py) è¿›è¡Œæµé‡æ§åˆ¶ï¼š

- å¯¹è€—æ—¶è¿‡é•¿çš„æ•°æ®æºè¿›è¡Œé™çº§å¤„ç†
- é˜²æ­¢æ•°æ®æºé—®é¢˜å½±å“æ•´ä¸ªé›†ç¾¤çš„å¤„ç†èƒ½åŠ›
- å®ç°å…¬å¹³çš„èµ„æºåˆ†é…å’Œè‡ªåŠ¨æ¢å¤æœºåˆ¶

### ğŸ“Š **æ€»ç»“**

**AccessCeleryHandler** æ˜¯ bk-monitor æ•°æ®æ¥å…¥æ¶æ„ä¸­çš„å…³é”®ç»„ä»¶ï¼Œå®ƒå°†ä¼ ç»Ÿçš„åŒæ­¥æ•°æ®å¤„ç†æ¨¡å¼è½¬æ¢ä¸ºé«˜æ•ˆçš„å¼‚æ­¥å¤„ç†æ¨¡å¼ï¼Œç¡®ä¿ç›‘æ§ç³»ç»Ÿèƒ½å¤Ÿï¼š

- âœ… **å¤§è§„æ¨¡å¹¶å‘å¤„ç†**å¤šç§æ•°æ®æºçš„ç›‘æ§æ•°æ®
- âœ… **å®æ—¶å“åº”**å„ç§ç›‘æ§äº‹ä»¶å’Œå‘Šè­¦ä¿¡å·  
- âœ… **ç¨³å®šè¿è¡Œ**åœ¨é«˜è´Ÿè½½å’Œå¼‚å¸¸æƒ…å†µä¸‹
- âœ… **åŠ¨æ€æ‰©å±•**å¤„ç†èƒ½åŠ›ä»¥é€‚åº”ä¸šåŠ¡å¢é•¿

è¿™ç§è®¾è®¡ä½¿å¾— bk-monitor èƒ½å¤Ÿæ”¯æ’‘ä¼ä¸šçº§çš„å¤§è§„æ¨¡ç›‘æ§éœ€æ±‚ï¼Œæ˜¯å…¶é«˜æ€§èƒ½å’Œé«˜å¯ç”¨æ€§çš„é‡è¦ä¿éšœã€‚